<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ–‡ç« ç²¾è¯»</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
  
  <link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'PT Serif', 'Crimson Text', ui-serif, 'Times New Roman', 'Georgia', serif; background: #f6f8fb; margin:0; line-height: 1.6; color: #1f2937; letter-spacing: -0.05px; text-rendering: optimizeLegibility; font-kerning: normal; }
    .container { max-width: 1200px; margin: 0 auto; background:#fff; min-height: 100vh; }
    h2 { text-align:center; color:#111827; margin:0 0 24px; font-size: 26px; font-weight: 400; letter-spacing: -0.2px; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; padding: 24px 32px 16px; border-bottom: 1px solid #f1f5f9; }
    .toolbar button { padding: 10px 20px; border:none; border-radius:12px; cursor:pointer; background:#f8fafc; color:#374151; font-weight:500; transition: all 0.2s; border: 1px solid #e2e8f0; }
    .toolbar button:hover { background:#e2e8f0; transform: translateY(-1px); }
    .toolbar .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border: none; }
    .toolbar .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25); }
    .section { padding: 28px; margin: 24px; background: #ffffff; border: 1px solid #e6ebf2; border-radius: 16px; box-shadow: 0 6px 18px rgba(15,23,42,0.04); }
    label { font-weight:600; color:#374151; font-size:16px; display: block; margin-bottom: 8px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header-actions { display: flex; gap: 10px; }
    .action-btn { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 12px; background: #f8fafc; color: #475569; cursor: pointer; transition: all 0.2s; font-size: 14px; font-weight: 500; }
    .action-btn:hover { background: #eef2f7; border-color: #cbd5e1; transform: translateY(-1px); }
    .action-btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; }
    .action-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25); }
    .btn-icon { font-size: 16px; }
    .list { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px,1fr)); gap:18px; margin-top: 16px; }
    .card { background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%); border:1px solid #e5eaf0; border-radius:16px; padding:22px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 14px 30px rgba(0,0,0,0.08); border-color: #cbd5e1; }
    .card h3 { margin:0 0 10px; font-size:17px; color:#111827; font-weight: 600; line-height: 1.25; letter-spacing: -0.1px; }
    .muted { color:#6b7280; font-size:12.5px; letter-spacing: -0.1px; }
    .card .icon-btn { position:absolute; top:10px; right:10px; width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid #e5e7eb; background:#f8fafc; color:#94a3b8; cursor:pointer; transition: all .2s; opacity:0; }
    .card:hover .icon-btn { opacity:1; border-color:#cbd5e1; color:#64748b; }
    .card .icon-btn:hover { background:#eef2f7; }

    .viewer { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background:#fff; z-index: 1000; display: none; }
    .viewer.active { display: flex; flex-direction: column; }
    .viewer .header { display:flex; justify-content:space-between; align-items:center; padding: 20px 32px; border-bottom:1px solid #f1f5f9; background: #fafbfc; min-height: 80px; }
    .viewer .title { font-weight:600; color:#111827; font-size: 20px; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; word-break: break-word; }
    
    /* æ ‡é¢˜ç¼–è¾‘ç›¸å…³æ ·å¼ */
    .title-container {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    
    .edit-title-btn {
      padding: 4px 8px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: #6b7280;
      cursor: pointer;
      font-size: 14px;
      opacity: 0;
      transition: all 0.2s ease;
    }
    
    .title-container:hover .edit-title-btn {
      opacity: 1;
    }
    
    .edit-title-btn:hover {
      background: #f3f4f6;
      border-color: #e5e7eb;
      color: #374151;
    }
    
    .title-edit-container {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    
    .title-edit-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      outline: none;
      transition: border-color 0.2s ease;
    }
    
    .title-edit-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .title-edit-save, .title-edit-cancel {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .title-edit-save {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .title-edit-save:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .title-edit-cancel {
      background: #f3f4f6;
      color: #6b7280;
    }
    
    .title-edit-cancel:hover {
      background: #e5e7eb;
      color: #374151;
    }
    .viewer .close-btn { width: 40px; height: 40px; border: none; border-radius: 12px; background: #f3f4f6; color: #6b7280; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 18px; }
    .viewer .close-btn:hover { background: #e5e7eb; color: #374151; transform: scale(1.05); }
    .viewer-body { flex: 1; display: flex; overflow: hidden; position: relative; }
    .viewer-body .content { flex: 1; padding: 24px; line-height:1.7; font-size:16.5px; color:#344256; overflow-y: auto; transition: all 0.3s ease; }
    .viewer-body .content.panel-open { margin-right: var(--panel-width, 320px); }
    .viewer-body .content > .reader { max-width: 900px; margin: 16px auto; background: #fff; border: 1px solid #e6ebf2; border-radius: 16px; padding: 28px; box-shadow: 0 6px 18px rgba(15,23,42,0.03); letter-spacing: -0.05px; }
    .vocab-btn { padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 12px; background: #f8fafc; color: #475569; cursor: pointer; transition: all 0.2s; font-size: 14px; }
    .vocab-btn:hover { background: #eef2f7; border-color: #cbd5e1; }
    .vocab-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border-color: transparent; }
    .highlights-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 320px; min-width: 280px; max-width: 60vw; background: #fff; border-left: 1px solid #e6ebf2; box-shadow: -8px 0 24px rgba(15,23,42,0.06); z-index: 1100; transform: translateX(100%); transition: transform 0.3s ease; resize: none; }
    .highlights-panel.active { transform: translateX(0); }
    .highlights-panel .hp-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid #f1f5f9; }
    .highlights-panel .hp-title { font-weight: 700; color: #111827; }
    .highlights-panel .hp-search { flex: 1; margin: 0 8px 0 12px; }
    .highlights-panel .hp-search input { width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 10px; background: #f8fafc; font-size: 13px; }
    .highlights-panel .hp-body { padding: 10px 12px; overflow-y: auto; height: calc(100% - 54px); }
    .resize-handle { position: absolute; left: 0; top: 0; bottom: 0; width: 6px; cursor: col-resize; background: transparent; transition: background-color 0.2s; }
    .resize-handle:hover { background: rgba(102, 126, 234, 0.2); }
    .resize-handle.dragging { background: rgba(102, 126, 234, 0.4); }
    .hp-item { border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px 12px; margin-bottom: 8px; background: #fafbff; cursor: pointer; transition: .2s; }
    .hp-item:hover { border-color: #c7d2fe; background: #f5f7ff; }
    .hp-item.highlight { background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%); border-color: #96e6fb; }
    .hp-word { font-weight: 700; color: #111827; font-size: 13px; }
    .hp-meaning { color: #6b7280; font-size: 12px; margin-top: 4px; }
    .hl { background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%); border-radius:4px; padding: 2px 4px; position:relative; transition: all 0.2s; user-select: text; -webkit-user-select: text; margin: 1px 1px; display: inline-block; }
    .hl:hover { background: linear-gradient(120deg, #96e6fb 0%, #fbb6ce 100%); }
    .hl.active { background: linear-gradient(120deg, #fbbf24 0%, #f59e0b 100%); animation: highlight-pulse 0.6s ease-in-out; }
    @keyframes highlight-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes temp-tooltip-fade { 0% { opacity: 1; transform: translateY(0); } 70% { opacity: 1; } 100% { opacity: 0; transform: translateY(-10px); } }
    .tooltip { position:absolute; left:50%; bottom:100%; transform: translateX(-50%) translateY(-8px); background:#1f2937; color:#fff; padding:8px 12px; border-radius:8px; font-size:12px; white-space:nowrap; box-shadow:0 10px 30px rgba(0,0,0,0.2); display:none; z-index:20; pointer-events: none; user-select: none; }
    .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: #1f2937; }
    .hl:hover .tooltip { display:block; }
    .floating { position:fixed; background:rgba(17, 24, 39, 0.95); backdrop-filter: blur(12px); color:#fff; padding:12px 16px; border-radius:16px; font-size:14px; box-shadow:0 20px 40px rgba(0,0,0,0.3); display:none; z-index:3000; border: 1px solid rgba(255,255,255,0.1); }
    .floating button { background:#10b981; border:none; color:#fff; padding:8px 16px; border-radius:10px; cursor:pointer; font-weight:600; transition: all 0.2s; font-size: 13px; }
    .floating button:hover { background:#059669; transform: translateY(-1px); }
    .floating button:disabled { background:#6b7280; cursor:not-allowed; transform: none; }
    .floating button:disabled:hover { background:#6b7280; transform: none; }
    .floating .del { background:#ef4444; margin-left:8px; }
    .floating .del:hover { background:#dc2626; }
    .floating input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px 12px; border-radius: 8px; outline: none; font-size: 14px; margin-right: 8px; min-width: 200px; font-family: 'PT Serif', 'Crimson Text', ui-serif, 'Times New Roman', 'Georgia', serif; }
    .floating input::placeholder { color: rgba(255,255,255,0.6); }
    .floating input:focus { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4); }
    .empty { color:#9ca3af; font-size:15px; text-align:center; padding:48px 16px; }
    .cat-tabs { display:flex; gap:4px; justify-content:center; margin: 24px 0; }
    .cat-tabs button { padding:10px 20px; border-radius:12px; border:none; background:#f8fafc; cursor:pointer; font-weight:500; color:#6b7280; transition: all 0.2s; }
    .cat-tabs button.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    .cat-tabs button:hover:not(.active) { background:#e2e8f0; }
    
    /* éŸ³é¢‘æ’­æ”¾é¢æ¿æ ·å¼ */
    .audio-panel { 
      position: absolute; 
      bottom: 0; 
      left: 0; 
      right: 0; 
      background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%); 
      border-top: 1px solid #e6ebf2; 
      padding: 16px 24px; 
      box-shadow: 0 -4px 12px rgba(15,23,42,0.08); 
      z-index: 100; 
    }
    .audio-controls { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      max-width: 900px; 
      margin: 0 auto; 
    }
    .audio-controls audio { 
      flex: 1; 
      height: 40px; 
      border-radius: 8px; 
      outline: none; 
    }
    .audio-controls button { 
      padding: 8px 12px; 
      border: 1px solid #e2e8f0; 
      border-radius: 8px; 
      background: #f8fafc; 
      color: #475569; 
      cursor: pointer; 
      transition: all 0.2s; 
      font-size: 14px; 
      font-weight: 500; 
      display: flex; 
      align-items: center; 
      gap: 4px; 
    }
    .audio-controls button:hover { 
      background: #eef2f7; 
      border-color: #cbd5e1; 
      transform: translateY(-1px); 
    }
    
    /* éŸ³é¢‘æŒ‡ç¤ºå™¨æ ·å¼ */
    .audio-indicator {
      position: absolute;
      bottom: 8px;
      right: 8px;
      display: flex;
      align-items: center;
      gap: 2px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 9px;
      font-weight: 600;
      box-shadow: 0 1px 4px rgba(16, 185, 129, 0.4);
      opacity: 0;
      animation: fadeInSlideUp 0.4s ease-out 0.3s forwards;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 2;
    }
    
    .audio-indicator:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .audio-indicator svg {
      flex-shrink: 0;
      width: 12px;
      height: 12px;
    }
    
    .audio-indicator span {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      letter-spacing: 0.1px;
      font-size: 8px;
    }
    
    @keyframes fadeInSlide {
      from {
        opacity: 0;
        transform: translateX(10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes fadeInSlideLeft {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes fadeInSlideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* å¡ç‰‡æ‚¬åœæ—¶éŸ³é¢‘æŒ‡ç¤ºå™¨çš„æ•ˆæœ */
    .card:hover .audio-indicator {
      transform: translateY(-2px) scale(1.08);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.45);
    }
    
    /* å›¾ç‰‡ç›¸å…³æ ·å¼ */
    .article-images {
      margin-bottom: 24px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border: 1px solid #e6ebf2;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(15,23,42,0.04);
    }
    
    .article-images h4 {
      margin: 0 0 16px 0;
      color: #374151;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }
    
    .image-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      background: #f8fafc;
      border: 1px solid #e5eaf0;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(15,23,42,0.08);
    }
    
    .image-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(15,23,42,0.15);
      border-color: #cbd5e1;
    }
    
    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .image-item:hover img {
      transform: scale(1.05);
    }
    
    .image-delete-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 24px;
      height: 24px;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      opacity: 0;
      transition: all 0.2s ease;
      z-index: 10;
    }
    
    .image-item:hover .image-delete-btn {
      opacity: 1;
    }
    
    .image-delete-btn:hover {
      background: rgba(220, 38, 38, 0.95);
      transform: scale(1.1);
    }
    
    /* å¤§å›¾æŸ¥çœ‹æ¨¡æ€æ¡†æ ·å¼ */
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(4px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .image-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .image-modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      cursor: pointer;
    }
    
    .image-modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1;
    }
    
    .image-modal-close {
      position: absolute;
      top: -50px;
      right: 0;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s ease;
      backdrop-filter: blur(8px);
    }
    
    .image-modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    .image-modal img {
      max-width: 100%;
      max-height: calc(90vh - 80px);
      border-radius: 8px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }
    
    .image-modal-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 20px;
    }
    
    .image-modal-nav button {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s ease;
      backdrop-filter: blur(8px);
    }
    
    .image-modal-nav button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    .image-modal-nav button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }
    
    .image-modal-nav button:disabled:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: none;
    }
    
    #prevImageBtn {
      left: -80px;
    }
    
    #nextImageBtn {
      right: -80px;
    }
    
    .image-modal-info {
      position: absolute;
      bottom: -50px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 12px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
    }
    
          @media (max-width: 768px) {
        .container { margin: 0; }
        .toolbar { padding: 16px 20px 12px; }
        h2 { font-size: 24px; margin-bottom: 24px; }
        .section { padding: 20px; margin: 16px; }
        .section-header { flex-direction: column; gap: 12px; align-items: flex-start; }
        .header-actions { width: 100%; justify-content: center; }
        .action-btn { flex: 1; justify-content: center; }
      .list { grid-template-columns: 1fr; gap: 16px; }
      .card { padding: 20px; }
      .card h3 { font-size: 16px; }
      .viewer .header { padding: 12px 16px; flex-direction: column; gap: 12px; align-items: stretch; min-height: auto; }
      .viewer .title { font-size: 16px; -webkit-line-clamp: 1; line-height: 1.2; }
      .title-container { flex-direction: column; align-items: stretch; gap: 8px; }
      .title-edit-container { flex-direction: column; gap: 8px; }
      .title-edit-input { font-size: 16px; }
      .title-edit-save, .title-edit-cancel { width: 100%; height: 36px; }
      .viewer .header > div:last-child { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
      .viewer .header > div:last-child > * { flex: 0 0 auto; font-size: 12px; padding: 6px 8px; }
      .viewer .header select { font-size: 12px; padding: 4px 8px; }
      .viewer .content { padding: 16px; font-size: 15.5px; }
      .viewer .content > .reader { margin: 12px auto; padding: 18px; border-radius: 14px; }
      .cat-tabs { flex-wrap: wrap; gap: 8px; margin: 16px 0; }
      .cat-tabs button { padding: 8px 16px; font-size: 14px; }
      .floating { margin: 8px; max-width: calc(100vw - 16px); }
      .card .icon-btn { opacity: .85; }
      .floating input { min-width: 160px; }
      .highlights-panel { max-width: 90vw; min-width: 240px; }
      .resize-handle { display: none; }
      .hl { margin: 2px 2px; padding: 3px 5px; display: inline-block; }
      .audio-panel { padding: 12px 16px; }
      .audio-controls { gap: 8px; }
      .audio-controls button { padding: 6px 8px; font-size: 12px; }
      .audio-indicator { 
        bottom: 6px; 
        right: 6px; 
        padding: 2px 4px; 
        font-size: 8px; 
        border-radius: 6px; 
      }
      .audio-indicator span { display: none; }
      .audio-indicator svg { width: 10px; height: 10px; }
      .article-images { padding: 16px; margin-bottom: 20px; }
      .images-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
      .image-delete-btn { opacity: 1; width: 20px; height: 20px; font-size: 10px; }
      .image-modal-nav button { width: 40px; height: 40px; font-size: 16px; }
      #prevImageBtn { left: -60px; }
      #nextImageBtn { right: -60px; }
      .image-modal-close { top: -40px; width: 35px; height: 35px; font-size: 16px; }
      .image-modal-info { bottom: -40px; font-size: 12px; }
      .edit-title-btn { opacity: 1; }
      .title-edit-input { font-size: 16px; padding: 6px 10px; }
      .title-edit-save, .title-edit-cancel { width: 28px; height: 28px; font-size: 12px; }
    }
    
    @media (max-width: 480px) {
      .toolbar { padding: 12px 16px; }
      .section { padding: 16px; }
      .card { padding: 16px; }
      .viewer .content { padding: 14px; }
      .viewer .content > .reader { margin: 8px auto; padding: 14px; border-radius: 12px; }
      .floating { padding: 8px 12px; }
      .floating button { padding: 6px 12px; font-size: 12px; }
      .floating input { min-width: 140px; padding: 6px 10px; }
      .hl { margin: 3px 3px; padding: 4px 6px; line-height: 1.4; display: inline-block; }
    }
  </style>
  <!-- è¯æ±‡å‘éŸ³ç®¡ç†å™¨ -->
  <script src="/static/word-pronunciation.js"></script>
</head>
<body>
  <div id="authOverlay" style="position:fixed;z-index:10000;left:0;top:0;width:100vw;height:100vh;background:rgba(240,245,255,0.98);display:flex;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:14px;box-shadow:0 8px 32px 0 rgba(31,38,135,0.15);padding:38px 32px 32px 32px;max-width:90vw;min-width:320px;text-align:center;">
        <h2 style="color:#3b4a6b;margin-bottom:18px;">è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
        <input id="authPassword" type="password" placeholder="Password" style="padding:12px 16px;font-size:17px;border-radius:8px;border:1.5px solid #d1d5db;width:80%;max-width:260px;outline:none;" autofocus onkeydown="if(event.key==='Enter'){checkPassword();}">
        <div id="authError" style="color:#e94e77;margin-top:14px;display:none;font-size:15px;">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚</div>
        <button onclick="checkPassword()" style="margin-top:22px;width:60%;max-width:180px;">è¿›å…¥</button>
    </div>
  </div>
  <div class="container">
    <div class="toolbar" style="justify-content:space-between;">
      <button onclick="location.href='/'" style="background:#0ea5e9;color:#fff;border: none;">è¿”å›æ¨¡å—é€‰æ‹©</button>
    </div>
    <h2>æ–‡ç« ç²¾è¯»</h2>
    

    <div class="section">
      <div class="section-header">
        <label>æˆ‘çš„æ–‡ç« </label>
        <div class="header-actions">
          <button class="action-btn" onclick="location.href='/vocab_summary'">
            <span class="btn-icon">ğŸ“Š</span>
            <span>è¯æ±‡æ±‡æ€»</span>
          </button>
          <button class="action-btn primary" onclick="location.href='/intensive/new'">
            <span class="btn-icon">âœï¸</span>
            <span>æ·»åŠ æ–‡ç« </span>
          </button>
        </div>
      </div>
      <div class="cat-tabs">
        <button id="tab-Reading" class="active" onclick="setActiveCat('Reading')">Reading</button>
        <button id="tab-Listening" onclick="setActiveCat('Listening')">Listening</button>
        <button id="tab-Writing" onclick="setActiveCat('Writing')">Writing</button>
      </div>
      <div id="list" class="list"></div>
      <div id="empty" class="empty" style="display:none;">è¯¥åˆ†ç±»æš‚æ— æ–‡ç« </div>
    </div>

          <div class="viewer" id="viewer">
      <div class="header">
        <div class="title-container">
          <div class="title" id="vTitle">-</div>
          <button id="editTitleBtn" class="edit-title-btn" onclick="startEditTitle()" title="ç¼–è¾‘æ ‡é¢˜">âœï¸</button>
          <div id="titleEditContainer" class="title-edit-container" style="display: none;">
            <input type="text" id="titleEditInput" class="title-edit-input" placeholder="è¾“å…¥æ–°æ ‡é¢˜">
            <button class="title-edit-save" onclick="saveTitleEdit()">âœ“</button>
            <button class="title-edit-cancel" onclick="cancelTitleEdit()">âœ•</button>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;">
          <select id="vCategory" style="padding:6px 12px;border:1px solid #e2e8f0;border-radius:8px;background:#f8fafc;">
            <option value="Reading">Reading</option>
            <option value="Listening">Listening</option>
            <option value="Writing">Writing</option>
          </select>
          <button id="generateAudioBtn" class="vocab-btn" onclick="generateArticleAudio()" title="ç”Ÿæˆè‹±æ–‡éŸ³é¢‘" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #fff; border: none;">
            <span style="margin-right: 4px;">ğŸ”Š</span>éŸ³é¢‘
          </button>
          <button id="resumeAudioBtn" class="vocab-btn" onclick="resumeAudioGeneration()" title="æ¢å¤ä¸­æ–­çš„éŸ³é¢‘ç”Ÿæˆ" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #fff; border: none; display: none;">
            <span style="margin-right: 4px;">ğŸ”„</span>æ¢å¤
          </button>
          <button id="uploadImageBtn" class="vocab-btn" onclick="triggerImageUpload()" title="ä¸Šä¼ å›¾ç‰‡" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #fff; border: none;">
            <span style="margin-right: 4px;">ğŸ“·</span>å›¾ç‰‡
          </button>
          <button id="vocabToggle" class="vocab-btn" onclick="toggleHighlightsPanel()" title="è¯æ±‡é¢æ¿">è¯æ±‡</button>
          <button class="close-btn" onclick="closeViewer()" title="å…³é—­">âœ•</button>
        </div>
      </div>
      <div class="viewer-body">
        <div class="content" id="vContent">
          <!-- å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ -->
          <div id="articleImages" class="article-images" style="display: none;">
            <h4>ğŸ“· æ–‡ç« å›¾ç‰‡</h4>
            <div class="images-grid" id="imagesGrid"></div>
          </div>
        </div>
        <div class="highlights-panel" id="highlightsPanel">
          <div class="resize-handle" id="resizeHandle"></div>
          <div class="hp-header">
            <div class="hp-title">è¯æ±‡</div>
            <div class="hp-search"><input id="hpSearch" type="text" placeholder="æœç´¢å•è¯æˆ–é‡Šä¹‰" oninput="renderHighlightsPanel()"></div>
            <button class="close-btn" onclick="closeHighlightsPanel()" title="å…³é—­">âœ•</button>
          </div>
          <div class="hp-body" id="hpBody"></div>
        </div>
      </div>
      <!-- éŸ³é¢‘æ’­æ”¾æ§åˆ¶é¢æ¿ -->
      <div id="audioPanel" class="audio-panel" style="display: none;">
        <div class="audio-controls">
          <audio id="articleAudio" controls style="flex: 1; margin-right: 12px;">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
          </audio>
          <button id="downloadAudioBtn" class="action-btn" onclick="downloadAudio()" title="ä¸‹è½½éŸ³é¢‘">
            <span class="btn-icon">â¬‡ï¸</span>
            ä¸‹è½½
          </button>
          <button class="action-btn" onclick="closeAudioPanel()" title="å…³é—­éŸ³é¢‘é¢æ¿">
            <span class="btn-icon">âœ•</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="floating" id="floatBox" style="background:#111827cc;backdrop-filter: blur(2px);">
    <button onclick="confirmHighlight()" style="background:#22c55e;padding:6px 10px;border-radius:8px;">Highlight</button>
    <button class="del" onclick="cancelFloat()" style="background:#6b7280;padding:6px 10px;border-radius:8px;">Cancel</button>
    <button class="del" onclick="removeCurrentHighlight()" style="padding:6px 10px;border-radius:8px;">Remove</button>
  </div>
  <div class="floating" id="meaningBox" style="background:#111827cc;backdrop-filter: blur(2px);display:none;">
    <input id="meaningInput" type="text" placeholder="Enter meaning" style="padding:6px 10px;border-radius:8px;border:none;outline:none;min-width:220px;" onkeydown="if(event.key==='Enter'){ event.preventDefault(); saveMeaning(); } else if(event.key==='Escape'){ event.preventDefault(); cancelMeaning(); }">
    <button onclick="saveMeaning()" style="background:#22c55e;padding:6px 10px;border-radius:8px;">Save</button>
    <button onclick="cancelMeaning()" class="del" style="background:#6b7280;padding:6px 10px;border-radius:8px;">Cancel</button>
  </div>

  <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡† -->
  <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">

  <!-- å¤§å›¾æŸ¥çœ‹æ¨¡æ€æ¡† -->
  <div id="imageModal" class="image-modal" style="display: none;">
    <div class="image-modal-overlay" onclick="closeImageModal()"></div>
    <div class="image-modal-content">
      <button class="image-modal-close" onclick="closeImageModal()" title="å…³é—­">âœ•</button>
      <img id="modalImage" src="" alt="å¤§å›¾é¢„è§ˆ">
      <div class="image-modal-nav">
        <button id="prevImageBtn" onclick="showPreviousImage()" title="ä¸Šä¸€å¼ ">â€¹</button>
        <button id="nextImageBtn" onclick="showNextImage()" title="ä¸‹ä¸€å¼ ">â€º</button>
      </div>
      <div class="image-modal-info">
        <span id="imageCounter">1 / 1</span>
        <button id="deleteImageBtn" onclick="deleteCurrentImage()" title="åˆ é™¤å›¾ç‰‡" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; margin-left: 12px;">åˆ é™¤</button>
      </div>
    </div>
  </div>

  <script>
    let currentToken=null; let currentArticle=null; let selectionRange=null; let highlights=[]; let lastSelectionRect=null;
    let currentImages=[]; let currentImageIndex=0;
    function fetchServerPassword(){ return fetch('/get_password').then(r=>r.json()); }
    function checkStoredToken(){ const tk=localStorage.getItem('authToken'); if(!tk) return Promise.resolve(false); return fetch('/verify_token',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({token:tk})}).then(r=>r.json()).then(d=>{ if(d.valid){ currentToken=tk; return true;} localStorage.removeItem('authToken'); return false; }).catch(()=>{ localStorage.removeItem('authToken'); return false; }); }
    function checkPassword(){ const val=document.getElementById('authPassword').value; fetch('/verify_password',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({password:val})}).then(r=>r.json()).then(d=>{ if(d.success){ currentToken=d.token; localStorage.setItem('authToken', d.token); document.getElementById('authOverlay').style.display='none'; document.body.style.overflow=''; loadList(); } else { document.getElementById('authError').style.display=''; document.getElementById('authPassword').value=''; document.getElementById('authPassword').focus(); } }).catch(()=>{ document.getElementById('authError').style.display=''; }); }
    window.onload=function(){ checkStoredToken().then(valid=>{ if(valid){ if(document.getElementById('authOverlay')){ document.getElementById('authOverlay').style.display='none'; document.body.style.overflow=''; } loadList(); checkURLHash(); initResizeHandle(); } else { window.location.href='/login'; } }); }
    function checkURLHash(){ const hash = window.location.hash; if(hash && hash.startsWith('#article-')){ const articleId = hash.replace('#article-', ''); if(articleId){ setTimeout(()=>{ openArticle(articleId); }, 500); } } }

    function createArticle(){ const title=document.getElementById('title').value.trim(); const category=document.getElementById('category').value; const content=document.getElementById('content').value; if(!content.trim()){ showCreateMsg('è¯·ç²˜è´´æ–‡ç« å†…å®¹', true); return; } fetch('/intensive_create',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({title, category, content})}).then(r=>r.json()).then(d=>{ if(d.success){ showCreateMsg('åˆ›å»ºæˆåŠŸ', false); document.getElementById('content').value=''; document.getElementById('title').value=''; loadList(); openArticle(d.id); } else { showCreateMsg(d.error||'åˆ›å»ºå¤±è´¥', true); } }); }
    function showCreateMsg(msg, isErr){ const el=document.getElementById('createMsg'); el.textContent=msg; el.style.color=isErr?'#ef4444':'#6b7280'; setTimeout(()=>{ el.textContent=''; }, 1500); }
    let allItems=[]; let activeCat='Reading';
    function setActiveCat(cat){ activeCat=cat; ['Reading','Listening','Writing'].forEach(c=>{ const el=document.getElementById('tab-'+c); if(el) el.className = (c===activeCat? 'active': ''); }); renderList(); }
    function loadList(){ fetch('/intensive_list').then(r=>r.json()).then(d=>{ allItems = d.items||[]; renderList(); }); }
    function renderList(){ const wrap=document.getElementById('list'); const empty=document.getElementById('empty'); wrap.innerHTML=''; const filtered = (allItems||[]).filter(it=> (it.category||'Reading')===activeCat ); if(!filtered.length){ empty.style.display=''; return; } empty.style.display='none'; filtered.forEach(it=>{ const div=document.createElement('div'); div.className='card'; div.style.cursor='pointer'; 
      
      // åˆ›å»ºåŸºæœ¬å†…å®¹
      const title = escapeHtml(it.title||'æœªå‘½å');
      const highlightCount = it.highlight_count||0;
      const createdTime = (it.created_at||'').slice(0,19).replace('T',' ');
      
      div.innerHTML = `<h3>${title}</h3><div class=\"muted\">é«˜äº®ï¼š${highlightCount}ï½œåˆ›å»ºï¼š${createdTime}</div>`;
      
      // å¼‚æ­¥æ£€æŸ¥éŸ³é¢‘çŠ¶æ€å¹¶æ·»åŠ æŒ‡ç¤ºå™¨
      checkExistingAudio(it.id).then(audioInfo => {
        if (audioInfo.exists) {
          const audioIndicator = document.createElement('div');
          audioIndicator.className = 'audio-indicator';
          audioIndicator.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            </svg>
            <span>éŸ³é¢‘</span>
          `;
          audioIndicator.title = `å·²æœ‰éŸ³é¢‘ (${new Date(audioInfo.created_time).toLocaleString()})`;
          div.appendChild(audioIndicator);
        }
      }).catch(() => {
        // é™é»˜å¤„ç†é”™è¯¯ï¼Œä¸å½±å“åˆ—è¡¨æ˜¾ç¤º
      });
      
      const delBtn=document.createElement('button'); delBtn.className='icon-btn'; delBtn.setAttribute('title','åˆ é™¤'); delBtn.setAttribute('aria-label','åˆ é™¤'); delBtn.textContent='âœ•'; delBtn.onclick=function(e){ e.stopPropagation(); if(!confirm('ç¡®å®šåˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return; fetch('/intensive_delete_article',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id: it.id})}).then(r=>r.json()).then(d=>{ if(d.success){ renderAfterDelete(it.id); } else { alert(d.error||'åˆ é™¤å¤±è´¥'); } }); }; div.onclick=function(){ openArticle(it.id); }; div.appendChild(delBtn); wrap.appendChild(div); }); }
    function renderAfterDelete(id){ allItems = (allItems||[]).filter(x=>x.id!==id); renderList(); if(window.clearArticlePronunciationCache){ window.clearArticlePronunciationCache(id); } }

    function openArticle(id){ fetch(`/intensive_article/${id}`).then(r=>r.json()).then(d=>{ if(!d.success){ alert(d.error||'åŠ è½½å¤±è´¥'); return; } const art=d.article; currentArticle=art; highlights = art.highlights||[]; currentImages = art.images||[]; document.getElementById('vTitle').textContent = `${art.title||'æœªå‘½å'}`; document.getElementById('vCategory').value = art.category||'Reading'; const contentDiv=document.getElementById('vContent'); contentDiv.innerHTML = `<div id="articleImages" class="article-images" style="display: none;"><h4>ğŸ“· æ–‡ç« å›¾ç‰‡</h4><div class="images-grid" id="imagesGrid"></div></div><div class=\"reader\">${art.content_html || ''}</div>`; document.getElementById('viewer').classList.add('active'); loadArticleImages(); bindSelection(contentDiv, art); restoreHighlights(contentDiv, art); closeHighlightsPanel(); checkForJumpHighlight(); 
      
      // æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶çŠ¶æ€å¹¶æ›´æ–°æŒ‰é’®
      checkExistingAudio(id).then(audioInfo => {
        updateAudioButton(audioInfo.exists);
        currentAudioInfo = audioInfo.exists ? audioInfo : null;
        
        // å¦‚æœæœ‰ç°æœ‰éŸ³é¢‘ï¼Œè‡ªåŠ¨æ˜¾ç¤ºæ’­æ”¾å™¨
        if (audioInfo.exists) {
          showAudioPlayer(audioInfo.audio_url, audioInfo.filename, true);
          currentAudioUrl = audioInfo.audio_url;
          console.log(`è‡ªåŠ¨åŠ è½½å·²å­˜åœ¨çš„éŸ³é¢‘: ${audioInfo.filename} (${new Date(audioInfo.created_time).toLocaleString()})`);
        } else {
          // å¦‚æœæ²¡æœ‰å®Œæˆçš„éŸ³é¢‘ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡
          checkForUnfinishedAudioTasks();
        }
      }).catch(error => {
        console.error('æ£€æŸ¥éŸ³é¢‘çŠ¶æ€å¤±è´¥:', error);
        updateAudioButton(false);
        // å³ä½¿æ£€æŸ¥å¤±è´¥ï¼Œä¹Ÿå°è¯•æŸ¥æ‰¾æœªå®Œæˆä»»åŠ¡
        checkForUnfinishedAudioTasks();
      });
    }); }
    function checkForJumpHighlight(){ const targetHighlightId = sessionStorage.getItem('jumpToHighlight'); if(targetHighlightId){ sessionStorage.removeItem('jumpToHighlight'); setTimeout(()=>{ scrollToHighlight(targetHighlightId); }, 300); } }
    function renderHighlightsPanel(){ const searchVal=(document.getElementById('hpSearch').value||'').toLowerCase(); const body=document.getElementById('hpBody'); body.innerHTML=''; let list=(highlights||[]).slice().sort((a,b)=>a.start-b.start); if(searchVal){ list=list.filter(h=>{ const word=(h.text || (currentArticle.content_text||'').substring(h.start, h.end)).toLowerCase(); const meaning=(h.meaning||'').toLowerCase(); return word.includes(searchVal) || meaning.includes(searchVal); }); } if(!list.length){ body.innerHTML=`<div class="muted" style="padding:8px 4px;">${searchVal?'æœªæ‰¾åˆ°åŒ¹é…è¯æ±‡':'æš‚æ— è¯æ±‡'}</div>`; return; } list.forEach(h=>{ const item=document.createElement('div'); item.className='hp-item'; item.style.cursor='pointer'; const word=document.createElement('div'); word.className='hp-word'; word.textContent= h.text || (currentArticle.content_text||'').substring(h.start, h.end); const mean=document.createElement('div'); mean.className='hp-meaning'; mean.textContent= h.meaning || ''; const actions=document.createElement('div'); actions.className='hp-actions'; actions.style.cssText='display:flex;gap:4px;align-items:center;margin-left:auto;'; const playBtn=document.createElement('button'); playBtn.style.cssText='padding:4px 6px;border:none;background:#f3f4f6;color:#6b7280;border-radius:4px;cursor:pointer;font-size:12px;'; playBtn.textContent='ğŸ”Š'; playBtn.title='æ’­æ”¾å‘éŸ³'; playBtn.onclick=function(e){ e.stopPropagation(); const wordText = h.text || (currentArticle.content_text||'').substring(h.start, h.end); if(wordText && window.playWordPronunciation){ window.playWordPronunciation(wordText.trim(), currentArticle?.id); } }; const jumpBtn=document.createElement('button'); jumpBtn.style.cssText='padding:4px 6px;border:none;background:#f3f4f6;color:#6b7280;border-radius:4px;cursor:pointer;font-size:11px;'; jumpBtn.textContent='â†—'; jumpBtn.title='è·³è½¬åˆ°åŸæ–‡'; jumpBtn.onclick=function(e){ e.stopPropagation(); scrollToHighlight(h.id); }; actions.appendChild(playBtn); actions.appendChild(jumpBtn); item.appendChild(word); item.appendChild(mean); item.appendChild(actions); item.onclick=function(){ const wordText = h.text || (currentArticle.content_text||'').substring(h.start, h.end); if(wordText && window.playWordPronunciation){ window.playWordPronunciation(wordText.trim(), currentArticle?.id); } }; body.appendChild(item); }); }
    let panelWidth = 320; // é»˜è®¤å®½åº¦
    function toggleHighlightsPanel(){ const panel=document.getElementById('highlightsPanel'); const content=document.getElementById('vContent'); const btn=document.getElementById('vocabToggle'); const isOpen=panel.classList.contains('active'); if(isOpen){ panel.classList.remove('active'); content.classList.remove('panel-open'); btn.classList.remove('active'); } else { renderHighlightsPanel(); panel.classList.add('active'); content.classList.add('panel-open'); btn.classList.add('active'); updatePanelWidth(); } }
    function closeHighlightsPanel(){ const panel=document.getElementById('highlightsPanel'); const content=document.getElementById('vContent'); const btn=document.getElementById('vocabToggle'); panel.classList.remove('active'); content.classList.remove('panel-open'); btn.classList.remove('active'); }
    function updatePanelWidth(){ const panel=document.getElementById('highlightsPanel'); const content=document.getElementById('vContent'); if(panel && content){ panel.style.width = panelWidth + 'px'; content.style.setProperty('--panel-width', panelWidth + 'px'); } }
    function scrollToHighlight(hid){ try{ const container=document.getElementById('vContent'); const mark=container.querySelector(`mark.hl[data-hid="${hid}"]`); if(mark){ mark.scrollIntoView({behavior:'smooth', block:'center'}); mark.classList.add('active'); setTimeout(()=>{ mark.classList.remove('active'); }, 1200); } }catch(e){} }
    function closeViewer(){ document.getElementById('viewer').classList.remove('active'); currentArticle=null; selectionRange=null; highlights=[]; cancelFloat(); cancelMeaning(); closeHighlightsPanel(); closeAudioPanel(); currentAudioInfo=null; updateAudioButton(false); document.getElementById('resumeAudioBtn').style.display = 'none'; }

    // æ‹–æ‹½è°ƒæ•´ä¾§è¾¹æ å®½åº¦
    function initResizeHandle(){ 
      const resizeHandle = document.getElementById('resizeHandle'); 
      const panel = document.getElementById('highlightsPanel'); 
      let isResizing = false; 
      let startX = 0; 
      let startWidth = 0;
      
      resizeHandle.addEventListener('mousedown', function(e) { 
        if(window.innerWidth <= 768) return; // ç§»åŠ¨ç«¯ç¦ç”¨
        isResizing = true; 
        startX = e.clientX; 
        startWidth = panelWidth; 
        resizeHandle.classList.add('dragging');
        document.body.style.cursor = 'col-resize'; 
        document.body.style.userSelect = 'none'; 
        e.preventDefault(); 
      }); 
      
      document.addEventListener('mousemove', function(e) { 
        if (!isResizing) return; 
        const diff = startX - e.clientX; 
        const newWidth = Math.max(280, Math.min(window.innerWidth * 0.6, startWidth + diff)); 
        panelWidth = newWidth; 
        updatePanelWidth(); 
      }); 
      
      document.addEventListener('mouseup', function() { 
        if (isResizing) { 
          isResizing = false; 
          resizeHandle.classList.remove('dragging');
          document.body.style.cursor = ''; 
          document.body.style.userSelect = ''; 
          // ä¿å­˜å®½åº¦åˆ°localStorage
          localStorage.setItem('panelWidth', panelWidth);
        } 
      }); 
      
      // æ¢å¤ä¿å­˜çš„å®½åº¦
      const savedWidth = localStorage.getItem('panelWidth');
      if(savedWidth) {
        panelWidth = Math.max(280, Math.min(window.innerWidth * 0.6, parseInt(savedWidth)));
      }
      
      // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´é¢æ¿å®½åº¦
      window.addEventListener('resize', function() {
        if (panelWidth > window.innerWidth * 0.6) {
          panelWidth = Math.max(280, window.innerWidth * 0.6);
          updatePanelWidth();
        }
      });
    }

    // æ–‡æœ¬é€‰æ‹©ä¸æ‚¬æµ®æ“ä½œ
    function bindSelection(container, art){ container.addEventListener('mouseup', function(e){ const sel=window.getSelection(); if(!sel || sel.isCollapsed){ cancelFloat(); return; } const range=sel.getRangeAt(0); if(!container.contains(range.commonAncestorContainer)){ cancelFloat(); return; } const text=sel.toString().trim(); if(!text){ cancelFloat(); return; }
        
        // æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†å·²ç»é«˜äº®çš„è¯æ±‡
        const existingMark = findHighlightMarkInSelection(range);
        if(existingMark){
          // å¦‚æœé€‰ä¸­äº†å·²é«˜äº®çš„è¯æ±‡ï¼Œæ˜¾ç¤ºç§»é™¤é€‰é¡¹
          selectionRange = { existingHighlight: existingMark.getAttribute('data-hid'), text };
          lastSelectionRect = range.getBoundingClientRect();
          showFloatAtRect(lastSelectionRect, true);
          return;
        }

        // é™åˆ¶åªèƒ½åœ¨åŒä¸€æ®µè½å†…é«˜äº®ï¼Œé¿å…è·¨å—åŒ…è£¹å¯¼è‡´é”™è¯¯
        const sP = closestBlock(range.startContainer, 'p'); const eP = closestBlock(range.endContainer, 'p');
        if(sP !== eP){ showTempTooltip('è¯·åœ¨åŒä¸€æ®µå†…è¿›è¡Œé«˜äº®', range.getBoundingClientRect()); cancelFloat(); return; }
        
        const off = getOffsetsFromRange(container, range);
        if(!off){ cancelFloat(); return; }
        const containerText = getContainerText(container);
        const startOrig = containerToOriginalIndex(off.start, art.content_text||'', containerText);
        const endOrig = containerToOriginalIndex(off.end, art.content_text||'', containerText);
        if(startOrig==null || endOrig==null || endOrig<=startOrig){ cancelFloat(); return; }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤è¯æ±‡
        const isDuplicate = (highlights||[]).some(h => h.text && h.text.toLowerCase() === text.toLowerCase());
        
        selectionRange = { start: startOrig, end: endOrig, text, isDuplicate };
        lastSelectionRect = range.getBoundingClientRect();
        showFloatAtRect(lastSelectionRect, false, isDuplicate);
    }); }

    function showFloatAtRect(rect, isExisting = false, isDuplicate = false){ 
      const box=document.getElementById('floatBox'); 
      const highlightBtn = box.querySelector('button[onclick="confirmHighlight()"]');
      const removeBtn = box.querySelector('button[onclick="removeCurrentHighlight()"]');
      
      if(isExisting){
        highlightBtn.style.display='none';
        removeBtn.style.display='inline-block';
      } else {
        highlightBtn.style.display='inline-block';
        removeBtn.style.display='none';
        
        // å¦‚æœæ˜¯é‡å¤è¯æ±‡ï¼Œç¦ç”¨é«˜äº®æŒ‰é’®å¹¶æ˜¾ç¤ºæç¤º
        if(isDuplicate){
          highlightBtn.disabled = true;
          highlightBtn.style.opacity = '0.5';
          highlightBtn.style.cursor = 'not-allowed';
          highlightBtn.title = 'æ­¤è¯æ±‡å·²å­˜åœ¨é«˜äº®';
        } else {
          highlightBtn.disabled = false;
          highlightBtn.style.opacity = '1';
          highlightBtn.style.cursor = 'pointer';
          highlightBtn.title = '';
        }
      }
      
      positionBoxAtRect(box, rect); 
      box.style.display='block'; 
    }
    function positionBoxAtRect(el, rect){ const x = window.scrollX + rect.left + rect.width/2; const y = window.scrollY + rect.top; const r = el.getBoundingClientRect(); el.style.left = Math.max(8, x - r.width/2) + 'px'; el.style.top = Math.max(8, y - 48) + 'px'; }
    
    // æŸ¥æ‰¾é€‰åŒºä¸­æ˜¯å¦åŒ…å«é«˜äº®æ ‡è®°
    function findHighlightMarkInSelection(range){
      try{
        const container = range.commonAncestorContainer;
        if(container.nodeType === Node.TEXT_NODE){
          let parent = container.parentNode;
          while(parent && parent.tagName !== 'MARK'){
            parent = parent.parentNode;
          }
          return parent && parent.classList.contains('hl') ? parent : null;
        } else {
          const marks = container.querySelectorAll ? container.querySelectorAll('mark.hl') : [];
          for(let mark of marks){
            if(range.intersectsNode && range.intersectsNode(mark)){
              return mark;
            }
          }
        }
      }catch(e){}
      return null;
    }
    
    // æ˜¾ç¤ºä¸´æ—¶æç¤º
    function showTempTooltip(message, rect){
      const tooltip = document.createElement('div');
      tooltip.className = 'temp-tooltip';
      tooltip.textContent = message;
      tooltip.style.cssText = `
        position: fixed;
        background: rgba(239, 68, 68, 0.95);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 13px;
        z-index: 4000;
        pointer-events: none;
        animation: temp-tooltip-fade 2s ease-out forwards;
      `;
      
      const x = window.scrollX + rect.left + rect.width/2;
      const y = window.scrollY + rect.top;
      tooltip.style.left = Math.max(8, x - 80) + 'px';
      tooltip.style.top = Math.max(8, y - 40) + 'px';
      
      document.body.appendChild(tooltip);
      setTimeout(() => {
        if(tooltip.parentNode) tooltip.parentNode.removeChild(tooltip);
      }, 2000);
    }
    function cancelFloat(){ 
      const box=document.getElementById('floatBox'); 
      const highlightBtn = box.querySelector('button[onclick="confirmHighlight()"]');
      
      // é‡ç½®æŒ‰é’®çŠ¶æ€
      highlightBtn.disabled = false;
      highlightBtn.style.opacity = '1';
      highlightBtn.style.cursor = 'pointer';
      highlightBtn.title = '';
      
      box.style.display='none'; 
      selectionRange=null; 
      window.getSelection().removeAllRanges(); 
    }
    function confirmHighlight(){ 
      if(!currentArticle||!selectionRange){ 
        cancelFloat(); 
        return; 
      } 
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤è¯æ±‡
      if(selectionRange.isDuplicate){
        return; // é‡å¤è¯æ±‡ä¸å…è®¸é«˜äº®
      }
      
      const mBox=document.getElementById('meaningBox'); 
      const mInput=document.getElementById('meaningInput'); 
      mInput.value=''; 
      if(lastSelectionRect){ 
        positionBoxAtRect(mBox, lastSelectionRect); 
      } 
      mBox.style.display='block'; 
    }
    function cancelMeaning(){ document.getElementById('meaningBox').style.display='none'; window.getSelection().removeAllRanges(); }
    function saveMeaning(){ const meaning=document.getElementById('meaningInput').value.trim(); if(!meaning){ alert('Meaning required'); return; } const selTxt=(selectionRange&&selectionRange.text)?selectionRange.text:''; const body={ id: currentArticle.id, start: selectionRange.start, end: selectionRange.end, meaning, text: selTxt }; fetch('/intensive_add_highlight',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)}).then(r=>r.json()).then(d=>{ if(d.success){ const list=document.getElementById('vContent'); // é˜²é‡å¤ï¼šå…ˆæ¸…ç†å¹¶é‡ç»˜
        restoreHighlights(list, {highlights: (function(){ const idx = (highlights||[]).findIndex(h=>h.id===d.highlight.id); if(idx>=0){ highlights[idx]=d.highlight; } else { // è‹¥å­˜åœ¨ç›¸åŒèŒƒå›´ï¼Œæ›¿æ¢
            const sameIdx=(highlights||[]).findIndex(h=>h.start===d.highlight.start && h.end===d.highlight.end);
            if(sameIdx>=0) highlights[sameIdx]=d.highlight; else highlights.push(d.highlight);
        } return highlights; })(), content_text: currentArticle.content_text}); cancelFloat(); cancelMeaning(); } else { alert(d.error||'ä¿å­˜å¤±è´¥'); } }); }

    // åˆ†ç±»ä¿®æ”¹
    document.addEventListener('change', function(e){ if(e.target && e.target.id==='vCategory' && currentArticle){ const newCat=e.target.value; fetch('/intensive_update_category',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id: currentArticle.id, category: newCat})}).then(r=>r.json()).then(d=>{ if(!d.success){ alert(d.error||'ä¿å­˜å¤±è´¥'); e.target.value=currentArticle.category||'Reading'; } else { currentArticle.category=newCat; } }); } });

    // ç§»é™¤ç°æœ‰é«˜äº®
    function removeCurrentHighlight(){ 
      if(!currentArticle) return; 
      
      let hid = null;
      
      // å¦‚æœé€šè¿‡é€‰æ‹©èŒƒå›´ä¼ å…¥äº†é«˜äº®ID
      if(selectionRange && selectionRange.existingHighlight){
        hid = selectionRange.existingHighlight;
      } else {
        // æŸ¥æ‰¾é€‰åŒºæ˜¯å¦ä½äºæŸä¸ª mark.hl å†…
        const sel=window.getSelection(); 
        if(!sel || sel.rangeCount===0) return; 
        const node = sel.anchorNode; 
        const mark = node ? (node.nodeType===1? node : node.parentNode).closest && (node.nodeType===1? node : node.parentNode).closest('mark.hl') : null; 
        if(!mark) return; 
        hid = mark.getAttribute('data-hid');
      }
      
      if(!hid) return; 
      deleteHighlight(hid); 
      cancelFloat(); 
      cancelMeaning(); 
    }

    // æ»šåŠ¨/çª—å£å˜åŒ–æ—¶ä¿æŒæµ®åŠ¨æ¡†è·Ÿéšé€‰åŒº
    function repositionFloating(){ if(!selectionRange || !currentArticle || (!isVisible('floatBox') && !isVisible('meaningBox'))) return; const rect = computeRectFromSelectionRange(); if(!rect) return; lastSelectionRect = rect; if(isVisible('floatBox')) positionBoxAtRect(document.getElementById('floatBox'), rect); if(isVisible('meaningBox')) positionBoxAtRect(document.getElementById('meaningBox'), rect); }
    function isVisible(id){ const el=document.getElementById(id); return el && el.style.display!== 'none'; }
    function computeRectFromSelectionRange(){ try{ const container=document.getElementById('vContent'); if(!container) return null; const containerText=getContainerText(container); const startC=originalToContainerIndex(selectionRange.start, currentArticle.content_text||'', containerText); const endC=originalToContainerIndex(selectionRange.end, currentArticle.content_text||'', containerText); if(startC==null||endC==null||endC<=startC) return null; // å»ºç«‹ä¸´æ—¶rangeå–rect
      const walker=createWalker(container); let n,pos=0,sN=null,sO=0,eN=null,eO=0; while(n=walker.nextNode()){ const next=pos+n.nodeValue.length; if(sN===null && startC>=pos && startC<=next){ sN=n; sO=startC-pos; } if(eN===null && endC>=pos && endC<=next){ eN=n; eO=endC-pos; break; } pos=next; } if(!sN||!eN) return null; const r=document.createRange(); r.setStart(sN,sO); r.setEnd(eN,eO); return r.getBoundingClientRect(); }catch(e){ return null; } }
    window.addEventListener('scroll', function(){ repositionFloating(); }, true);
    window.addEventListener('resize', function(){ repositionFloating(); });
    
    // å…¨å±€ ESC é”®ç›‘å¬
    document.addEventListener('keydown', function(e){ 
      if(e.key === 'Escape'){ 
        if(isVisible('meaningBox')){ 
          cancelMeaning(); 
        } else if(isVisible('floatBox')){ 
          cancelFloat(); 
        }
      }
    });

    function restoreHighlights(container, art){ // å»é‡å¹¶æ¸…ç†å·²å­˜åœ¨çš„ mark
      container.querySelectorAll('mark.hl').forEach(function(n){ const p=n.parentNode; if(!p) return; while(n.firstChild) p.insertBefore(n.firstChild, n); p.removeChild(n); p.normalize(); });
      const uniq=[]; (art.highlights||[]).forEach(function(h){ const key=h.start+'-'+h.end; if(!uniq.some(x=>x.start===h.start&&x.end===h.end)){ uniq.push(h); } });
      uniq.sort((a,b)=>a.start-b.start).forEach(h=>{ applyOneHighlight(container, h, art.content_text); }); }
    function applyOneHighlight(container, h, originalText){ try{ const containerText = getContainerText(container); const startC = originalToContainerIndex(h.start, originalText||'', containerText); const endC = originalToContainerIndex(h.end, originalText||'', containerText); if(startC==null || endC==null || endC<=startC) return; // å·²å­˜åœ¨åˆ™è·³è¿‡
      if(container.querySelector(`mark.hl[data-hid="${h.id}"]`)) return; wrapContainerOffsets(container, startC, endC, h); }catch(e){} }
    function deleteHighlight(hid){ if(!currentArticle) return; fetch('/intensive_delete_highlight',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id: currentArticle.id, highlight_id: hid})}).then(r=>r.json()).then(d=>{ if(d.success){ // é‡æ–°åŠ è½½æ–‡ç« ä»¥åˆ·æ–° DOM
          openArticle(currentArticle.id);
        } else { alert(d.error||'åˆ é™¤å¤±è´¥'); } }); }

    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
    function getContainerText(container){ const walker=createWalker(container); let t='', n; while(n=walker.nextNode()){ t+=n.nodeValue; } return t; }
    function getOffsetsFromRange(container, range){ try{ const walker=createWalker(container); let pos=0, n; let sN=range.startContainer, eN=range.endContainer; let sO=range.startOffset, eO=range.endOffset; let start=-1,end=-1; while(n=walker.nextNode()){ if(n===sN){ start = pos + sO; } if(n===eN){ end = pos + eO; break; } pos += n.nodeValue.length; } if(start>=0 && end>start) return {start,end}; }catch(e){} return null; }
    function wrapContainerOffsets(container, start, end, meta){ const walker=createWalker(container); let n, pos=0; let sN=null,sO=0,eN=null,eO=0; while(n=walker.nextNode()){ const next=pos + n.nodeValue.length; if(sN===null && start>=pos && start<=next){ sN=n; sO=start-pos; } if(eN===null && end>=pos && end<=next){ eN=n; eO=end-pos; break; } pos=next; } if(!sN||!eN) return; const r=document.createRange(); r.setStart(sN, sO); r.setEnd(eN, eO); const mark=document.createElement('mark'); mark.className='hl'; mark.setAttribute('data-hid', meta.id); mark.style.cursor='pointer'; const tip=document.createElement('span'); tip.className='tooltip'; tip.textContent=meta.meaning||''; r.surroundContents(mark); mark.appendChild(tip); mark.addEventListener('contextmenu', function(ev){ ev.preventDefault(); if(confirm('åˆ é™¤è¯¥é«˜äº®/ç¬”è®°ï¼Ÿ')){ deleteHighlight(meta.id); } }); mark.addEventListener('click', function(ev){ ev.preventDefault(); ev.stopPropagation(); const word = meta.text || mark.textContent.replace(tip.textContent, '').trim(); if(word && window.playWordPronunciation){ window.playWordPronunciation(word, currentArticle?.id); } }); }
    function createWalker(container){ return document.createTreeWalker(container, NodeFilter.SHOW_TEXT, { acceptNode: function(node){ let p=node.parentNode; while(p){ if(p.nodeType===1 && p.classList && p.classList.contains('tooltip')) return NodeFilter.FILTER_REJECT; p=p.parentNode; } return NodeFilter.FILTER_ACCEPT; } }); }
    function closestBlock(node, selector){ let el = node.nodeType===1 ? node : node.parentNode; if(!el) return null; if(el.closest) return el.closest(selector); while(el){ if(el.matches && el.matches(selector)) return el; el = el.parentNode; } return null; }
    // éŸ³é¢‘ç”Ÿæˆç›¸å…³åŠŸèƒ½
    let currentAudioUrl = null;
    let currentAudioInfo = null;
    
    function extractEnglishText(text) {
      if (!text) return '';
      
      // ç§»é™¤HTMLæ ‡ç­¾
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = text;
      const plainText = tempDiv.textContent || tempDiv.innerText || '';
      
      // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–è‹±æ–‡å†…å®¹ï¼ˆåŒ…æ‹¬æ ‡ç‚¹ç¬¦å·ã€æ•°å­—ï¼‰
      // æ’é™¤ä¸­æ–‡å­—ç¬¦ï¼ˆUnicodeèŒƒå›´ \u4e00-\u9fffï¼‰å’Œä¸­æ–‡æ ‡ç‚¹ç¬¦å·
      const englishParts = plainText.match(/[^\u4e00-\u9fff\uFF00-\uFFEF\u3000-\u303F]+/g);
      
      if (!englishParts) return '';
      
      // æ¸…ç†å’Œè¿æ¥è‹±æ–‡éƒ¨åˆ†ï¼Œç§»é™¤åªåŒ…å«æ ‡ç‚¹ç¬¦å·çš„éƒ¨åˆ†
      return englishParts
        .map(part => part.trim())
        .filter(part => part.length > 0 && /[a-zA-Z0-9]/.test(part)) // å¿…é¡»åŒ…å«å­—æ¯æˆ–æ•°å­—
        .join(' ')
        .replace(/\s+/g, ' ')
        .trim();
    }
    
    function checkExistingAudio(articleId) {
      return fetch(`/check_article_audio/${articleId}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            throw new Error(data.error);
          }
          return data;
        });
    }
    
    function updateAudioButton(audioExists = false) {
      const btn = document.getElementById('generateAudioBtn');
      if (audioExists) {
        btn.innerHTML = '<span style="margin-right: 4px;">ğŸ”„</span>é‡æ–°ç”Ÿæˆ';
        btn.title = 'é‡æ–°ç”Ÿæˆè‹±æ–‡éŸ³é¢‘';
      } else {
        btn.innerHTML = '<span style="margin-right: 4px;">ğŸ”Š</span>éŸ³é¢‘';
        btn.title = 'ç”Ÿæˆè‹±æ–‡éŸ³é¢‘';
      }
    }
    
    function generateArticleAudio() {
      if (!currentArticle) {
        alert('è¯·å…ˆæ‰“å¼€ä¸€ç¯‡æ–‡ç« ');
        return;
      }
      
      // å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨éŸ³é¢‘æ–‡ä»¶
      checkExistingAudio(currentArticle.id)
        .then(audioInfo => {
          if (audioInfo.exists) {
            // å¦‚æœéŸ³é¢‘å·²å­˜åœ¨ï¼Œæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            const confirmMessage = `æ­¤æ–‡ç« å·²æœ‰éŸ³é¢‘æ–‡ä»¶ï¼ˆç”Ÿæˆæ—¶é—´ï¼š${new Date(audioInfo.created_time).toLocaleString()}ï¼‰ã€‚\n\næ˜¯å¦è¦é‡æ–°ç”ŸæˆéŸ³é¢‘ï¼Ÿè¿™å°†è¦†ç›–åŸæœ‰æ–‡ä»¶ã€‚`;
            
            if (!confirm(confirmMessage)) {
              // ç”¨æˆ·é€‰æ‹©ä¸é‡æ–°ç”Ÿæˆï¼Œç›´æ¥æ’­æ”¾ç°æœ‰éŸ³é¢‘
              showAudioPlayer(audioInfo.audio_url, audioInfo.filename, true);
              currentAudioUrl = audioInfo.audio_url;
              currentAudioInfo = audioInfo;
              return;
            }
            
            // ç”¨æˆ·ç¡®è®¤é‡æ–°ç”Ÿæˆï¼Œå…ˆæ¸…ç†å·²å­˜åœ¨çš„éŸ³é¢‘æ–‡ä»¶
            cleanupExistingAudio().then(() => {
              // æ¸…ç†å®Œæˆåç»§ç»­ç”Ÿæˆ
              proceedWithAudioGeneration();
            }).catch(error => {
              console.error('æ¸…ç†éŸ³é¢‘æ–‡ä»¶å¤±è´¥:', error);
              // å³ä½¿æ¸…ç†å¤±è´¥ä¹Ÿç»§ç»­ç”Ÿæˆï¼Œè®©ç”¨æˆ·çŸ¥é“
              alert('æ¸…ç†æ—§éŸ³é¢‘æ–‡ä»¶æ—¶å‡ºç°é—®é¢˜ï¼Œä½†å°†ç»§ç»­ç”Ÿæˆæ–°éŸ³é¢‘');
              proceedWithAudioGeneration();
            });
          } else {
            // æ²¡æœ‰å·²å­˜åœ¨éŸ³é¢‘ï¼Œç›´æ¥ç”Ÿæˆ
            proceedWithAudioGeneration();
          }
        })
        .catch(error => {
          console.error('æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶é”™è¯¯:', error);
          // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œç›´æ¥å°è¯•ç”Ÿæˆ
          proceedWithAudioGeneration();
        });
    }
    
    function cleanupExistingAudio() {
      if (!currentArticle) {
        return Promise.resolve();
      }
      
      console.log('å¼€å§‹æ¸…ç†å·²å­˜åœ¨çš„éŸ³é¢‘æ–‡ä»¶å’Œä¸´æ—¶æ–‡ä»¶...');
      
      return fetch('/cleanup_article_audio', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          article_id: currentArticle.id
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('éŸ³é¢‘æ¸…ç†å®Œæˆ:', data.message);
          if (data.cleaned_files.length > 0 || data.cleaned_dirs.length > 0) {
            console.log('å·²åˆ é™¤æ–‡ä»¶:', data.cleaned_files);
            console.log('å·²åˆ é™¤ç›®å½•:', data.cleaned_dirs);
          }
          
          // å…³é—­å½“å‰çš„éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          closeAudioPanel();
          
          // é‡ç½®ç›¸å…³çŠ¶æ€
          currentAudioUrl = null;
          currentAudioInfo = null;
          
          return data;
        } else {
          throw new Error(data.error || 'æ¸…ç†å¤±è´¥');
        }
      });
    }
    
    function proceedWithAudioGeneration() {
      const btn = document.getElementById('generateAudioBtn');
      const originalContent = btn.innerHTML;
      
      // æå–è‹±æ–‡æ–‡æœ¬
      const englishText = extractEnglishText(currentArticle.content_text);
      
      if (!englishText || englishText.trim().length === 0) {
        alert('æœªæ‰¾åˆ°è‹±æ–‡å†…å®¹å¯ç”ŸæˆéŸ³é¢‘');
        return;
      }
      
      // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      btn.disabled = true;
      btn.innerHTML = '<span style="margin-right: 4px;">â³</span>å‡†å¤‡ä¸­...';
      btn.style.opacity = '0.7';
      btn.style.cursor = 'not-allowed';
      
      // æ ¹æ®æ–‡æœ¬é•¿åº¦å†³å®šä½¿ç”¨å“ªç§å¤„ç†æ–¹å¼ï¼ˆé™ä½é˜ˆå€¼ï¼Œå¢åŠ 40%å†—ä½™ï¼‰
      if (englishText.length <= 2200) {
        // çŸ­æ–‡æœ¬ï¼Œä½¿ç”¨åŸæœ‰çš„ç›´æ¥ç”Ÿæˆæ–¹å¼
        generateAudioDirect(englishText, btn, originalContent);
      } else {
        // é•¿æ–‡æœ¬ï¼Œä½¿ç”¨åˆ†æ‰¹å¤„ç†æ–¹å¼ï¼ˆå¢åŠ 40%å†—ä½™åˆ†æ®µï¼‰
        generateAudioBatch(englishText, btn, originalContent);
      }
    }
    
    function generateAudioDirect(englishText, btn, originalContent) {
      btn.innerHTML = '<span style="margin-right: 4px;">â³</span>ç”Ÿæˆä¸­...';
      
      // è°ƒç”¨åŸæœ‰çš„API
      fetch('/generate_article_audio', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          article_id: currentArticle.id,
          text: englishText
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showAudioPlayer(data.audio_url, data.filename);
          currentAudioUrl = data.audio_url;
          updateAudioButton(true);
        } else {
          alert(data.error || 'éŸ³é¢‘ç”Ÿæˆå¤±è´¥');
        }
      })
      .catch(error => {
        console.error('éŸ³é¢‘ç”Ÿæˆé”™è¯¯:', error);
        alert('éŸ³é¢‘ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      })
      .finally(() => {
        resetAudioButton(btn, originalContent);
      });
    }
    
    function generateAudioBatch(englishText, btn, originalContent) {
      // ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡åˆ†æ‰¹å¤„ç†
      fetch('/prepare_article_audio', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          article_id: currentArticle.id,
          text: englishText
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const { task_id, segments_count, segments_info } = data;
          console.log(`æ–‡æœ¬å°†åˆ†ä¸º ${segments_count} æ®µè¿›è¡Œå¤„ç†:`, segments_info);
          
          // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºåˆ†æ®µä¿¡æ¯
          btn.innerHTML = `<span style="margin-right: 4px;">â³</span>ç”Ÿæˆä¸­... (0/${segments_count})`;
          
          // å¼€å§‹åˆ†æ®µç”Ÿæˆ
          generateSegmentsSequentially(task_id, segments_info, englishText, btn, originalContent);
        } else {
          alert(data.error || 'å‡†å¤‡å¤±è´¥');
          resetAudioButton(btn, originalContent);
        }
      })
      .catch(error => {
        console.error('å‡†å¤‡é”™è¯¯:', error);
        alert('å‡†å¤‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        resetAudioButton(btn, originalContent);
      });
    }
    
    async function generateSegmentsSequentially(taskId, segmentsInfo, originalText, btn, originalContent) {
      const totalSegments = segmentsInfo.length;
      let completedSegments = 0;
      
      try {
        // é‡æ–°åˆ†å‰²æ–‡æœ¬ä»¥è·å–å®é™…çš„åˆ†æ®µå†…å®¹
        const segments = await getSegmentTexts(originalText, totalSegments);
        
        // é¦–å…ˆæ£€æŸ¥å·²å­˜åœ¨çš„åˆ†ç‰‡çŠ¶æ€
        btn.innerHTML = `<span style="margin-right: 4px;">â³</span>æ£€æŸ¥å·²å­˜åœ¨åˆ†ç‰‡...`;
        const statusResult = await checkSegmentStatus(taskId, totalSegments);
        
        if (statusResult.success) {
          completedSegments = statusResult.completed_segments.length;
          const missingSegments = statusResult.missing_segments;
          
          if (completedSegments > 0) {
            console.log(`å‘ç° ${completedSegments} ä¸ªå·²å®Œæˆçš„åˆ†ç‰‡ï¼Œå°†è·³è¿‡è¿™äº›åˆ†ç‰‡`);
            btn.innerHTML = `<span style="margin-right: 4px;">â³</span>å‘ç° ${completedSegments} ä¸ªå·²å®Œæˆåˆ†ç‰‡...`;
            await new Promise(resolve => setTimeout(resolve, 1000)); // æ˜¾ç¤ºçŠ¶æ€1ç§’
          }
          
          // åªç”Ÿæˆç¼ºå¤±çš„åˆ†æ®µ
          for (const segmentIndex of missingSegments) {
            btn.innerHTML = `<span style="margin-right: 4px;">â³</span>ç”Ÿæˆç¬¬${segmentIndex+1}æ®µ... (${completedSegments}/${totalSegments})`;
            
            const success = await generateSingleSegmentWithRetry(
              taskId, 
              segmentIndex, 
              segments[segmentIndex], 
              3 // æœ€å¤§é‡è¯•æ¬¡æ•°
            );
            
            if (!success) {
              throw new Error(`ç¬¬${segmentIndex+1}æ®µç”Ÿæˆå¤±è´¥ï¼Œå·²é‡è¯•å¤šæ¬¡`);
            }
            
            completedSegments++;
            btn.innerHTML = `<span style="margin-right: 4px;">â³</span>å·²å®Œæˆ ${completedSegments}/${totalSegments} æ®µ`;
            
            console.log(`ç¬¬${segmentIndex+1}æ®µç”Ÿæˆå®Œæˆ (${segments[segmentIndex].length}å­—ç¬¦)`);
          }
        } else {
          // å¦‚æœçŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼ŒæŒ‰åŸé€»è¾‘é€ä¸ªç”Ÿæˆ
          for (let i = 0; i < segments.length; i++) {
            btn.innerHTML = `<span style="margin-right: 4px;">â³</span>ç”Ÿæˆç¬¬${i+1}æ®µ... (${completedSegments}/${totalSegments})`;
            
            const success = await generateSingleSegmentWithRetry(
              taskId, 
              i, 
              segments[i], 
              3 // æœ€å¤§é‡è¯•æ¬¡æ•°
            );
            
            if (!success) {
              throw new Error(`ç¬¬${i+1}æ®µç”Ÿæˆå¤±è´¥ï¼Œå·²é‡è¯•å¤šæ¬¡`);
            }
            
            completedSegments++;
            btn.innerHTML = `<span style="margin-right: 4px;">â³</span>å·²å®Œæˆ ${completedSegments}/${totalSegments} æ®µ`;
            
            console.log(`ç¬¬${i+1}æ®µç”Ÿæˆå®Œæˆ (${segments[i].length}å­—ç¬¦)`);
          }
        }
        
        // æ‰€æœ‰åˆ†æ®µå®Œæˆï¼Œå¼€å§‹åˆå¹¶
        btn.innerHTML = `<span style="margin-right: 4px;">â³</span>åˆå¹¶éŸ³é¢‘...`;
        
        const combineResponse = await fetch('/combine_audio_segments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            article_id: currentArticle.id,
            task_id: taskId,
            segments_count: totalSegments,
            original_text: originalText
          })
        });
        
        const combineResult = await combineResponse.json();
        
        if (combineResult.success) {
          showAudioPlayer(combineResult.audio_url, combineResult.filename);
          currentAudioUrl = combineResult.audio_url;
          updateAudioButton(true);
          console.log(`éŸ³é¢‘ç”ŸæˆæˆåŠŸï¼å…±${combineResult.segments_count}æ®µï¼Œæ€»é•¿åº¦${combineResult.text_length}å­—ç¬¦`);
        } else {
          throw new Error(combineResult.error || 'åˆå¹¶å¤±è´¥');
        }
        
      } catch (error) {
        console.error('åˆ†æ‰¹ç”Ÿæˆé”™è¯¯:', error);
        alert(`éŸ³é¢‘ç”Ÿæˆå¤±è´¥: ${error.message}`);
      } finally {
        resetAudioButton(btn, originalContent);
      }
    }
    
    async function getSegmentTexts(text, targetSegments) {
      // åœ¨å‰ç«¯é‡æ–°åˆ†å‰²æ–‡æœ¬ï¼Œç¡®ä¿ä¸åç«¯ä¸€è‡´ï¼ˆå¢åŠ 40%å†—ä½™ï¼‰
      const MAX_CHARS = 2200;  // è¿›ä¸€æ­¥é™ä½å­—ç¬¦é™åˆ¶
      if (text.length <= MAX_CHARS) {
        return [text];
      }
      
      // æ™ºèƒ½åˆ†å‰²é€»è¾‘ï¼ŒæŒ‰å¥å·åˆ†å‰²å¹¶ç¡®ä¿å¹³å‡åˆ†é…
      const sentences = text.split(/(?<=[.!?])\s+/);
      const idealLength = text.length / targetSegments;
      
      const segments = [];
      let currentSegment = '';
      
      for (const sentence of sentences) {
        const testSegment = currentSegment + (currentSegment ? ' ' : '') + sentence;
        
        // æ›´ä¸¥æ ¼çš„åˆ†å‰²æ¡ä»¶ï¼Œç¡®ä¿æ®µè½æ›´çŸ­ï¼ˆ40%å†—ä½™ç­–ç•¥ï¼‰
        const shouldSplit = (
          testSegment.length > idealLength * 0.9 &&  // æ›´æ—©åˆ†å‰²
          currentSegment && 
          segments.length < targetSegments - 1 &&
          testSegment.length > MAX_CHARS * 0.5  // é¿å…è¿‡å°æ®µè½
        );
        
        if (shouldSplit) {
          segments.push(currentSegment.trim());
          currentSegment = sentence;
        } else {
          currentSegment = testSegment;
        }
      }
      
      if (currentSegment) {
        segments.push(currentSegment.trim());
      }
      
      // å¦‚æœæŸä¸ªæ®µè½ä»ç„¶è¿‡é•¿ï¼Œè¿›è¡ŒäºŒæ¬¡åˆ†å‰²
      const finalSegments = [];
      for (const segment of segments) {
        if (segment.length <= MAX_CHARS) {
          finalSegments.push(segment);
        } else {
          // å¯¹è¿‡é•¿æ®µè½æŒ‰å¥å­è¿›ä¸€æ­¥åˆ†å‰²
          const subSentences = segment.split(/(?<=[.!?])\s+/);
          let currentSub = '';
          
          for (const subSentence of subSentences) {
            const testSub = currentSub + (currentSub ? ' ' : '') + subSentence;
            if (testSub.length > MAX_CHARS && currentSub) {
              finalSegments.push(currentSub.trim());
              currentSub = subSentence;
            } else {
              currentSub = testSub;
            }
          }
          
          if (currentSub) {
            finalSegments.push(currentSub.trim());
          }
        }
      }
      
      return finalSegments;
    }
    
    function resetAudioButton(btn, originalContent) {
      btn.disabled = false;
      btn.innerHTML = originalContent;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
    }
    
    // æ£€æŸ¥åˆ†ç‰‡çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
    async function checkSegmentStatus(taskId, segmentsCount) {
      try {
        const response = await fetch('/check_segment_status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            article_id: currentArticle.id,
            task_id: taskId,
            segments_count: segmentsCount
          })
        });
        
        return await response.json();
      } catch (error) {
        console.error('æ£€æŸ¥åˆ†ç‰‡çŠ¶æ€å¤±è´¥:', error);
        return { success: false, error: error.message };
      }
    }
    
    // å•ä¸ªåˆ†ç‰‡ç”Ÿæˆï¼ˆå¸¦é‡è¯•ï¼‰çš„è¾…åŠ©å‡½æ•°
    async function generateSingleSegmentWithRetry(taskId, segmentIndex, text, maxRetries = 3) {
      let lastError = null;
      
      for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
          console.log(`æ­£åœ¨ç”Ÿæˆåˆ†ç‰‡ ${segmentIndex}ï¼Œå°è¯• ${attempt + 1}/${maxRetries}`);
          
          const response = await fetch('/generate_audio_segment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              article_id: currentArticle.id,
              task_id: taskId,
              segment_index: segmentIndex,
              text: text
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            console.log(`åˆ†ç‰‡ ${segmentIndex} ç”ŸæˆæˆåŠŸ`);
            return true;
          } else {
            throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
          }
          
        } catch (error) {
          lastError = error;
          console.error(`åˆ†ç‰‡ ${segmentIndex} ç¬¬ ${attempt + 1} æ¬¡å°è¯•å¤±è´¥:`, error.message);
          
          if (attempt < maxRetries - 1) {
            // æŒ‡æ•°é€€é¿ï¼šç­‰å¾… 2^attempt ç§’ï¼Œæœ€å°‘1ç§’
            const waitTime = Math.max(1000, Math.min(8000, Math.pow(2, attempt) * 1000));
            console.log(`ç­‰å¾… ${waitTime/1000} ç§’åé‡è¯•...`);
            await new Promise(resolve => setTimeout(resolve, waitTime));
          }
        }
      }
      
      console.error(`åˆ†ç‰‡ ${segmentIndex} ç”Ÿæˆå¤±è´¥ï¼Œå·²é‡è¯• ${maxRetries} æ¬¡ã€‚æœ€åé”™è¯¯:`, lastError?.message);
      return false;
    }
    
    // æ¢å¤éŸ³é¢‘ç”ŸæˆåŠŸèƒ½
    async function resumeAudioGeneration() {
      if (!currentArticle) {
        alert('è¯·å…ˆæ‰“å¼€ä¸€ç¯‡æ–‡ç« ');
        return;
      }
      
      // æŸ¥æ‰¾æœªå®Œæˆçš„éŸ³é¢‘ä»»åŠ¡
      const unfinishedTask = await findUnfinishedAudioTask();
      
      if (!unfinishedTask) {
        alert('æ²¡æœ‰æ‰¾åˆ°æœªå®Œæˆçš„éŸ³é¢‘ç”Ÿæˆä»»åŠ¡');
        return;
      }
      
      if (!confirm(`å‘ç°æœªå®Œæˆçš„éŸ³é¢‘ç”Ÿæˆä»»åŠ¡ï¼ˆ${unfinishedTask.completion_rate.toFixed(1)}% å®Œæˆï¼‰ã€‚\n\næ˜¯å¦ç»§ç»­å®Œæˆè¯¥ä»»åŠ¡ï¼Ÿ`)) {
        return;
      }
      
      const btn = document.getElementById('generateAudioBtn');
      const resumeBtn = document.getElementById('resumeAudioBtn');
      const originalContent = btn.innerHTML;
      
      try {
        // ç¦ç”¨æŒ‰é’®
        btn.disabled = true;
        resumeBtn.disabled = true;
        resumeBtn.style.display = 'none';
        
        // æå–è‹±æ–‡æ–‡æœ¬
        const englishText = extractEnglishText(currentArticle.content_text);
        
        if (!englishText || englishText.trim().length === 0) {
          alert('æœªæ‰¾åˆ°è‹±æ–‡å†…å®¹å¯ç”ŸæˆéŸ³é¢‘');
          return;
        }
        
        // ç»§ç»­ç”Ÿæˆå‰©ä½™åˆ†ç‰‡
        await continueSegmentGeneration(unfinishedTask, englishText, btn, originalContent);
        
      } catch (error) {
        console.error('æ¢å¤éŸ³é¢‘ç”Ÿæˆé”™è¯¯:', error);
        alert(`æ¢å¤å¤±è´¥: ${error.message}`);
      } finally {
        resetAudioButton(btn, originalContent);
        resumeBtn.disabled = false;
      }
    }
    
    // æŸ¥æ‰¾æœªå®Œæˆçš„éŸ³é¢‘ä»»åŠ¡
    async function findUnfinishedAudioTask() {
      if (!currentArticle) return null;
      
      try {
        // æ£€æŸ¥æ–‡ç« éŸ³é¢‘ç›®å½•ä¸­çš„ä¸´æ—¶ä»»åŠ¡ç›®å½•
        const response = await fetch(`/find_unfinished_audio_tasks/${currentArticle.id}`);
        const data = await response.json();
        
        if (data.success && data.unfinished_tasks.length > 0) {
          // è¿”å›æœ€æ–°çš„æœªå®Œæˆä»»åŠ¡
          return data.unfinished_tasks[0];
        }
        
        return null;
      } catch (error) {
        console.error('æŸ¥æ‰¾æœªå®Œæˆä»»åŠ¡å¤±è´¥:', error);
        return null;
      }
    }
    
    // ç»§ç»­åˆ†ç‰‡ç”Ÿæˆ
    async function continueSegmentGeneration(taskInfo, originalText, btn, originalContent) {
      const { task_id, segments_count, completed_segments, missing_segments } = taskInfo;
      
      // é‡æ–°åˆ†å‰²æ–‡æœ¬
      const segments = await getSegmentTexts(originalText, segments_count);
      let completedCount = completed_segments.length;
      
      btn.innerHTML = `<span style="margin-right: 4px;">â³</span>æ¢å¤ç”Ÿæˆ (${completedCount}/${segments_count})...`;
      
      // ç”Ÿæˆç¼ºå¤±çš„åˆ†æ®µ
      for (const segmentIndex of missing_segments) {
        btn.innerHTML = `<span style="margin-right: 4px;">â³</span>æ¢å¤ç¬¬${segmentIndex+1}æ®µ... (${completedCount}/${segments_count})`;
        
        const success = await generateSingleSegmentWithRetry(
          task_id,
          segmentIndex,
          segments[segmentIndex],
          3
        );
        
        if (!success) {
          throw new Error(`ç¬¬${segmentIndex+1}æ®µæ¢å¤ç”Ÿæˆå¤±è´¥`);
        }
        
        completedCount++;
        btn.innerHTML = `<span style="margin-right: 4px;">â³</span>å·²å®Œæˆ ${completedCount}/${segments_count} æ®µ`;
        
        console.log(`ç¬¬${segmentIndex+1}æ®µæ¢å¤ç”Ÿæˆå®Œæˆ`);
      }
      
      // åˆå¹¶éŸ³é¢‘
      btn.innerHTML = `<span style="margin-right: 4px;">â³</span>åˆå¹¶éŸ³é¢‘...`;
      
      const combineResponse = await fetch('/combine_audio_segments', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          article_id: currentArticle.id,
          task_id: task_id,
          segments_count: segments_count,
          original_text: originalText
        })
      });
      
      const combineResult = await combineResponse.json();
      
      if (combineResult.success) {
        showAudioPlayer(combineResult.audio_url, combineResult.filename);
        currentAudioUrl = combineResult.audio_url;
        updateAudioButton(true);
        console.log(`éŸ³é¢‘æ¢å¤æˆåŠŸï¼å…±${combineResult.segments_count}æ®µ`);
      } else {
        throw new Error(combineResult.error || 'åˆå¹¶å¤±è´¥');
      }
    }
    
    // æ£€æŸ¥æœªå®Œæˆçš„éŸ³é¢‘ä»»åŠ¡
    async function checkForUnfinishedAudioTasks() {
      if (!currentArticle) return;
      
      try {
        const unfinishedTask = await findUnfinishedAudioTask();
        const resumeBtn = document.getElementById('resumeAudioBtn');
        
        if (unfinishedTask && unfinishedTask.completion_rate < 1.0) {
          // æ˜¾ç¤ºæ¢å¤æŒ‰é’®
          resumeBtn.style.display = 'inline-block';
          resumeBtn.title = `æ¢å¤æœªå®Œæˆçš„éŸ³é¢‘ç”Ÿæˆä»»åŠ¡ (${(unfinishedTask.completion_rate * 100).toFixed(1)}% å®Œæˆ)`;
          console.log(`å‘ç°æœªå®Œæˆçš„éŸ³é¢‘ä»»åŠ¡: ${unfinishedTask.task_id} (${(unfinishedTask.completion_rate * 100).toFixed(1)}% å®Œæˆ)`);
        } else {
          resumeBtn.style.display = 'none';
        }
      } catch (error) {
        console.error('æ£€æŸ¥æœªå®Œæˆä»»åŠ¡å¤±è´¥:', error);
        document.getElementById('resumeAudioBtn').style.display = 'none';
      }
    }
    
    function showAudioPlayer(audioUrl, filename, isExisting = false) {
      const audioPanel = document.getElementById('audioPanel');
      const audio = document.getElementById('articleAudio');
      const downloadBtn = document.getElementById('downloadAudioBtn');
      
      // è®¾ç½®éŸ³é¢‘æº
      audio.src = audioUrl;
      
      // å¦‚æœæ˜¯å·²å­˜åœ¨çš„éŸ³é¢‘ï¼Œæ·»åŠ é¢„åŠ è½½
      if (isExisting) {
        audio.preload = 'metadata';
        audio.addEventListener('loadedmetadata', function() {
          console.log(`éŸ³é¢‘åŠ è½½å®Œæˆï¼Œæ—¶é•¿: ${Math.round(audio.duration)}ç§’`);
        }, { once: true });
      }
      
      // è®¾ç½®ä¸‹è½½é“¾æ¥
      downloadBtn.onclick = function() {
        const link = document.createElement('a');
        link.href = audioUrl;
        link.download = filename || 'article_audio.mp3';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
      
      // æ˜¾ç¤ºéŸ³é¢‘é¢æ¿
      audioPanel.style.display = 'block';
      
      // è°ƒæ•´å†…å®¹åŒºåŸŸï¼Œä¸ºéŸ³é¢‘é¢æ¿ç•™å‡ºç©ºé—´
      const content = document.getElementById('vContent');
      if (content) {
        content.style.paddingBottom = '80px';
      }
      
      // å¦‚æœæ˜¯å·²å­˜åœ¨çš„éŸ³é¢‘ï¼Œæ·»åŠ ä¸€ä¸ªæ·¡å…¥æ•ˆæœ
      if (isExisting) {
        audioPanel.style.opacity = '0';
        audioPanel.style.transition = 'opacity 0.3s ease-in';
        setTimeout(() => {
          audioPanel.style.opacity = '1';
        }, 100);
      }
    }
    
    function closeAudioPanel() {
      const audioPanel = document.getElementById('audioPanel');
      const audio = document.getElementById('articleAudio');
      const content = document.getElementById('vContent');
      
      // åœæ­¢æ’­æ”¾
      audio.pause();
      audio.src = '';
      
      // éšè—é¢æ¿
      audioPanel.style.display = 'none';
      
      // æ¢å¤å†…å®¹åŒºåŸŸ
      if (content) {
        content.style.paddingBottom = '';
      }
      
      currentAudioUrl = null;
    }
    
    function downloadAudio() {
      if (currentAudioUrl) {
        const link = document.createElement('a');
        link.href = currentAudioUrl;
        link.download = `${currentArticle.title || 'article'}_audio.mp3`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }
    
    // å›¾ç‰‡ç›¸å…³åŠŸèƒ½
    function triggerImageUpload() {
      if (!currentArticle) {
        alert('è¯·å…ˆæ‰“å¼€ä¸€ç¯‡æ–‡ç« ');
        return;
      }
      document.getElementById('imageUpload').click();
    }
    
    function handleImageUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      
      if (!currentArticle) {
        alert('è¯·å…ˆæ‰“å¼€ä¸€ç¯‡æ–‡ç« ');
        return;
      }
      
      const uploadBtn = document.getElementById('uploadImageBtn');
      const originalContent = uploadBtn.innerHTML;
      
      // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<span style="margin-right: 4px;">â³</span>ä¸Šä¼ ä¸­...';
      uploadBtn.style.opacity = '0.7';
      
      const promises = Array.from(files).map(file => {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('article_id', currentArticle.id);
        
        return fetch('/intensive_upload_image', {
          method: 'POST',
          body: formData
        }).then(response => response.json());
      });
      
      Promise.all(promises)
        .then(results => {
          const successResults = results.filter(r => r.success);
          const errorResults = results.filter(r => !r.success);
          
          if (successResults.length > 0) {
            // æ›´æ–°å½“å‰å›¾ç‰‡åˆ—è¡¨
            successResults.forEach(result => {
              currentImages.push(result.image);
            });
            
            // é‡æ–°æ¸²æŸ“å›¾ç‰‡
            loadArticleImages();
            
            if (errorResults.length > 0) {
              alert(`æˆåŠŸä¸Šä¼  ${successResults.length} å¼ å›¾ç‰‡ï¼Œ${errorResults.length} å¼ å¤±è´¥`);
            }
          } else {
            alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
          }
        })
        .catch(error => {
          console.error('ä¸Šä¼ é”™è¯¯:', error);
          alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
        })
        .finally(() => {
          // é‡ç½®æŒ‰é’®çŠ¶æ€
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = originalContent;
          uploadBtn.style.opacity = '1';
          
          // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
          event.target.value = '';
        });
    }
    
    function loadArticleImages() {
      const imagesContainer = document.getElementById('articleImages');
      const imagesGrid = document.getElementById('imagesGrid');
      
      if (!currentImages || currentImages.length === 0) {
        imagesContainer.style.display = 'none';
        return;
      }
      
      imagesContainer.style.display = 'block';
      imagesGrid.innerHTML = '';
      
      currentImages.forEach((image, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';
        
        const img = document.createElement('img');
        img.src = `/intensive_image/${currentArticle.id}/${image.filename}`;
        img.alt = image.original_name || 'æ–‡ç« å›¾ç‰‡';
        img.loading = 'lazy';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'image-delete-btn';
        deleteBtn.innerHTML = 'âœ•';
        deleteBtn.title = 'åˆ é™¤å›¾ç‰‡';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteImage(image.id, index);
        };
        
        imageItem.appendChild(img);
        imageItem.appendChild(deleteBtn);
        
        // ç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹å¤§å›¾
        imageItem.onclick = () => {
          showImageModal(index);
        };
        
        imagesGrid.appendChild(imageItem);
      });
    }
    
    function deleteImage(imageId, index) {
      if (!confirm('ç¡®å®šåˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;
      
      fetch('/intensive_delete_image', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          article_id: currentArticle.id,
          image_id: imageId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // ä»å½“å‰å›¾ç‰‡åˆ—è¡¨ä¸­ç§»é™¤
          currentImages.splice(index, 1);
          // é‡æ–°æ¸²æŸ“å›¾ç‰‡
          loadArticleImages();
        } else {
          alert(data.error || 'åˆ é™¤å¤±è´¥');
        }
      })
      .catch(error => {
        console.error('åˆ é™¤é”™è¯¯:', error);
        alert('åˆ é™¤å¤±è´¥');
      });
    }
    
    function showImageModal(index) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const imageCounter = document.getElementById('imageCounter');
      const prevBtn = document.getElementById('prevImageBtn');
      const nextBtn = document.getElementById('nextImageBtn');
      const deleteBtn = document.getElementById('deleteImageBtn');
      
      currentImageIndex = index;
      
      // æ˜¾ç¤ºå½“å‰å›¾ç‰‡
      updateModalImage();
      
      // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
      prevBtn.disabled = currentImageIndex === 0;
      nextBtn.disabled = currentImageIndex === currentImages.length - 1;
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      modal.classList.add('active');
      modal.style.display = 'block';
      
      // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
      document.body.style.overflow = 'hidden';
    }
    
    function updateModalImage() {
      const modalImage = document.getElementById('modalImage');
      const imageCounter = document.getElementById('imageCounter');
      const deleteBtn = document.getElementById('deleteImageBtn');
      
      if (currentImages[currentImageIndex]) {
        const image = currentImages[currentImageIndex];
        modalImage.src = `/intensive_image/${currentArticle.id}/${image.filename}`;
        imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        
        // æ›´æ–°åˆ é™¤æŒ‰é’®
        deleteBtn.onclick = () => {
          deleteCurrentImage();
        };
      }
    }
    
    function showPreviousImage() {
      if (currentImageIndex > 0) {
        currentImageIndex--;
        updateModalImage();
        
        const prevBtn = document.getElementById('prevImageBtn');
        const nextBtn = document.getElementById('nextImageBtn');
        prevBtn.disabled = currentImageIndex === 0;
        nextBtn.disabled = false;
      }
    }
    
    function showNextImage() {
      if (currentImageIndex < currentImages.length - 1) {
        currentImageIndex++;
        updateModalImage();
        
        const prevBtn = document.getElementById('prevImageBtn');
        const nextBtn = document.getElementById('nextImageBtn');
        prevBtn.disabled = false;
        nextBtn.disabled = currentImageIndex === currentImages.length - 1;
      }
    }
    
    function deleteCurrentImage() {
      if (!currentImages[currentImageIndex]) return;
      
      const image = currentImages[currentImageIndex];
      const wasLastImage = currentImages.length === 1;
      
      if (!confirm('ç¡®å®šåˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;
      
      fetch('/intensive_delete_image', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          article_id: currentArticle.id,
          image_id: image.id
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // ä»å½“å‰å›¾ç‰‡åˆ—è¡¨ä¸­ç§»é™¤
          currentImages.splice(currentImageIndex, 1);
          
          if (wasLastImage || currentImages.length === 0) {
            // å¦‚æœæ˜¯æœ€åä¸€å¼ å›¾ç‰‡ï¼Œå…³é—­æ¨¡æ€æ¡†
            closeImageModal();
          } else {
            // è°ƒæ•´å½“å‰ç´¢å¼•
            if (currentImageIndex >= currentImages.length) {
              currentImageIndex = currentImages.length - 1;
            }
            
            // æ›´æ–°æ¨¡æ€æ¡†
            updateModalImage();
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®
            const prevBtn = document.getElementById('prevImageBtn');
            const nextBtn = document.getElementById('nextImageBtn');
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.disabled = currentImageIndex === currentImages.length - 1;
          }
          
          // é‡æ–°æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
          loadArticleImages();
        } else {
          alert(data.error || 'åˆ é™¤å¤±è´¥');
        }
      })
      .catch(error => {
        console.error('åˆ é™¤é”™è¯¯:', error);
        alert('åˆ é™¤å¤±è´¥');
      });
    }
    
    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.remove('active');
      
      setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }, 300);
    }
    
    // é”®ç›˜å¯¼èˆªæ”¯æŒ
    document.addEventListener('keydown', function(e) {
      const modal = document.getElementById('imageModal');
      if (modal.classList.contains('active')) {
        switch(e.key) {
          case 'Escape':
            closeImageModal();
            break;
          case 'ArrowLeft':
            showPreviousImage();
            break;
          case 'ArrowRight':
            showNextImage();
            break;
        }
      }
      
      // æ ‡é¢˜ç¼–è¾‘é”®ç›˜å¿«æ·é”®
      const titleEditContainer = document.getElementById('titleEditContainer');
      if (titleEditContainer && titleEditContainer.style.display !== 'none') {
        switch(e.key) {
          case 'Enter':
            e.preventDefault();
            saveTitleEdit();
            break;
          case 'Escape':
            e.preventDefault();
            cancelTitleEdit();
            break;
        }
      }
    });
    
    // æ ‡é¢˜ç¼–è¾‘åŠŸèƒ½
    function startEditTitle() {
      if (!currentArticle) return;
      
      const titleElement = document.getElementById('vTitle');
      const editBtn = document.getElementById('editTitleBtn');
      const editContainer = document.getElementById('titleEditContainer');
      const editInput = document.getElementById('titleEditInput');
      
      // éšè—æ ‡é¢˜å’Œç¼–è¾‘æŒ‰é’®ï¼Œæ˜¾ç¤ºç¼–è¾‘ç•Œé¢
      titleElement.style.display = 'none';
      editBtn.style.display = 'none';
      editContainer.style.display = 'flex';
      
      // è®¾ç½®å½“å‰æ ‡é¢˜ä½œä¸ºåˆå§‹å€¼
      editInput.value = currentArticle.title || 'æœªå‘½å';
      editInput.focus();
      editInput.select();
    }
    
    function cancelTitleEdit() {
      const titleElement = document.getElementById('vTitle');
      const editBtn = document.getElementById('editTitleBtn');
      const editContainer = document.getElementById('titleEditContainer');
      
      // æ¢å¤æ˜¾ç¤º
      titleElement.style.display = 'block';
      editBtn.style.display = 'block';
      editContainer.style.display = 'none';
    }
    
    function saveTitleEdit() {
      if (!currentArticle) return;
      
      const editInput = document.getElementById('titleEditInput');
      const newTitle = editInput.value.trim();
      
      if (!newTitle) {
        alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
        editInput.focus();
        return;
      }
      
      if (newTitle === currentArticle.title) {
        cancelTitleEdit();
        return;
      }
      
      const saveBtn = document.querySelector('.title-edit-save');
      const originalContent = saveBtn.innerHTML;
      
      // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
      saveBtn.disabled = true;
      saveBtn.innerHTML = 'â³';
      saveBtn.style.opacity = '0.7';
      
      fetch('/intensive_update_title', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          article_id: currentArticle.id,
          new_title: newTitle
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // æ›´æ–°å½“å‰æ–‡ç« å¯¹è±¡
          const oldArticleId = currentArticle.id;
          currentArticle.title = newTitle;
          currentArticle.id = data.new_article_id;
          
          // æ›´æ–°æ˜¾ç¤ºçš„æ ‡é¢˜
          document.getElementById('vTitle').textContent = newTitle;
          
          // å¦‚æœæ–‡ä»¶è¢«é‡å‘½åï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
          if (data.renamed_files) {
            console.log('æ ‡é¢˜æ›´æ–°æˆåŠŸï¼Œç›¸å…³æ–‡ä»¶å·²é‡å‘½åï¼š');
            console.log('æ–‡ä»¶:', data.details.files);
            console.log('ç›®å½•:', data.details.directories);
            
            // æ›´æ–°æµè§ˆå™¨URLï¼ˆå¦‚æœæœ‰hashï¼‰
            if (window.location.hash === `#article-${oldArticleId}`) {
              window.location.hash = `#article-${data.new_article_id}`;
            }
          }
          
          // åˆ·æ–°æ–‡ç« åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°æ ‡é¢˜
          if (typeof loadList === 'function') {
            loadList();
          }
          
          cancelTitleEdit();
        } else {
          alert(data.error || 'æ ‡é¢˜æ›´æ–°å¤±è´¥');
        }
      })
      .catch(error => {
        console.error('æ ‡é¢˜æ›´æ–°é”™è¯¯:', error);
        alert('æ ‡é¢˜æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      })
      .finally(() => {
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalContent;
        saveBtn.style.opacity = '1';
      });
    }
    
    function originalToContainerIndex(oi, original, container){
      let o=0, c=0;
      const olen=original.length, clen=container.length;
      
      while(o < olen && c < clen){
        // å¦‚æœå·²ç»åˆ°è¾¾ç›®æ ‡ä½ç½®
        if(o === oi) return c;
        
        const origChar = original[o];
        
        // è·³è¿‡åŸæ–‡ä¸­çš„æ¢è¡Œç¬¦ã€å›è½¦ç¬¦å’Œå¤šä½™çš„ç©ºæ ¼
        if(origChar === '\n' || origChar === '\r'){
          o++;
          continue;
        }
        
        // å¦‚æœåŸæ–‡æ˜¯ç©ºæ ¼ï¼Œè·³è¿‡è¿ç»­çš„ç©ºæ ¼
        if(origChar === ' '){
          // è·³è¿‡åŸæ–‡ä¸­è¿ç»­çš„ç©ºæ ¼
          while(o < olen && original[o] === ' '){
            o++;
          }
          // è·³è¿‡å®¹å™¨ä¸­çš„å•ä¸ªç©ºæ ¼
          if(c < clen && container[c] === ' '){
            c++;
          }
          continue;
        }
        
        // è·³è¿‡å®¹å™¨ä¸­è¿ç»­çš„ç©ºç™½å­—ç¬¦ç›´åˆ°æ‰¾åˆ°åŒ¹é…æˆ–éç©ºç™½å­—ç¬¦
        while(c < clen && /\s/.test(container[c]) && container[c] !== origChar){
          c++;
        }
        
        if(c >= clen) break;
        
        // æ£€æŸ¥å­—ç¬¦æ˜¯å¦åŒ¹é…
        if(origChar === container[c]){
          o++;
          c++;
        } else {
          // å­—ç¬¦ä¸åŒ¹é…ï¼Œå¯èƒ½æ˜¯æ ¼å¼å·®å¼‚ï¼Œç»§ç»­å°è¯•
          o++;
          // åœ¨å®¹å™¨ä¸­å¯»æ‰¾ä¸‹ä¸€ä¸ªåŒ¹é…çš„å­—ç¬¦
          let found = false;
          for(let j = c; j < Math.min(c + 10, clen); j++){
            if(container[j] === origChar){
              c = j + 1;
              found = true;
              break;
            }
          }
          if(!found) c++;
        }
      }
      
      // ç›®æ ‡åœ¨åŸæ–‡æœ«å°¾æˆ–è¶…å‡º
      if(oi >= o) return clen;
      return c;
    }
    function containerToOriginalIndex(ci, original, container){
      let o=0, c=0;
      const olen=original.length, clen=container.length;
      
      while(o < olen && c < clen){
        // å¦‚æœå·²ç»åˆ°è¾¾ç›®æ ‡å®¹å™¨ä½ç½®
        if(c === ci) return o;
        
        const origChar = original[o];
        
        // è·³è¿‡åŸæ–‡ä¸­çš„æ¢è¡Œç¬¦ã€å›è½¦ç¬¦
        if(origChar === '\n' || origChar === '\r'){
          o++;
          continue;
        }
        
        // å¦‚æœåŸæ–‡æ˜¯ç©ºæ ¼ï¼Œå¤„ç†è¿ç»­ç©ºæ ¼
        if(origChar === ' '){
          // è·³è¿‡åŸæ–‡ä¸­è¿ç»­çš„ç©ºæ ¼
          while(o < olen && original[o] === ' '){
            o++;
          }
          // è·³è¿‡å®¹å™¨ä¸­çš„å•ä¸ªç©ºæ ¼
          if(c < clen && container[c] === ' '){
            c++;
          }
          continue;
        }
        
        // è·³è¿‡å®¹å™¨ä¸­è¿ç»­çš„ç©ºç™½å­—ç¬¦ç›´åˆ°æ‰¾åˆ°åŒ¹é…æˆ–éç©ºç™½å­—ç¬¦
        while(c < clen && /\s/.test(container[c]) && container[c] !== origChar){
          c++;
        }
        
        if(c >= clen) break;
        
        // æ£€æŸ¥å­—ç¬¦æ˜¯å¦åŒ¹é…
        if(origChar === container[c]){
          o++;
          c++;
        } else {
          // å­—ç¬¦ä¸åŒ¹é…ï¼Œå¯»æ‰¾ä¸‹ä¸€ä¸ªåŒ¹é…
          let found = false;
          for(let j = c; j < Math.min(c + 10, clen); j++){
            if(container[j] === origChar){
              c = j + 1;
              found = true;
              break;
            }
          }
          if(!found) c++;
          o++;
        }
      }
      
      // ç›®æ ‡åœ¨å®¹å™¨æœ«å°¾æˆ–è¶…å‡º
      if(ci >= c) return o;
      return o;
    }
  </script>
</body>
</html>


