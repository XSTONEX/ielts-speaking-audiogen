<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Â≠¶‰π†‰∫§ÊµÅÂ∞èÂ§©Âú∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
  
  <link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'PT Serif', 'Crimson Text', ui-serif, 'Times New Roman', 'Georgia', serif; 
      background: linear-gradient(135deg, #e0e7ff 0%, #f4f6fa 100%); 
      margin: 0; 
      min-height: 100vh; 
      padding: 16px; 
      box-sizing: border-box; 
    }
    
    .container { 
      max-width: 900px; 
      margin: 0 auto; 
      background: #fff; 
      border-radius: 20px; 
      box-shadow: 0 16px 48px rgba(31,38,135,0.20); 
      overflow: hidden;
    }
    
    .header { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      padding: 20px 24px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    
    .header-left {
      flex: 0 0 auto;
    }
    
    .back-btn {
      background: rgba(255,255,255,0.2); 
      border: 2px solid rgba(255,255,255,0.3); 
      color: white; 
      border-radius: 20px; 
      padding: 8px 16px; 
      cursor: pointer; 
      font-size: 14px; 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      transition: all 0.2s; 
    }
    
    .back-btn:hover { 
      background: rgba(255,255,255,0.3); 
      border-color: rgba(255,255,255,0.5); 
    }
    
    .header h1 { 
      margin: 0; 
      font-size: 24px; 
      font-weight: 700; 
    }
    
    .header-actions { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
    }
    
    .user-info { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      color: rgba(255,255,255,0.9); 
      font-size: 14px; 
    }
    
    .user-avatar-small { 
      width: 28px; 
      height: 28px; 
      border-radius: 50%; 
      border: 2px solid rgba(255,255,255,0.3); 
    }
    
    .new-post-btn { 
      background: rgba(255,255,255,0.2); 
      border: 2px solid rgba(255,255,255,0.3); 
      color: white; 
      border-radius: 20px; 
      padding: 8px 16px; 
      cursor: pointer; 
      font-size: 14px; 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      transition: all 0.2s; 
    }
    
    .new-post-btn:hover { 
      background: rgba(255,255,255,0.3); 
      border-color: rgba(255,255,255,0.5); 
    }
    
    .posts-container { 
      min-height: 500px; 
      padding: 20px 24px; 
      display: flex; 
      flex-direction: column; 
      gap: 16px; 
    }
    
    .post-card { 
      background: #f8fafc; 
      border-radius: 16px; 
      padding: 20px; 
      border: 1px solid #e2e8f0; 
      transition: box-shadow 0.2s; 
      margin-bottom: 20px; 
    }
    
    .post-card:hover { 
      box-shadow: 0 6px 20px rgba(0,0,0,0.08); 
    }
    
    .post-header { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin-bottom: 16px; 
      position: relative; 
    }
    
    .user-avatar { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      object-fit: cover;
      border: 2px solid #e5e7eb; 
    }
    
    .post-user-info { 
      flex: 1; 
    }
    
    .user-name { 
      font-weight: 600; 
      color: #1f2937; 
      font-size: 16px; 
    }
    
    .post-time { 
      color: #6b7280; 
      font-size: 13px; 
      margin-top: 2px; 
    }
    
    .post-content { 
      line-height: 1.6; 
      color: #374151; 
      margin-bottom: 16px; 
    }
    
    .post-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
      margin-top: 16px;
    }
    
    .write-comment-btn {
      background: none;
      border: 1px solid #d1d5db;
      color: #6b7280;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .write-comment-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
      color: #374151;
    }
    
    .write-comment-btn.active {
      background: #e0f2fe;
      border-color: #0284c7;
      color: #0c4a6e;
    }
    
    .comments-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
      background: #f8fafc;
      border-radius: 0 0 16px 16px;
      margin: 16px -20px -20px -20px;
      padding: 16px 20px 20px 20px;
      display: none;
    }
    
    .comments-section.has-comments {
      display: block;
    }
    
    .comments-section.active {
      display: block;
    }
    
    .comment-form {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      display: none;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
    
    .comment-form.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    
    .comments-wrapper {
      position: relative;
    }
    
    .comments-list-container {
      margin-bottom: 12px;
    }
    
    .comment-input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 10px 12px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
      box-sizing: border-box;
      margin-bottom: 12px;
    }
    
    .comment-input:focus {
      outline: none;
      border-color: #0284c7;
      box-shadow: 0 0 0 3px rgba(2,132,199,0.1);
    }
    
    .comment-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .comment-type-selector {
      display: flex;
      gap: 6px;
    }
    
    .comment-type-btn {
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    
    .comment-type-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }
    
    .comment-submit-actions {
      display: flex;
      gap: 6px;
    }
    
    .comment-submit-btn {
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .comment-submit-btn.primary {
      background: #0284c7;
      border-color: #0284c7;
      color: white;
    }
    
    .comment-submit-btn.primary:hover {
      background: #0369a1;
    }
    
    .comment-submit-btn.secondary {
      background: white;
      color: #374151;
    }
    
    .comment-submit-btn.secondary:hover {
      background: #f9fafb;
    }
    
    .comments-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .comments-list:empty::before {
      content: "ÊöÇÊó†ËØÑËÆ∫ÔºåÂø´Êù•Êä¢Ê≤ôÂèëÂêßÔºÅ";
      display: block;
      text-align: center;
      color: #9ca3af;
      font-size: 13px;
      padding: 20px;
      font-style: italic;
    }
    

    
    .comment-item {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      position: relative;
    }
    
    .comment-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .comment-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #e5e7eb;
    }
    
    .comment-user-info {
      flex: 1;
    }
    
    .comment-user-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 13px;
    }
    
    .comment-time {
      color: #6b7280;
      font-size: 11px;
      margin-top: 1px;
    }
    
    .comment-content {
      color: #374151;
      font-size: 13px;
      line-height: 1.5;
    }
    
    .comment-delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      font-size: 12px;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
      opacity: 0.7;
    }
    
    .comment-delete-btn:hover {
      background: #fee2e2;
      color: #dc2626;
      opacity: 1;
    }
    
    .text-content { 
      font-size: 15px; 
      white-space: pre-wrap; 
      line-height: 1.6; 
    }
    
    .image-content { 
      margin-top: 12px; 
    }
    
    .content-section { 
      margin-top: 12px; 
    }
    
    .content-section:first-child { 
      margin-top: 0; 
    }
    
    .message-image { 
      max-width: 100%; 
      max-height: 300px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    }
    
    .audio-card, .article-card { 
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); 
      border: 1px solid #0284c7; 
      border-radius: 12px; 
      padding: 16px; 
      margin-top: 12px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .audio-card:hover, .article-card:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 24px rgba(2,132,199,0.15); 
    }
    
    .card-header { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 8px; 
    }
    
    .card-icon { 
      font-size: 20px; 
    }
    
    .card-title { 
      font-weight: 600; 
      color: #0c4a6e; 
      font-size: 16px; 
    }
    
    .card-desc { 
      color: #075985; 
      font-size: 13px; 
      margin-bottom: 6px; 
    }
    
    .card-meta { 
      color: #0369a1; 
      font-size: 12px; 
    }
    
    .new-post-form { 
      background: #f0f9ff; 
      border: 2px dashed #0284c7; 
      border-radius: 16px; 
      padding: 20px; 
      margin-bottom: 20px; 
      display: none; 
    }
    
    .new-post-form.active { 
      display: block; 
    }
    
    .form-row { 
      margin-bottom: 16px; 
    }
    
    .form-label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600; 
      color: #1f2937; 
      font-size: 14px; 
    }
    
    .text-input { 
      width: 100%; 
      border: 1px solid #d1d5db; 
      border-radius: 12px; 
      padding: 12px 16px; 
      font-family: inherit; 
      font-size: 14px; 
      resize: vertical; 
      min-height: 100px; 
      box-sizing: border-box; 
    }
    
    .text-input:focus { 
      outline: none; 
      border-color: #0284c7; 
      box-shadow: 0 0 0 3px rgba(2,132,199,0.1); 
    }
    
    .form-actions { 
      display: flex; 
      gap: 12px; 
      justify-content: space-between; 
      align-items: center; 
    }
    
    .content-type-selector { 
      display: flex; 
      gap: 8px; 
    }
    
    .type-btn { 
      padding: 6px 12px; 
      border: 1px solid #d1d5db; 
      background: white; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 12px; 
      transition: all 0.2s; 
      display: flex; 
      align-items: center; 
      gap: 4px; 
    }
    
    .type-btn:hover { 
      background: #f3f4f6; 
      border-color: #9ca3af; 
    }
    
    .form-submit-actions { 
      display: flex; 
      gap: 8px; 
    }
    
    .form-btn { 
      padding: 10px 20px; 
      border: 1px solid #d1d5db; 
      border-radius: 8px; 
      cursor: pointer; 
      font-family: inherit; 
      font-size: 14px; 
      transition: all 0.2s; 
    }
    
    .form-btn.primary { 
      background: #0284c7; 
      border-color: #0284c7; 
      color: white; 
    }
    
    .form-btn.primary:hover { 
      background: #0369a1; 
    }
    
    .form-btn.secondary { 
      background: white; 
      color: #374151; 
    }
    
    .form-btn.secondary:hover { 
      background: #f9fafb; 
    }
    
    .modal-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.5); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000; 
      overflow: hidden; /* Èò≤Ê≠¢ËÉåÊôØÊªöÂä® */
      touch-action: none; /* Èò≤Ê≠¢Ëß¶Êë∏ÊªöÂä®ËÉåÊôØ */
    }
    
    .modal { 
      background: white; 
      border-radius: 16px; 
      padding: 0; 
      max-width: 500px; 
      width: 90%; 
      max-height: 70vh; 
      overflow: hidden; 
      display: flex; 
      flex-direction: column; 
    }
    
    .large-modal { 
      max-width: 800px; 
      max-height: 80vh; 
    }
    
    .modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 20px 24px; 
      border-bottom: 1px solid #e5e7eb; 
    }
    
    .modal-header h3 { 
      margin: 0; 
      color: #1f2937; 
      font-size: 18px; 
    }
    
    .close-btn { 
      background: none; 
      border: none; 
      font-size: 24px; 
      cursor: pointer; 
      color: #6b7280; 
      padding: 0; 
      width: 32px; 
      height: 32px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      border-radius: 6px; 
    }
    
    .close-btn:hover { 
      background: #f3f4f6; 
      color: #374151; 
    }
    
    .modal-body { 
      display: flex; 
      flex: 1; 
      min-height: 0; 
    }
    
    .sidebar { 
      width: 200px; 
      background: #f8fafc; 
      border-right: 1px solid #e5e7eb; 
      overflow-y: auto; 
    }
    
    .sidebar-section { 
      padding: 16px; 
    }
    
    .section-title { 
      font-weight: 600; 
      color: #374151; 
      font-size: 14px; 
      margin-bottom: 12px; 
    }
    
    .category-list { 
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
    }
    
    .category-item { 
      padding: 10px 12px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 14px; 
      color: #4b5563; 
      transition: all 0.2s; 
    }
    
    .category-item:hover { 
      background: #e0f2fe; 
      color: #0c4a6e; 
    }
    
    .category-item.active { 
      background: #0284c7; 
      color: white; 
    }
    
    .category-item.active:hover { 
      background: #0369a1; 
    }
    
    .content-area { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      min-height: 0; 
    }
    
    .content-header { 
      padding: 16px 20px; 
      border-bottom: 1px solid #e5e7eb; 
    }
    
    .breadcrumb { 
      color: #6b7280; 
      font-size: 14px; 
    }
    
    .content-list { 
      flex: 1; 
      padding: 16px 20px; 
      overflow-y: auto; 
    }
    
    .empty-content { 
      text-align: center; 
      color: #9ca3af; 
      font-size: 14px; 
      padding: 40px 20px; 
    }
    
    .content-item { 
      padding: 12px 16px; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
      margin-bottom: 8px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .content-item:hover { 
      border-color: #0284c7; 
      box-shadow: 0 2px 8px rgba(2,132,199,0.1); 
    }
    
    .content-item.selected { 
      border-color: #0284c7; 
      background: #f0f9ff; 
    }
    
    .content-item-title { 
      font-weight: 600; 
      color: #1f2937; 
      margin-bottom: 4px; 
    }
    
    .content-item-meta { 
      color: #6b7280; 
      font-size: 12px; 
    }
    
    .content-item-actions { 
      display: flex; 
      gap: 8px; 
      margin-top: 8px; 
    }
    
    .content-item-btn { 
      padding: 4px 8px; 
      border: 1px solid #d1d5db; 
      background: white; 
      border-radius: 4px; 
      font-size: 11px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .content-item-btn:hover { 
      background: #f3f4f6; 
    }
    
    .content-item-btn.primary { 
      background: #0284c7; 
      border-color: #0284c7; 
      color: white; 
    }
    
    .content-item-btn.primary:hover { 
      background: #0369a1; 
    }
    
    .modal h3 { 
      margin: 0 0 16px; 
      color: #1f2937; 
    }
    
    .modal-section { 
      margin-bottom: 20px; 
    }
    
    .modal-section h4 { 
      margin: 0 0 8px; 
      color: #374151; 
      font-size: 14px; 
    }
    
    .item-list { 
      max-height: 200px; 
      overflow-y: auto; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
    }
    
    .item { 
      padding: 12px; 
      border-bottom: 1px solid #f3f4f6; 
      cursor: pointer; 
      transition: background 0.2s; 
    }
    
    .item:hover { 
      background: #f8fafc; 
    }
    
    .item:last-child { 
      border-bottom: none; 
    }
    
    .item-title { 
      font-weight: 600; 
      color: #1f2937; 
      margin-bottom: 4px; 
    }
    
    .item-meta { 
      color: #6b7280; 
      font-size: 12px; 
    }
    
    .modal-actions { 
      display: flex; 
      gap: 12px; 
      justify-content: flex-end; 
      padding: 16px 24px; 
      border-top: 1px solid #e5e7eb; 
      background: #f9fafb; 
    }
    
    .modal-btn { 
      padding: 8px 16px; 
      border: 1px solid #d1d5db; 
      border-radius: 8px; 
      cursor: pointer; 
      font-family: inherit; 
      transition: all 0.2s; 
    }
    
    .modal-btn.primary { 
      background: #6366f1; 
      border-color: #6366f1; 
      color: white; 
    }
    
    .modal-btn.primary:hover { 
      background: #5a5afc; 
    }
    
    .modal-btn.secondary { 
      background: white; 
      color: #374151; 
    }
    
    .modal-btn.secondary:hover { 
      background: #f9fafb; 
    }
    
    .empty-state { 
      text-align: center; 
      padding: 40px 20px; 
      color: #6b7280; 
    }
    
    .empty-icon { 
      font-size: 48px; 
      margin-bottom: 16px; 
      opacity: 0.5; 
    }
    
    .hidden { 
      display: none !important; 
    }
    
    /* ÂõæÁâáÊîæÂ§ßÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
    .image-modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.9); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 2000; 
      cursor: pointer; 
    }
    
    .image-modal img { 
      max-width: 90vw; 
      max-height: 90vh; 
      object-fit: contain; 
      border-radius: 8px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.5); 
    }
    
        .image-modal .close-hint {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      padding: 8px 12px;
      border-radius: 20px;
    }
    
    /* ÊåëÊàòÁõ∏ÂÖ≥Ê†∑Âºè */
    .word-count-btn {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      color: #6b7280;
    }
    
    .word-count-btn:hover {
      border-color: #4a90e2;
      color: #4a90e2;
    }
    
    .word-count-btn.active {
      background: #4a90e2;
      border-color: #4a90e2;
      color: white;
    }
    
    .challenge-article-item, .challenge-user-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 4px;
    }
    
    .challenge-article-item:hover, .challenge-user-item:hover {
      background: #f3f4f6;
    }
    
    .challenge-article-item.selected, .challenge-user-item.selected {
      background: #e0f2fe;
      border: 1px solid #0284c7;
    }
    
    .challenge-article-checkbox, .challenge-user-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid #d1d5db;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .challenge-article-item.selected .challenge-article-checkbox,
    .challenge-user-item.selected .challenge-user-checkbox {
      background: #0284c7;
      border-color: #0284c7;
      color: white;
    }
    
    .challenge-article-info, .challenge-user-info {
      flex: 1;
    }
    
    .challenge-article-title, .challenge-user-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }
    
    .challenge-article-meta, .challenge-user-meta {
      color: #6b7280;
      font-size: 12px;
      margin-top: 2px;
    }
    
    .challenge-option {
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      color: #374151;
    }
    
    .challenge-option:hover {
      border-color: #4a90e2;
      background: #f0f9ff;
    }
    
    .challenge-option.correct {
      border-color: #10b981;
      background: #d1fae5;
      color: #065f46;
    }
    
    .challenge-option.incorrect {
      border-color: #ef4444;
      background: #fee2e2;
      color: #991b1b;
    }
    
    .challenge-option.selected {
      border-color: #4a90e2;
      background: #dbeafe;
      color: #1e40af;
    }
    
    .challenge-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .challenge-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(245, 158, 11, 0.15);
    }
    
    .challenge-card .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .challenge-card .card-icon {
      font-size: 20px;
    }
    
    .challenge-card .card-title {
      font-weight: 600;
      color: #92400e;
      font-size: 16px;
    }
    
    .challenge-card .card-desc {
      color: #a16207;
      font-size: 13px;
      margin-bottom: 6px;
    }
    
    .challenge-card .card-meta {
      color: #d97706;
      font-size: 12px;
    }
    
    .ranking-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      background: white;
      border: 1px solid #e5e7eb;
      transition: all 0.2s;
    }
    
    .ranking-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .ranking-item.rank-1 {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
    }
    
    .ranking-item.rank-2 {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-color: #9ca3af;
    }
    
    .ranking-item.rank-3 {
      background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
      border-color: #c084fc;
    }
    
    .ranking-number {
      font-size: 24px;
      font-weight: 700;
      color: #374151;
      min-width: 40px;
      text-align: center;
    }
    
    .ranking-item.rank-1 .ranking-number {
      color: #d97706;
    }
    
    .ranking-item.rank-2 .ranking-number {
      color: #6b7280;
    }
    
    .ranking-item.rank-3 .ranking-number {
      color: #a855f7;
    }
    
    .ranking-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
    }
    
    .ranking-info {
      flex: 1;
    }
    
    .ranking-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    .ranking-score {
      color: #6b7280;
      font-size: 14px;
    }
    
    .ranking-points {
      font-size: 20px;
      font-weight: 700;
      color: #4a90e2;
    }
    
    /* ÊåëÊàòÊèêÈÜíÊù°Ê†∑Âºè */
    .challenge-alert {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: 0 0 16px 16px;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
      position: relative;
      z-index: 10;
    }
    
    .alert-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .alert-icon {
      font-size: 24px;
      animation: gentle-bounce 2s ease-in-out infinite;
    }
    
    @keyframes gentle-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }
    
    .alert-text {
      color: #92400e;
      font-weight: 600;
      font-size: 15px;
    }
    
    .alert-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .alert-btn-primary {
      background: #f59e0b;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .alert-btn-primary:hover {
      background: #d97706;
      transform: translateY(-1px);
    }
    
    .alert-btn-close {
      background: none;
      border: none;
      color: #92400e;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .alert-btn-close:hover {
      background: rgba(146, 64, 14, 0.1);
      transform: scale(1.1);
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0;
      }
      
      .container { 
        margin: 0; 
        border-radius: 0; 
        min-height: 100vh; 
        box-shadow: none;
      }
      
      /* ÊåëÊàòÊèêÈÜíÊù°ÁßªÂä®Á´ØÈÄÇÈÖç */
      .challenge-alert {
        padding: 12px 16px;
        flex-direction: column;
        gap: 12px;
        border-radius: 0;
      }
      
      .alert-content {
        justify-content: center;
        text-align: center;
      }
      
      .alert-text {
        font-size: 14px;
      }
      
      .alert-actions {
        width: 100%;
        justify-content: center;
      }
      
      .header {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .header-left {
        order: -1;
        align-self: flex-start;
      }
      
      .back-btn {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 16px;
      }
      
      .back-btn span:last-child {
        display: none;
      }
      
      .header h1 {
        font-size: 20px;
        text-align: center;
        margin: 0;
      }
      
      .header-actions {
        justify-content: space-between;
        width: 100%;
      }
      
      .user-info {
        font-size: 13px;
      }
      
      .user-avatar-small {
        width: 24px;
        height: 24px;
      }
      
      .new-post-btn {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 16px;
      }
      
      .posts-container { 
        padding: 12px 16px;
        min-height: calc(100vh - 180px); 
        gap: 12px;
      }
      
      .post-card {
        padding: 16px;
        margin-bottom: 16px;
        border-radius: 12px;
      }
      
      .post-header {
        margin-bottom: 12px;
      }
      
      .user-avatar {
        width: 32px;
        height: 32px;
      }
      
      .user-name {
        font-size: 14px;
      }
      
      .post-time {
        font-size: 11px;
      }
      
      .text-content {
        font-size: 14px;
      }
      
      .audio-card, .article-card {
        padding: 12px;
        margin-top: 8px;
      }
      
      .card-title {
        font-size: 14px;
      }
      
      .card-desc {
        font-size: 12px;
      }
      
      .card-meta {
        font-size: 11px;
      }
      
      .message-image {
        max-height: 250px;
      }
      
      .new-post-form {
        padding: 16px;
        margin-bottom: 16px;
        border-radius: 12px;
      }
      
      .text-input {
        min-height: 80px;
        font-size: 14px;
        padding: 10px 12px;
      }
      
      .form-actions {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .content-type-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        width: 100%;
      }
      
      /* ÊåëÊàòÂäüËÉΩÁßªÂä®Á´ØÈÄÇÈÖç */
      .word-count-btn {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 16px;
      }
      
      .challenge-article-item, .challenge-user-item {
        padding: 6px 10px;
        margin-bottom: 3px;
      }
      
      .challenge-article-title, .challenge-user-name {
        font-size: 13px;
      }
      
      .challenge-article-meta, .challenge-user-meta {
        font-size: 11px;
      }
      
      .challenge-article-checkbox, .challenge-user-checkbox {
        width: 16px;
        height: 16px;
      }
      
      .challenge-option {
        padding: 12px;
        font-size: 14px;
        border-radius: 10px;
      }
      
      .challenge-card {
        padding: 12px;
        margin-top: 8px;
      }
      
      .challenge-card .card-title {
        font-size: 14px;
      }
      
      .challenge-card .card-desc {
        font-size: 12px;
      }
      
      .challenge-card .card-meta {
        font-size: 11px;
      }
      
      .ranking-item {
        padding: 12px;
        margin-bottom: 8px;
        gap: 12px;
      }
      
      .ranking-number {
        font-size: 20px;
        min-width: 32px;
      }
      
      .ranking-avatar {
        width: 40px;
        height: 40px;
      }
      
      .ranking-name {
        font-size: 14px;
      }
      
      .ranking-score {
        font-size: 12px;
      }
      
      .ranking-points {
        font-size: 16px;
      }
      
      /* ÊåëÊàòÊ∏∏ÊàèÊ®°ÊÄÅÊ°ÜÁßªÂä®Á´ØÈÄÇÈÖç */
      #challengeGameModal .modal {
        max-width: 95vw;
        max-height: 95vh;
        margin: 0 8px;
      }
      
      #challengeGameModal .modal-body {
        padding: 20px;
      }
      
      #challengeTimer {
        font-size: 20px;
        margin-bottom: 16px;
      }
      
      #challengeQuestion {
        font-size: 16px;
        min-height: 50px;
        padding: 16px;
        margin-bottom: 20px;
      }
      
      .challenge-word {
        margin-right: 12px;
        font-weight: 600;
      }
      
      .challenge-audio-btn {
        background: transparent;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 12px;
        color: #3b82f6;
        transition: all 0.2s ease;
        margin-left: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      
      .challenge-audio-btn:hover {
        background: rgba(59, 130, 246, 0.1);
        color: #1d4ed8;
        transform: scale(1.1);
      }
      
      .challenge-audio-btn:active {
        transform: scale(0.95);
      }
      
      #challengeOptions {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .challenge-option {
        padding: 14px;
        font-size: 15px;
      }
      
      #challengeProgress {
        font-size: 12px;
      }
      
      /* ÊåëÊàòÂàõÂª∫Ê®°ÊÄÅÊ°ÜÁßªÂä®Á´ØÈÄÇÈÖç */
      #challengeModal .modal {
        max-width: 95vw;
        max-height: 90vh;
        margin: 0 8px;
      }
      
      #challengeModal .modal-body {
        padding: 16px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
      
      #challengeTitle, #challengeDescription {
        font-size: 14px;
        padding: 8px 10px;
      }
      
      #challengeDescription {
        min-height: 50px;
      }
      
      #challengeArticleList, #challengeUserList {
        max-height: 150px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
      
      /* ÊåëÊàòÊéíÂêçÊ®°ÊÄÅÊ°ÜÁßªÂä®Á´ØÈÄÇÈÖç */
      #challengeRankingModal .modal {
        max-width: 95vw;
        max-height: 90vh;
        margin: 0 8px;
      }
      
      #challengeRankingModal .modal-body {
        padding: 16px;
      }
      
      #challengeInfo {
        font-size: 13px;
        padding: 12px;
      }
      
      .type-btn {
        padding: 8px 12px;
        font-size: 12px;
        justify-content: center;
      }
      
      .form-submit-actions {
        width: 100%;
        justify-content: center;
      }
      
      .form-btn {
        flex: 1;
        max-width: 120px;
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .write-comment-btn {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 16px;
      }
      
      .comments-section {
        margin: 12px -16px -16px -16px;
        padding: 12px 16px 16px 16px;
      }
      
      .comment-form {
        padding: 12px;
      }
      
      .comment-input {
        min-height: 50px;
        font-size: 13px;
        padding: 8px 10px;
      }
      
      .comment-type-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px;
      }
      
      .comment-type-btn {
        padding: 3px 6px;
        font-size: 10px;
        justify-content: center;
      }
      
      .comment-submit-btn {
        padding: 6px 10px;
        font-size: 11px;
      }
      
      .comment-item {
        padding: 10px;
        margin-bottom: 6px;
      }
      
      .comment-avatar {
        width: 20px;
        height: 20px;
      }
      
      .comment-user-name {
        font-size: 12px;
      }
      
      .comment-time {
        font-size: 10px;
      }
      
      .comment-content {
        font-size: 12px;
      }
      

      
      .large-modal { 
        max-width: 95vw; 
        max-height: 90vh; 
        margin: 0 8px;
      }
      
      .modal-header {
        padding: 16px 20px;
      }
      
      .modal-header h3 {
        font-size: 16px;
      }
      
      .modal-body { 
        flex-direction: column; 
      }
      
      .sidebar { 
        width: 100%; 
        max-height: 120px; 
        border-right: none; 
        border-bottom: 1px solid #e5e7eb; 
      }
      
      .sidebar-section {
        padding: 12px 16px;
      }
      
      .section-title {
        font-size: 13px;
        margin-bottom: 8px;
      }
      
      .category-list { 
        flex-direction: row; 
        overflow-x: auto; 
        gap: 6px;
        padding-bottom: 8px; 
      }
      
      .category-item { 
        flex-shrink: 0; 
        white-space: nowrap; 
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .content-area { 
        min-height: 250px; 
      }
      
      .content-header {
        padding: 12px 16px;
      }
      
      .breadcrumb {
        font-size: 12px;
      }
      
      .content-list {
        padding: 12px 16px;
      }
      
      .content-item {
        padding: 10px 12px;
        margin-bottom: 6px;
      }
      
      .content-item-title {
        font-size: 13px;
        margin-bottom: 3px;
      }
      
      .content-item-meta {
        font-size: 11px;
      }
      
      .content-item-actions {
        margin-top: 6px;
        gap: 6px;
      }
      
      .content-item-btn {
        padding: 4px 8px;
        font-size: 10px;
        border-radius: 4px;
      }
      
      .modal-actions {
        padding: 12px 16px;
      }
      
      .modal-btn {
        padding: 8px 16px;
        font-size: 13px;
      }
      
      .expanded-content {
        margin-top: 8px !important;
        padding: 12px !important;
      }
      
      .image-modal .close-hint {
        top: 10px;
        right: 10px;
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .empty-state {
        padding: 30px 16px;
      }
      
      .empty-icon {
        font-size: 36px;
        margin-bottom: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 12px 16px;
      }
      
      .header h1 {
        font-size: 18px;
      }
      
      .user-info {
        font-size: 12px;
      }
      
      .user-avatar-small {
        width: 20px;
        height: 20px;
      }
      
      .new-post-btn {
        padding: 6px 10px;
        font-size: 12px;
        gap: 4px;
      }
      
      .posts-container {
        padding: 8px 12px;
      }
      
      .post-card {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      .user-avatar {
        width: 28px;
        height: 28px;
      }
      
      .user-name {
        font-size: 13px;
      }
      
      .post-time {
        font-size: 10px;
      }
      
      .text-content {
        font-size: 13px;
      }
      
      .audio-card, .article-card {
        padding: 10px;
      }
      
      .card-title {
        font-size: 13px;
      }
      
      .card-desc {
        font-size: 11px;
      }
      
      .card-meta {
        font-size: 10px;
      }
      
      .new-post-form {
        padding: 12px;
      }
      
      .text-input {
        min-height: 70px;
        font-size: 13px;
        padding: 8px 10px;
      }
      
      .content-type-selector {
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }
      
      .type-btn {
        padding: 6px 8px;
        font-size: 11px;
        gap: 3px;
      }
      
      .type-btn span:last-child {
        display: none;
      }
      
      /* ÊåëÊàòÂäüËÉΩÂ∞èÂ±èÂπïÈÄÇÈÖç */
      .word-count-btn {
        padding: 5px 10px;
        font-size: 11px;
      }
      
      .challenge-article-item, .challenge-user-item {
        padding: 5px 8px;
      }
      
      .challenge-article-title, .challenge-user-name {
        font-size: 12px;
      }
      
      .challenge-article-meta, .challenge-user-meta {
        font-size: 10px;
      }
      
      .challenge-option {
        padding: 10px;
        font-size: 13px;
      }
      
      .challenge-card {
        padding: 10px;
      }
      
      .challenge-card .card-title {
        font-size: 13px;
      }
      
      .challenge-card .card-desc {
        font-size: 11px;
      }
      
      .challenge-card .card-meta {
        font-size: 10px;
      }
      
      .ranking-item {
        padding: 10px;
        gap: 10px;
      }
      
      .ranking-number {
        font-size: 18px;
        min-width: 28px;
      }
      
      .ranking-avatar {
        width: 36px;
        height: 36px;
      }
      
      .ranking-name {
        font-size: 13px;
      }
      
      .ranking-score {
        font-size: 11px;
      }
      
      .ranking-points {
        font-size: 14px;
      }
      
      /* ÊåëÊàòÊ∏∏ÊàèÊ®°ÊÄÅÊ°ÜÂ∞èÂ±èÂπïÈÄÇÈÖç */
      #challengeGameModal .modal {
        max-width: 98vw;
        max-height: 98vh;
        margin: 0 4px;
      }
      
      #challengeGameModal .modal-body {
        padding: 16px;
      }
      
      #challengeTimer {
        font-size: 18px;
        margin-bottom: 12px;
      }
      
      #challengeQuestion {
        font-size: 14px;
        min-height: 40px;
        padding: 12px;
        margin-bottom: 16px;
      }
      
      .challenge-word {
        margin-right: 8px;
        font-weight: 600;
      }
      
      .challenge-audio-btn {
        background: transparent;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 10px;
        color: #3b82f6;
        transition: all 0.2s ease;
        margin-left: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      #challengeOptions {
        gap: 6px;
      }
      
      .challenge-option {
        padding: 12px;
        font-size: 14px;
      }
      
      #challengeProgress {
        font-size: 11px;
      }
      
      /* ÊåëÊàòÂàõÂª∫Ê®°ÊÄÅÊ°ÜÂ∞èÂ±èÂπïÈÄÇÈÖç */
      #challengeModal .modal {
        max-width: 98vw;
        max-height: 95vh;
        margin: 0 4px;
      }
      
      #challengeModal .modal-body {
        padding: 12px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
      
      #challengeTitle, #challengeDescription {
        font-size: 13px;
        padding: 6px 8px;
      }
      
      #challengeDescription {
        min-height: 40px;
      }
      
      #challengeArticleList, #challengeUserList {
        max-height: 120px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
      
      /* ÊåëÊàòÊéíÂêçÊ®°ÊÄÅÊ°ÜÂ∞èÂ±èÂπïÈÄÇÈÖç */
      #challengeRankingModal .modal {
        max-width: 98vw;
        max-height: 95vh;
        margin: 0 4px;
      }
      
      #challengeRankingModal .modal-body {
        padding: 12px;
      }
      
      #challengeInfo {
        font-size: 12px;
        padding: 10px;
      }
      
      .form-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .write-comment-btn {
        padding: 4px 8px;
        font-size: 11px;
      }
      
      .comments-section {
        margin: 10px -12px -12px -12px;
        padding: 10px 12px 12px 12px;
      }
      
      .comment-form {
        padding: 10px;
      }
      
      .comment-input {
        min-height: 40px;
        font-size: 12px;
        padding: 6px 8px;
      }
      
      .comment-type-btn {
        padding: 2px 4px;
        font-size: 9px;
      }
      
      .comment-type-btn span:last-child {
        display: none;
      }
      
      .comment-submit-btn {
        padding: 5px 8px;
        font-size: 10px;
      }
      
      .comment-item {
        padding: 8px;
        margin-bottom: 4px;
      }
      
      .comment-avatar {
        width: 18px;
        height: 18px;
      }
      
      .comment-user-name {
        font-size: 11px;
      }
      
      .comment-time {
        font-size: 9px;
      }
      
      .comment-content {
        font-size: 11px;
      }
      

      
      .large-modal {
        max-width: 98vw;
        max-height: 95vh;
        margin: 0 4px;
      }
      
      .modal-header {
        padding: 12px 16px;
      }
      
      .modal-header h3 {
        font-size: 15px;
      }
      
      .sidebar-section {
        padding: 8px 12px;
      }
      
      .category-item {
        padding: 6px 10px;
        font-size: 11px;
      }
      
      .content-header {
        padding: 8px 12px;
      }
      
      .content-list {
        padding: 8px 12px;
      }
      
      .content-item {
        padding: 8px 10px;
      }
      
      .content-item-title {
        font-size: 12px;
      }
      
      .content-item-meta {
        font-size: 10px;
      }
      
      .content-item-btn {
        padding: 3px 6px;
        font-size: 9px;
      }
      
      .modal-actions {
        padding: 10px 12px;
      }
      
      .modal-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ÊåëÊàòÊèêÈÜíÊù° -->
    <div id="challengeAlert" class="challenge-alert" style="display: none;">
      <div class="alert-content">
        <span class="alert-icon">üèÜ</span>
        <div class="alert-text">
          <span id="alertMessage">ÊÇ®ÊúâÊñ∞ÁöÑËØçÊ±áÊåëÊàòÁ≠âÂæÖÂÆåÊàê</span>
        </div>
      </div>
      <div class="alert-actions">
        <button class="alert-btn-primary" onclick="goToChallengePost()">Êü•ÁúãÊåëÊàò</button>
        <button class="alert-btn-close" onclick="dismissAlert()">√ó</button>
      </div>
    </div>
    
    <div class="header">
      <div class="header-left">
        <button class="back-btn" onclick="goBackToModules()" title="ËøîÂõûÊ®°Âùó">
          <span>‚Üê</span>
          <span>ËøîÂõûÊ®°Âùó</span>
        </button>
      </div>
      <h1>üìö Â≠¶‰π†‰∫§ÊµÅÂ∞èÂ§©Âú∞</h1>
      <div class="header-actions">
        <div class="user-info" id="userInfo">
          <img class="user-avatar-small" id="userAvatarSmall" src="" alt="">
          <span id="userDisplayName">Âä†ËΩΩ‰∏≠...</span>
        </div>
        <button class="new-post-btn" onclick="toggleNewPostForm()">
          <span>+</span>
          <span>ÂèëÂ∏ÉÊñ∞Â∏ñ</span>
        </button>
      </div>
    </div>
    
    <div class="posts-container" id="postsContainer">
      <!-- Êñ∞Â∏ñÂèëÂ∏ÉË°®Âçï -->
      <div class="new-post-form" id="newPostForm">
        <div class="form-row">
          <label class="form-label">ÂàÜ‰∫´ÂÜÖÂÆπ</label>
          <textarea 
            class="text-input" 
            id="postContent" 
            placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÂ≠¶‰π†ÂøÉÂæó„ÄÅÁªèÈ™åÊàñÊÉ≥Ê≥ï..."
          ></textarea>
        </div>
        
        <div class="form-actions">
          <div class="content-type-selector">
            <button class="type-btn" onclick="showAudioSelector()">
              <span>üé§</span>
              <span>Ê∑ªÂä†Èü≥È¢ë</span>
            </button>
            <button class="type-btn" onclick="showArticleSelector()">
              <span>üìù</span>
              <span>Ê∑ªÂä†ÊñáÁ´†</span>
            </button>
            <button class="type-btn" onclick="showImageUploader()">
              <span>üñºÔ∏è</span>
              <span>Ê∑ªÂä†ÂõæÁâá</span>
            </button>
            <button class="type-btn" onclick="showChallengeCreator()">
              <span>üèÜ</span>
              <span>ÂèëËµ∑ÊåëÊàò</span>
            </button>
          </div>
          
          <div class="form-submit-actions">
            <button class="form-btn secondary" onclick="cancelNewPost()">ÂèñÊ∂à</button>
            <button class="form-btn primary" onclick="submitPost()">ÂèëÂ∏É</button>
          </div>
        </div>
        
        <!-- È¢ùÂ§ñÂÜÖÂÆπÈÄâÊã©Âå∫Âüü -->
        <div id="extraContentArea"></div>
      </div>
      
      <!-- Â∏ñÂ≠êÂàóË°® -->
      <div id="postsList">
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">üìù</div>
          <div>ËøòÊ≤°ÊúâÂ∏ñÂ≠êÔºåÁÇπÂáª‰∏äÊñπ"ÂèëÂ∏ÉÊñ∞Â∏ñ"ÂºÄÂßãÂàÜ‰∫´ÂêßÔºÅ</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Èü≥È¢ëÂàÜ‰∫´Ê®°ÊÄÅÊ°Ü -->
  <div class="modal-overlay" id="audioModal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>ÂàÜ‰∫´Èü≥È¢ëÂÜÖÂÆπ</h3>
        <button class="close-btn" onclick="closeModal('audioModal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="sidebar">
          <div class="sidebar-section">
            <div class="section-title">ÈÄâÊã©ÂàÜÁ±ª</div>
            <div class="category-list" id="audioCategoryList">
              <div class="category-item" data-category="Part1">Part 1</div>
              <div class="category-item" data-category="Part2">Part 2</div>
              <div class="category-item" data-category="Part3">Part 3</div>
              <div class="category-item" data-category="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</div>
            </div>
          </div>
        </div>
        <div class="content-area">
          <div class="content-header">
            <div class="breadcrumb" id="audioBreadcrumb">ËØ∑ÈÄâÊã©ÂàÜÁ±ª</div>
          </div>
          <div class="content-list" id="audioContentList">
            <div class="empty-content">ËØ∑ÂÖàÈÄâÊã©Â∑¶‰æßÂàÜÁ±ª</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeModal('audioModal')">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>
  
  <!-- ÊñáÁ´†ÂàÜ‰∫´Ê®°ÊÄÅÊ°Ü -->
  <div class="modal-overlay" id="articleModal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>ÂàÜ‰∫´Á≤æËØªÊñáÁ´†</h3>
        <button class="close-btn" onclick="closeModal('articleModal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="sidebar">
          <div class="sidebar-section">
            <div class="section-title">ÈÄâÊã©ÂàÜÁ±ª</div>
            <div class="category-list" id="articleCategoryList">
              <div class="category-item" data-category="Reading">Reading</div>
              <div class="category-item" data-category="Listening">Listening</div>
              <div class="category-item" data-category="Writing">Writing</div>
            </div>
          </div>
        </div>
        <div class="content-area">
          <div class="content-header">
            <div class="breadcrumb" id="articleBreadcrumb">ËØ∑ÈÄâÊã©ÂàÜÁ±ª</div>
          </div>
          <div class="content-list" id="articleContentList">
            <div class="empty-content">ËØ∑ÂÖàÈÄâÊã©Â∑¶‰æßÂàÜÁ±ª</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeModal('articleModal')">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>
  
  <!-- ÊåëÊàòÂàõÂª∫Ê®°ÊÄÅÊ°Ü -->
  <div class="modal-overlay" id="challengeModal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>ÂèëËµ∑ËØçÊ±áÊåëÊàò</h3>
        <button class="close-btn" onclick="closeModal('challengeModal')">√ó</button>
      </div>
      <div class="modal-body" style="flex-direction: column;">
        <div style="padding: 20px;">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">ÊåëÊàòÊ†áÈ¢ò</label>
            <input type="text" id="challengeTitle" placeholder="ËæìÂÖ•ÊåëÊàòÊ†áÈ¢ò..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">ÊåëÊàòÊèèËø∞ÔºàÂèØÈÄâÔºâ</label>
            <textarea id="challengeDescription" placeholder="ÊèèËø∞‰∏Ä‰∏ãËøô‰∏™ÊåëÊàò..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; min-height: 60px; resize: vertical; box-sizing: border-box;"></textarea>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">ÈÄâÊã©ÊñáÁ´†</label>
            <div id="challengeArticleList" style="max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; touch-action: pan-y;">
              <div style="text-align: center; padding: 20px; color: #6b7280;">Âä†ËΩΩ‰∏≠...</div>
            </div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">ËØçÊ±áÊï∞Èáè</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button class="word-count-btn active" data-count="5" onclick="selectWordCount(5)">5‰∏™</button>
              <button class="word-count-btn" data-count="10" onclick="selectWordCount(10)">10‰∏™</button>
              <button class="word-count-btn" data-count="15" onclick="selectWordCount(15)">15‰∏™</button>
              <span style="margin: 0 8px; color: #6b7280;">Êàñ</span>
              <input type="number" id="customWordCount" placeholder="Ëá™ÂÆö‰πâ" min="1" max="50" style="width: 80px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
            </div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">@ Áî®Êà∑ÔºàÂèØÈÄâÔºâ</label>
            <div id="challengeUserList" style="max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; touch-action: pan-y;">
              <div style="text-align: center; padding: 20px; color: #6b7280;">Âä†ËΩΩ‰∏≠...</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeModal('challengeModal')">ÂèñÊ∂à</button>
        <button class="modal-btn primary" onclick="createChallenge()">ÂàõÂª∫ÊåëÊàò</button>
      </div>
    </div>
  </div>

  <!-- ÊåëÊàòÊ∏∏ÊàèÊ®°ÊÄÅÊ°Ü -->
  <div class="modal-overlay" id="challengeGameModal" style="background: rgba(0,0,0,0.9);">
    <div class="modal" style="max-width: 600px; max-height: 90vh;">
      <div class="modal-header">
        <h3 id="challengeGameTitle">ËØçÊ±áÊåëÊàò</h3>
        <div id="challengeProgress" style="color: #6b7280; font-size: 14px;"></div>
      </div>
      <div class="modal-body" style="flex-direction: column; padding: 30px;">
        <div id="challengeTimer" style="text-align: center; margin-bottom: 20px; font-size: 24px; font-weight: 700; color: #ef4444;"></div>
        
        <div id="challengeQuestion" style="text-align: center; margin-bottom: 30px; font-size: 20px; font-weight: 600; color: #1f2937; min-height: 60px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 12px; padding: 20px;"></div>
        
        <div id="challengeOptions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <!-- ÈÄâÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
        </div>
        
        <div id="challengeResult" style="display: none; text-align: center; margin-top: 20px; padding: 20px; border-radius: 12px;"></div>
      </div>
    </div>
  </div>

  <!-- ÊåëÊàòÊéíÂêçÊ®°ÊÄÅÊ°Ü -->
  <div class="modal-overlay" id="challengeRankingModal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3 id="rankingTitle">ÊåëÊàòÊéíÂêç</h3>
        <button class="close-btn" onclick="closeModal('challengeRankingModal')">√ó</button>
      </div>
      <div class="modal-body" style="flex-direction: column; padding: 20px;">
        <div id="challengeInfo" style="text-align: center; margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 12px; color: #6b7280;"></div>
        <div id="rankingList" style="flex: 1; overflow-y: auto;">
          <!-- ÊéíÂêçÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn primary" onclick="closeModal('challengeRankingModal')">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>
  
  <!-- ÂõæÁâáÊîæÂ§ßÊ®°ÊÄÅÊ°Ü -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <div class="close-hint">ÁÇπÂáª‰ªªÊÑè‰ΩçÁΩÆÂÖ≥Èó≠</div>
    <img id="modalImage" src="" alt="ÊîæÂ§ßÂõæÁâá">
  </div>
  
  <!-- ÈöêËóèÁöÑÊñá‰ª∂‰∏ä‰º†input -->
  <input type="file" id="imageUpload" accept="image/*" style="display: none" onchange="handleImageUpload(event)">
  
  <script>
    let currentUser = null;
    let authToken = null;
    let selectedItems = {
      audios: [],
      articles: [],
      images: [],
      challenge: null
    };
    
    // ÊåëÊàòÁõ∏ÂÖ≥ÂèòÈáè
    let challengeData = {
      selectedArticles: [],
      selectedUsers: [],
      wordCount: 5
    };
    let currentChallenge = null;
    let currentChallengeAnswers = [];
    let currentQuestionIndex = 0;
    let challengeTimer = null;
    let questionStartTime = 0;
    let currentQuestionType = null; // 'word_to_meaning' Êàñ 'meaning_to_word'
    let pendingChallenges = [];
    
    // ËØÑËÆ∫ÂäüËÉΩÂèòÈáè
    let currentCommentPostId = null;
    let commentSelectedItems = {
      audios: [],
      articles: [],
      images: [],
      challenge: null
    };
    
    // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
    function checkStoredToken(){
      const tk = localStorage.getItem('authToken');
      if(!tk) return Promise.resolve(false);
      return fetch('/verify_token',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({token:tk})})
        .then(r=>r.json()).then(d=>{ 
          if(d.valid){ 
            authToken=tk; 
            // Â∞ùËØïËé∑ÂèñÂ≠òÂÇ®ÁöÑÁî®Êà∑‰ø°ÊÅØ
            const userStr = localStorage.getItem('currentUser');
            if(userStr) {
              try {
                currentUser = JSON.parse(userStr);
              } catch(e) {}
            }
            return true;
          } 
          localStorage.removeItem('authToken'); 
          localStorage.removeItem('currentUser');
          return false; 
        })
        .catch(()=>{ 
          localStorage.removeItem('authToken'); 
          localStorage.removeItem('currentUser');
          return false; 
        });
    }
    
    function redirectToLogin() {
      window.location.href = '/login';
    }
    
    // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
    window.onload = function() {
      // È¶ñÂÖàÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
      checkStoredToken().then(valid=>{
        if(!valid) {
          redirectToLogin();
          return;
        }
        
        // ÁôªÂΩïÊàêÂäüÂêéÁªßÁª≠ÂàùÂßãÂåñ
        showUserInfo();
        loadPosts();
        checkPendingChallenges();
      });
    };
    
    // ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØ
    function showUserInfo() {
      if(currentUser) {
        document.getElementById('userAvatarSmall').src = `/static/${currentUser.avatar}`;
        document.getElementById('userDisplayName').textContent = currentUser.display_name;
      }
    }
    
    // ÂàáÊç¢Êñ∞Â∏ñË°®Âçï
    function toggleNewPostForm() {
      const form = document.getElementById('newPostForm');
      form.classList.toggle('active');
      if (form.classList.contains('active')) {
        document.getElementById('postContent').focus();
      }
    }
    
    // ÂèñÊ∂àÊñ∞Â∏ñ
    function cancelNewPost() {
      document.getElementById('newPostForm').classList.remove('active');
      document.getElementById('postContent').value = '';
      document.getElementById('extraContentArea').innerHTML = '';
      
      // Ê∏ÖÁ©∫ÊâÄÊúâÈÄâÊã©
      selectedItems = {
        audios: [],
        articles: [],
        images: [],
        challenge: null
      };
    }
    
    // Êõ¥Êñ∞ÂÜÖÂÆπÈ¢ÑËßàÂå∫Âüü
    function updateContentPreview() {
      const extraArea = document.getElementById('extraContentArea');
      extraArea.innerHTML = '';
      
      // ÊòæÁ§∫ÊâÄÊúâÈÄâ‰∏≠ÁöÑÂÜÖÂÆπ
      selectedItems.audios.forEach((audio, index) => {
        extraArea.appendChild(createAudioPreview(audio, index));
      });
      
      selectedItems.articles.forEach((article, index) => {
        extraArea.appendChild(createArticlePreview(article, index));
      });
      
      selectedItems.images.forEach((image, index) => {
        extraArea.appendChild(createImagePreview(image, index));
      });
      
      // ÊòæÁ§∫ÊåëÊàòÂÜÖÂÆπ
      if (selectedItems.challenge) {
        extraArea.appendChild(createChallengePreview(selectedItems.challenge, 0));
      }
    }
    
    // Êèê‰∫§Â∏ñÂ≠ê
    function submitPost() {
      const content = document.getElementById('postContent').value.trim();
      if (!content && selectedItems.audios.length === 0 && selectedItems.articles.length === 0 && selectedItems.images.length === 0 && !selectedItems.challenge) {
        alert('ËØ∑ËæìÂÖ•ÂÜÖÂÆπÊàñÊ∑ªÂä†ÂàÜ‰∫´ÂÜÖÂÆπ');
        return;
      }
      
      let postData = {
        type: 'mixed_content',
        content: {
          text: content,
          audios: selectedItems.audios,
          articles: selectedItems.articles,
          images: selectedItems.images,
          challenge: selectedItems.challenge
        }
      };
      
      postMessage(postData);
    }
    
    // ÊòæÁ§∫ÂõæÁâá‰∏ä‰º†Âô®
    function showImageUploader() {
      const extraArea = document.getElementById('extraContentArea');
      extraArea.innerHTML = `
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
          <label class="form-label">‰∏ä‰º†ÂõæÁâá</label>
          <input type="file" accept="image/*,.heic,.heif" onchange="handleImageUpload(event)" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px;">
          <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
            ÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF„ÄÅWebP„ÄÅHEIC Ê†ºÂºèÔºåÊúÄÂ§ß 10MB<br>
            <span style="color: #059669;">‚úì Ëá™Âä®Â§ÑÁêÜËãπÊûúHEICÊ†ºÂºè</span> ‚Ä¢
            <span style="color: #059669;">‚úì Ëá™Âä®ÂéãÁº©‰ºòÂåñ</span> ‚Ä¢
            <span style="color: #059669;">‚úì Ëá™Âä®ÊóãËΩ¨Á∫†Ê≠£</span>
          </div>
        </div>
      `;
    }
    
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      console.log('‰∏ä‰º†Êñá‰ª∂‰ø°ÊÅØ:', {
        name: file.name,
        type: file.type,
        size: file.size,
        lastModified: file.lastModified
      });
      
      // Êâ©Â±ïÁöÑÊñá‰ª∂Á±ªÂûãÊîØÊåÅ
      const allowedTypes = [
        'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',
        'image/heic', 'image/heif', 'image/avif'
      ];
      
      // Ê£ÄÊü•Êñá‰ª∂Êâ©Â±ïÂêçÔºà‰Ωú‰∏∫MIMEÁ±ªÂûãÁöÑÂêéÂ§áÔºâ
      const fileExtension = file.name.toLowerCase().split('.').pop();
      const allowedExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'heif', 'avif'];
      
      const isValidType = allowedTypes.includes(file.type) || allowedExtensions.includes(fileExtension);
      
      if (!isValidType) {
        alert('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊ†ºÂºèÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWebP„ÄÅHEICÔºâ\nÂΩìÂâçÊñá‰ª∂Á±ªÂûãÔºö' + (file.type || 'Êú™Áü•'));
        event.target.value = '';
        return;
      }
      
      // È™åËØÅÊñá‰ª∂Â§ßÂ∞èÔºà10MBÔºâ
      if (file.size > 10 * 1024 * 1024) {
        alert(`ÂõæÁâáÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá10MB\nÂΩìÂâçÊñá‰ª∂Â§ßÂ∞èÔºö${(file.size / 1024 / 1024).toFixed(2)}MB`);
        event.target.value = '';
        return;
      }
      
      // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶ÂíåÁä∂ÊÄÅ
      const uploadBtn = event.target;
      const originalText = uploadBtn.parentNode.querySelector('label').textContent;
      const statusDiv = uploadBtn.parentNode.querySelector('div');
      
      uploadBtn.disabled = true;
      uploadBtn.style.opacity = '0.6';
      uploadBtn.parentNode.querySelector('label').textContent = 'Ê≠£Âú®‰∏ä‰º†...';
      statusDiv.innerHTML = `
        <div style="color: #0284c7; font-weight: 500;">
          üì§ Ê≠£Âú®Â§ÑÁêÜÂõæÁâáÔºåËØ∑Á®çÂÄô...
        </div>
      `;
      
      const formData = new FormData();
      formData.append('image', file);
      formData.append('user_id', currentUser.username);
      
      fetch('/api/upload_message_image', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // Ê∑ªÂä†Âà∞ÈÄâ‰∏≠ÂàóË°®
          selectedItems.images.push({
            filename: data.filename,
            caption: ''
          });
          
          updateContentPreview();
          
          // ÊòæÁ§∫ÊàêÂäüÁä∂ÊÄÅ
          statusDiv.innerHTML = `
            <div style="color: #059669; font-weight: 500;">
              ‚úÖ ÂõæÁâá‰∏ä‰º†ÊàêÂäüÔºÅÂ∑≤Ëá™Âä®‰ºòÂåñÂ§ÑÁêÜ
            </div>
          `;
          
        } else {
          console.error('ÊúçÂä°Âô®ËøîÂõûÈîôËØØ:', data);
          alert('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
          
          // ÊòæÁ§∫ÈîôËØØÁä∂ÊÄÅ
          statusDiv.innerHTML = `
            <div style="color: #dc2626; font-weight: 500;">
              ‚ùå ‰∏ä‰º†Â§±Ë¥•Ôºö${data.error || 'Êú™Áü•ÈîôËØØ'}
            </div>
          `;
        }
      })
      .catch(e => {
        console.error('ÂõæÁâá‰∏ä‰º†ÈîôËØØ:', e);
        alert('‰∏ä‰º†Â§±Ë¥•ÔºöÁΩëÁªúÈîôËØØÊàñÊúçÂä°Âô®ÂºÇÂ∏∏');
        
        // ÊòæÁ§∫ÈîôËØØÁä∂ÊÄÅ
        statusDiv.innerHTML = `
          <div style="color: #dc2626; font-weight: 500;">
            ‚ùå ÁΩëÁªúÈîôËØØÔºö${e.message}
          </div>
        `;
      })
      .finally(() => {
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = '1';
        uploadBtn.parentNode.querySelector('label').textContent = originalText;
        // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©
        event.target.value = '';
        
        // 3ÁßíÂêéÊÅ¢Â§çÁä∂ÊÄÅÊèêÁ§∫
        setTimeout(() => {
          if (statusDiv) {
            statusDiv.innerHTML = `
              ÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF„ÄÅWebP„ÄÅHEIC Ê†ºÂºèÔºåÊúÄÂ§ß 10MB<br>
              <span style="color: #059669;">‚úì Ëá™Âä®Â§ÑÁêÜËãπÊûúHEICÊ†ºÂºè</span> ‚Ä¢
              <span style="color: #059669;">‚úì Ëá™Âä®ÂéãÁº©‰ºòÂåñ</span> ‚Ä¢
              <span style="color: #059669;">‚úì Ëá™Âä®ÊóãËΩ¨Á∫†Ê≠£</span>
            `;
          }
        }, 3000);
      });
    }
    
    // ÂàõÂª∫Èü≥È¢ëÈ¢ÑËßàÁªÑ‰ª∂
    function createAudioPreview(audio, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      // ÂàõÂª∫Ê†áÈ¢òÂíåÁßªÈô§ÊåâÈíÆ
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';
      
      const label = document.createElement('label');
      label.className = 'form-label';
      label.textContent = audio.type === 'single' ? `Èü≥È¢ë ${index + 1}` : `ÂêàÈõÜÈü≥È¢ë ${index + 1}`;
      
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'ÁßªÈô§';
      removeBtn.style.cssText = 'background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;';
      removeBtn.onclick = () => removeSelectedItem('audios', index);
      
      headerDiv.appendChild(label);
      headerDiv.appendChild(removeBtn);
      div.appendChild(headerDiv);
      
      // ÂàõÂª∫ÂÜÖÂÆπÂç°Áâá
      const cardDiv = document.createElement('div');
      
      if (audio.type === 'single') {
        cardDiv.style.cssText = 'padding: 16px; background: #f0f9ff; border: 1px solid #0284c7; border-radius: 12px;';
        
        // Ê†áÈ¢òÈÉ®ÂàÜ
        const titleDiv = document.createElement('div');
        titleDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; margin-bottom: 12px;';
        titleDiv.innerHTML = `
          <span style="font-size: 20px;">üé§</span>
          <div>
            <div style="font-weight: 600; color: #0c4a6e;">${audio.filename.replace('.mp3', '')}</div>
            <div style="color: #0369a1; font-size: 12px;">Êù•Ëá™Ôºö${audio.folder}</div>
          </div>
        `;
        cardDiv.appendChild(titleDiv);
        
        // ÈóÆÈ¢òÊèèËø∞ÔºàÊîØÊåÅÊç¢Ë°åÔºâ
        if (audio.question) {
          const questionDiv = document.createElement('div');
          questionDiv.style.cssText = 'color: #075985; font-size: 13px; margin-bottom: 8px; line-height: 1.4; white-space: pre-wrap;';
          questionDiv.textContent = audio.question;
          cardDiv.appendChild(questionDiv);
        }
      } else {
        cardDiv.style.cssText = 'padding: 16px; background: #fef9c3; border: 1px solid #eab308; border-radius: 12px;';
        
        // Ê†áÈ¢òÈÉ®ÂàÜ
        const titleDiv = document.createElement('div');
        titleDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; margin-bottom: 12px;';
        titleDiv.innerHTML = `
          <span style="font-size: 20px;">üéµ</span>
          <div>
            <div style="font-weight: 600; color: #92400e;">${audio.folder}</div>
            <div style="color: #a16207; font-size: 12px;">${audio.file_count} ‰∏™Èü≥È¢ëÁöÑÂêàÈõÜ</div>
          </div>
        `;
        cardDiv.appendChild(titleDiv);
        
        // ÈóÆÈ¢òÊèèËø∞ÔºàÊîØÊåÅÊç¢Ë°åÔºâ
        if (audio.question) {
          const questionDiv = document.createElement('div');
          questionDiv.style.cssText = 'color: #a16207; font-size: 13px; margin-bottom: 8px; line-height: 1.4; white-space: pre-wrap;';
          questionDiv.textContent = audio.question;
          cardDiv.appendChild(questionDiv);
        }
      }
      
      div.appendChild(cardDiv);
      return div;
    }
    
    // ÂàõÂª∫ÊñáÁ´†È¢ÑËßàÁªÑ‰ª∂
    function createArticlePreview(article, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label class="form-label">ÊñáÁ´† ${index + 1}</label>
          <button onclick="removeSelectedItem('articles', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ÁßªÈô§</button>
        </div>
        <div style="padding: 16px; background: #f0fdf4; border: 1px solid #16a34a; border-radius: 12px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 20px;">üìù</span>
            <div>
              <div style="font-weight: 600; color: #14532d;">${article.title}</div>
              <div style="color: #15803d; font-size: 12px;">${article.category} ‚Ä¢ ${article.highlight_count} ‰∏™È´ò‰∫ÆËØçÊ±á</div>
            </div>
          </div>
        </div>
      `;
      
      return div;
    }
    
    // ÂàõÂª∫ÂõæÁâáÈ¢ÑËßàÁªÑ‰ª∂
    function createImagePreview(image, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label class="form-label">ÂõæÁâá ${index + 1}</label>
          <button onclick="removeSelectedItem('images', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ÁßªÈô§</button>
        </div>
        <div style="padding: 16px; background: #fef7ff; border: 1px solid #a855f7; border-radius: 12px;">
          <img src="/message_images/${image.filename}" alt="È¢ÑËßàÂõæÁâá" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
        </div>
      `;
      
      return div;
    }
    
    // ÁßªÈô§ÈÄâ‰∏≠ÁöÑÈ°πÁõÆ
    function removeSelectedItem(type, index) {
      if (type === 'challenge') {
        selectedItems.challenge = null;
      } else {
        selectedItems[type].splice(index, 1);
      }
      updateContentPreview();
    }
    
    // ÊòæÁ§∫Èü≥È¢ëÈÄâÊã©Âô®
    function showAudioSelector() {
      document.getElementById('audioModal').style.display = 'flex';
      // ÈòªÊ≠¢ËÉåÊôØÊªöÂä®
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      resetAudioModal();
      loadAudioList();
    }
    
    // ÊòæÁ§∫ÊñáÁ´†ÈÄâÊã©Âô®
    function showArticleSelector() {
      document.getElementById('articleModal').style.display = 'flex';
      // ÈòªÊ≠¢ËÉåÊôØÊªöÂä®
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      resetArticleModal();
      loadArticleList();
    }
    
    // ÈáçÁΩÆÈü≥È¢ëÊ®°ÊÄÅÊ°Ü
    function resetAudioModal() {
      document.querySelectorAll('#audioCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById('audioBreadcrumb').textContent = 'ËØ∑ÈÄâÊã©ÂàÜÁ±ª';
      document.getElementById('audioContentList').innerHTML = '<div class="empty-content">ËØ∑ÂÖàÈÄâÊã©Â∑¶‰æßÂàÜÁ±ª</div>';
    }
    
    // ÈáçÁΩÆÊñáÁ´†Ê®°ÊÄÅÊ°Ü
    function resetArticleModal() {
      document.querySelectorAll('#articleCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById('articleBreadcrumb').textContent = 'ËØ∑ÈÄâÊã©ÂàÜÁ±ª';
      document.getElementById('articleContentList').innerHTML = '<div class="empty-content">ËØ∑ÂÖàÈÄâÊã©Â∑¶‰æßÂàÜÁ±ª</div>';
    }
    
    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
    }
    
    // Âä†ËΩΩÈü≥È¢ëÂàóË°®
    function loadAudioList() {
      fetch('/api/get_audio_list')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            audioData = data.categories;
            setupAudioModal();
          }
        })
        .catch(e => console.error('Âä†ËΩΩÈü≥È¢ëÂàóË°®Â§±Ë¥•:', e));
    }
    
    let audioData = {};
    let articleData = {};
    
    // ËÆæÁΩÆÈü≥È¢ëÊ®°ÊÄÅÊ°Ü
    function setupAudioModal() {
      const categoryItems = document.querySelectorAll('#audioCategoryList .category-item');
      categoryItems.forEach(item => {
        item.onclick = () => {
          const category = item.dataset.category;
          selectAudioCategory(category, item);
        };
      });
    }
    
    // ÈÄâÊã©Èü≥È¢ëÂàÜÁ±ª
    function selectAudioCategory(category, itemEl) {
      // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
      document.querySelectorAll('#audioCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      itemEl.classList.add('active');
      
      // Êõ¥Êñ∞Èù¢ÂåÖÂ±ë
      document.getElementById('audioBreadcrumb').textContent = category;
      
      // Ê∏≤ÊüìÂÜÖÂÆπ
      renderAudioContent(category);
    }
    
    // Ê∏≤ÊüìÈü≥È¢ëÂÜÖÂÆπ
    function renderAudioContent(category) {
      const contentList = document.getElementById('audioContentList');
      const items = audioData[category] || [];
      
      if (items.length === 0) {
        contentList.innerHTML = '<div class="empty-content">ËØ•ÂàÜÁ±ª‰∏ãÊöÇÊó†ÂÜÖÂÆπ</div>';
        return;
      }
      
      contentList.innerHTML = '';
      items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'content-item';
        
        const titleEl = document.createElement('div');
        titleEl.className = 'content-item-title';
        titleEl.textContent = item.folder;
        
        const metaEl = document.createElement('div');
        metaEl.className = 'content-item-meta';
        let metaText = `${item.file_count} ‰∏™Èü≥È¢ë`;
        if (item.has_combined) metaText += ' ‚Ä¢ ÊúâÂêàÈõÜ';
        if (item.question) metaText += ` ‚Ä¢ ${item.question.substring(0, 40)}...`;
        metaEl.textContent = metaText;
        
        const actionsEl = document.createElement('div');
        actionsEl.className = 'content-item-actions';
        
        // ÂçïÁã¨Èü≥È¢ëÊåâÈíÆ
        const singleBtn = document.createElement('button');
        singleBtn.className = 'content-item-btn';
        singleBtn.textContent = 'ÂàÜ‰∫´ÂçïÁã¨Èü≥È¢ë';
        singleBtn.onclick = (e) => {
          e.stopPropagation();
          selectAudioItem(item, 'single', itemEl);
        };
        
        actionsEl.appendChild(singleBtn);
        
        // ÂêàÈõÜÈü≥È¢ëÊåâÈíÆÔºàÂ¶ÇÊûúÊúâÂêàÈõÜÔºâ
        if (item.has_combined) {
          const combinedBtn = document.createElement('button');
          combinedBtn.className = 'content-item-btn primary';
          combinedBtn.textContent = 'ÂàÜ‰∫´ÂêàÈõÜÈü≥È¢ë';
          combinedBtn.onclick = (e) => {
            e.stopPropagation();
            selectAudioItem(item, 'combined', itemEl);
          };
          actionsEl.appendChild(combinedBtn);
        }
        
        itemEl.appendChild(titleEl);
        itemEl.appendChild(metaEl);
        itemEl.appendChild(actionsEl);
        
        contentList.appendChild(itemEl);
      });
    }
    
    // ÈÄâÊã©Èü≥È¢ëÈ°πÁõÆ
    function selectAudioItem(item, type, itemEl) {
      if (type === 'single') {
        // Âú®ÂΩìÂâçÈ°πÁõÆ‰∏ãÂ±ïÂºÄÂçï‰∏™Èü≥È¢ëÈÄâÊã©
        showIndividualAudioInline(item, itemEl);
      } else {
        // Âú®ÂΩìÂâçÈ°πÁõÆ‰∏ãÂ±ïÂºÄÂêàÈõÜÈü≥È¢ëÈÄâÊã©
        showCombinedAudioInline(item, itemEl);
      }
    }
    
    // Âú®Ë°åÂÜÖÂ±ïÂºÄÂçï‰∏™Èü≥È¢ëÈÄâÊã©
    function showIndividualAudioInline(item, itemEl) {
      // ÁßªÈô§ÂÖ∂‰ªñÂ±ïÂºÄÁöÑÂÜÖÂÆπ
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // Ëé∑ÂèñÂÖ∑‰ΩìÈü≥È¢ëÊñá‰ª∂ÂàóË°®
      fetch(`/list_audio`)
        .then(r => r.json())
        .then(data => {
          if (data) {
            // ÊâæÂà∞ÂØπÂ∫îÁöÑÊñá‰ª∂Â§πËØ¶ÁªÜ‰ø°ÊÅØ
            let folderData = null;
            Object.keys(data).forEach(category => {
              const found = data[category].find(f => f.folder === item.folder);
              if (found) folderData = found;
            });
            
            if (folderData && folderData.files) {
              renderIndividualAudioInline(item, folderData.files, itemEl);
            }
          }
        })
        .catch(e => console.error('Ëé∑ÂèñÈü≥È¢ëÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', e));
    }
    
    // Âú®Ë°åÂÜÖÂ±ïÂºÄÂêàÈõÜÈü≥È¢ëÈÄâÊã©
    function showCombinedAudioInline(item, itemEl) {
      // ÁßªÈô§ÂÖ∂‰ªñÂ±ïÂºÄÁöÑÂÜÖÂÆπ
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // ÂàõÂª∫ÂêàÈõÜÈü≥È¢ëÂ±ïÂºÄÂÜÖÂÆπ
      const expandedDiv = document.createElement('div');
      expandedDiv.className = 'expanded-content';
      expandedDiv.style.cssText = `
        margin-top: 12px; 
        padding: 16px; 
        background: #fef9c3; 
        border: 1px solid #eab308; 
        border-radius: 8px;
      `;
      
      // ÂàõÂª∫Ê†áÈ¢òÂíåÊî∂Ëµ∑ÊåâÈíÆÈÉ®ÂàÜ
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
      
      const titleDiv = document.createElement('div');
      titleDiv.innerHTML = `
        <div style="font-weight: 600; color: #92400e; font-size: 13px;">ÂêàÈõÜÈü≥È¢ëÈ¢ÑËßà</div>
        <div style="color: #a16207; font-size: 11px;">${item.file_count} ‰∏™Èü≥È¢ëÁöÑÂêàÈõÜ</div>
      `;
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Êî∂Ëµ∑';
      closeBtn.style.cssText = 'background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px;';
      closeBtn.onclick = () => expandedDiv.remove();
      
      headerDiv.appendChild(titleDiv);
      headerDiv.appendChild(closeBtn);
      expandedDiv.appendChild(headerDiv);
      
      // Ê∑ªÂä†ÈóÆÈ¢òÊèèËø∞ÔºàÊîØÊåÅÊç¢Ë°åÔºâ
      if (item.question) {
        const questionDiv = document.createElement('div');
        questionDiv.style.cssText = 'color: #a16207; font-size: 12px; margin-bottom: 8px; line-height: 1.4; white-space: pre-wrap;';
        questionDiv.textContent = item.question;
        expandedDiv.appendChild(questionDiv);
      }
      
      // Ê∑ªÂä†Âà∞Â∏ñÂ≠êÊåâÈíÆ
      const addBtn = document.createElement('button');
      addBtn.textContent = 'Ê∑ªÂä†Âà∞Â∏ñÂ≠ê';
      addBtn.style.cssText = 'background: #0284c7; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 11px;';
      addBtn.onclick = () => {
        addCombinedAudio(item.folder, item.file_count, item.has_combined, item.question || '');
      };
      expandedDiv.appendChild(addBtn);
      
      itemEl.appendChild(expandedDiv);
    }
    
    // Âú®Ë°åÂÜÖÊ∏≤ÊüìÂçï‰∏™Èü≥È¢ëÊñá‰ª∂
    function renderIndividualAudioInline(folderItem, files, itemEl) {
      const expandedDiv = document.createElement('div');
      expandedDiv.className = 'expanded-content';
      expandedDiv.style.cssText = `
        margin-top: 12px; 
        padding: 16px; 
        background: #f0f9ff; 
        border: 1px solid #0284c7; 
        border-radius: 8px;
      `;
      
      let filesHtml = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="font-weight: 600; color: #0c4a6e; font-size: 13px;">ÈÄâÊã©ÂÖ∑‰ΩìÈü≥È¢ëÊñá‰ª∂</div>
          <button onclick="this.closest('.expanded-content').remove()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px;">Êî∂Ëµ∑</button>
        </div>
        <div style="max-height: 200px; overflow-y: auto;">
      `;
      
      files.forEach((file, index) => {
        filesHtml += `
          <div style="padding: 8px 12px; border: 1px solid #e0f2fe; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;" 
               onmouseover="this.style.background='#e0f2fe'" 
               onmouseout="this.style.background=''" 
               onclick="selectIndividualAudioFile('${folderItem.folder}', '${file.name}', '${file.question || ''}')">
            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px; font-size: 13px;">${file.name.replace('.mp3', '')}</div>
            ${file.question ? `<div style="color: #6b7280; font-size: 11px; line-height: 1.4;">${file.question}</div>` : ''}
          </div>
        `;
      });
      
      filesHtml += '</div>';
      expandedDiv.innerHTML = filesHtml;
      itemEl.appendChild(expandedDiv);
    }
    
    // ÈÄâÊã©Âçï‰∏™Èü≥È¢ëÊñá‰ª∂
    function selectIndividualAudioFile(folder, filename, question) {
      // ÁßªÈô§Â±ïÂºÄÂÜÖÂÆπ
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // Ê∑ªÂä†Âà∞ÈÄâ‰∏≠ÂàóË°®
      const audioItem = {
        folder: folder,
        filename: filename,
        question: question,
        type: 'single'
      };
      
      if (currentCommentPostId) {
        // ËØÑËÆ∫Ê®°Âºè
        commentSelectedItems.audios.push(audioItem);
        updateCommentPreview(currentCommentPostId);
        currentCommentPostId = null;
      } else {
        // Â∏ñÂ≠êÊ®°Âºè
        selectedItems.audios.push(audioItem);
        updateContentPreview();
      }
      closeModal('audioModal');
    }
    
    // Ê∑ªÂä†ÂêàÈõÜÈü≥È¢ë
    function addCombinedAudio(folder, fileCount, hasCombined, question) {
      // ÁßªÈô§Â±ïÂºÄÂÜÖÂÆπ
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // Ê∑ªÂä†Âà∞ÈÄâ‰∏≠ÂàóË°®
      const audioItem = {
        folder: folder,
        file_count: fileCount,
        has_combined: hasCombined,
        question: question,
        type: 'combined'
      };
      
      if (currentCommentPostId) {
        // ËØÑËÆ∫Ê®°Âºè
        commentSelectedItems.audios.push(audioItem);
        updateCommentPreview(currentCommentPostId);
        currentCommentPostId = null;
      } else {
        // Â∏ñÂ≠êÊ®°Âºè
        selectedItems.audios.push(audioItem);
        updateContentPreview();
      }
      closeModal('audioModal');
    }
    

    

    
    // Âä†ËΩΩÊñáÁ´†ÂàóË°®
    function loadArticleList() {
      fetch('/api/get_articles_list')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            articleData = data.categories;
            setupArticleModal();
          }
        })
        .catch(e => console.error('Âä†ËΩΩÊñáÁ´†ÂàóË°®Â§±Ë¥•:', e));
    }
    
    // ËÆæÁΩÆÊñáÁ´†Ê®°ÊÄÅÊ°Ü
    function setupArticleModal() {
      const categoryItems = document.querySelectorAll('#articleCategoryList .category-item');
      categoryItems.forEach(item => {
        item.onclick = () => {
          const category = item.dataset.category;
          selectArticleCategory(category, item);
        };
      });
    }
    
    // ÈÄâÊã©ÊñáÁ´†ÂàÜÁ±ª
    function selectArticleCategory(category, itemEl) {
      // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
      document.querySelectorAll('#articleCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      itemEl.classList.add('active');
      
      // Êõ¥Êñ∞Èù¢ÂåÖÂ±ë
      document.getElementById('articleBreadcrumb').textContent = category;
      
      // Ê∏≤ÊüìÂÜÖÂÆπ
      renderArticleContent(category);
    }
    
    // Ê∏≤ÊüìÊñáÁ´†ÂÜÖÂÆπ
    function renderArticleContent(category) {
      const contentList = document.getElementById('articleContentList');
      const items = articleData[category] || [];
      
      if (items.length === 0) {
        contentList.innerHTML = '<div class="empty-content">ËØ•ÂàÜÁ±ª‰∏ãÊöÇÊó†ÂÜÖÂÆπ</div>';
        return;
      }
      
      contentList.innerHTML = '';
      items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'content-item';
        itemEl.onclick = () => selectArticleItem(item, itemEl);
        
        const titleEl = document.createElement('div');
        titleEl.className = 'content-item-title';
        titleEl.textContent = item.title;
        
        const metaEl = document.createElement('div');
        metaEl.className = 'content-item-meta';
        metaEl.textContent = `${item.highlight_count} ‰∏™È´ò‰∫ÆËØçÊ±á`;
        
        itemEl.appendChild(titleEl);
        itemEl.appendChild(metaEl);
        contentList.appendChild(itemEl);
      });
    }
    
    // ÈÄâÊã©ÊñáÁ´†È°πÁõÆ
    function selectArticleItem(item, itemEl) {
      // Ê∑ªÂä†Âà∞ÈÄâ‰∏≠ÂàóË°®
      if (currentCommentPostId) {
        // ËØÑËÆ∫Ê®°Âºè
        commentSelectedItems.articles.push(item);
        updateCommentPreview(currentCommentPostId);
        currentCommentPostId = null;
      } else {
        // Â∏ñÂ≠êÊ®°Âºè
        selectedItems.articles.push(item);
        updateContentPreview();
      }
      closeModal('articleModal');
    }
    

    

    
    // ÂèëÈÄÅÊ∂àÊÅØÂà∞ÊúçÂä°Âô®
    function postMessage(message) {
      // Ê∑ªÂä†tokenÂà∞ËØ∑Ê±Ç‰Ωì
      message.token = authToken;
      
      fetch('/api/messages', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(message)
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // ÂÖ≥Èó≠Êñ∞Â∏ñË°®Âçï
          cancelNewPost();
          // Á´ãÂç≥Â∞ÜÊñ∞Â∏ñÊ∑ªÂä†Âà∞ÂàóË°®È°∂ÈÉ®ÔºåËÄå‰∏çÊòØÈáçÊñ∞Âä†ËΩΩÊï¥‰∏™ÂàóË°®
          addNewPostToTop(data.message);
        } else {
          alert('ÂèëÈÄÅÂ§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
        }
      })
      .catch(e => {
        alert('ÂèëÈÄÅÂ§±Ë¥•Ôºö' + e.message);
      });
    }
    
    // Â∞ÜÊñ∞Â∏ñÊ∑ªÂä†Âà∞ÂàóË°®È°∂ÈÉ®
    function addNewPostToTop(newPost) {
      const postsList = document.getElementById('postsList');
      const emptyState = document.getElementById('emptyState');
      
      // ÈöêËóèÁ©∫Áä∂ÊÄÅ
      if (emptyState) {
        emptyState.style.display = 'none';
      }
      
      // ÂàõÂª∫Êñ∞Â∏ñÂÖÉÁ¥†
      const newPostEl = createPostElement(newPost);
      
      // Ê∑ªÂä†Âà∞ÂàóË°®È°∂ÈÉ®
      if (postsList.firstChild) {
        postsList.insertBefore(newPostEl, postsList.firstChild);
      } else {
        postsList.appendChild(newPostEl);
      }
      
      // Ê∑ªÂä†‰∏Ä‰∏™ËΩªÂæÆÁöÑÂä®ÁîªÊïàÊûú
      newPostEl.style.opacity = '0';
      newPostEl.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        newPostEl.style.transition = 'all 0.3s ease';
        newPostEl.style.opacity = '1';
        newPostEl.style.transform = 'translateY(0)';
      }, 100);
    }
    
    // Âä†ËΩΩÊâÄÊúâÂ∏ñÂ≠ê
    function loadPosts() {
      fetch('/api/messages')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            renderPosts(data.messages);
          }
        })
        .catch(e => console.error('Âä†ËΩΩÂ∏ñÂ≠êÂ§±Ë¥•:', e));
    }
    
    // Ê∏≤ÊüìÂ∏ñÂ≠êÂàóË°®
    function renderPosts(posts) {
      const container = document.getElementById('postsList');
      const emptyState = document.getElementById('emptyState');
      
      if (posts.length === 0) {
        emptyState.style.display = 'block';
        return;
      } else {
        emptyState.style.display = 'none';
      }
      
      container.innerHTML = '';
      
      posts.forEach(post => {
        const postEl = createPostElement(post);
        container.appendChild(postEl);
      });
    }
    
    // ÂàõÂª∫Â∏ñÂ≠êÂÖÉÁ¥†
    function createPostElement(post) {
      const postEl = document.createElement('div');
      postEl.className = 'post-card';
      postEl.setAttribute('data-post-id', post.id);
      
      const header = document.createElement('div');
      header.className = 'post-header';
      
      const avatar = document.createElement('img');
      avatar.className = 'user-avatar';
      avatar.src = `/static/${post.user.avatar}`;
      avatar.alt = post.user.display_name;
      
      const userInfo = document.createElement('div');
      userInfo.className = 'post-user-info';
      
      const userName = document.createElement('div');
      userName.className = 'user-name';
      userName.textContent = post.user.display_name;
      
      const time = document.createElement('div');
      time.className = 'post-time';
      time.textContent = formatTime(post.timestamp);
      
      userInfo.appendChild(userName);
      userInfo.appendChild(time);
      
      // Â¶ÇÊûúÊòØÂΩìÂâçÁî®Êà∑ÁöÑÂ∏ñÂ≠êÔºåÊ∑ªÂä†Âà†Èô§ÊåâÈíÆÂà∞Âè≥‰∏äËßí
      if (currentUser && post.user.username === currentUser.username) {
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.title = 'Âà†Èô§Â∏ñÂ≠ê';
        deleteBtn.style.cssText = `
          position: absolute;
          top: 0;
          right: 0;
          background: none; 
          border: none; 
          color: #9ca3af; 
          cursor: pointer; 
          font-size: 14px; 
          padding: 6px; 
          border-radius: 6px; 
          transition: all 0.2s;
          opacity: 0.7;
        `;
        deleteBtn.onmouseover = () => {
          deleteBtn.style.background = '#fee2e2';
          deleteBtn.style.color = '#dc2626';
          deleteBtn.style.opacity = '1';
          deleteBtn.style.transform = 'scale(1.1)';
        };
        deleteBtn.onmouseout = () => {
          deleteBtn.style.background = 'none';
          deleteBtn.style.color = '#9ca3af';
          deleteBtn.style.opacity = '0.7';
          deleteBtn.style.transform = 'scale(1)';
        };
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deletePost(post.id);
        };
        header.appendChild(deleteBtn);
      }
      header.appendChild(avatar);
      header.appendChild(userInfo);
      
      const content = document.createElement('div');
      content.className = 'post-content';
      
      // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÊ∏≤Êüì‰∏çÂêåÂÜÖÂÆπ
      let hasContent = false;
      
      if (post.type === 'mixed_content') {
        // ÊñáÂ≠óÂÜÖÂÆπ
        if (post.content.text) {
          const textDiv = document.createElement('div');
          textDiv.className = 'text-content';
          if (hasContent) textDiv.className += ' content-section';
          textDiv.innerHTML = escapeHtml(post.content.text);
          content.appendChild(textDiv);
          hasContent = true;
        }
        
        // Èü≥È¢ëÂÜÖÂÆπ
        if (post.content.audios && post.content.audios.length > 0) {
          post.content.audios.forEach(audio => {
            const audioCard = createAudioCard(audio);
            if (hasContent) audioCard.classList.add('content-section');
            content.appendChild(audioCard);
            hasContent = true;
          });
        }
        
        // ÊñáÁ´†ÂÜÖÂÆπ
        if (post.content.articles && post.content.articles.length > 0) {
          post.content.articles.forEach(article => {
            const articleCard = createArticleCard(article);
            if (hasContent) articleCard.classList.add('content-section');
            content.appendChild(articleCard);
            hasContent = true;
          });
        }
        
        // ÂõæÁâáÂÜÖÂÆπ
        if (post.content.images && post.content.images.length > 0) {
          post.content.images.forEach(image => {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'image-content';
            if (hasContent) imageDiv.classList.add('content-section');
            imageDiv.innerHTML = `<img class="message-image" src="/message_images/${image.filename}" alt="ÂõæÁâá" ondblclick="openImageModal('/message_images/${image.filename}')" title="ÂèåÂáªÊü•ÁúãÂ§ßÂõæ">`;
            content.appendChild(imageDiv);
            hasContent = true;
          });
        }
        
        // ÊåëÊàòÂÜÖÂÆπ
        if (post.content.challenge) {
          const challengeCard = createChallengeCard(post.content.challenge);
          if (hasContent) challengeCard.classList.add('content-section');
          content.appendChild(challengeCard);
          hasContent = true;
        }
      } else if (post.type === 'text') {
        content.innerHTML = `<div class="text-content">${escapeHtml(post.content.text)}</div>        `;
      } else if (post.type === 'image') {
        content.innerHTML = `
          <div class="image-content">
            <img class="message-image" src="/message_images/${post.content.filename}" alt="ÂõæÁâá" ondblclick="openImageModal('/message_images/${post.content.filename}')" title="ÂèåÂáªÊü•ÁúãÂ§ßÂõæ">
            ${post.content.caption ? `<div class="text-content" style="margin-top: 8px;">${escapeHtml(post.content.caption)}</div>` : ''}
          </div>
        `;
      } else if (post.type === 'audio_share') {
        if (post.content.text) {
          content.innerHTML = `<div class="text-content">${escapeHtml(post.content.text)}</div>`;
        }
        const audioCard = createAudioCard(post.content);
        content.appendChild(audioCard);
      } else if (post.type === 'article_share') {
        if (post.content.text) {
          content.innerHTML = `<div class="text-content">${escapeHtml(post.content.text)}</div>`;
        }
        const articleCard = createArticleCard(post.content);
        content.appendChild(articleCard);
      }
      
      // Ê∑ªÂä†Â∏ñÂ≠êÊìç‰ΩúÂå∫Âüü
      const actions = document.createElement('div');
      actions.className = 'post-actions';
      
      // ÂàõÂª∫ÂÜôËØÑËÆ∫ÊåâÈíÆÔºàÂßãÁªàÊòæÁ§∫Ôºâ
      const writeCommentBtn = document.createElement('button');
      writeCommentBtn.className = 'write-comment-btn';
      writeCommentBtn.innerHTML = '<span>üí¨</span><span>ÂÜôËØÑËÆ∫</span>';
      writeCommentBtn.onclick = () => toggleCommentForm(post.id);
      
      actions.appendChild(document.createElement('div')); // Âç†‰ΩçÁ¨¶
      actions.appendChild(writeCommentBtn);
      
      // ÂàõÂª∫ËØÑËÆ∫Âå∫Âüü
      const commentsSection = document.createElement('div');
      commentsSection.className = 'comments-section';
      commentsSection.id = `comments-${post.id}`;
      
      // ËØÑËÆ∫ÂåÖË£ÖÂô®
      const commentsWrapper = document.createElement('div');
      commentsWrapper.className = 'comments-wrapper';
      
      // ËØÑËÆ∫ÂàóË°®ÂÆπÂô®
      const commentsListContainer = document.createElement('div');
      commentsListContainer.className = 'comments-list-container';
      
      const commentsList = document.createElement('div');
      commentsList.className = 'comments-list';
      commentsList.id = `commentsList-${post.id}`;
      
      commentsListContainer.appendChild(commentsList);
      
      // ËØÑËÆ∫Ë°®Âçï
      const commentForm = document.createElement('div');
      commentForm.className = 'comment-form';
      commentForm.id = `commentForm-${post.id}`;
      commentForm.innerHTML = `
        <textarea class="comment-input" id="commentInput-${post.id}" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫..."></textarea>
        <div class="comment-actions">
          <div class="comment-type-selector">
            <button class="comment-type-btn" onclick="addCommentContent('${post.id}', 'audio')">
              <span>üé§</span><span>Èü≥È¢ë</span>
            </button>
            <button class="comment-type-btn" onclick="addCommentContent('${post.id}', 'article')">
              <span>üìù</span><span>ÊñáÁ´†</span>
            </button>
            <button class="comment-type-btn" onclick="addCommentContent('${post.id}', 'image')">
              <span>üñºÔ∏è</span><span>ÂõæÁâá</span>
            </button>
            <button class="comment-type-btn" onclick="addCommentContent('${post.id}', 'challenge')">
              <span>üèÜ</span><span>ÊåëÊàò</span>
            </button>
          </div>
          <div class="comment-submit-actions">
            <button class="comment-submit-btn secondary" onclick="cancelComment('${post.id}')">ÂèñÊ∂à</button>
            <button class="comment-submit-btn primary" onclick="submitComment('${post.id}')">ÂèëË°®</button>
          </div>
        </div>
        <div id="commentExtra-${post.id}"></div>
      `;
      
      commentsWrapper.appendChild(commentsListContainer);
      commentsWrapper.appendChild(commentForm);
      commentsSection.appendChild(commentsWrapper);
      
      postEl.appendChild(header);
      postEl.appendChild(content);
      postEl.appendChild(actions);
      postEl.appendChild(commentsSection);
      
      // Âä†ËΩΩËØÑËÆ∫
      loadComments(post.id);
      
      return postEl;
    }
    
    // ÂàõÂª∫Èü≥È¢ëÂç°Áâá
    function createAudioCard(audioContent) {
      const card = document.createElement('div');
      card.className = 'audio-card';
      
      if (audioContent.type === 'single') {
        card.onclick = () => {
          // ÊûÑÈÄ†ËØ¶ÁªÜÁöÑÂçï‰∏™Èü≥È¢ëË∑≥ËΩ¨URLÔºåÂåÖÂê´Êñá‰ª∂Â§πÂíåÂÖ∑‰ΩìÈü≥È¢ëÊñá‰ª∂‰ø°ÊÅØ
          const jumpUrl = `/speaking#folder=${encodeURIComponent(audioContent.folder)}&file=${encodeURIComponent(audioContent.filename)}`;
          window.open(jumpUrl, '_blank');
        };
        
        const header = document.createElement('div');
        header.className = 'card-header';
        
        const icon = document.createElement('div');
        icon.className = 'card-icon';
        icon.textContent = 'üé§';
        
        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = audioContent.filename.replace('.mp3', '');
        
        header.appendChild(icon);
        header.appendChild(title);
        
        const desc = document.createElement('div');
        desc.className = 'card-desc';
        desc.style.whiteSpace = 'pre-wrap';
        if (audioContent.question) {
          desc.textContent = audioContent.question;
        } else {
          desc.textContent = 'ÁÇπÂáªÊü•ÁúãÈü≥È¢ëÂÜÖÂÆπ';
        }
        
        const meta = document.createElement('div');
        meta.className = 'card-meta';
        meta.textContent = `Êù•Ëá™Ôºö${audioContent.folder}`;
        
        card.appendChild(header);
        card.appendChild(desc);
        card.appendChild(meta);
        
      } else {
        // ÂêàÈõÜÈü≥È¢ë
        card.onclick = () => {
          // ÊûÑÈÄ†ÂêàÈõÜÈü≥È¢ëË∑≥ËΩ¨URLÔºåÁõ¥Êé•ÂÆö‰ΩçÂà∞ÂÖ∑‰ΩìÂêàÈõÜ
          window.open(`/combined#folder=${encodeURIComponent(audioContent.folder)}`, '_blank');
        };
        
        const header = document.createElement('div');
        header.className = 'card-header';
        
        const icon = document.createElement('div');
        icon.className = 'card-icon';
        icon.textContent = 'üéµ';
        
        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = audioContent.folder;
        
        header.appendChild(icon);
        header.appendChild(title);
        
        const desc = document.createElement('div');
        desc.className = 'card-desc';
        desc.style.whiteSpace = 'pre-wrap';
        if (audioContent.question) {
          desc.textContent = audioContent.question;
        } else {
          desc.textContent = 'ÁÇπÂáªÊü•ÁúãÈü≥È¢ëÂÜÖÂÆπ';
        }
        
        const meta = document.createElement('div');
        meta.className = 'card-meta';
        meta.textContent = `${audioContent.file_count} ‰∏™Èü≥È¢ëÁöÑÂêàÈõÜ`;
        
        card.appendChild(header);
        card.appendChild(desc);
        card.appendChild(meta);
      }
      
      return card;
    }
    
    // ÂàõÂª∫ÊñáÁ´†Âç°Áâá
    function createArticleCard(articleContent) {
      const card = document.createElement('div');
      card.className = 'article-card';
      card.onclick = () => {
        // ÊûÑÈÄ†Ê≠£Á°ÆÁöÑÊñáÁ´†Ë∑≥ËΩ¨URLÔºå‰ΩøÁî®intensiveÈ°µÈù¢ÁöÑhashÊ†ºÂºè
        window.open(`/intensive#article-${articleContent.id || articleContent.article_id}`, '_blank');
      };
      
      const header = document.createElement('div');
      header.className = 'card-header';
      
      const icon = document.createElement('div');
      icon.className = 'card-icon';
      icon.textContent = 'üìù';
      
      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = articleContent.title;
      
      header.appendChild(icon);
      header.appendChild(title);
      
      const desc = document.createElement('div');
      desc.className = 'card-desc';
      desc.textContent = `${articleContent.category} ÊñáÁ´† ‚Ä¢ ÁÇπÂáªÊü•ÁúãÁ≤æËØªÂÜÖÂÆπ`;
      
      const meta = document.createElement('div');
      meta.className = 'card-meta';
      meta.textContent = `${articleContent.highlight_count} ‰∏™È´ò‰∫ÆËØçÊ±á`;
      
      card.appendChild(header);
      card.appendChild(desc);
      card.appendChild(meta);
      
      return card;
    }
    
    // Ê†ºÂºèÂåñÊó∂Èó¥
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // 1ÂàÜÈíüÂÜÖ
        return 'ÂàöÂàö';
      } else if (diff < 3600000) { // 1Â∞èÊó∂ÂÜÖ
        return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
      } else if (diff < 86400000) { // 24Â∞èÊó∂ÂÜÖ
        return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
      } else if (diff < 604800000) { // 7Â§©ÂÜÖ
        return Math.floor(diff / 86400000) + 'Â§©Ââç';
      } else {
        return date.toLocaleDateString();
      }
    }
    
    // HTMLËΩ¨‰πâ
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Âà†Èô§Â∏ñÂ≠ê
    function deletePost(postId) {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â∏ñÂ≠êÂêóÔºüÂà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ')) {
        return;
      }
      
      fetch(`/api/messages/${postId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // ÊâæÂà∞Âπ∂ÁßªÈô§ÂØπÂ∫îÁöÑÂ∏ñÂ≠êÂÖÉÁ¥†ÔºåÊ∑ªÂä†Âà†Èô§Âä®Áîª
          const postElement = document.querySelector(`[data-post-id="${postId}"]`);
          if (postElement) {
            // Ê∑ªÂä†Âà†Èô§Âä®Áîª
            postElement.style.transition = 'all 0.3s ease';
            postElement.style.opacity = '0';
            postElement.style.transform = 'translateX(-100px)';
            
            setTimeout(() => {
              postElement.remove();
              
              // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÂÖ∂‰ªñÂ∏ñÂ≠ê
              const remainingPosts = document.querySelectorAll('.post-card');
              if (remainingPosts.length === 0) {
                // Â¶ÇÊûúÊ≤°ÊúâÂ∏ñÂ≠ê‰∫ÜÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ
                const emptyState = document.getElementById('emptyState');
                if (emptyState) {
                  emptyState.style.display = 'block';
                }
              }
            }, 300);
          } else {
            // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂÖÉÁ¥†ÔºåÈáçÊñ∞Âä†ËΩΩÊï¥‰∏™ÂàóË°®
            loadPosts();
          }
        } else {
          alert('Âà†Èô§Â§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
        }
      })
      .catch(e => {
        alert('Âà†Èô§Â§±Ë¥•Ôºö' + e.message);
      });
    }
    
    // ÊâìÂºÄÂõæÁâáÊîæÂ§ßÊ®°ÊÄÅÊ°Ü
    function openImageModal(imageSrc) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      modalImage.src = imageSrc;
      modal.style.display = 'flex';
      
      // Ê∑ªÂä†Ê∑°ÂÖ•Âä®Áîª
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.transition = 'opacity 0.3s ease';
        modal.style.opacity = '1';
      }, 10);
    }
    
    // ÂÖ≥Èó≠ÂõæÁâáÊîæÂ§ßÊ®°ÊÄÅÊ°Ü
    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
    
    // ==================== ÊåëÊàòÂäüËÉΩ ====================
    
    // ÊòæÁ§∫ÊåëÊàòÂàõÂª∫Âô®
    function showChallengeCreator() {
      document.getElementById('challengeModal').style.display = 'flex';
      // ÈòªÊ≠¢ËÉåÊôØÊªöÂä®
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      loadChallengeArticles();
      loadChallengeUsers();
    }
    
    // Âä†ËΩΩÊñáÁ´†ÂàóË°®
    function loadChallengeArticles() {
      fetch('/api/get_articles_list')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            renderChallengeArticles(data.categories);
          }
        })
        .catch(e => console.error('Âä†ËΩΩÊñáÁ´†ÂàóË°®Â§±Ë¥•:', e));
    }
    
    // Ê∏≤ÊüìÊñáÁ´†ÂàóË°®
    function renderChallengeArticles(categories) {
      const container = document.getElementById('challengeArticleList');
      let html = '';
      
      Object.keys(categories).forEach(category => {
        const articles = categories[category];
        if (articles.length > 0) {
          html += `<div style="margin-bottom: 12px;">
            <div style="font-weight: 600; color: #374151; margin-bottom: 6px; font-size: 13px;">${category}</div>`;
          
          articles.forEach(article => {
            const isSelected = challengeData.selectedArticles.includes(article.id);
            html += `
              <div class="challenge-article-item ${isSelected ? 'selected' : ''}" onclick="toggleChallengeArticle('${article.id}')">
                <div class="challenge-article-checkbox">
                  ${isSelected ? '‚úì' : ''}
                </div>
                <div class="challenge-article-info">
                  <div class="challenge-article-title">${article.title}</div>
                  <div class="challenge-article-meta">${article.highlight_count} ‰∏™ËØçÊ±á</div>
                </div>
              </div>
            `;
          });
          
          html += '</div>';
        }
      });
      
      if (!html) {
        html = '<div style="text-align: center; padding: 20px; color: #6b7280;">ÊöÇÊó†ÂèØÁî®ÊñáÁ´†</div>';
      }
      
      container.innerHTML = html;
    }
    
    // ÂàáÊç¢ÊñáÁ´†ÈÄâÊã©
    function toggleChallengeArticle(articleId) {
      const index = challengeData.selectedArticles.indexOf(articleId);
      if (index > -1) {
        challengeData.selectedArticles.splice(index, 1);
      } else {
        challengeData.selectedArticles.push(articleId);
      }
      loadChallengeArticles(); // ÈáçÊñ∞Ê∏≤Êüì
    }
    
    // Âä†ËΩΩÁî®Êà∑ÂàóË°®
    function loadChallengeUsers() {
      fetch('/api/get_users_list')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            renderChallengeUsers(data.users);
          }
        })
        .catch(e => console.error('Âä†ËΩΩÁî®Êà∑ÂàóË°®Â§±Ë¥•:', e));
    }
    
    // Ê∏≤ÊüìÁî®Êà∑ÂàóË°®
    function renderChallengeUsers(users) {
      const container = document.getElementById('challengeUserList');
      let html = '';
      
      users.forEach(user => {
        if (user.username === currentUser.username) return; // ÊéíÈô§Ëá™Â∑±
        
        const isSelected = challengeData.selectedUsers.includes(user.username);
        html += `
          <div class="challenge-user-item ${isSelected ? 'selected' : ''}" onclick="toggleChallengeUser('${user.username}')">
            <div class="challenge-user-checkbox">
              ${isSelected ? '‚úì' : ''}
            </div>
            <img src="/static/${user.avatar}" alt="${user.display_name}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
            <div class="challenge-user-info">
              <div class="challenge-user-name">${user.display_name}</div>
            </div>
          </div>
        `;
      });
      
      if (!html) {
        html = '<div style="text-align: center; padding: 20px; color: #6b7280;">ÊöÇÊó†ÂÖ∂‰ªñÁî®Êà∑</div>';
      }
      
      container.innerHTML = html;
    }
    
    // ÂàáÊç¢Áî®Êà∑ÈÄâÊã©
    function toggleChallengeUser(username) {
      const index = challengeData.selectedUsers.indexOf(username);
      if (index > -1) {
        challengeData.selectedUsers.splice(index, 1);
      } else {
        challengeData.selectedUsers.push(username);
      }
      loadChallengeUsers(); // ÈáçÊñ∞Ê∏≤Êüì
    }
    
    // ÈÄâÊã©ËØçÊ±áÊï∞Èáè
    function selectWordCount(count) {
      challengeData.wordCount = count;
      document.getElementById('customWordCount').value = '';
      
      // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
      document.querySelectorAll('.word-count-btn').forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.dataset.count) === count) {
          btn.classList.add('active');
        }
      });
    }
    
    // ÂàõÂª∫ÊåëÊàò
    function createChallenge() {
      const title = document.getElementById('challengeTitle').value.trim();
      const description = document.getElementById('challengeDescription').value.trim();
      const customCount = document.getElementById('customWordCount').value;
      
      if (!title) {
        alert('ËØ∑ËæìÂÖ•ÊåëÊàòÊ†áÈ¢ò');
        return;
      }
      
      if (challengeData.selectedArticles.length === 0) {
        alert('ËØ∑ÈÄâÊã©Ëá≥Â∞ë‰∏ÄÁØáÊñáÁ´†');
        return;
      }
      
      const wordCount = customCount ? parseInt(customCount) : challengeData.wordCount;
      if (wordCount < 1 || wordCount > 50) {
        alert('ËØçÊ±áÊï∞ÈáèÂ∫îÂú®1-50‰πãÈó¥');
        return;
      }
      
      const challengeRequest = {
        title: title,
        description: description,
        article_ids: challengeData.selectedArticles,
        word_count: wordCount,
        mentioned_users: challengeData.selectedUsers
      };
      
      fetch('/api/create_challenge', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(challengeRequest)
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // ÂàõÂª∫ÊåëÊàòÂç°ÁâáÂπ∂Ê∑ªÂä†Âà∞ÈÄâ‰∏≠È°π
          const challengeItem = {
            id: data.challenge_id,
            title: title,
            description: description,
            vocabulary_count: data.vocabulary_count,
            mentioned_users: challengeData.selectedUsers
          };
          
          if (currentCommentPostId) {
            // ËØÑËÆ∫Ê®°Âºè
            commentSelectedItems.challenge = challengeItem;
            updateCommentPreview(currentCommentPostId);
            currentCommentPostId = null;
          } else {
            // Â∏ñÂ≠êÊ®°Âºè
            selectedItems.challenge = challengeItem;
            updateContentPreview();
          }
          closeModal('challengeModal');
          
          // ÈáçÁΩÆÊåëÊàòÊï∞ÊçÆ
          challengeData = {
            selectedArticles: [],
            selectedUsers: [],
            wordCount: 5
          };
          document.getElementById('challengeTitle').value = '';
          document.getElementById('challengeDescription').value = '';
          document.getElementById('customWordCount').value = '';
          selectWordCount(5);
        } else {
          alert('ÂàõÂª∫ÊåëÊàòÂ§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
        }
      })
      .catch(e => {
        alert('ÂàõÂª∫ÊåëÊàòÂ§±Ë¥•Ôºö' + e.message);
      });
    }
    
    // ÂàõÂª∫ÊåëÊàòÈ¢ÑËßàÁªÑ‰ª∂
    function createChallengePreview(challenge, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label class="form-label">ÊåëÊàò ${index + 1}</label>
          <button onclick="removeSelectedItem('challenge', 0)" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ÁßªÈô§</button>
        </div>
        <div class="challenge-card">
          <div class="card-header">
            <span class="card-icon">üèÜ</span>
            <div class="card-title">${challenge.title}</div>
          </div>
          ${challenge.description ? `<div class="card-desc">${challenge.description}</div>` : ''}
          <div class="card-meta">
            ${challenge.vocabulary_count} ‰∏™ËØçÊ±á
            ${challenge.mentioned_users.length > 0 ? ` ‚Ä¢ @${challenge.mentioned_users.length} ‰∏™Áî®Êà∑` : ''}
          </div>
        </div>
      `;
      
      return div;
    }
    
    // Ê£ÄÊü•ÊåëÊàòÁä∂ÊÄÅ
    function checkChallengeStatus(challengeId) {
      return fetch(`/api/get_challenge/${challengeId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            const challenge = data.challenge;
            const hasParticipated = challenge.participants && challenge.participants[currentUser.username];
            const mentionedUsers = challenge.mentioned_users || [];
            const isCurrentUserMentioned = mentionedUsers.includes(currentUser.username);
            const isCreator = challenge.creator === currentUser.username;
            
            // Âà§Êñ≠ÊòØÂê¶ÊâÄÊúâË¢´@ÁöÑÁî®Êà∑ÈÉΩÂ∑≤ÂèÇ‰∏é
            const allMentionedParticipated = mentionedUsers.length === 0 || 
              mentionedUsers.every(user => challenge.participants && challenge.participants[user]);
            
            // ÊåëÊàòÂÆåÊàêÊù°‰ª∂ÔºöÊ≤°Êúâ@‰ªª‰Ωï‰∫∫ Êàñ ÊâÄÊúâË¢´@ÁöÑÁî®Êà∑ÈÉΩÂèÇ‰∏é‰∫Ü
            const isChallengeCompleted = challenge.status === 'completed' || allMentionedParticipated;
            
            // Áî®Êà∑ÊòØÂê¶ÈúÄË¶ÅÂèÇ‰∏éÊåëÊàòÁöÑÈÄªËæëÔºö
            // 1. Â¶ÇÊûúÁî®Êà∑Ë¢´@‰∫ÜÔºåÂàôÈúÄË¶ÅÂèÇ‰∏é
            // 2. Â¶ÇÊûúÁî®Êà∑ÊòØÂàõÂª∫ËÄÖÔºå‰πüÈúÄË¶ÅÂèÇ‰∏é
            // 3. Â¶ÇÊûúÁî®Êà∑Ê≤°Ë¢´@‰∏î‰∏çÊòØÂàõÂª∫ËÄÖÔºåÂèØ‰ª•Áõ¥Êé•Êü•ÁúãÁªìÊûú
            const needsParticipation = isCurrentUserMentioned || isCreator;
            
            // Áî®Êà∑ÊòØÂê¶ÂèØ‰ª•Êü•ÁúãÁªìÊûúÔºö
            // 1. Â¶ÇÊûú‰∏çÈúÄË¶ÅÂèÇ‰∏éÔºàÊ≤°Ë¢´@‰∏î‰∏çÊòØÂàõÂª∫ËÄÖÔºâÔºåÁõ¥Êé•ÂèØ‰ª•Êü•Áúã
            // 2. Â¶ÇÊûúÈúÄË¶ÅÂèÇ‰∏éÔºåÂøÖÈ°ªÂÖàÂèÇ‰∏é‰∫ÜÊâçËÉΩÊü•ÁúãÁªìÊûú
            const canViewResults = !needsParticipation || hasParticipated;
            
            return {
              completed: isChallengeCompleted && canViewResults,
              participated: hasParticipated,
              needsParticipation: needsParticipation,
              canViewResults: canViewResults,
              totalParticipants: Object.keys(challenge.participants || {}).length,
              mentionedUsers: mentionedUsers
            };
          } else {
            throw new Error(data.error || 'Ëé∑ÂèñÊåëÊàòÁä∂ÊÄÅÂ§±Ë¥•');
          }
        });
    }
    
    // ÂàõÂª∫ÊåëÊàòÂç°ÁâáÔºàÂ∏ñÂ≠ê‰∏≠ÊòæÁ§∫Ôºâ
    function createChallengeCard(challengeContent) {
      const card = document.createElement('div');
      card.className = 'challenge-card';
      card.setAttribute('data-challenge-id', challengeContent.id);
      card.onclick = () => {
        startChallenge(challengeContent.id);
      };
      
      const header = document.createElement('div');
      header.className = 'card-header';
      
      const icon = document.createElement('div');
      icon.className = 'card-icon';
      icon.textContent = 'üèÜ';
      
      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = challengeContent.title;
      
      header.appendChild(icon);
      header.appendChild(title);
      
      if (challengeContent.description) {
        const desc = document.createElement('div');
        desc.className = 'card-desc';
        desc.textContent = challengeContent.description;
        card.appendChild(desc);
      }
      
      const meta = document.createElement('div');
      meta.className = 'card-meta';
      meta.textContent = `${challengeContent.vocabulary_count} ‰∏™ËØçÊ±á`;
      
      // ÊòæÁ§∫Ë¢´@Áî®Êà∑ÁöÑÂêçÂ≠ó
      if (challengeContent.mentioned_users && challengeContent.mentioned_users.length > 0) {
        // ÈúÄË¶ÅËé∑ÂèñÁî®Êà∑ÊòæÁ§∫ÂêçÂ≠óÔºåÂÖàÊòæÁ§∫Áî®Êà∑ÂêçÔºåÂêéÁª≠ÂèØ‰ª•‰ºòÂåñ‰∏∫ÊòæÁ§∫Âêç
        const userNames = challengeContent.mentioned_users.join(', ');
        meta.innerHTML += ` ‚Ä¢ @<span style="color: #2563eb; font-weight: 600;">${userNames}</span>`;
      }
      
      // Ê∑ªÂä†Âä®ÊÄÅÊåâÈíÆ
      const actionBtn = document.createElement('div');
      actionBtn.setAttribute('data-challenge-btn', 'true');
      actionBtn.style.cssText = 'margin-top: 12px; padding: 8px 16px; background: rgba(255,255,255,0.8); border-radius: 8px; text-align: center; font-weight: 600; color: #92400e; border: 1px solid #f59e0b; cursor: pointer; transition: all 0.2s; user-select: none;';
      
      // Ê£ÄÊü•ÊåëÊàòÁä∂ÊÄÅÂπ∂ËÆæÁΩÆÊåâÈíÆÊñáÊú¨
      checkChallengeStatus(challengeContent.id).then(status => {
        if (status.completed) {
          // ÊåëÊàòÂÆåÊàê‰∏îÁî®Êà∑ÂèØ‰ª•Êü•ÁúãÁªìÊûú
          actionBtn.textContent = 'Êü•ÁúãÊåëÊàòÁªìÊûú';
          actionBtn.style.background = 'rgba(16, 185, 129, 0.1)';
          actionBtn.style.color = '#059669';
          actionBtn.style.borderColor = '#10b981';
        } else if (!status.needsParticipation) {
          // Áî®Êà∑‰∏çÈúÄË¶ÅÂèÇ‰∏éÔºàÊú™Ë¢´@‰∏î‰∏çÊòØÂàõÂª∫ËÄÖÔºâÔºåÂèØ‰ª•Áõ¥Êé•Êü•ÁúãÂΩìÂâçÁªìÊûú
          actionBtn.textContent = 'Êü•ÁúãÊåëÊàòÁªìÊûú';
          actionBtn.style.background = 'rgba(16, 185, 129, 0.1)';
          actionBtn.style.color = '#059669';
          actionBtn.style.borderColor = '#10b981';
        } else if (status.participated) {
          // Áî®Êà∑Â∑≤ÂèÇ‰∏é‰ΩÜÊåëÊàòÊú™ÂÆåÂÖ®ÁªìÊùü
          actionBtn.textContent = 'Êü•ÁúãÊàëÁöÑÊàêÁª©';
          actionBtn.style.background = 'rgba(59, 130, 246, 0.1)';
          actionBtn.style.color = '#2563eb';
          actionBtn.style.borderColor = '#3b82f6';
        } else {
          // Áî®Êà∑ÈúÄË¶ÅÂèÇ‰∏é‰ΩÜËøòÊú™ÂèÇ‰∏é
          actionBtn.textContent = 'ÁÇπÂáªÂèÇ‰∏éÊåëÊàò';
        }
      }).catch(() => {
        actionBtn.textContent = 'ÁÇπÂáªÂèÇ‰∏éÊåëÊàò';
      });
      
      actionBtn.onclick = (e) => {
        e.stopPropagation();
        startChallenge(challengeContent.id);
      };
      
      card.appendChild(header);
      card.appendChild(meta);
      card.appendChild(actionBtn);
      
      return card;
    }
    
    // ÂºÄÂßãÊåëÊàò
    function startChallenge(challengeId) {
      fetch(`/api/get_challenge/${challengeId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            currentChallenge = data.challenge;
            currentChallengeAnswers = [];
            currentQuestionIndex = 0;
            
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁªèÂèÇ‰∏éËøá
            if (currentChallenge.participants[currentUser.username]) {
              showChallengeRanking(challengeId);
              return;
            }
            
            document.getElementById('challengeGameModal').style.display = 'flex';
            // ÈòªÊ≠¢ËÉåÊôØÊªöÂä®
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.getElementById('challengeGameTitle').textContent = currentChallenge.title;
            showNextQuestion();
          } else {
            alert('Âä†ËΩΩÊåëÊàòÂ§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
          }
        })
        .catch(e => {
          alert('Âä†ËΩΩÊåëÊàòÂ§±Ë¥•Ôºö' + e.message);
        });
    }
    
    // Êí≠ÊîæÊåëÊàòËØçÊ±áÈü≥È¢ë
    function playChallengeWord(word, challengeId) {
      if (!word || !challengeId) {
        console.warn('Word or challenge ID missing for audio playback');
        return;
      }
      
      try {
        // ÊûÑÈÄ†ÊåëÊàòÈü≥È¢ëURLÔºà‰ΩøÁî®challenge_ÂâçÁºÄ‰Ωú‰∏∫ÊñáÁ´†IDÔºâ
        const audioUrl = `/vocab_audio/challenge_${encodeURIComponent(challengeId)}/${encodeURIComponent(word.trim().toLowerCase())}`;
        
        // ÂàõÂª∫Âπ∂Êí≠ÊîæÈü≥È¢ë
        const audio = new Audio(audioUrl);
        audio.onended = () => {
          console.log(`Êí≠ÊîæÂÆåÊàê: ${word}`);
        };
        audio.onerror = (error) => {
          console.warn(`Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•: ${word}`, error);
          // Êí≠ÊîæÂ§±Ë¥•Êó∂‰∏çÊòæÁ§∫ÈîôËØØÁªôÁî®Êà∑Ôºå‰øùÊåÅÊåëÊàòÊµÅÁïÖÊÄß
        };
        audio.play().catch(error => {
          console.warn(`Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•: ${word}`, error);
        });
      } catch (error) {
        console.warn(`Èü≥È¢ëÊí≠ÊîæÈîôËØØ: ${word}`, error);
      }
    }

    // ÊòæÁ§∫‰∏ã‰∏ÄÈ¢ò
    function showNextQuestion() {
      if (currentQuestionIndex >= currentChallenge.vocabulary.length) {
        finishChallenge();
        return;
      }
      
      const vocab = currentChallenge.vocabulary[currentQuestionIndex];
      const progress = document.getElementById('challengeProgress');
      progress.textContent = `Á¨¨ ${currentQuestionIndex + 1} È¢ò / ÂÖ± ${currentChallenge.vocabulary.length} È¢ò`;
      
      // ÈöèÊú∫ÂÜ≥ÂÆöÊòØÊòæÁ§∫ÂçïËØçËøòÊòØÊÑèÊÄù
      const showWord = Math.random() > 0.5;
      const question = document.getElementById('challengeQuestion');
      const optionsContainer = document.getElementById('challengeOptions');
      
      if (showWord) {
        // Ëã±ÊñáÂØπ‰∏≠ÊñáÔºöÊòæÁ§∫Ëã±ÊñáÂçïËØçÔºåÈÄâÊã©‰∏≠ÊñáÈáä‰πâ
        currentQuestionType = 'word_to_meaning';
        question.innerHTML = `
          <span class="challenge-word">${vocab.word}</span>
          <button class="challenge-audio-btn" onclick="playChallengeWord('${vocab.word.replace(/'/g, "\\'")}', '${currentChallenge.id}')" title="Êí≠ÊîæÂèëÈü≥">
            üîä
          </button>
        `;
        
        // Ëá™Âä®Êí≠Êîæ‰∏ÄÊ¨°
        setTimeout(() => {
          playChallengeWord(vocab.word, currentChallenge.id);
        }, 100);
        
        // ÁîüÊàêÈÄâÈ°πÔºöÊ≠£Á°ÆÁ≠îÊ°à + 3‰∏™ÈîôËØØÁ≠îÊ°à
        const options = [vocab.meaning];
        const otherVocab = currentChallenge.vocabulary.filter(v => v.word !== vocab.word);
        while (options.length < 4 && otherVocab.length > 0) {
          const randomVocab = otherVocab[Math.floor(Math.random() * otherVocab.length)];
          if (!options.includes(randomVocab.meaning)) {
            options.push(randomVocab.meaning);
          }
          otherVocab.splice(otherVocab.indexOf(randomVocab), 1);
        }
        
        // Êâì‰π±ÈÄâÈ°πÈ°∫Â∫è
        for (let i = options.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [options[i], options[j]] = [options[j], options[i]];
        }
        
        renderChallengeOptions(options, vocab.meaning);
      } else {
        // ‰∏≠ÊñáÂØπËã±ÊñáÔºöÊòæÁ§∫‰∏≠ÊñáÈáä‰πâÔºåÈÄâÊã©Ëã±ÊñáÂçïËØç
        currentQuestionType = 'meaning_to_word';
        question.textContent = vocab.meaning;
        
        // ÁîüÊàêÈÄâÈ°πÔºöÊ≠£Á°ÆÁ≠îÊ°à + 3‰∏™ÈîôËØØÁ≠îÊ°à
        const options = [vocab.word];
        const otherVocab = currentChallenge.vocabulary.filter(v => v.meaning !== vocab.meaning);
        while (options.length < 4 && otherVocab.length > 0) {
          const randomVocab = otherVocab[Math.floor(Math.random() * otherVocab.length)];
          if (!options.includes(randomVocab.word)) {
            options.push(randomVocab.word);
          }
          otherVocab.splice(otherVocab.indexOf(randomVocab), 1);
        }
        
        // Êâì‰π±ÈÄâÈ°πÈ°∫Â∫è
        for (let i = options.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [options[i], options[j]] = [options[j], options[i]];
        }
        
        renderChallengeOptions(options, vocab.word);
      }
      
      // ÂºÄÂßãÂÄíËÆ°Êó∂
      startQuestionTimer();
    }
    
    // Ê∏≤ÊüìÈÄâÈ°π
    function renderChallengeOptions(options, correctAnswer) {
      const container = document.getElementById('challengeOptions');
      container.innerHTML = '';
      
      options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'challenge-option';
        optionDiv.textContent = option;
        optionDiv.onclick = () => selectChallengeOption(option, correctAnswer, optionDiv);
        container.appendChild(optionDiv);
      });
    }
    
    // ÈÄâÊã©Á≠îÊ°à
    function selectChallengeOption(selectedOption, correctAnswer, optionElement) {
      // ÂÅúÊ≠¢ËÆ°Êó∂Âô®
      if (challengeTimer) {
        clearInterval(challengeTimer);
        challengeTimer = null;
      }
      
      const timeTaken = Math.round((Date.now() - questionStartTime) / 1000);
      const isCorrect = selectedOption === correctAnswer;
      
      // Â¶ÇÊûúÊòØ‰∏≠ÊñáÂØπËã±ÊñáÈ¢òÁõÆÔºåÊí≠ÊîæÈÄâ‰∏≠ÂçïËØçÁöÑÈü≥È¢ë
      if (currentQuestionType === 'meaning_to_word') {
        // selectedOption ÊòØËã±ÊñáÂçïËØçÔºåÊí≠ÊîæÂÖ∂Èü≥È¢ë
        playChallengeWord(selectedOption, currentChallenge.id);
      }
      
      // ËÆ∞ÂΩïÁ≠îÊ°à
      currentChallengeAnswers.push({
        question_index: currentQuestionIndex,
        selected_option: selectedOption,
        correct_answer: correctAnswer,
        time_taken: timeTaken,
        is_correct: isCorrect
      });
      
      // ÊòæÁ§∫ÁªìÊûú
      const allOptions = document.querySelectorAll('.challenge-option');
      allOptions.forEach(opt => {
        opt.style.pointerEvents = 'none';
        if (opt.textContent === correctAnswer) {
          opt.classList.add('correct');
        } else if (opt === optionElement && !isCorrect) {
          opt.classList.add('incorrect');
        }
      });
      
      // 2ÁßíÂêéÊòæÁ§∫‰∏ã‰∏ÄÈ¢ò
      setTimeout(() => {
        currentQuestionIndex++;
        showNextQuestion();
      }, 2000);
    }
    
    // ÂºÄÂßãÈóÆÈ¢òËÆ°Êó∂Âô®
    function startQuestionTimer() {
      questionStartTime = Date.now();
      let timeLeft = 10;
      const timerElement = document.getElementById('challengeTimer');
      
      timerElement.textContent = `${timeLeft}s`;
      
      challengeTimer = setInterval(() => {
        timeLeft--;
        timerElement.textContent = `${timeLeft}s`;
        
        if (timeLeft <= 0) {
          clearInterval(challengeTimer);
          challengeTimer = null;
          
          // Êó∂Èó¥Âà∞ÔºåËá™Âä®ÈÄâÊã©ÈîôËØØÁ≠îÊ°à
          const timeTaken = 10;
          currentChallengeAnswers.push({
            question_index: currentQuestionIndex,
            selected_option: null,
            correct_answer: null,
            time_taken: timeTaken,
            is_correct: false
          });
          
          // ÊòæÁ§∫Ê≠£Á°ÆÁ≠îÊ°à
          const allOptions = document.querySelectorAll('.challenge-option');
          allOptions.forEach(opt => {
            opt.style.pointerEvents = 'none';
            // ËøôÈáåÈúÄË¶ÅÊ†πÊçÆÂΩìÂâçÈ¢òÁõÆÊâæÂà∞Ê≠£Á°ÆÁ≠îÊ°à
            // ÁÆÄÂåñÂ§ÑÁêÜÔºåÁõ¥Êé•ËøõÂÖ•‰∏ã‰∏ÄÈ¢ò
          });
          
          setTimeout(() => {
            currentQuestionIndex++;
            showNextQuestion();
          }, 2000);
        }
      }, 1000);
    }
    
    // ÂÆåÊàêÊåëÊàò
    function finishChallenge() {
      fetch('/api/participate_challenge', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({
          challenge_id: currentChallenge.id,
          answers: currentChallengeAnswers
        })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // ÂÖ≥Èó≠Ê∏∏ÊàèÊ®°ÊÄÅÊ°Ü
          closeModal('challengeGameModal');
          
          // ÊòæÁ§∫ÁªìÊûú
          alert(`ÊåëÊàòÂÆåÊàêÔºÅ\\nÊ≠£Á°ÆÁéáÔºö${data.correct_count}/${data.total_questions}\\nÊÄªÂàÜÔºö${data.score}ÂàÜ`);
          
          // Âà∑Êñ∞È°µÈù¢‰∏äÊâÄÊúâÊåëÊàòÂç°ÁâáÁöÑÁä∂ÊÄÅ
          refreshChallengeCards();
          
          // ÈáçÊñ∞Ê£ÄÊü•ÂæÖÂÆåÊàêÁöÑÊåëÊàòÔºàÊõ¥Êñ∞ÊèêÈÜíÁä∂ÊÄÅÔºâ
          setTimeout(() => {
            checkPendingChallenges();
          }, 500);
          
          // Â¶ÇÊûúÊéíÂêçÂ∑≤ÂáÜÂ§áÂ•ΩÔºåÊòæÁ§∫ÊéíÂêç
          if (data.ranking_ready) {
            setTimeout(() => {
              showChallengeRanking(currentChallenge.id);
            }, 1000);
          }
        } else {
          alert('Êèê‰∫§Á≠îÊ°àÂ§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
        }
      })
      .catch(e => {
        alert('Êèê‰∫§Á≠îÊ°àÂ§±Ë¥•Ôºö' + e.message);
      });
    }
    
    // Âà∑Êñ∞È°µÈù¢‰∏äÊâÄÊúâÊåëÊàòÂç°ÁâáÁöÑÁä∂ÊÄÅ
    function refreshChallengeCards() {
      const challengeCards = document.querySelectorAll('.challenge-card');
      challengeCards.forEach(card => {
        const challengeId = card.getAttribute('data-challenge-id');
        if (challengeId) {
          // ÊâæÂà∞ÊåëÊàòÂç°Áâá‰∏≠ÁöÑÊåâÈíÆÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ
          const actionBtn = card.querySelector('[data-challenge-btn]');
          if (actionBtn) {
            updateChallengeButton(challengeId, actionBtn);
          }
        }
      });
    }
    
    // Êõ¥Êñ∞Âçï‰∏™ÊåëÊàòÊåâÈíÆÁä∂ÊÄÅ
    function updateChallengeButton(challengeId, actionBtn) {
      checkChallengeStatus(challengeId).then(status => {
        if (status.completed) {
          actionBtn.textContent = 'Êü•ÁúãÊåëÊàòÁªìÊûú';
          actionBtn.style.background = 'rgba(16, 185, 129, 0.1)';
          actionBtn.style.color = '#059669';
          actionBtn.style.borderColor = '#10b981';
        } else if (!status.needsParticipation) {
          actionBtn.textContent = 'Êü•ÁúãÊåëÊàòÁªìÊûú';
          actionBtn.style.background = 'rgba(16, 185, 129, 0.1)';
          actionBtn.style.color = '#059669';
          actionBtn.style.borderColor = '#10b981';
        } else if (status.participated) {
          actionBtn.textContent = 'Êü•ÁúãÊàëÁöÑÊàêÁª©';
          actionBtn.style.background = 'rgba(59, 130, 246, 0.1)';
          actionBtn.style.color = '#2563eb';
          actionBtn.style.borderColor = '#3b82f6';
        } else {
          actionBtn.textContent = 'ÁÇπÂáªÂèÇ‰∏éÊåëÊàò';
          actionBtn.style.background = 'rgba(255,255,255,0.8)';
          actionBtn.style.color = '#92400e';
          actionBtn.style.borderColor = '#f59e0b';
        }
      }).catch(() => {
        // ÈîôËØØÊó∂‰øùÊåÅÈªòËÆ§Áä∂ÊÄÅ
      });
    }
    
    // ÊòæÁ§∫ÊåëÊàòÊéíÂêç
    function showChallengeRanking(challengeId) {
      fetch(`/api/get_challenge_ranking/${challengeId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            document.getElementById('challengeRankingModal').style.display = 'flex';
            // ÈòªÊ≠¢ËÉåÊôØÊªöÂä®
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.getElementById('rankingTitle').textContent = data.challenge.title + ' - ÊéíË°åÊ¶ú';
            
            const challengeInfo = document.getElementById('challengeInfo');
            challengeInfo.innerHTML = `
              ${data.challenge.description ? `<div style="margin-bottom: 8px;">${data.challenge.description}</div>` : ''}
              <div>${data.challenge.vocabulary_count} ‰∏™ËØçÊ±á ‚Ä¢ ${data.ranking.length} ‰∫∫ÂèÇ‰∏é</div>
            `;
            
            renderRanking(data.ranking);
          } else {
            alert('Âä†ËΩΩÊéíÂêçÂ§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
          }
        })
        .catch(e => {
          alert('Âä†ËΩΩÊéíÂêçÂ§±Ë¥•Ôºö' + e.message);
        });
    }
    
    // Ê∏≤ÊüìÊéíÂêç
    function renderRanking(ranking) {
      const container = document.getElementById('rankingList');
      let html = '';
      
      ranking.forEach((item, index) => {
        const rank = index + 1;
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        
        html += `
          <div class="ranking-item ${rankClass}">
            <div class="ranking-number">${rank}</div>
            <img src="/static/${item.avatar}" alt="${item.display_name}" class="ranking-avatar">
            <div class="ranking-info">
              <div class="ranking-name">${item.display_name}</div>
              <div class="ranking-score">${item.correct_count}/${item.total_questions} Ê≠£Á°Æ</div>
            </div>
            <div class="ranking-points">${item.score}ÂàÜ</div>
          </div>
        `;
      });
      
      if (!html) {
        html = '<div style="text-align: center; padding: 40px; color: #6b7280;">ÊöÇÊó†ÂèÇ‰∏éËÄÖ</div>';
      }
      
      container.innerHTML = html;
    }
    
    // ==================== ÊåëÊàòÊèêÈÜíÂäüËÉΩ ====================
    
    // Ê£ÄÊü•ÂæÖÂÆåÊàêÁöÑÊåëÊàò
    function checkPendingChallenges() {
      fetch('/api/messages')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            findPendingChallenges(data.messages);
          }
        })
        .catch(e => console.error('Ê£ÄÊü•ÊåëÊàòÂ§±Ë¥•:', e));
    }
    
    // ‰ªéÊ∂àÊÅØÂàóË°®‰∏≠ÊâæÂà∞ÂæÖÂÆåÊàêÁöÑÊåëÊàò
    function findPendingChallenges(messages) {
      pendingChallenges = [];
      const challengePromises = [];
      
      messages.forEach(message => {
        if (message.type === 'mixed_content' && message.content.challenge) {
          const challenge = message.content.challenge;
          // Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑ÊòØÂê¶Ë¢´@ÊàñÊòØÂàõÂª∫ËÄÖ
          const isCreator = message.user.username === currentUser.username;
          const isMentioned = challenge.mentioned_users && 
            challenge.mentioned_users.includes(currentUser.username);
          
          if (isCreator || isMentioned) {
            challengePromises.push(
              checkChallengeStatus(challenge.id).then(status => {
                if (!status.participated) {
                  pendingChallenges.push({
                    id: challenge.id,
                    title: challenge.title,
                    postId: message.id,
                    creator: message.user.display_name,
                    isCreator: isCreator
                  });
                }
              }).catch(() => {})
            );
          }
        }
      });
      
      Promise.all(challengePromises).then(() => {
        if (pendingChallenges.length > 0) {
          showChallengeAlert();
        }
      });
    }
    
    // ÊòæÁ§∫ÊåëÊàòÊèêÈÜí
    function showChallengeAlert() {
      const alert = document.getElementById('challengeAlert');
      const message = document.getElementById('alertMessage');
      
      if (pendingChallenges.length === 1) {
        const challenge = pendingChallenges[0];
        if (challenge.isCreator) {
          message.textContent = `ÊÇ®ÂàõÂª∫ÁöÑÊåëÊàò"${challenge.title}"Á≠âÂæÖÊÇ®ÂÆåÊàê`;
        } else {
          message.textContent = `${challenge.creator}ÈÇÄËØ∑ÊÇ®ÂÆåÊàêÊåëÊàò"${challenge.title}"`;
        }
      } else {
        message.textContent = `ÊÇ®Êúâ${pendingChallenges.length}‰∏™ËØçÊ±áÊåëÊàòÁ≠âÂæÖÂÆåÊàê`;
      }
      
      alert.style.display = 'flex';
      
      // Ê∑ªÂä†Ê∑°ÂÖ•Âä®Áîª
      alert.style.opacity = '0';
      alert.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        alert.style.transition = 'all 0.3s ease';
        alert.style.opacity = '1';
        alert.style.transform = 'translateY(0)';
      }, 100);
    }
    
    // Ë∑≥ËΩ¨Âà∞ÊåëÊàòÂ∏ñÂ≠ê
    function goToChallengePost() {
      if (pendingChallenges.length > 0) {
        const firstChallenge = pendingChallenges[0];
        // ÊâæÂà∞ÂØπÂ∫îÁöÑÂ∏ñÂ≠êÂπ∂È´ò‰∫ÆÊòæÁ§∫
        const postElement = document.querySelector(`[data-post-id="${firstChallenge.postId}"]`);
        if (postElement) {
          // ÊªöÂä®Âà∞Â∏ñÂ≠ê‰ΩçÁΩÆ
          postElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
          
          // È´ò‰∫ÆÊòæÁ§∫Â∏ñÂ≠ê
          highlightPost(postElement);
        }
      }
      dismissAlert();
    }
    
    // È´ò‰∫ÆÊòæÁ§∫Â∏ñÂ≠ê
    function highlightPost(postElement) {
      // Ê∑ªÂä†È´ò‰∫ÆÊïàÊûú
      postElement.style.background = 'rgba(245, 158, 11, 0.1)';
      postElement.style.border = '2px solid #f59e0b';
      postElement.style.transform = 'scale(1.02)';
      postElement.style.transition = 'all 0.3s ease';
      postElement.style.boxShadow = '0 8px 24px rgba(245, 158, 11, 0.3)';
      
      // 3ÁßíÂêéÁßªÈô§È´ò‰∫Æ
      setTimeout(() => {
        postElement.style.background = '';
        postElement.style.border = '';
        postElement.style.transform = '';
        postElement.style.boxShadow = '';
      }, 3000);
    }
    
    // ÂÖ≥Èó≠ÊèêÈÜí
    function dismissAlert() {
      const alert = document.getElementById('challengeAlert');
      alert.style.opacity = '0';
      alert.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 300);
    }
    
    // ==================== ËØÑËÆ∫ÂäüËÉΩ ====================
    
    // ÊòæÁ§∫ËØÑËÆ∫Âå∫ÂüüÔºàÂ¶ÇÊûúÊúâËØÑËÆ∫Ôºâ
    function showCommentsIfNeeded(postId, hasComments) {
      const commentsSection = document.getElementById(`comments-${postId}`);
      if (commentsSection) {
        if (hasComments) {
          commentsSection.classList.add('has-comments');
        } else {
          commentsSection.classList.remove('has-comments');
        }
      }
    }
    
    // ÂàáÊç¢ËØÑËÆ∫Ë°®ÂçïÊòæÁ§∫/ÈöêËóè
    function toggleCommentForm(postId) {
      const commentForm = document.getElementById(`commentForm-${postId}`);
      const commentsSection = document.getElementById(`comments-${postId}`);
      const postElement = document.querySelector(`[data-post-id="${postId}"]`);
      const writeCommentBtn = postElement ? postElement.querySelector('.write-comment-btn') : null;
      
      // Á°Æ‰øùËØÑËÆ∫Âå∫ÂüüÂèØËßÅ
      if (commentsSection) {
        commentsSection.classList.add('has-comments');
      }
      
      if (commentForm.classList.contains('active')) {
        // ÈöêËóèË°®Âçï
        commentForm.classList.remove('active');
        if (writeCommentBtn) {
          writeCommentBtn.classList.remove('active');
          writeCommentBtn.innerHTML = '<span>üí¨</span><span>ÂÜôËØÑËÆ∫</span>';
        }
        
        // Ê∏ÖÁ©∫Ë°®ÂçïÂÜÖÂÆπ
        const input = document.getElementById(`commentInput-${postId}`);
        if (input) input.value = '';
        const extraArea = document.getElementById(`commentExtra-${postId}`);
        if (extraArea) extraArea.innerHTML = '';
        
        // ÈáçÁΩÆÈÄâ‰∏≠È°π
        commentSelectedItems = {
          audios: [],
          articles: [],
          images: [],
          challenge: null
        };
      } else {
        // ÊòæÁ§∫Ë°®Âçï
        commentForm.classList.add('active');
        if (writeCommentBtn) {
          writeCommentBtn.classList.add('active');
          writeCommentBtn.innerHTML = '<span>‚úñ</span><span>ÂèñÊ∂à</span>';
        }
        
        // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
        setTimeout(() => {
          const input = document.getElementById(`commentInput-${postId}`);
          if (input) {
            input.focus();
            input.style.height = 'auto';
            input.style.height = input.scrollHeight + 'px';
          }
        }, 300);
      }
    }
    
    // Âä†ËΩΩËØÑËÆ∫
    function loadComments(postId) {
      fetch(`/api/comments/${postId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            renderComments(postId, data.comments);
            // Êõ¥Êñ∞ËØÑËÆ∫ÊåâÈíÆÊñáÂ≠ó
            updateCommentButton(postId, data.comments.length);
          }
        })
        .catch(e => console.error('Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•:', e));
    }
    
    // Êõ¥Êñ∞ËØÑËÆ∫Âå∫ÂüüÁä∂ÊÄÅ
    function updateCommentButton(postId, commentCount) {
      const commentsSection = document.getElementById(`comments-${postId}`);
      
      // Â¶ÇÊûúÊúâËØÑËÆ∫ÔºåËá™Âä®ÊòæÁ§∫ËØÑËÆ∫Âå∫Âüü
      if (commentsSection) {
        if (commentCount > 0) {
          commentsSection.classList.add('has-comments');
        } else {
          commentsSection.classList.remove('has-comments');
        }
      }
    }
    
    // Ê∏≤ÊüìËØÑËÆ∫ÂàóË°®
    function renderComments(postId, comments) {
      const container = document.getElementById(`commentsList-${postId}`);
      if (!container) return;
      
      container.innerHTML = '';
      if (comments.length === 0) {
        // Á©∫Áä∂ÊÄÅÁî±CSSÂ§ÑÁêÜÔºåËøôÈáå‰∏çÊ∑ªÂä†‰ªª‰ΩïÂÜÖÂÆπ
        return;
      }
      
      comments.forEach((comment, index) => {
        const commentEl = createCommentElement(comment, postId);
        // Ê∑ªÂä†ËøõÂÖ•Âä®Áîª
        commentEl.style.opacity = '0';
        commentEl.style.transform = 'translateY(10px)';
        container.appendChild(commentEl);
        
        // Âª∂ËøüÊòæÁ§∫Âä®Áîª
        setTimeout(() => {
          commentEl.style.transition = 'all 0.3s ease';
          commentEl.style.opacity = '1';
          commentEl.style.transform = 'translateY(0)';
        }, index * 50);
      });
    }
    
    // ÂàõÂª∫ËØÑËÆ∫ÂÖÉÁ¥†
    function createCommentElement(comment, postId) {
      const commentEl = document.createElement('div');
      commentEl.className = 'comment-item';
      commentEl.setAttribute('data-comment-id', comment.id);
      
      const header = document.createElement('div');
      header.className = 'comment-header';
      
      const avatar = document.createElement('img');
      avatar.className = 'comment-avatar';
      avatar.src = `/static/${comment.user.avatar}`;
      avatar.alt = comment.user.display_name;
      
      const userInfo = document.createElement('div');
      userInfo.className = 'comment-user-info';
      
      const userName = document.createElement('div');
      userName.className = 'comment-user-name';
      userName.textContent = comment.user.display_name;
      
      const time = document.createElement('div');
      time.className = 'comment-time';
      time.textContent = formatTime(comment.timestamp);
      
      userInfo.appendChild(userName);
      userInfo.appendChild(time);
      header.appendChild(avatar);
      header.appendChild(userInfo);
      
      // Â¶ÇÊûúÊòØÂΩìÂâçÁî®Êà∑ÁöÑËØÑËÆ∫ÔºåÊ∑ªÂä†Âà†Èô§ÊåâÈíÆ
      if (currentUser && comment.user.username === currentUser.username) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'comment-delete-btn';
        deleteBtn.innerHTML = '√ó';
        deleteBtn.title = 'Âà†Èô§ËØÑËÆ∫';
        deleteBtn.onclick = () => deleteComment(postId, comment.id);
        header.appendChild(deleteBtn);
      }
      
      const content = document.createElement('div');
      content.className = 'comment-content';
      
      // Ê†πÊçÆËØÑËÆ∫Á±ªÂûãÊ∏≤Êüì‰∏çÂêåÂÜÖÂÆπ
      if (comment.type === 'mixed_content') {
        let hasContent = false;
        
        // ÊñáÂ≠óÂÜÖÂÆπ
        if (comment.content.text) {
          const textDiv = document.createElement('div');
          textDiv.style.cssText = 'margin-bottom: 8px; white-space: pre-wrap;';
          textDiv.textContent = comment.content.text;
          content.appendChild(textDiv);
          hasContent = true;
        }
        
        // Èü≥È¢ëÂÜÖÂÆπ
        if (comment.content.audios && comment.content.audios.length > 0) {
          comment.content.audios.forEach(audio => {
            const audioCard = createAudioCard(audio);
            audioCard.style.cssText = 'margin-top: 8px; padding: 8px; font-size: 11px;';
            content.appendChild(audioCard);
            hasContent = true;
          });
        }
        
        // ÊñáÁ´†ÂÜÖÂÆπ
        if (comment.content.articles && comment.content.articles.length > 0) {
          comment.content.articles.forEach(article => {
            const articleCard = createArticleCard(article);
            articleCard.style.cssText = 'margin-top: 8px; padding: 8px; font-size: 11px;';
            content.appendChild(articleCard);
            hasContent = true;
          });
        }
        
        // ÂõæÁâáÂÜÖÂÆπ
        if (comment.content.images && comment.content.images.length > 0) {
          comment.content.images.forEach(image => {
            const imageDiv = document.createElement('div');
            imageDiv.style.cssText = 'margin-top: 8px;';
            imageDiv.innerHTML = `<img src="/message_images/${image.filename}" alt="ÂõæÁâá" style="max-width: 100%; max-height: 150px; border-radius: 6px;" ondblclick="openImageModal('/message_images/${image.filename}')" title="ÂèåÂáªÊü•ÁúãÂ§ßÂõæ">`;
            content.appendChild(imageDiv);
            hasContent = true;
          });
        }
        
        // ÊåëÊàòÂÜÖÂÆπ
        if (comment.content.challenge) {
          const challengeCard = createChallengeCard(comment.content.challenge);
          challengeCard.style.cssText = 'margin-top: 8px; padding: 8px; font-size: 11px;';
          content.appendChild(challengeCard);
          hasContent = true;
        }
      } else {
        content.textContent = comment.content.text || '';
      }
      
      commentEl.appendChild(header);
      commentEl.appendChild(content);
      
      return commentEl;
    }
    
    // Ê∑ªÂä†ËØÑËÆ∫ÂÜÖÂÆπ
    function addCommentContent(postId, type) {
      currentCommentPostId = postId;
      
      // ÈáçÁΩÆËØÑËÆ∫ÈÄâ‰∏≠È°π
      commentSelectedItems = {
        audios: [],
        articles: [],
        images: [],
        challenge: null
      };
      
      if (type === 'audio') {
        showAudioSelector();
      } else if (type === 'article') {
        showArticleSelector();
      } else if (type === 'image') {
        showCommentImageUploader(postId);
      } else if (type === 'challenge') {
        showChallengeCreator();
      }
    }
    
    // ÊòæÁ§∫ËØÑËÆ∫ÂõæÁâá‰∏ä‰º†Âô®
    function showCommentImageUploader(postId) {
      const extraArea = document.getElementById(`commentExtra-${postId}`);
      extraArea.innerHTML = `
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1f2937; font-size: 12px;">‰∏ä‰º†ÂõæÁâá</label>
          <input type="file" accept="image/*,.heic,.heif" onchange="handleCommentImageUpload(event, '${postId}')" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px;">
          <div style="margin-top: 6px; font-size: 10px; color: #6b7280;">
            ÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF„ÄÅWebP„ÄÅHEIC Ê†ºÂºèÔºåÊúÄÂ§ß 10MB<br>
            <span style="color: #059669;">‚úì Ëá™Âä®Â§ÑÁêÜÂíå‰ºòÂåñ</span>
          </div>
        </div>
      `;
    }
    
    // Â§ÑÁêÜËØÑËÆ∫ÂõæÁâá‰∏ä‰º†
    function handleCommentImageUpload(event, postId) {
      const file = event.target.files[0];
      if (!file) return;
      
      console.log('ËØÑËÆ∫‰∏ä‰º†Êñá‰ª∂‰ø°ÊÅØ:', {
        name: file.name,
        type: file.type,
        size: file.size
      });
      
      // Êâ©Â±ïÁöÑÊñá‰ª∂Á±ªÂûãÊîØÊåÅ
      const allowedTypes = [
        'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',
        'image/heic', 'image/heif', 'image/avif'
      ];
      
      // Ê£ÄÊü•Êñá‰ª∂Êâ©Â±ïÂêçÔºà‰Ωú‰∏∫MIMEÁ±ªÂûãÁöÑÂêéÂ§áÔºâ
      const fileExtension = file.name.toLowerCase().split('.').pop();
      const allowedExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'heif', 'avif'];
      
      const isValidType = allowedTypes.includes(file.type) || allowedExtensions.includes(fileExtension);
      
      if (!isValidType) {
        alert('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊ†ºÂºèÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWebP„ÄÅHEICÔºâ\nÂΩìÂâçÊñá‰ª∂Á±ªÂûãÔºö' + (file.type || 'Êú™Áü•'));
        event.target.value = '';
        return;
      }
      
      // È™åËØÅÊñá‰ª∂Â§ßÂ∞èÔºà10MBÔºâ
      if (file.size > 10 * 1024 * 1024) {
        alert(`ÂõæÁâáÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá10MB\nÂΩìÂâçÊñá‰ª∂Â§ßÂ∞èÔºö${(file.size / 1024 / 1024).toFixed(2)}MB`);
        event.target.value = '';
        return;
      }
      
      // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
      const uploadBtn = event.target;
      const statusDiv = uploadBtn.parentNode.querySelector('div');
      
      uploadBtn.disabled = true;
      uploadBtn.style.opacity = '0.6';
      statusDiv.innerHTML = `
        <div style="color: #0284c7; font-weight: 500; font-size: 10px;">
          üì§ Ê≠£Âú®Â§ÑÁêÜÂõæÁâá...
        </div>
      `;
      
      const formData = new FormData();
      formData.append('image', file);
      formData.append('user_id', currentUser.username);
      
      fetch('/api/upload_message_image', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // Ê∑ªÂä†Âà∞ËØÑËÆ∫ÈÄâ‰∏≠ÂàóË°®
          commentSelectedItems.images.push({
            filename: data.filename,
            caption: ''
          });
          
          updateCommentPreview(postId);
          
          // ÊòæÁ§∫ÊàêÂäüÁä∂ÊÄÅ
          statusDiv.innerHTML = `
            <div style="color: #059669; font-weight: 500; font-size: 10px;">
              ‚úÖ ‰∏ä‰º†ÊàêÂäüÔºÅ
            </div>
          `;
          
        } else {
          console.error('ÊúçÂä°Âô®ËøîÂõûÈîôËØØ:', data);
          alert('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
          
          statusDiv.innerHTML = `
            <div style="color: #dc2626; font-weight: 500; font-size: 10px;">
              ‚ùå ${data.error || '‰∏ä‰º†Â§±Ë¥•'}
            </div>
          `;
        }
      })
      .catch(e => {
        console.error('ÂõæÁâá‰∏ä‰º†ÈîôËØØ:', e);
        alert('‰∏ä‰º†Â§±Ë¥•ÔºöÁΩëÁªúÈîôËØØÊàñÊúçÂä°Âô®ÂºÇÂ∏∏');
        
        statusDiv.innerHTML = `
          <div style="color: #dc2626; font-weight: 500; font-size: 10px;">
            ‚ùå ÁΩëÁªúÈîôËØØ
          </div>
        `;
      })
      .finally(() => {
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = '1';
        // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©
        event.target.value = '';
        
        // 2ÁßíÂêéÊÅ¢Â§çÁä∂ÊÄÅÊèêÁ§∫
        setTimeout(() => {
          if (statusDiv) {
            statusDiv.innerHTML = `
              ÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF„ÄÅWebP„ÄÅHEIC Ê†ºÂºèÔºåÊúÄÂ§ß 10MB<br>
              <span style="color: #059669;">‚úì Ëá™Âä®Â§ÑÁêÜÂíå‰ºòÂåñ</span>
            `;
          }
        }, 2000);
      });
    }
    
    // Êõ¥Êñ∞ËØÑËÆ∫È¢ÑËßà
    function updateCommentPreview(postId) {
      const extraArea = document.getElementById(`commentExtra-${postId}`);
      extraArea.innerHTML = '';
      
      // ÊòæÁ§∫ÊâÄÊúâÈÄâ‰∏≠ÁöÑÂÜÖÂÆπ
      commentSelectedItems.audios.forEach((audio, index) => {
        const preview = createCommentAudioPreview(audio, index, postId);
        extraArea.appendChild(preview);
      });
      
      commentSelectedItems.articles.forEach((article, index) => {
        const preview = createCommentArticlePreview(article, index, postId);
        extraArea.appendChild(preview);
      });
      
      commentSelectedItems.images.forEach((image, index) => {
        const preview = createCommentImagePreview(image, index, postId);
        extraArea.appendChild(preview);
      });
      
      if (commentSelectedItems.challenge) {
        const preview = createCommentChallengePreview(commentSelectedItems.challenge, 0, postId);
        extraArea.appendChild(preview);
      }
    }
    
    // ÂàõÂª∫ËØÑËÆ∫Èü≥È¢ëÈ¢ÑËßà
    function createCommentAudioPreview(audio, index, postId) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;';
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <label style="font-weight: 600; color: #1f2937; font-size: 12px;">Èü≥È¢ë ${index + 1}</label>
          <button onclick="removeCommentItem('audios', ${index}, '${postId}')" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 10px;">ÁßªÈô§</button>
        </div>
        <div style="padding: 8px; background: #f0f9ff; border: 1px solid #0284c7; border-radius: 8px; font-size: 11px;">
          <div style="font-weight: 600; color: #0c4a6e;">${audio.type === 'single' ? audio.filename.replace('.mp3', '') : audio.folder}</div>
          <div style="color: #0369a1; font-size: 10px;">${audio.type === 'single' ? `Êù•Ëá™Ôºö${audio.folder}` : `${audio.file_count} ‰∏™Èü≥È¢ëÁöÑÂêàÈõÜ`}</div>
        </div>
      `;
      return div;
    }
    
    // ÂàõÂª∫ËØÑËÆ∫ÊñáÁ´†È¢ÑËßà
    function createCommentArticlePreview(article, index, postId) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;';
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <label style="font-weight: 600; color: #1f2937; font-size: 12px;">ÊñáÁ´† ${index + 1}</label>
          <button onclick="removeCommentItem('articles', ${index}, '${postId}')" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 10px;">ÁßªÈô§</button>
        </div>
        <div style="padding: 8px; background: #f0fdf4; border: 1px solid #16a34a; border-radius: 8px; font-size: 11px;">
          <div style="font-weight: 600; color: #14532d;">${article.title}</div>
          <div style="color: #15803d; font-size: 10px;">${article.category} ‚Ä¢ ${article.highlight_count} ‰∏™È´ò‰∫ÆËØçÊ±á</div>
        </div>
      `;
      return div;
    }
    
    // ÂàõÂª∫ËØÑËÆ∫ÂõæÁâáÈ¢ÑËßà
    function createCommentImagePreview(image, index, postId) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;';
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <label style="font-weight: 600; color: #1f2937; font-size: 12px;">ÂõæÁâá ${index + 1}</label>
          <button onclick="removeCommentItem('images', ${index}, '${postId}')" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 10px;">ÁßªÈô§</button>
        </div>
        <div style="padding: 8px; background: #fef7ff; border: 1px solid #a855f7; border-radius: 8px;">
          <img src="/message_images/${image.filename}" alt="È¢ÑËßàÂõæÁâá" style="max-width: 100%; max-height: 100px; border-radius: 6px;">
        </div>
      `;
      return div;
    }
    
    // ÂàõÂª∫ËØÑËÆ∫ÊåëÊàòÈ¢ÑËßà
    function createCommentChallengePreview(challenge, index, postId) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;';
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <label style="font-weight: 600; color: #1f2937; font-size: 12px;">ÊåëÊàò</label>
          <button onclick="removeCommentItem('challenge', 0, '${postId}')" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 10px;">ÁßªÈô§</button>
        </div>
        <div style="padding: 8px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; font-size: 11px;">
          <div style="font-weight: 600; color: #92400e;">${challenge.title}</div>
          ${challenge.description ? `<div style="color: #a16207; font-size: 10px; margin-top: 2px;">${challenge.description}</div>` : ''}
          <div style="color: #d97706; font-size: 10px; margin-top: 4px;">${challenge.vocabulary_count} ‰∏™ËØçÊ±á</div>
        </div>
      `;
      return div;
    }
    
    // ÁßªÈô§ËØÑËÆ∫È°πÁõÆ
    function removeCommentItem(type, index, postId) {
      if (type === 'challenge') {
        commentSelectedItems.challenge = null;
      } else {
        commentSelectedItems[type].splice(index, 1);
      }
      updateCommentPreview(postId);
    }
    
    // Êèê‰∫§ËØÑËÆ∫
    function submitComment(postId) {
      const content = document.getElementById(`commentInput-${postId}`).value.trim();
      
      if (!content && commentSelectedItems.audios.length === 0 && 
          commentSelectedItems.articles.length === 0 && 
          commentSelectedItems.images.length === 0 && 
          !commentSelectedItems.challenge) {
        alert('ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπÊàñÊ∑ªÂä†ÂàÜ‰∫´ÂÜÖÂÆπ');
        return;
      }
      
      const commentData = {
        post_id: postId,
        type: 'mixed_content',
        content: {
          text: content,
          audios: commentSelectedItems.audios,
          articles: commentSelectedItems.articles,
          images: commentSelectedItems.images,
          challenge: commentSelectedItems.challenge
        }
      };
      
      fetch('/api/comments', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(commentData)
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // ÈöêËóèËØÑËÆ∫Ë°®Âçï
          toggleCommentForm(postId);
          
          // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫
          loadComments(postId);
          
          // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
          const postElement = document.querySelector(`[data-post-id="${postId}"]`);
          const writeCommentBtn = postElement ? postElement.querySelector('.write-comment-btn') : null;
          if (writeCommentBtn) {
            const originalContent = writeCommentBtn.innerHTML;
            writeCommentBtn.innerHTML = '<span>‚úÖ</span><span>Â∑≤ÂèëË°®</span>';
            writeCommentBtn.style.background = '#10b981';
            writeCommentBtn.style.borderColor = '#10b981';
            writeCommentBtn.style.color = 'white';
            setTimeout(() => {
              writeCommentBtn.innerHTML = originalContent;
              writeCommentBtn.style.background = '';
              writeCommentBtn.style.borderColor = '';
              writeCommentBtn.style.color = '';
            }, 2000);
          }
        } else {
          alert('ÂèëË°®ËØÑËÆ∫Â§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
        }
      })
      .catch(e => {
        alert('ÂèëË°®ËØÑËÆ∫Â§±Ë¥•Ôºö' + e.message);
      });
    }
    
    // ÂèñÊ∂àËØÑËÆ∫
    function cancelComment(postId) {
      // Áõ¥Êé•Ë∞ÉÁî®toggleCommentFormÊù•ÈöêËóèË°®Âçï
      toggleCommentForm(postId);
    }
    
    // Âà†Èô§ËØÑËÆ∫
    function deleteComment(postId, commentId) {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºü')) {
        return;
      }
      
      fetch(`/api/comments/${commentId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          loadComments(postId);
        } else {
          alert('Âà†Èô§ËØÑËÆ∫Â§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
        }
      })
      .catch(e => {
        alert('Âà†Èô§ËØÑËÆ∫Â§±Ë¥•Ôºö' + e.message);
      });
    }
    
    // Ê∑ªÂä†ËøîÂõûÊåâÈíÆÂäüËÉΩ
    function goBackToModules() {
      window.location.href = '/';
    }
  </script>
</body>
</html>
