<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å­¦ä¹ äº¤æµå°å¤©åœ°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
  
  <link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'PT Serif', 'Crimson Text', ui-serif, 'Times New Roman', 'Georgia', serif; 
      background: linear-gradient(135deg, #e0e7ff 0%, #f4f6fa 100%); 
      margin: 0; 
      min-height: 100vh; 
      padding: 16px; 
      box-sizing: border-box; 
    }
    
    .container { 
      max-width: 900px; 
      margin: 0 auto; 
      background: #fff; 
      border-radius: 20px; 
      box-shadow: 0 16px 48px rgba(31,38,135,0.20); 
      overflow: hidden;
    }
    
    .header { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      padding: 20px 24px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    
    .header h1 { 
      margin: 0; 
      font-size: 24px; 
      font-weight: 700; 
    }
    
    .header-actions { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
    }
    
    .user-info { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      color: rgba(255,255,255,0.9); 
      font-size: 14px; 
    }
    
    .user-avatar-small { 
      width: 28px; 
      height: 28px; 
      border-radius: 50%; 
      border: 2px solid rgba(255,255,255,0.3); 
    }
    
    .new-post-btn { 
      background: rgba(255,255,255,0.2); 
      border: 2px solid rgba(255,255,255,0.3); 
      color: white; 
      border-radius: 20px; 
      padding: 8px 16px; 
      cursor: pointer; 
      font-size: 14px; 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      transition: all 0.2s; 
    }
    
    .new-post-btn:hover { 
      background: rgba(255,255,255,0.3); 
      border-color: rgba(255,255,255,0.5); 
    }
    
    .posts-container { 
      min-height: 500px; 
      padding: 20px 24px; 
      display: flex; 
      flex-direction: column; 
      gap: 16px; 
    }
    
    .post-card { 
      background: #f8fafc; 
      border-radius: 16px; 
      padding: 20px; 
      border: 1px solid #e2e8f0; 
      transition: box-shadow 0.2s; 
      margin-bottom: 20px; 
    }
    
    .post-card:hover { 
      box-shadow: 0 6px 20px rgba(0,0,0,0.08); 
    }
    
    .post-header { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin-bottom: 16px; 
      position: relative; 
    }
    
    .user-avatar { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      object-fit: cover;
      border: 2px solid #e5e7eb; 
    }
    
    .post-user-info { 
      flex: 1; 
    }
    
    .user-name { 
      font-weight: 600; 
      color: #1f2937; 
      font-size: 16px; 
    }
    
    .post-time { 
      color: #6b7280; 
      font-size: 13px; 
      margin-top: 2px; 
    }
    
    .post-content { 
      line-height: 1.6; 
      color: #374151; 
      margin-bottom: 16px; 
    }
    
    .text-content { 
      font-size: 15px; 
      white-space: pre-wrap; 
      line-height: 1.6; 
    }
    
    .image-content { 
      margin-top: 12px; 
    }
    
    .content-section { 
      margin-top: 12px; 
    }
    
    .content-section:first-child { 
      margin-top: 0; 
    }
    
    .message-image { 
      max-width: 100%; 
      max-height: 300px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    }
    
    .audio-card, .article-card { 
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); 
      border: 1px solid #0284c7; 
      border-radius: 12px; 
      padding: 16px; 
      margin-top: 12px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .audio-card:hover, .article-card:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 24px rgba(2,132,199,0.15); 
    }
    
    .card-header { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 8px; 
    }
    
    .card-icon { 
      font-size: 20px; 
    }
    
    .card-title { 
      font-weight: 600; 
      color: #0c4a6e; 
      font-size: 16px; 
    }
    
    .card-desc { 
      color: #075985; 
      font-size: 13px; 
      margin-bottom: 6px; 
    }
    
    .card-meta { 
      color: #0369a1; 
      font-size: 12px; 
    }
    
    .new-post-form { 
      background: #f0f9ff; 
      border: 2px dashed #0284c7; 
      border-radius: 16px; 
      padding: 20px; 
      margin-bottom: 20px; 
      display: none; 
    }
    
    .new-post-form.active { 
      display: block; 
    }
    
    .form-row { 
      margin-bottom: 16px; 
    }
    
    .form-label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600; 
      color: #1f2937; 
      font-size: 14px; 
    }
    
    .text-input { 
      width: 100%; 
      border: 1px solid #d1d5db; 
      border-radius: 12px; 
      padding: 12px 16px; 
      font-family: inherit; 
      font-size: 14px; 
      resize: vertical; 
      min-height: 100px; 
      box-sizing: border-box; 
    }
    
    .text-input:focus { 
      outline: none; 
      border-color: #0284c7; 
      box-shadow: 0 0 0 3px rgba(2,132,199,0.1); 
    }
    
    .form-actions { 
      display: flex; 
      gap: 12px; 
      justify-content: space-between; 
      align-items: center; 
    }
    
    .content-type-selector { 
      display: flex; 
      gap: 8px; 
    }
    
    .type-btn { 
      padding: 6px 12px; 
      border: 1px solid #d1d5db; 
      background: white; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 12px; 
      transition: all 0.2s; 
      display: flex; 
      align-items: center; 
      gap: 4px; 
    }
    
    .type-btn:hover { 
      background: #f3f4f6; 
      border-color: #9ca3af; 
    }
    
    .form-submit-actions { 
      display: flex; 
      gap: 8px; 
    }
    
    .form-btn { 
      padding: 10px 20px; 
      border: 1px solid #d1d5db; 
      border-radius: 8px; 
      cursor: pointer; 
      font-family: inherit; 
      font-size: 14px; 
      transition: all 0.2s; 
    }
    
    .form-btn.primary { 
      background: #0284c7; 
      border-color: #0284c7; 
      color: white; 
    }
    
    .form-btn.primary:hover { 
      background: #0369a1; 
    }
    
    .form-btn.secondary { 
      background: white; 
      color: #374151; 
    }
    
    .form-btn.secondary:hover { 
      background: #f9fafb; 
    }
    
    .modal-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.5); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000; 
      overflow: hidden; /* é˜²æ­¢èƒŒæ™¯æ»šåŠ¨ */
      touch-action: none; /* é˜²æ­¢è§¦æ‘¸æ»šåŠ¨èƒŒæ™¯ */
    }
    
    .modal { 
      background: white; 
      border-radius: 16px; 
      padding: 0; 
      max-width: 500px; 
      width: 90%; 
      max-height: 70vh; 
      overflow: hidden; 
      display: flex; 
      flex-direction: column; 
    }
    
    .large-modal { 
      max-width: 800px; 
      max-height: 80vh; 
    }
    
    .modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 20px 24px; 
      border-bottom: 1px solid #e5e7eb; 
    }
    
    .modal-header h3 { 
      margin: 0; 
      color: #1f2937; 
      font-size: 18px; 
    }
    
    .close-btn { 
      background: none; 
      border: none; 
      font-size: 24px; 
      cursor: pointer; 
      color: #6b7280; 
      padding: 0; 
      width: 32px; 
      height: 32px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      border-radius: 6px; 
    }
    
    .close-btn:hover { 
      background: #f3f4f6; 
      color: #374151; 
    }
    
    .modal-body { 
      display: flex; 
      flex: 1; 
      min-height: 0; 
    }
    
    .sidebar { 
      width: 200px; 
      background: #f8fafc; 
      border-right: 1px solid #e5e7eb; 
      overflow-y: auto; 
    }
    
    .sidebar-section { 
      padding: 16px; 
    }
    
    .section-title { 
      font-weight: 600; 
      color: #374151; 
      font-size: 14px; 
      margin-bottom: 12px; 
    }
    
    .category-list { 
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
    }
    
    .category-item { 
      padding: 10px 12px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 14px; 
      color: #4b5563; 
      transition: all 0.2s; 
    }
    
    .category-item:hover { 
      background: #e0f2fe; 
      color: #0c4a6e; 
    }
    
    .category-item.active { 
      background: #0284c7; 
      color: white; 
    }
    
    .category-item.active:hover { 
      background: #0369a1; 
    }
    
    .content-area { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      min-height: 0; 
    }
    
    .content-header { 
      padding: 16px 20px; 
      border-bottom: 1px solid #e5e7eb; 
    }
    
    .breadcrumb { 
      color: #6b7280; 
      font-size: 14px; 
    }
    
    .content-list { 
      flex: 1; 
      padding: 16px 20px; 
      overflow-y: auto; 
    }
    
    .empty-content { 
      text-align: center; 
      color: #9ca3af; 
      font-size: 14px; 
      padding: 40px 20px; 
    }
    
    .content-item { 
      padding: 12px 16px; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
      margin-bottom: 8px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .content-item:hover { 
      border-color: #0284c7; 
      box-shadow: 0 2px 8px rgba(2,132,199,0.1); 
    }
    
    .content-item.selected { 
      border-color: #0284c7; 
      background: #f0f9ff; 
    }
    
    .content-item-title { 
      font-weight: 600; 
      color: #1f2937; 
      margin-bottom: 4px; 
    }
    
    .content-item-meta { 
      color: #6b7280; 
      font-size: 12px; 
    }
    
    .content-item-actions { 
      display: flex; 
      gap: 8px; 
      margin-top: 8px; 
    }
    
    .content-item-btn { 
      padding: 4px 8px; 
      border: 1px solid #d1d5db; 
      background: white; 
      border-radius: 4px; 
      font-size: 11px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .content-item-btn:hover { 
      background: #f3f4f6; 
    }
    
    .content-item-btn.primary { 
      background: #0284c7; 
      border-color: #0284c7; 
      color: white; 
    }
    
    .content-item-btn.primary:hover { 
      background: #0369a1; 
    }
    
    .modal h3 { 
      margin: 0 0 16px; 
      color: #1f2937; 
    }
    
    .modal-section { 
      margin-bottom: 20px; 
    }
    
    .modal-section h4 { 
      margin: 0 0 8px; 
      color: #374151; 
      font-size: 14px; 
    }
    
    .item-list { 
      max-height: 200px; 
      overflow-y: auto; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
    }
    
    .item { 
      padding: 12px; 
      border-bottom: 1px solid #f3f4f6; 
      cursor: pointer; 
      transition: background 0.2s; 
    }
    
    .item:hover { 
      background: #f8fafc; 
    }
    
    .item:last-child { 
      border-bottom: none; 
    }
    
    .item-title { 
      font-weight: 600; 
      color: #1f2937; 
      margin-bottom: 4px; 
    }
    
    .item-meta { 
      color: #6b7280; 
      font-size: 12px; 
    }
    
    .modal-actions { 
      display: flex; 
      gap: 12px; 
      justify-content: flex-end; 
      padding: 16px 24px; 
      border-top: 1px solid #e5e7eb; 
      background: #f9fafb; 
    }
    
    .modal-btn { 
      padding: 8px 16px; 
      border: 1px solid #d1d5db; 
      border-radius: 8px; 
      cursor: pointer; 
      font-family: inherit; 
      transition: all 0.2s; 
    }
    
    .modal-btn.primary { 
      background: #6366f1; 
      border-color: #6366f1; 
      color: white; 
    }
    
    .modal-btn.primary:hover { 
      background: #5a5afc; 
    }
    
    .modal-btn.secondary { 
      background: white; 
      color: #374151; 
    }
    
    .modal-btn.secondary:hover { 
      background: #f9fafb; 
    }
    
    .empty-state { 
      text-align: center; 
      padding: 40px 20px; 
      color: #6b7280; 
    }
    
    .empty-icon { 
      font-size: 48px; 
      margin-bottom: 16px; 
      opacity: 0.5; 
    }
    
    .hidden { 
      display: none !important; 
    }
    
    /* å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†æ ·å¼ */
    .image-modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.9); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 2000; 
      cursor: pointer; 
    }
    
    .image-modal img { 
      max-width: 90vw; 
      max-height: 90vh; 
      object-fit: contain; 
      border-radius: 8px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.5); 
    }
    
        .image-modal .close-hint {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      padding: 8px 12px;
      border-radius: 20px;
    }
    
    /* æŒ‘æˆ˜ç›¸å…³æ ·å¼ */
    .word-count-btn {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      color: #6b7280;
    }
    
    .word-count-btn:hover {
      border-color: #4a90e2;
      color: #4a90e2;
    }
    
    .word-count-btn.active {
      background: #4a90e2;
      border-color: #4a90e2;
      color: white;
    }
    
    .challenge-article-item, .challenge-user-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 4px;
    }
    
    .challenge-article-item:hover, .challenge-user-item:hover {
      background: #f3f4f6;
    }
    
    .challenge-article-item.selected, .challenge-user-item.selected {
      background: #e0f2fe;
      border: 1px solid #0284c7;
    }
    
    .challenge-article-checkbox, .challenge-user-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid #d1d5db;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .challenge-article-item.selected .challenge-article-checkbox,
    .challenge-user-item.selected .challenge-user-checkbox {
      background: #0284c7;
      border-color: #0284c7;
      color: white;
    }
    
    .challenge-article-info, .challenge-user-info {
      flex: 1;
    }
    
    .challenge-article-title, .challenge-user-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }
    
    .challenge-article-meta, .challenge-user-meta {
      color: #6b7280;
      font-size: 12px;
      margin-top: 2px;
    }
    
    .challenge-option {
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      color: #374151;
    }
    
    .challenge-option:hover {
      border-color: #4a90e2;
      background: #f0f9ff;
    }
    
    .challenge-option.correct {
      border-color: #10b981;
      background: #d1fae5;
      color: #065f46;
    }
    
    .challenge-option.incorrect {
      border-color: #ef4444;
      background: #fee2e2;
      color: #991b1b;
    }
    
    .challenge-option.selected {
      border-color: #4a90e2;
      background: #dbeafe;
      color: #1e40af;
    }
    
    .challenge-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .challenge-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(245, 158, 11, 0.15);
    }
    
    .challenge-card .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .challenge-card .card-icon {
      font-size: 20px;
    }
    
    .challenge-card .card-title {
      font-weight: 600;
      color: #92400e;
      font-size: 16px;
    }
    
    .challenge-card .card-desc {
      color: #a16207;
      font-size: 13px;
      margin-bottom: 6px;
    }
    
    .challenge-card .card-meta {
      color: #d97706;
      font-size: 12px;
    }
    
    .ranking-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      background: white;
      border: 1px solid #e5e7eb;
      transition: all 0.2s;
    }
    
    .ranking-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .ranking-item.rank-1 {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
    }
    
    .ranking-item.rank-2 {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-color: #9ca3af;
    }
    
    .ranking-item.rank-3 {
      background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
      border-color: #c084fc;
    }
    
    .ranking-number {
      font-size: 24px;
      font-weight: 700;
      color: #374151;
      min-width: 40px;
      text-align: center;
    }
    
    .ranking-item.rank-1 .ranking-number {
      color: #d97706;
    }
    
    .ranking-item.rank-2 .ranking-number {
      color: #6b7280;
    }
    
    .ranking-item.rank-3 .ranking-number {
      color: #a855f7;
    }
    
    .ranking-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
    }
    
    .ranking-info {
      flex: 1;
    }
    
    .ranking-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    .ranking-score {
      color: #6b7280;
      font-size: 14px;
    }
    
    .ranking-points {
      font-size: 20px;
      font-weight: 700;
      color: #4a90e2;
    }
    
    /* æŒ‘æˆ˜æé†’æ¡æ ·å¼ */
    .challenge-alert {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: 0 0 16px 16px;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
      position: relative;
      z-index: 10;
    }
    
    .alert-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .alert-icon {
      font-size: 24px;
      animation: gentle-bounce 2s ease-in-out infinite;
    }
    
    @keyframes gentle-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }
    
    .alert-text {
      color: #92400e;
      font-weight: 600;
      font-size: 15px;
    }
    
    .alert-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .alert-btn-primary {
      background: #f59e0b;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .alert-btn-primary:hover {
      background: #d97706;
      transform: translateY(-1px);
    }
    
    .alert-btn-close {
      background: none;
      border: none;
      color: #92400e;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .alert-btn-close:hover {
      background: rgba(146, 64, 14, 0.1);
      transform: scale(1.1);
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0;
      }
      
      .container { 
        margin: 0; 
        border-radius: 0; 
        min-height: 100vh; 
        box-shadow: none;
      }
      
      /* æŒ‘æˆ˜æé†’æ¡ç§»åŠ¨ç«¯é€‚é… */
      .challenge-alert {
        padding: 12px 16px;
        flex-direction: column;
        gap: 12px;
        border-radius: 0;
      }
      
      .alert-content {
        justify-content: center;
        text-align: center;
      }
      
      .alert-text {
        font-size: 14px;
      }
      
      .alert-actions {
        width: 100%;
        justify-content: center;
      }
      
      .header {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .header h1 {
        font-size: 20px;
        text-align: center;
        margin: 0;
      }
      
      .header-actions {
        justify-content: space-between;
        width: 100%;
      }
      
      .user-info {
        font-size: 13px;
      }
      
      .user-avatar-small {
        width: 24px;
        height: 24px;
      }
      
      .new-post-btn {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 16px;
      }
      
      .posts-container { 
        padding: 12px 16px;
        min-height: calc(100vh - 180px); 
        gap: 12px;
      }
      
      .post-card {
        padding: 16px;
        margin-bottom: 16px;
        border-radius: 12px;
      }
      
      .post-header {
        margin-bottom: 12px;
      }
      
      .user-avatar {
        width: 32px;
        height: 32px;
      }
      
      .user-name {
        font-size: 14px;
      }
      
      .post-time {
        font-size: 11px;
      }
      
      .text-content {
        font-size: 14px;
      }
      
      .audio-card, .article-card {
        padding: 12px;
        margin-top: 8px;
      }
      
      .card-title {
        font-size: 14px;
      }
      
      .card-desc {
        font-size: 12px;
      }
      
      .card-meta {
        font-size: 11px;
      }
      
      .message-image {
        max-height: 250px;
      }
      
      .new-post-form {
        padding: 16px;
        margin-bottom: 16px;
        border-radius: 12px;
      }
      
      .text-input {
        min-height: 80px;
        font-size: 14px;
        padding: 10px 12px;
      }
      
      .form-actions {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .content-type-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        width: 100%;
      }
      
      /* æŒ‘æˆ˜åŠŸèƒ½ç§»åŠ¨ç«¯é€‚é… */
      .word-count-btn {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 16px;
      }
      
      .challenge-article-item, .challenge-user-item {
        padding: 6px 10px;
        margin-bottom: 3px;
      }
      
      .challenge-article-title, .challenge-user-name {
        font-size: 13px;
      }
      
      .challenge-article-meta, .challenge-user-meta {
        font-size: 11px;
      }
      
      .challenge-article-checkbox, .challenge-user-checkbox {
        width: 16px;
        height: 16px;
      }
      
      .challenge-option {
        padding: 12px;
        font-size: 14px;
        border-radius: 10px;
      }
      
      .challenge-card {
        padding: 12px;
        margin-top: 8px;
      }
      
      .challenge-card .card-title {
        font-size: 14px;
      }
      
      .challenge-card .card-desc {
        font-size: 12px;
      }
      
      .challenge-card .card-meta {
        font-size: 11px;
      }
      
      .ranking-item {
        padding: 12px;
        margin-bottom: 8px;
        gap: 12px;
      }
      
      .ranking-number {
        font-size: 20px;
        min-width: 32px;
      }
      
      .ranking-avatar {
        width: 40px;
        height: 40px;
      }
      
      .ranking-name {
        font-size: 14px;
      }
      
      .ranking-score {
        font-size: 12px;
      }
      
      .ranking-points {
        font-size: 16px;
      }
      
      /* æŒ‘æˆ˜æ¸¸æˆæ¨¡æ€æ¡†ç§»åŠ¨ç«¯é€‚é… */
      #challengeGameModal .modal {
        max-width: 95vw;
        max-height: 95vh;
        margin: 0 8px;
      }
      
      #challengeGameModal .modal-body {
        padding: 20px;
      }
      
      #challengeTimer {
        font-size: 20px;
        margin-bottom: 16px;
      }
      
      #challengeQuestion {
        font-size: 16px;
        min-height: 50px;
        padding: 16px;
        margin-bottom: 20px;
      }
      
      #challengeOptions {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .challenge-option {
        padding: 14px;
        font-size: 15px;
      }
      
      #challengeProgress {
        font-size: 12px;
      }
      
      /* æŒ‘æˆ˜åˆ›å»ºæ¨¡æ€æ¡†ç§»åŠ¨ç«¯é€‚é… */
      #challengeModal .modal {
        max-width: 95vw;
        max-height: 90vh;
        margin: 0 8px;
      }
      
      #challengeModal .modal-body {
        padding: 16px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
      
      #challengeTitle, #challengeDescription {
        font-size: 14px;
        padding: 8px 10px;
      }
      
      #challengeDescription {
        min-height: 50px;
      }
      
      #challengeArticleList, #challengeUserList {
        max-height: 150px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
      
      /* æŒ‘æˆ˜æ’åæ¨¡æ€æ¡†ç§»åŠ¨ç«¯é€‚é… */
      #challengeRankingModal .modal {
        max-width: 95vw;
        max-height: 90vh;
        margin: 0 8px;
      }
      
      #challengeRankingModal .modal-body {
        padding: 16px;
      }
      
      #challengeInfo {
        font-size: 13px;
        padding: 12px;
      }
      
      .type-btn {
        padding: 8px 12px;
        font-size: 12px;
        justify-content: center;
      }
      
      .form-submit-actions {
        width: 100%;
        justify-content: center;
      }
      
      .form-btn {
        flex: 1;
        max-width: 120px;
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .large-modal { 
        max-width: 95vw; 
        max-height: 90vh; 
        margin: 0 8px;
      }
      
      .modal-header {
        padding: 16px 20px;
      }
      
      .modal-header h3 {
        font-size: 16px;
      }
      
      .modal-body { 
        flex-direction: column; 
      }
      
      .sidebar { 
        width: 100%; 
        max-height: 120px; 
        border-right: none; 
        border-bottom: 1px solid #e5e7eb; 
      }
      
      .sidebar-section {
        padding: 12px 16px;
      }
      
      .section-title {
        font-size: 13px;
        margin-bottom: 8px;
      }
      
      .category-list { 
        flex-direction: row; 
        overflow-x: auto; 
        gap: 6px;
        padding-bottom: 8px; 
      }
      
      .category-item { 
        flex-shrink: 0; 
        white-space: nowrap; 
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .content-area { 
        min-height: 250px; 
      }
      
      .content-header {
        padding: 12px 16px;
      }
      
      .breadcrumb {
        font-size: 12px;
      }
      
      .content-list {
        padding: 12px 16px;
      }
      
      .content-item {
        padding: 10px 12px;
        margin-bottom: 6px;
      }
      
      .content-item-title {
        font-size: 13px;
        margin-bottom: 3px;
      }
      
      .content-item-meta {
        font-size: 11px;
      }
      
      .content-item-actions {
        margin-top: 6px;
        gap: 6px;
      }
      
      .content-item-btn {
        padding: 4px 8px;
        font-size: 10px;
        border-radius: 4px;
      }
      
      .modal-actions {
        padding: 12px 16px;
      }
      
      .modal-btn {
        padding: 8px 16px;
        font-size: 13px;
      }
      
      .expanded-content {
        margin-top: 8px !important;
        padding: 12px !important;
      }
      
      .image-modal .close-hint {
        top: 10px;
        right: 10px;
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .empty-state {
        padding: 30px 16px;
      }
      
      .empty-icon {
        font-size: 36px;
        margin-bottom: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 12px 16px;
      }
      
      .header h1 {
        font-size: 18px;
      }
      
      .user-info {
        font-size: 12px;
      }
      
      .user-avatar-small {
        width: 20px;
        height: 20px;
      }
      
      .new-post-btn {
        padding: 6px 10px;
        font-size: 12px;
        gap: 4px;
      }
      
      .posts-container {
        padding: 8px 12px;
      }
      
      .post-card {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      .user-avatar {
        width: 28px;
        height: 28px;
      }
      
      .user-name {
        font-size: 13px;
      }
      
      .post-time {
        font-size: 10px;
      }
      
      .text-content {
        font-size: 13px;
      }
      
      .audio-card, .article-card {
        padding: 10px;
      }
      
      .card-title {
        font-size: 13px;
      }
      
      .card-desc {
        font-size: 11px;
      }
      
      .card-meta {
        font-size: 10px;
      }
      
      .new-post-form {
        padding: 12px;
      }
      
      .text-input {
        min-height: 70px;
        font-size: 13px;
        padding: 8px 10px;
      }
      
      .content-type-selector {
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }
      
      .type-btn {
        padding: 6px 8px;
        font-size: 11px;
        gap: 3px;
      }
      
      .type-btn span:last-child {
        display: none;
      }
      
      /* æŒ‘æˆ˜åŠŸèƒ½å°å±å¹•é€‚é… */
      .word-count-btn {
        padding: 5px 10px;
        font-size: 11px;
      }
      
      .challenge-article-item, .challenge-user-item {
        padding: 5px 8px;
      }
      
      .challenge-article-title, .challenge-user-name {
        font-size: 12px;
      }
      
      .challenge-article-meta, .challenge-user-meta {
        font-size: 10px;
      }
      
      .challenge-option {
        padding: 10px;
        font-size: 13px;
      }
      
      .challenge-card {
        padding: 10px;
      }
      
      .challenge-card .card-title {
        font-size: 13px;
      }
      
      .challenge-card .card-desc {
        font-size: 11px;
      }
      
      .challenge-card .card-meta {
        font-size: 10px;
      }
      
      .ranking-item {
        padding: 10px;
        gap: 10px;
      }
      
      .ranking-number {
        font-size: 18px;
        min-width: 28px;
      }
      
      .ranking-avatar {
        width: 36px;
        height: 36px;
      }
      
      .ranking-name {
        font-size: 13px;
      }
      
      .ranking-score {
        font-size: 11px;
      }
      
      .ranking-points {
        font-size: 14px;
      }
      
      /* æŒ‘æˆ˜æ¸¸æˆæ¨¡æ€æ¡†å°å±å¹•é€‚é… */
      #challengeGameModal .modal {
        max-width: 98vw;
        max-height: 98vh;
        margin: 0 4px;
      }
      
      #challengeGameModal .modal-body {
        padding: 16px;
      }
      
      #challengeTimer {
        font-size: 18px;
        margin-bottom: 12px;
      }
      
      #challengeQuestion {
        font-size: 14px;
        min-height: 40px;
        padding: 12px;
        margin-bottom: 16px;
      }
      
      #challengeOptions {
        gap: 6px;
      }
      
      .challenge-option {
        padding: 12px;
        font-size: 14px;
      }
      
      #challengeProgress {
        font-size: 11px;
      }
      
      /* æŒ‘æˆ˜åˆ›å»ºæ¨¡æ€æ¡†å°å±å¹•é€‚é… */
      #challengeModal .modal {
        max-width: 98vw;
        max-height: 95vh;
        margin: 0 4px;
      }
      
      #challengeModal .modal-body {
        padding: 12px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
      
      #challengeTitle, #challengeDescription {
        font-size: 13px;
        padding: 6px 8px;
      }
      
      #challengeDescription {
        min-height: 40px;
      }
      
      #challengeArticleList, #challengeUserList {
        max-height: 120px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
      
      /* æŒ‘æˆ˜æ’åæ¨¡æ€æ¡†å°å±å¹•é€‚é… */
      #challengeRankingModal .modal {
        max-width: 98vw;
        max-height: 95vh;
        margin: 0 4px;
      }
      
      #challengeRankingModal .modal-body {
        padding: 12px;
      }
      
      #challengeInfo {
        font-size: 12px;
        padding: 10px;
      }
      
      .form-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .large-modal {
        max-width: 98vw;
        max-height: 95vh;
        margin: 0 4px;
      }
      
      .modal-header {
        padding: 12px 16px;
      }
      
      .modal-header h3 {
        font-size: 15px;
      }
      
      .sidebar-section {
        padding: 8px 12px;
      }
      
      .category-item {
        padding: 6px 10px;
        font-size: 11px;
      }
      
      .content-header {
        padding: 8px 12px;
      }
      
      .content-list {
        padding: 8px 12px;
      }
      
      .content-item {
        padding: 8px 10px;
      }
      
      .content-item-title {
        font-size: 12px;
      }
      
      .content-item-meta {
        font-size: 10px;
      }
      
      .content-item-btn {
        padding: 3px 6px;
        font-size: 9px;
      }
      
      .modal-actions {
        padding: 10px 12px;
      }
      
      .modal-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æŒ‘æˆ˜æé†’æ¡ -->
    <div id="challengeAlert" class="challenge-alert" style="display: none;">
      <div class="alert-content">
        <span class="alert-icon">ğŸ†</span>
        <div class="alert-text">
          <span id="alertMessage">æ‚¨æœ‰æ–°çš„è¯æ±‡æŒ‘æˆ˜ç­‰å¾…å®Œæˆ</span>
        </div>
      </div>
      <div class="alert-actions">
        <button class="alert-btn-primary" onclick="goToChallengePost()">æŸ¥çœ‹æŒ‘æˆ˜</button>
        <button class="alert-btn-close" onclick="dismissAlert()">Ã—</button>
      </div>
    </div>
    
    <div class="header">
      <h1>ğŸ“š å­¦ä¹ äº¤æµå°å¤©åœ°</h1>
      <div class="header-actions">
        <div class="user-info" id="userInfo">
          <img class="user-avatar-small" id="userAvatarSmall" src="" alt="">
          <span id="userDisplayName">åŠ è½½ä¸­...</span>
        </div>
        <button class="new-post-btn" onclick="toggleNewPostForm()">
          <span>+</span>
          <span>å‘å¸ƒæ–°å¸–</span>
        </button>
      </div>
    </div>
    
    <div class="posts-container" id="postsContainer">
      <!-- æ–°å¸–å‘å¸ƒè¡¨å• -->
      <div class="new-post-form" id="newPostForm">
        <div class="form-row">
          <label class="form-label">åˆ†äº«å†…å®¹</label>
          <textarea 
            class="text-input" 
            id="postContent" 
            placeholder="åˆ†äº«ä½ çš„å­¦ä¹ å¿ƒå¾—ã€ç»éªŒæˆ–æƒ³æ³•..."
          ></textarea>
        </div>
        
        <div class="form-actions">
          <div class="content-type-selector">
            <button class="type-btn" onclick="showAudioSelector()">
              <span>ğŸ¤</span>
              <span>æ·»åŠ éŸ³é¢‘</span>
            </button>
            <button class="type-btn" onclick="showArticleSelector()">
              <span>ğŸ“</span>
              <span>æ·»åŠ æ–‡ç« </span>
            </button>
            <button class="type-btn" onclick="showImageUploader()">
              <span>ğŸ–¼ï¸</span>
              <span>æ·»åŠ å›¾ç‰‡</span>
            </button>
            <button class="type-btn" onclick="showChallengeCreator()">
              <span>ğŸ†</span>
              <span>å‘èµ·æŒ‘æˆ˜</span>
            </button>
          </div>
          
          <div class="form-submit-actions">
            <button class="form-btn secondary" onclick="cancelNewPost()">å–æ¶ˆ</button>
            <button class="form-btn primary" onclick="submitPost()">å‘å¸ƒ</button>
          </div>
        </div>
        
        <!-- é¢å¤–å†…å®¹é€‰æ‹©åŒºåŸŸ -->
        <div id="extraContentArea"></div>
      </div>
      
      <!-- å¸–å­åˆ—è¡¨ -->
      <div id="postsList">
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">ğŸ“</div>
          <div>è¿˜æ²¡æœ‰å¸–å­ï¼Œç‚¹å‡»ä¸Šæ–¹"å‘å¸ƒæ–°å¸–"å¼€å§‹åˆ†äº«å§ï¼</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- éŸ³é¢‘åˆ†äº«æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="audioModal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>åˆ†äº«éŸ³é¢‘å†…å®¹</h3>
        <button class="close-btn" onclick="closeModal('audioModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="sidebar">
          <div class="sidebar-section">
            <div class="section-title">é€‰æ‹©åˆ†ç±»</div>
            <div class="category-list" id="audioCategoryList">
              <div class="category-item" data-category="Part1">Part 1</div>
              <div class="category-item" data-category="Part2">Part 2</div>
              <div class="category-item" data-category="Part3">Part 3</div>
              <div class="category-item" data-category="å…¶ä»–">å…¶ä»–</div>
            </div>
          </div>
        </div>
        <div class="content-area">
          <div class="content-header">
            <div class="breadcrumb" id="audioBreadcrumb">è¯·é€‰æ‹©åˆ†ç±»</div>
          </div>
          <div class="content-list" id="audioContentList">
            <div class="empty-content">è¯·å…ˆé€‰æ‹©å·¦ä¾§åˆ†ç±»</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeModal('audioModal')">å…³é—­</button>
      </div>
    </div>
  </div>
  
  <!-- æ–‡ç« åˆ†äº«æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="articleModal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>åˆ†äº«ç²¾è¯»æ–‡ç« </h3>
        <button class="close-btn" onclick="closeModal('articleModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="sidebar">
          <div class="sidebar-section">
            <div class="section-title">é€‰æ‹©åˆ†ç±»</div>
            <div class="category-list" id="articleCategoryList">
              <div class="category-item" data-category="Reading">Reading</div>
              <div class="category-item" data-category="Listening">Listening</div>
              <div class="category-item" data-category="Writing">Writing</div>
            </div>
          </div>
        </div>
        <div class="content-area">
          <div class="content-header">
            <div class="breadcrumb" id="articleBreadcrumb">è¯·é€‰æ‹©åˆ†ç±»</div>
          </div>
          <div class="content-list" id="articleContentList">
            <div class="empty-content">è¯·å…ˆé€‰æ‹©å·¦ä¾§åˆ†ç±»</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeModal('articleModal')">å…³é—­</button>
      </div>
    </div>
  </div>
  
  <!-- æŒ‘æˆ˜åˆ›å»ºæ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="challengeModal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>å‘èµ·è¯æ±‡æŒ‘æˆ˜</h3>
        <button class="close-btn" onclick="closeModal('challengeModal')">Ã—</button>
      </div>
      <div class="modal-body" style="flex-direction: column;">
        <div style="padding: 20px;">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">æŒ‘æˆ˜æ ‡é¢˜</label>
            <input type="text" id="challengeTitle" placeholder="è¾“å…¥æŒ‘æˆ˜æ ‡é¢˜..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">æŒ‘æˆ˜æè¿°ï¼ˆå¯é€‰ï¼‰</label>
            <textarea id="challengeDescription" placeholder="æè¿°ä¸€ä¸‹è¿™ä¸ªæŒ‘æˆ˜..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; min-height: 60px; resize: vertical; box-sizing: border-box;"></textarea>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">é€‰æ‹©æ–‡ç« </label>
            <div id="challengeArticleList" style="max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; touch-action: pan-y;">
              <div style="text-align: center; padding: 20px; color: #6b7280;">åŠ è½½ä¸­...</div>
            </div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">è¯æ±‡æ•°é‡</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button class="word-count-btn active" data-count="5" onclick="selectWordCount(5)">5ä¸ª</button>
              <button class="word-count-btn" data-count="10" onclick="selectWordCount(10)">10ä¸ª</button>
              <button class="word-count-btn" data-count="15" onclick="selectWordCount(15)">15ä¸ª</button>
              <span style="margin: 0 8px; color: #6b7280;">æˆ–</span>
              <input type="number" id="customWordCount" placeholder="è‡ªå®šä¹‰" min="1" max="50" style="width: 80px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
            </div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">@ ç”¨æˆ·ï¼ˆå¯é€‰ï¼‰</label>
            <div id="challengeUserList" style="max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; touch-action: pan-y;">
              <div style="text-align: center; padding: 20px; color: #6b7280;">åŠ è½½ä¸­...</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeModal('challengeModal')">å–æ¶ˆ</button>
        <button class="modal-btn primary" onclick="createChallenge()">åˆ›å»ºæŒ‘æˆ˜</button>
      </div>
    </div>
  </div>

  <!-- æŒ‘æˆ˜æ¸¸æˆæ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="challengeGameModal" style="background: rgba(0,0,0,0.9);">
    <div class="modal" style="max-width: 600px; max-height: 90vh;">
      <div class="modal-header">
        <h3 id="challengeGameTitle">è¯æ±‡æŒ‘æˆ˜</h3>
        <div id="challengeProgress" style="color: #6b7280; font-size: 14px;"></div>
      </div>
      <div class="modal-body" style="flex-direction: column; padding: 30px;">
        <div id="challengeTimer" style="text-align: center; margin-bottom: 20px; font-size: 24px; font-weight: 700; color: #ef4444;"></div>
        
        <div id="challengeQuestion" style="text-align: center; margin-bottom: 30px; font-size: 20px; font-weight: 600; color: #1f2937; min-height: 60px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 12px; padding: 20px;"></div>
        
        <div id="challengeOptions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div id="challengeResult" style="display: none; text-align: center; margin-top: 20px; padding: 20px; border-radius: 12px;"></div>
      </div>
    </div>
  </div>

  <!-- æŒ‘æˆ˜æ’åæ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="challengeRankingModal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3 id="rankingTitle">æŒ‘æˆ˜æ’å</h3>
        <button class="close-btn" onclick="closeModal('challengeRankingModal')">Ã—</button>
      </div>
      <div class="modal-body" style="flex-direction: column; padding: 20px;">
        <div id="challengeInfo" style="text-align: center; margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 12px; color: #6b7280;"></div>
        <div id="rankingList" style="flex: 1; overflow-y: auto;">
          <!-- æ’åå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn primary" onclick="closeModal('challengeRankingModal')">å…³é—­</button>
      </div>
    </div>
  </div>
  
  <!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <div class="close-hint">ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­</div>
    <img id="modalImage" src="" alt="æ”¾å¤§å›¾ç‰‡">
  </div>
  
  <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ input -->
  <input type="file" id="imageUpload" accept="image/*" style="display: none" onchange="handleImageUpload(event)">
  
  <script>
    let currentUser = null;
    let authToken = null;
    let selectedItems = {
      audios: [],
      articles: [],
      images: [],
      challenge: null
    };
    
    // æŒ‘æˆ˜ç›¸å…³å˜é‡
    let challengeData = {
      selectedArticles: [],
      selectedUsers: [],
      wordCount: 5
    };
    let currentChallenge = null;
    let currentChallengeAnswers = [];
    let currentQuestionIndex = 0;
    let challengeTimer = null;
    let questionStartTime = 0;
    let pendingChallenges = [];
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkStoredToken(){
      const tk = localStorage.getItem('authToken');
      if(!tk) return Promise.resolve(false);
      return fetch('/verify_token',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({token:tk})})
        .then(r=>r.json()).then(d=>{ 
          if(d.valid){ 
            authToken=tk; 
            // å°è¯•è·å–å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
            const userStr = localStorage.getItem('currentUser');
            if(userStr) {
              try {
                currentUser = JSON.parse(userStr);
              } catch(e) {}
            }
            return true;
          } 
          localStorage.removeItem('authToken'); 
          localStorage.removeItem('currentUser');
          return false; 
        })
        .catch(()=>{ 
          localStorage.removeItem('authToken'); 
          localStorage.removeItem('currentUser');
          return false; 
        });
    }
    
    function redirectToLogin() {
      window.location.href = '/login';
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
      // é¦–å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€
      checkStoredToken().then(valid=>{
        if(!valid) {
          redirectToLogin();
          return;
        }
        
        // ç™»å½•æˆåŠŸåç»§ç»­åˆå§‹åŒ–
        showUserInfo();
        loadPosts();
        checkPendingChallenges();
      });
    };
    
    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    function showUserInfo() {
      if(currentUser) {
        document.getElementById('userAvatarSmall').src = `/static/${currentUser.avatar}`;
        document.getElementById('userDisplayName').textContent = currentUser.display_name;
      }
    }
    
    // åˆ‡æ¢æ–°å¸–è¡¨å•
    function toggleNewPostForm() {
      const form = document.getElementById('newPostForm');
      form.classList.toggle('active');
      if (form.classList.contains('active')) {
        document.getElementById('postContent').focus();
      }
    }
    
    // å–æ¶ˆæ–°å¸–
    function cancelNewPost() {
      document.getElementById('newPostForm').classList.remove('active');
      document.getElementById('postContent').value = '';
      document.getElementById('extraContentArea').innerHTML = '';
      
      // æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
      selectedItems = {
        audios: [],
        articles: [],
        images: [],
        challenge: null
      };
    }
    
    // æ›´æ–°å†…å®¹é¢„è§ˆåŒºåŸŸ
    function updateContentPreview() {
      const extraArea = document.getElementById('extraContentArea');
      extraArea.innerHTML = '';
      
      // æ˜¾ç¤ºæ‰€æœ‰é€‰ä¸­çš„å†…å®¹
      selectedItems.audios.forEach((audio, index) => {
        extraArea.appendChild(createAudioPreview(audio, index));
      });
      
      selectedItems.articles.forEach((article, index) => {
        extraArea.appendChild(createArticlePreview(article, index));
      });
      
      selectedItems.images.forEach((image, index) => {
        extraArea.appendChild(createImagePreview(image, index));
      });
      
      // æ˜¾ç¤ºæŒ‘æˆ˜å†…å®¹
      if (selectedItems.challenge) {
        extraArea.appendChild(createChallengePreview(selectedItems.challenge, 0));
      }
    }
    
    // æäº¤å¸–å­
    function submitPost() {
      const content = document.getElementById('postContent').value.trim();
      if (!content && selectedItems.audios.length === 0 && selectedItems.articles.length === 0 && selectedItems.images.length === 0 && !selectedItems.challenge) {
        alert('è¯·è¾“å…¥å†…å®¹æˆ–æ·»åŠ åˆ†äº«å†…å®¹');
        return;
      }
      
      let postData = {
        type: 'mixed_content',
        content: {
          text: content,
          audios: selectedItems.audios,
          articles: selectedItems.articles,
          images: selectedItems.images,
          challenge: selectedItems.challenge
        }
      };
      
      postMessage(postData);
    }
    
    // æ˜¾ç¤ºå›¾ç‰‡ä¸Šä¼ å™¨
    function showImageUploader() {
      const extraArea = document.getElementById('extraContentArea');
      extraArea.innerHTML = `
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
          <label class="form-label">ä¸Šä¼ å›¾ç‰‡</label>
          <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px;">
        </div>
      `;
    }
    
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('image', file);
      formData.append('user_id', currentUser.username);
      
      fetch('/api/upload_message_image', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
          selectedItems.images.push({
            filename: data.filename,
            caption: ''
          });
          
          updateContentPreview();
        } else {
          alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      })
      .catch(e => {
        alert('ä¸Šä¼ å¤±è´¥ï¼š' + e.message);
      });
      
      // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
      event.target.value = '';
    }
    
    // åˆ›å»ºéŸ³é¢‘é¢„è§ˆç»„ä»¶
    function createAudioPreview(audio, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      if (audio.type === 'single') {
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label class="form-label">éŸ³é¢‘ ${index + 1}</label>
            <button onclick="removeSelectedItem('audios', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ç§»é™¤</button>
          </div>
          <div style="padding: 16px; background: #f0f9ff; border: 1px solid #0284c7; border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 20px;">ğŸ¤</span>
              <div>
                <div style="font-weight: 600; color: #0c4a6e;">${audio.filename.replace('.mp3', '')}</div>
                <div style="color: #0369a1; font-size: 12px;">æ¥è‡ªï¼š${audio.folder}</div>
              </div>
            </div>
            ${audio.question ? `<div style="color: #075985; font-size: 13px; margin-bottom: 8px; line-height: 1.4; white-space: pre-wrap;">${audio.question}</div>` : ''}
          </div>
        `;
      } else {
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label class="form-label">åˆé›†éŸ³é¢‘ ${index + 1}</label>
            <button onclick="removeSelectedItem('audios', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ç§»é™¤</button>
          </div>
          <div style="padding: 16px; background: #fef9c3; border: 1px solid #eab308; border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 20px;">ğŸµ</span>
              <div>
                <div style="font-weight: 600; color: #92400e;">${audio.folder}</div>
                <div style="color: #a16207; font-size: 12px;">${audio.file_count} ä¸ªéŸ³é¢‘çš„åˆé›†</div>
              </div>
            </div>
            ${audio.question ? `<div style="color: #a16207; font-size: 13px; margin-bottom: 8px; line-height: 1.4; white-space: pre-wrap;">${audio.question}</div>` : ''}
          </div>
        `;
      }
      
      return div;
    }
    
    // åˆ›å»ºæ–‡ç« é¢„è§ˆç»„ä»¶
    function createArticlePreview(article, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label class="form-label">æ–‡ç«  ${index + 1}</label>
          <button onclick="removeSelectedItem('articles', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ç§»é™¤</button>
        </div>
        <div style="padding: 16px; background: #f0fdf4; border: 1px solid #16a34a; border-radius: 12px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 20px;">ğŸ“</span>
            <div>
              <div style="font-weight: 600; color: #14532d;">${article.title}</div>
              <div style="color: #15803d; font-size: 12px;">${article.category} â€¢ ${article.highlight_count} ä¸ªé«˜äº®è¯æ±‡</div>
            </div>
          </div>
        </div>
      `;
      
      return div;
    }
    
    // åˆ›å»ºå›¾ç‰‡é¢„è§ˆç»„ä»¶
    function createImagePreview(image, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label class="form-label">å›¾ç‰‡ ${index + 1}</label>
          <button onclick="removeSelectedItem('images', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ç§»é™¤</button>
        </div>
        <div style="padding: 16px; background: #fef7ff; border: 1px solid #a855f7; border-radius: 12px;">
          <img src="/message_images/${image.filename}" alt="é¢„è§ˆå›¾ç‰‡" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
        </div>
      `;
      
      return div;
    }
    
    // ç§»é™¤é€‰ä¸­çš„é¡¹ç›®
    function removeSelectedItem(type, index) {
      if (type === 'challenge') {
        selectedItems.challenge = null;
      } else {
        selectedItems[type].splice(index, 1);
      }
      updateContentPreview();
    }
    
    // æ˜¾ç¤ºéŸ³é¢‘é€‰æ‹©å™¨
    function showAudioSelector() {
      document.getElementById('audioModal').style.display = 'flex';
      // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      resetAudioModal();
      loadAudioList();
    }
    
    // æ˜¾ç¤ºæ–‡ç« é€‰æ‹©å™¨
    function showArticleSelector() {
      document.getElementById('articleModal').style.display = 'flex';
      // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      resetArticleModal();
      loadArticleList();
    }
    
    // é‡ç½®éŸ³é¢‘æ¨¡æ€æ¡†
    function resetAudioModal() {
      document.querySelectorAll('#audioCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById('audioBreadcrumb').textContent = 'è¯·é€‰æ‹©åˆ†ç±»';
      document.getElementById('audioContentList').innerHTML = '<div class="empty-content">è¯·å…ˆé€‰æ‹©å·¦ä¾§åˆ†ç±»</div>';
    }
    
    // é‡ç½®æ–‡ç« æ¨¡æ€æ¡†
    function resetArticleModal() {
      document.querySelectorAll('#articleCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById('articleBreadcrumb').textContent = 'è¯·é€‰æ‹©åˆ†ç±»';
      document.getElementById('articleContentList').innerHTML = '<div class="empty-content">è¯·å…ˆé€‰æ‹©å·¦ä¾§åˆ†ç±»</div>';
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      // æ¢å¤èƒŒæ™¯æ»šåŠ¨
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
    }
    
    // åŠ è½½éŸ³é¢‘åˆ—è¡¨
    function loadAudioList() {
      fetch('/api/get_audio_list')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            audioData = data.categories;
            setupAudioModal();
          }
        })
        .catch(e => console.error('åŠ è½½éŸ³é¢‘åˆ—è¡¨å¤±è´¥:', e));
    }
    
    let audioData = {};
    let articleData = {};
    
    // è®¾ç½®éŸ³é¢‘æ¨¡æ€æ¡†
    function setupAudioModal() {
      const categoryItems = document.querySelectorAll('#audioCategoryList .category-item');
      categoryItems.forEach(item => {
        item.onclick = () => {
          const category = item.dataset.category;
          selectAudioCategory(category, item);
        };
      });
    }
    
    // é€‰æ‹©éŸ³é¢‘åˆ†ç±»
    function selectAudioCategory(category, itemEl) {
      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('#audioCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      itemEl.classList.add('active');
      
      // æ›´æ–°é¢åŒ…å±‘
      document.getElementById('audioBreadcrumb').textContent = category;
      
      // æ¸²æŸ“å†…å®¹
      renderAudioContent(category);
    }
    
    // æ¸²æŸ“éŸ³é¢‘å†…å®¹
    function renderAudioContent(category) {
      const contentList = document.getElementById('audioContentList');
      const items = audioData[category] || [];
      
      if (items.length === 0) {
        contentList.innerHTML = '<div class="empty-content">è¯¥åˆ†ç±»ä¸‹æš‚æ— å†…å®¹</div>';
        return;
      }
      
      contentList.innerHTML = '';
      items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'content-item';
        
        const titleEl = document.createElement('div');
        titleEl.className = 'content-item-title';
        titleEl.textContent = item.folder;
        
        const metaEl = document.createElement('div');
        metaEl.className = 'content-item-meta';
        let metaText = `${item.file_count} ä¸ªéŸ³é¢‘`;
        if (item.has_combined) metaText += ' â€¢ æœ‰åˆé›†';
        if (item.question) metaText += ` â€¢ ${item.question.substring(0, 40)}...`;
        metaEl.textContent = metaText;
        
        const actionsEl = document.createElement('div');
        actionsEl.className = 'content-item-actions';
        
        // å•ç‹¬éŸ³é¢‘æŒ‰é’®
        const singleBtn = document.createElement('button');
        singleBtn.className = 'content-item-btn';
        singleBtn.textContent = 'åˆ†äº«å•ç‹¬éŸ³é¢‘';
        singleBtn.onclick = (e) => {
          e.stopPropagation();
          selectAudioItem(item, 'single', itemEl);
        };
        
        actionsEl.appendChild(singleBtn);
        
        // åˆé›†éŸ³é¢‘æŒ‰é’®ï¼ˆå¦‚æœæœ‰åˆé›†ï¼‰
        if (item.has_combined) {
          const combinedBtn = document.createElement('button');
          combinedBtn.className = 'content-item-btn primary';
          combinedBtn.textContent = 'åˆ†äº«åˆé›†éŸ³é¢‘';
          combinedBtn.onclick = (e) => {
            e.stopPropagation();
            selectAudioItem(item, 'combined', itemEl);
          };
          actionsEl.appendChild(combinedBtn);
        }
        
        itemEl.appendChild(titleEl);
        itemEl.appendChild(metaEl);
        itemEl.appendChild(actionsEl);
        
        contentList.appendChild(itemEl);
      });
    }
    
    // é€‰æ‹©éŸ³é¢‘é¡¹ç›®
    function selectAudioItem(item, type, itemEl) {
      if (type === 'single') {
        // åœ¨å½“å‰é¡¹ç›®ä¸‹å±•å¼€å•ä¸ªéŸ³é¢‘é€‰æ‹©
        showIndividualAudioInline(item, itemEl);
      } else {
        // åœ¨å½“å‰é¡¹ç›®ä¸‹å±•å¼€åˆé›†éŸ³é¢‘é€‰æ‹©
        showCombinedAudioInline(item, itemEl);
      }
    }
    
    // åœ¨è¡Œå†…å±•å¼€å•ä¸ªéŸ³é¢‘é€‰æ‹©
    function showIndividualAudioInline(item, itemEl) {
      // ç§»é™¤å…¶ä»–å±•å¼€çš„å†…å®¹
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // è·å–å…·ä½“éŸ³é¢‘æ–‡ä»¶åˆ—è¡¨
      fetch(`/list_audio`)
        .then(r => r.json())
        .then(data => {
          if (data) {
            // æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶å¤¹è¯¦ç»†ä¿¡æ¯
            let folderData = null;
            Object.keys(data).forEach(category => {
              const found = data[category].find(f => f.folder === item.folder);
              if (found) folderData = found;
            });
            
            if (folderData && folderData.files) {
              renderIndividualAudioInline(item, folderData.files, itemEl);
            }
          }
        })
        .catch(e => console.error('è·å–éŸ³é¢‘æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', e));
    }
    
    // åœ¨è¡Œå†…å±•å¼€åˆé›†éŸ³é¢‘é€‰æ‹©
    function showCombinedAudioInline(item, itemEl) {
      // ç§»é™¤å…¶ä»–å±•å¼€çš„å†…å®¹
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // åˆ›å»ºåˆé›†éŸ³é¢‘å±•å¼€å†…å®¹
      const expandedDiv = document.createElement('div');
      expandedDiv.className = 'expanded-content';
      expandedDiv.style.cssText = `
        margin-top: 12px; 
        padding: 16px; 
        background: #fef9c3; 
        border: 1px solid #eab308; 
        border-radius: 8px;
      `;
      
      expandedDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div>
            <div style="font-weight: 600; color: #92400e; font-size: 13px;">åˆé›†éŸ³é¢‘é¢„è§ˆ</div>
            <div style="color: #a16207; font-size: 11px;">${item.file_count} ä¸ªéŸ³é¢‘çš„åˆé›†</div>
          </div>
          <button onclick="this.closest('.expanded-content').remove()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px;">æ”¶èµ·</button>
        </div>
        ${item.question ? `<div style="color: #a16207; font-size: 12px; margin-bottom: 8px; line-height: 1.4;">${item.question}</div>` : ''}
        <button onclick="addCombinedAudio('${item.folder}', ${item.file_count}, ${item.has_combined}, '${item.question || ''}')" style="background: #0284c7; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 11px;">æ·»åŠ åˆ°å¸–å­</button>
      `;
      
      itemEl.appendChild(expandedDiv);
    }
    
    // åœ¨è¡Œå†…æ¸²æŸ“å•ä¸ªéŸ³é¢‘æ–‡ä»¶
    function renderIndividualAudioInline(folderItem, files, itemEl) {
      const expandedDiv = document.createElement('div');
      expandedDiv.className = 'expanded-content';
      expandedDiv.style.cssText = `
        margin-top: 12px; 
        padding: 16px; 
        background: #f0f9ff; 
        border: 1px solid #0284c7; 
        border-radius: 8px;
      `;
      
      let filesHtml = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="font-weight: 600; color: #0c4a6e; font-size: 13px;">é€‰æ‹©å…·ä½“éŸ³é¢‘æ–‡ä»¶</div>
          <button onclick="this.closest('.expanded-content').remove()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px;">æ”¶èµ·</button>
        </div>
        <div style="max-height: 200px; overflow-y: auto;">
      `;
      
      files.forEach((file, index) => {
        filesHtml += `
          <div style="padding: 8px 12px; border: 1px solid #e0f2fe; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;" 
               onmouseover="this.style.background='#e0f2fe'" 
               onmouseout="this.style.background=''" 
               onclick="selectIndividualAudioFile('${folderItem.folder}', '${file.name}', '${file.question || ''}')">
            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px; font-size: 13px;">${file.name.replace('.mp3', '')}</div>
            ${file.question ? `<div style="color: #6b7280; font-size: 11px; line-height: 1.4;">${file.question}</div>` : ''}
          </div>
        `;
      });
      
      filesHtml += '</div>';
      expandedDiv.innerHTML = filesHtml;
      itemEl.appendChild(expandedDiv);
    }
    
    // é€‰æ‹©å•ä¸ªéŸ³é¢‘æ–‡ä»¶
    function selectIndividualAudioFile(folder, filename, question) {
      // ç§»é™¤å±•å¼€å†…å®¹
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
      const audioItem = {
        folder: folder,
        filename: filename,
        question: question,
        type: 'single'
      };
      
      selectedItems.audios.push(audioItem);
      updateContentPreview();
      closeModal('audioModal');
    }
    
    // æ·»åŠ åˆé›†éŸ³é¢‘
    function addCombinedAudio(folder, fileCount, hasCombined, question) {
      // ç§»é™¤å±•å¼€å†…å®¹
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
      const audioItem = {
        folder: folder,
        file_count: fileCount,
        has_combined: hasCombined,
        question: question,
        type: 'combined'
      };
      
      selectedItems.audios.push(audioItem);
      updateContentPreview();
      closeModal('audioModal');
    }
    

    

    
    // åŠ è½½æ–‡ç« åˆ—è¡¨
    function loadArticleList() {
      fetch('/api/get_articles_list')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            articleData = data.categories;
            setupArticleModal();
          }
        })
        .catch(e => console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥:', e));
    }
    
    // è®¾ç½®æ–‡ç« æ¨¡æ€æ¡†
    function setupArticleModal() {
      const categoryItems = document.querySelectorAll('#articleCategoryList .category-item');
      categoryItems.forEach(item => {
        item.onclick = () => {
          const category = item.dataset.category;
          selectArticleCategory(category, item);
        };
      });
    }
    
    // é€‰æ‹©æ–‡ç« åˆ†ç±»
    function selectArticleCategory(category, itemEl) {
      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('#articleCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      itemEl.classList.add('active');
      
      // æ›´æ–°é¢åŒ…å±‘
      document.getElementById('articleBreadcrumb').textContent = category;
      
      // æ¸²æŸ“å†…å®¹
      renderArticleContent(category);
    }
    
    // æ¸²æŸ“æ–‡ç« å†…å®¹
    function renderArticleContent(category) {
      const contentList = document.getElementById('articleContentList');
      const items = articleData[category] || [];
      
      if (items.length === 0) {
        contentList.innerHTML = '<div class="empty-content">è¯¥åˆ†ç±»ä¸‹æš‚æ— å†…å®¹</div>';
        return;
      }
      
      contentList.innerHTML = '';
      items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'content-item';
        itemEl.onclick = () => selectArticleItem(item, itemEl);
        
        const titleEl = document.createElement('div');
        titleEl.className = 'content-item-title';
        titleEl.textContent = item.title;
        
        const metaEl = document.createElement('div');
        metaEl.className = 'content-item-meta';
        metaEl.textContent = `${item.highlight_count} ä¸ªé«˜äº®è¯æ±‡`;
        
        itemEl.appendChild(titleEl);
        itemEl.appendChild(metaEl);
        contentList.appendChild(itemEl);
      });
    }
    
    // é€‰æ‹©æ–‡ç« é¡¹ç›®
    function selectArticleItem(item, itemEl) {
      // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
      selectedItems.articles.push(item);
      updateContentPreview();
      closeModal('articleModal');
    }
    

    

    
    // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
    function postMessage(message) {
      // æ·»åŠ tokenåˆ°è¯·æ±‚ä½“
      message.token = authToken;
      
      fetch('/api/messages', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(message)
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // å…³é—­æ–°å¸–è¡¨å•
          cancelNewPost();
          // ç«‹å³å°†æ–°å¸–æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨ï¼Œè€Œä¸æ˜¯é‡æ–°åŠ è½½æ•´ä¸ªåˆ—è¡¨
          addNewPostToTop(data.message);
        } else {
          alert('å‘é€å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      })
      .catch(e => {
        alert('å‘é€å¤±è´¥ï¼š' + e.message);
      });
    }
    
    // å°†æ–°å¸–æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
    function addNewPostToTop(newPost) {
      const postsList = document.getElementById('postsList');
      const emptyState = document.getElementById('emptyState');
      
      // éšè—ç©ºçŠ¶æ€
      if (emptyState) {
        emptyState.style.display = 'none';
      }
      
      // åˆ›å»ºæ–°å¸–å…ƒç´ 
      const newPostEl = createPostElement(newPost);
      
      // æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
      if (postsList.firstChild) {
        postsList.insertBefore(newPostEl, postsList.firstChild);
      } else {
        postsList.appendChild(newPostEl);
      }
      
      // æ·»åŠ ä¸€ä¸ªè½»å¾®çš„åŠ¨ç”»æ•ˆæœ
      newPostEl.style.opacity = '0';
      newPostEl.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        newPostEl.style.transition = 'all 0.3s ease';
        newPostEl.style.opacity = '1';
        newPostEl.style.transform = 'translateY(0)';
      }, 100);
    }
    
    // åŠ è½½æ‰€æœ‰å¸–å­
    function loadPosts() {
      fetch('/api/messages')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            renderPosts(data.messages);
          }
        })
        .catch(e => console.error('åŠ è½½å¸–å­å¤±è´¥:', e));
    }
    
    // æ¸²æŸ“å¸–å­åˆ—è¡¨
    function renderPosts(posts) {
      const container = document.getElementById('postsList');
      const emptyState = document.getElementById('emptyState');
      
      if (posts.length === 0) {
        emptyState.style.display = 'block';
        return;
      } else {
        emptyState.style.display = 'none';
      }
      
      container.innerHTML = '';
      
      posts.forEach(post => {
        const postEl = createPostElement(post);
        container.appendChild(postEl);
      });
    }
    
    // åˆ›å»ºå¸–å­å…ƒç´ 
    function createPostElement(post) {
      const postEl = document.createElement('div');
      postEl.className = 'post-card';
      postEl.setAttribute('data-post-id', post.id);
      
      const header = document.createElement('div');
      header.className = 'post-header';
      
      const avatar = document.createElement('img');
      avatar.className = 'user-avatar';
      avatar.src = `/static/${post.user.avatar}`;
      avatar.alt = post.user.display_name;
      
      const userInfo = document.createElement('div');
      userInfo.className = 'post-user-info';
      
      const userName = document.createElement('div');
      userName.className = 'user-name';
      userName.textContent = post.user.display_name;
      
      const time = document.createElement('div');
      time.className = 'post-time';
      time.textContent = formatTime(post.timestamp);
      
      userInfo.appendChild(userName);
      userInfo.appendChild(time);
      
      // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„å¸–å­ï¼Œæ·»åŠ åˆ é™¤æŒ‰é’®åˆ°å³ä¸Šè§’
      if (currentUser && post.user.username === currentUser.username) {
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = 'ğŸ—‘ï¸';
        deleteBtn.title = 'åˆ é™¤å¸–å­';
        deleteBtn.style.cssText = `
          position: absolute;
          top: 0;
          right: 0;
          background: none; 
          border: none; 
          color: #9ca3af; 
          cursor: pointer; 
          font-size: 14px; 
          padding: 6px; 
          border-radius: 6px; 
          transition: all 0.2s;
          opacity: 0.7;
        `;
        deleteBtn.onmouseover = () => {
          deleteBtn.style.background = '#fee2e2';
          deleteBtn.style.color = '#dc2626';
          deleteBtn.style.opacity = '1';
          deleteBtn.style.transform = 'scale(1.1)';
        };
        deleteBtn.onmouseout = () => {
          deleteBtn.style.background = 'none';
          deleteBtn.style.color = '#9ca3af';
          deleteBtn.style.opacity = '0.7';
          deleteBtn.style.transform = 'scale(1)';
        };
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deletePost(post.id);
        };
        header.appendChild(deleteBtn);
      }
      header.appendChild(avatar);
      header.appendChild(userInfo);
      
      const content = document.createElement('div');
      content.className = 'post-content';
      
      // æ ¹æ®æ¶ˆæ¯ç±»å‹æ¸²æŸ“ä¸åŒå†…å®¹
      let hasContent = false;
      
      if (post.type === 'mixed_content') {
        // æ–‡å­—å†…å®¹
        if (post.content.text) {
          const textDiv = document.createElement('div');
          textDiv.className = 'text-content';
          if (hasContent) textDiv.className += ' content-section';
          textDiv.innerHTML = escapeHtml(post.content.text);
          content.appendChild(textDiv);
          hasContent = true;
        }
        
        // éŸ³é¢‘å†…å®¹
        if (post.content.audios && post.content.audios.length > 0) {
          post.content.audios.forEach(audio => {
            const audioCard = createAudioCard(audio);
            if (hasContent) audioCard.classList.add('content-section');
            content.appendChild(audioCard);
            hasContent = true;
          });
        }
        
        // æ–‡ç« å†…å®¹
        if (post.content.articles && post.content.articles.length > 0) {
          post.content.articles.forEach(article => {
            const articleCard = createArticleCard(article);
            if (hasContent) articleCard.classList.add('content-section');
            content.appendChild(articleCard);
            hasContent = true;
          });
        }
        
        // å›¾ç‰‡å†…å®¹
        if (post.content.images && post.content.images.length > 0) {
          post.content.images.forEach(image => {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'image-content';
            if (hasContent) imageDiv.classList.add('content-section');
            imageDiv.innerHTML = `<img class="message-image" src="/message_images/${image.filename}" alt="å›¾ç‰‡" ondblclick="openImageModal('/message_images/${image.filename}')" title="åŒå‡»æŸ¥çœ‹å¤§å›¾">`;
            content.appendChild(imageDiv);
            hasContent = true;
          });
        }
        
        // æŒ‘æˆ˜å†…å®¹
        if (post.content.challenge) {
          const challengeCard = createChallengeCard(post.content.challenge);
          if (hasContent) challengeCard.classList.add('content-section');
          content.appendChild(challengeCard);
          hasContent = true;
        }
      } else if (post.type === 'text') {
        content.innerHTML = `<div class="text-content">${escapeHtml(post.content.text)}</div>        `;
      } else if (post.type === 'image') {
        content.innerHTML = `
          <div class="image-content">
            <img class="message-image" src="/message_images/${post.content.filename}" alt="å›¾ç‰‡" ondblclick="openImageModal('/message_images/${post.content.filename}')" title="åŒå‡»æŸ¥çœ‹å¤§å›¾">
            ${post.content.caption ? `<div class="text-content" style="margin-top: 8px;">${escapeHtml(post.content.caption)}</div>` : ''}
          </div>
        `;
      } else if (post.type === 'audio_share') {
        if (post.content.text) {
          content.innerHTML = `<div class="text-content">${escapeHtml(post.content.text)}</div>`;
        }
        const audioCard = createAudioCard(post.content);
        content.appendChild(audioCard);
      } else if (post.type === 'article_share') {
        if (post.content.text) {
          content.innerHTML = `<div class="text-content">${escapeHtml(post.content.text)}</div>`;
        }
        const articleCard = createArticleCard(post.content);
        content.appendChild(articleCard);
      }
      
      postEl.appendChild(header);
      postEl.appendChild(content);
      
      return postEl;
    }
    
    // åˆ›å»ºéŸ³é¢‘å¡ç‰‡
    function createAudioCard(audioContent) {
      const card = document.createElement('div');
      card.className = 'audio-card';
      
      if (audioContent.type === 'single') {
        card.onclick = () => {
          // æ„é€ è¯¦ç»†çš„å•ä¸ªéŸ³é¢‘è·³è½¬URLï¼ŒåŒ…å«æ–‡ä»¶å¤¹å’Œå…·ä½“éŸ³é¢‘æ–‡ä»¶ä¿¡æ¯
          const jumpUrl = `/speaking#folder=${encodeURIComponent(audioContent.folder)}&file=${encodeURIComponent(audioContent.filename)}`;
          window.open(jumpUrl, '_blank');
        };
        
        const header = document.createElement('div');
        header.className = 'card-header';
        
        const icon = document.createElement('div');
        icon.className = 'card-icon';
        icon.textContent = 'ğŸ¤';
        
        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = audioContent.filename.replace('.mp3', '');
        
        header.appendChild(icon);
        header.appendChild(title);
        
        const desc = document.createElement('div');
        desc.className = 'card-desc';
        desc.style.whiteSpace = 'pre-wrap';
        if (audioContent.question) {
          desc.textContent = audioContent.question;
        } else {
          desc.textContent = 'ç‚¹å‡»æŸ¥çœ‹éŸ³é¢‘å†…å®¹';
        }
        
        const meta = document.createElement('div');
        meta.className = 'card-meta';
        meta.textContent = `æ¥è‡ªï¼š${audioContent.folder}`;
        
        card.appendChild(header);
        card.appendChild(desc);
        card.appendChild(meta);
        
      } else {
        // åˆé›†éŸ³é¢‘
        card.onclick = () => {
          // æ„é€ åˆé›†éŸ³é¢‘è·³è½¬URLï¼Œç›´æ¥å®šä½åˆ°å…·ä½“åˆé›†
          window.open(`/combined#folder=${encodeURIComponent(audioContent.folder)}`, '_blank');
        };
        
        const header = document.createElement('div');
        header.className = 'card-header';
        
        const icon = document.createElement('div');
        icon.className = 'card-icon';
        icon.textContent = 'ğŸµ';
        
        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = audioContent.folder;
        
        header.appendChild(icon);
        header.appendChild(title);
        
        const desc = document.createElement('div');
        desc.className = 'card-desc';
        desc.style.whiteSpace = 'pre-wrap';
        if (audioContent.question) {
          desc.textContent = audioContent.question;
        } else {
          desc.textContent = 'ç‚¹å‡»æŸ¥çœ‹éŸ³é¢‘å†…å®¹';
        }
        
        const meta = document.createElement('div');
        meta.className = 'card-meta';
        meta.textContent = `${audioContent.file_count} ä¸ªéŸ³é¢‘çš„åˆé›†`;
        
        card.appendChild(header);
        card.appendChild(desc);
        card.appendChild(meta);
      }
      
      return card;
    }
    
    // åˆ›å»ºæ–‡ç« å¡ç‰‡
    function createArticleCard(articleContent) {
      const card = document.createElement('div');
      card.className = 'article-card';
      card.onclick = () => {
        // æ„é€ æ­£ç¡®çš„æ–‡ç« è·³è½¬URLï¼Œä½¿ç”¨intensiveé¡µé¢çš„hashæ ¼å¼
        window.open(`/intensive#article-${articleContent.id || articleContent.article_id}`, '_blank');
      };
      
      const header = document.createElement('div');
      header.className = 'card-header';
      
      const icon = document.createElement('div');
      icon.className = 'card-icon';
      icon.textContent = 'ğŸ“';
      
      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = articleContent.title;
      
      header.appendChild(icon);
      header.appendChild(title);
      
      const desc = document.createElement('div');
      desc.className = 'card-desc';
      desc.textContent = `${articleContent.category} æ–‡ç«  â€¢ ç‚¹å‡»æŸ¥çœ‹ç²¾è¯»å†…å®¹`;
      
      const meta = document.createElement('div');
      meta.className = 'card-meta';
      meta.textContent = `${articleContent.highlight_count} ä¸ªé«˜äº®è¯æ±‡`;
      
      card.appendChild(header);
      card.appendChild(desc);
      card.appendChild(meta);
      
      return card;
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // 1åˆ†é’Ÿå†…
        return 'åˆšåˆš';
      } else if (diff < 3600000) { // 1å°æ—¶å†…
        return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
      } else if (diff < 86400000) { // 24å°æ—¶å†…
        return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
      } else if (diff < 604800000) { // 7å¤©å†…
        return Math.floor(diff / 86400000) + 'å¤©å‰';
      } else {
        return date.toLocaleDateString();
      }
    }
    
    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // åˆ é™¤å¸–å­
    function deletePost(postId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸–å­å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
        return;
      }
      
      fetch(`/api/messages/${postId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // æ‰¾åˆ°å¹¶ç§»é™¤å¯¹åº”çš„å¸–å­å…ƒç´ ï¼Œæ·»åŠ åˆ é™¤åŠ¨ç”»
          const postElement = document.querySelector(`[data-post-id="${postId}"]`);
          if (postElement) {
            // æ·»åŠ åˆ é™¤åŠ¨ç”»
            postElement.style.transition = 'all 0.3s ease';
            postElement.style.opacity = '0';
            postElement.style.transform = 'translateX(-100px)';
            
            setTimeout(() => {
              postElement.remove();
              
              // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–å¸–å­
              const remainingPosts = document.querySelectorAll('.post-card');
              if (remainingPosts.length === 0) {
                // å¦‚æœæ²¡æœ‰å¸–å­äº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                const emptyState = document.getElementById('emptyState');
                if (emptyState) {
                  emptyState.style.display = 'block';
                }
              }
            }, 300);
          } else {
            // å¦‚æœæ‰¾ä¸åˆ°å…ƒç´ ï¼Œé‡æ–°åŠ è½½æ•´ä¸ªåˆ—è¡¨
            loadPosts();
          }
        } else {
          alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      })
      .catch(e => {
        alert('åˆ é™¤å¤±è´¥ï¼š' + e.message);
      });
    }
    
    // æ‰“å¼€å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†
    function openImageModal(imageSrc) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      modalImage.src = imageSrc;
      modal.style.display = 'flex';
      
      // æ·»åŠ æ·¡å…¥åŠ¨ç”»
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.transition = 'opacity 0.3s ease';
        modal.style.opacity = '1';
      }, 10);
    }
    
    // å…³é—­å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†
    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
    
    // ==================== æŒ‘æˆ˜åŠŸèƒ½ ====================
    
    // æ˜¾ç¤ºæŒ‘æˆ˜åˆ›å»ºå™¨
    function showChallengeCreator() {
      document.getElementById('challengeModal').style.display = 'flex';
      // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      loadChallengeArticles();
      loadChallengeUsers();
    }
    
    // åŠ è½½æ–‡ç« åˆ—è¡¨
    function loadChallengeArticles() {
      fetch('/api/get_articles_list')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            renderChallengeArticles(data.categories);
          }
        })
        .catch(e => console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥:', e));
    }
    
    // æ¸²æŸ“æ–‡ç« åˆ—è¡¨
    function renderChallengeArticles(categories) {
      const container = document.getElementById('challengeArticleList');
      let html = '';
      
      Object.keys(categories).forEach(category => {
        const articles = categories[category];
        if (articles.length > 0) {
          html += `<div style="margin-bottom: 12px;">
            <div style="font-weight: 600; color: #374151; margin-bottom: 6px; font-size: 13px;">${category}</div>`;
          
          articles.forEach(article => {
            const isSelected = challengeData.selectedArticles.includes(article.id);
            html += `
              <div class="challenge-article-item ${isSelected ? 'selected' : ''}" onclick="toggleChallengeArticle('${article.id}')">
                <div class="challenge-article-checkbox">
                  ${isSelected ? 'âœ“' : ''}
                </div>
                <div class="challenge-article-info">
                  <div class="challenge-article-title">${article.title}</div>
                  <div class="challenge-article-meta">${article.highlight_count} ä¸ªè¯æ±‡</div>
                </div>
              </div>
            `;
          });
          
          html += '</div>';
        }
      });
      
      if (!html) {
        html = '<div style="text-align: center; padding: 20px; color: #6b7280;">æš‚æ— å¯ç”¨æ–‡ç« </div>';
      }
      
      container.innerHTML = html;
    }
    
    // åˆ‡æ¢æ–‡ç« é€‰æ‹©
    function toggleChallengeArticle(articleId) {
      const index = challengeData.selectedArticles.indexOf(articleId);
      if (index > -1) {
        challengeData.selectedArticles.splice(index, 1);
      } else {
        challengeData.selectedArticles.push(articleId);
      }
      loadChallengeArticles(); // é‡æ–°æ¸²æŸ“
    }
    
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    function loadChallengeUsers() {
      fetch('/api/get_users_list')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            renderChallengeUsers(data.users);
          }
        })
        .catch(e => console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', e));
    }
    
    // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
    function renderChallengeUsers(users) {
      const container = document.getElementById('challengeUserList');
      let html = '';
      
      users.forEach(user => {
        if (user.username === currentUser.username) return; // æ’é™¤è‡ªå·±
        
        const isSelected = challengeData.selectedUsers.includes(user.username);
        html += `
          <div class="challenge-user-item ${isSelected ? 'selected' : ''}" onclick="toggleChallengeUser('${user.username}')">
            <div class="challenge-user-checkbox">
              ${isSelected ? 'âœ“' : ''}
            </div>
            <img src="/static/${user.avatar}" alt="${user.display_name}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
            <div class="challenge-user-info">
              <div class="challenge-user-name">${user.display_name}</div>
            </div>
          </div>
        `;
      });
      
      if (!html) {
        html = '<div style="text-align: center; padding: 20px; color: #6b7280;">æš‚æ— å…¶ä»–ç”¨æˆ·</div>';
      }
      
      container.innerHTML = html;
    }
    
    // åˆ‡æ¢ç”¨æˆ·é€‰æ‹©
    function toggleChallengeUser(username) {
      const index = challengeData.selectedUsers.indexOf(username);
      if (index > -1) {
        challengeData.selectedUsers.splice(index, 1);
      } else {
        challengeData.selectedUsers.push(username);
      }
      loadChallengeUsers(); // é‡æ–°æ¸²æŸ“
    }
    
    // é€‰æ‹©è¯æ±‡æ•°é‡
    function selectWordCount(count) {
      challengeData.wordCount = count;
      document.getElementById('customWordCount').value = '';
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.word-count-btn').forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.dataset.count) === count) {
          btn.classList.add('active');
        }
      });
    }
    
    // åˆ›å»ºæŒ‘æˆ˜
    function createChallenge() {
      const title = document.getElementById('challengeTitle').value.trim();
      const description = document.getElementById('challengeDescription').value.trim();
      const customCount = document.getElementById('customWordCount').value;
      
      if (!title) {
        alert('è¯·è¾“å…¥æŒ‘æˆ˜æ ‡é¢˜');
        return;
      }
      
      if (challengeData.selectedArticles.length === 0) {
        alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ç¯‡æ–‡ç« ');
        return;
      }
      
      const wordCount = customCount ? parseInt(customCount) : challengeData.wordCount;
      if (wordCount < 1 || wordCount > 50) {
        alert('è¯æ±‡æ•°é‡åº”åœ¨1-50ä¹‹é—´');
        return;
      }
      
      const challengeRequest = {
        title: title,
        description: description,
        article_ids: challengeData.selectedArticles,
        word_count: wordCount,
        mentioned_users: challengeData.selectedUsers
      };
      
      fetch('/api/create_challenge', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(challengeRequest)
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // åˆ›å»ºæŒ‘æˆ˜å¡ç‰‡å¹¶æ·»åŠ åˆ°é€‰ä¸­é¡¹
          const challengeItem = {
            id: data.challenge_id,
            title: title,
            description: description,
            vocabulary_count: data.vocabulary_count,
            mentioned_users: challengeData.selectedUsers
          };
          
          selectedItems.challenge = challengeItem;
          updateContentPreview();
          closeModal('challengeModal');
          
          // é‡ç½®æŒ‘æˆ˜æ•°æ®
          challengeData = {
            selectedArticles: [],
            selectedUsers: [],
            wordCount: 5
          };
          document.getElementById('challengeTitle').value = '';
          document.getElementById('challengeDescription').value = '';
          document.getElementById('customWordCount').value = '';
          selectWordCount(5);
        } else {
          alert('åˆ›å»ºæŒ‘æˆ˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      })
      .catch(e => {
        alert('åˆ›å»ºæŒ‘æˆ˜å¤±è´¥ï¼š' + e.message);
      });
    }
    
    // åˆ›å»ºæŒ‘æˆ˜é¢„è§ˆç»„ä»¶
    function createChallengePreview(challenge, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label class="form-label">æŒ‘æˆ˜ ${index + 1}</label>
          <button onclick="removeSelectedItem('challenge', 0)" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ç§»é™¤</button>
        </div>
        <div class="challenge-card">
          <div class="card-header">
            <span class="card-icon">ğŸ†</span>
            <div class="card-title">${challenge.title}</div>
          </div>
          ${challenge.description ? `<div class="card-desc">${challenge.description}</div>` : ''}
          <div class="card-meta">
            ${challenge.vocabulary_count} ä¸ªè¯æ±‡
            ${challenge.mentioned_users.length > 0 ? ` â€¢ @${challenge.mentioned_users.length} ä¸ªç”¨æˆ·` : ''}
          </div>
        </div>
      `;
      
      return div;
    }
    
    // æ£€æŸ¥æŒ‘æˆ˜çŠ¶æ€
    function checkChallengeStatus(challengeId) {
      return fetch(`/api/get_challenge/${challengeId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            const challenge = data.challenge;
            const hasParticipated = challenge.participants && challenge.participants[currentUser.username];
            const mentionedUsers = challenge.mentioned_users || [];
            const isCurrentUserMentioned = mentionedUsers.includes(currentUser.username);
            const isCreator = challenge.creator === currentUser.username;
            
            // åˆ¤æ–­æ˜¯å¦æ‰€æœ‰è¢«@çš„ç”¨æˆ·éƒ½å·²å‚ä¸
            const allMentionedParticipated = mentionedUsers.length === 0 || 
              mentionedUsers.every(user => challenge.participants && challenge.participants[user]);
            
            // æŒ‘æˆ˜å®Œæˆæ¡ä»¶ï¼šæ²¡æœ‰@ä»»ä½•äºº æˆ– æ‰€æœ‰è¢«@çš„ç”¨æˆ·éƒ½å‚ä¸äº†
            const isChallengeCompleted = challenge.status === 'completed' || allMentionedParticipated;
            
            // ç”¨æˆ·æ˜¯å¦éœ€è¦å‚ä¸æŒ‘æˆ˜çš„é€»è¾‘ï¼š
            // 1. å¦‚æœç”¨æˆ·è¢«@äº†ï¼Œåˆ™éœ€è¦å‚ä¸
            // 2. å¦‚æœç”¨æˆ·æ˜¯åˆ›å»ºè€…ï¼Œä¹Ÿéœ€è¦å‚ä¸
            // 3. å¦‚æœç”¨æˆ·æ²¡è¢«@ä¸”ä¸æ˜¯åˆ›å»ºè€…ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹ç»“æœ
            const needsParticipation = isCurrentUserMentioned || isCreator;
            
            // ç”¨æˆ·æ˜¯å¦å¯ä»¥æŸ¥çœ‹ç»“æœï¼š
            // 1. å¦‚æœä¸éœ€è¦å‚ä¸ï¼ˆæ²¡è¢«@ä¸”ä¸æ˜¯åˆ›å»ºè€…ï¼‰ï¼Œç›´æ¥å¯ä»¥æŸ¥çœ‹
            // 2. å¦‚æœéœ€è¦å‚ä¸ï¼Œå¿…é¡»å…ˆå‚ä¸äº†æ‰èƒ½æŸ¥çœ‹ç»“æœ
            const canViewResults = !needsParticipation || hasParticipated;
            
            return {
              completed: isChallengeCompleted && canViewResults,
              participated: hasParticipated,
              needsParticipation: needsParticipation,
              canViewResults: canViewResults,
              totalParticipants: Object.keys(challenge.participants || {}).length,
              mentionedUsers: mentionedUsers
            };
          } else {
            throw new Error(data.error || 'è·å–æŒ‘æˆ˜çŠ¶æ€å¤±è´¥');
          }
        });
    }
    
    // åˆ›å»ºæŒ‘æˆ˜å¡ç‰‡ï¼ˆå¸–å­ä¸­æ˜¾ç¤ºï¼‰
    function createChallengeCard(challengeContent) {
      const card = document.createElement('div');
      card.className = 'challenge-card';
      card.setAttribute('data-challenge-id', challengeContent.id);
      card.onclick = () => {
        startChallenge(challengeContent.id);
      };
      
      const header = document.createElement('div');
      header.className = 'card-header';
      
      const icon = document.createElement('div');
      icon.className = 'card-icon';
      icon.textContent = 'ğŸ†';
      
      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = challengeContent.title;
      
      header.appendChild(icon);
      header.appendChild(title);
      
      if (challengeContent.description) {
        const desc = document.createElement('div');
        desc.className = 'card-desc';
        desc.textContent = challengeContent.description;
        card.appendChild(desc);
      }
      
      const meta = document.createElement('div');
      meta.className = 'card-meta';
      meta.textContent = `${challengeContent.vocabulary_count} ä¸ªè¯æ±‡`;
      
      // æ˜¾ç¤ºè¢«@ç”¨æˆ·çš„åå­—
      if (challengeContent.mentioned_users && challengeContent.mentioned_users.length > 0) {
        // éœ€è¦è·å–ç”¨æˆ·æ˜¾ç¤ºåå­—ï¼Œå…ˆæ˜¾ç¤ºç”¨æˆ·åï¼Œåç»­å¯ä»¥ä¼˜åŒ–ä¸ºæ˜¾ç¤ºå
        const userNames = challengeContent.mentioned_users.join(', ');
        meta.innerHTML += ` â€¢ @<span style="color: #2563eb; font-weight: 600;">${userNames}</span>`;
      }
      
      // æ·»åŠ åŠ¨æ€æŒ‰é’®
      const actionBtn = document.createElement('div');
      actionBtn.setAttribute('data-challenge-btn', 'true');
      actionBtn.style.cssText = 'margin-top: 12px; padding: 8px 16px; background: rgba(255,255,255,0.8); border-radius: 8px; text-align: center; font-weight: 600; color: #92400e; border: 1px solid #f59e0b; cursor: pointer; transition: all 0.2s; user-select: none;';
      
      // æ£€æŸ¥æŒ‘æˆ˜çŠ¶æ€å¹¶è®¾ç½®æŒ‰é’®æ–‡æœ¬
      checkChallengeStatus(challengeContent.id).then(status => {
        if (status.completed) {
          // æŒ‘æˆ˜å®Œæˆä¸”ç”¨æˆ·å¯ä»¥æŸ¥çœ‹ç»“æœ
          actionBtn.textContent = 'æŸ¥çœ‹æŒ‘æˆ˜ç»“æœ';
          actionBtn.style.background = 'rgba(16, 185, 129, 0.1)';
          actionBtn.style.color = '#059669';
          actionBtn.style.borderColor = '#10b981';
        } else if (!status.needsParticipation) {
          // ç”¨æˆ·ä¸éœ€è¦å‚ä¸ï¼ˆæœªè¢«@ä¸”ä¸æ˜¯åˆ›å»ºè€…ï¼‰ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹å½“å‰ç»“æœ
          actionBtn.textContent = 'æŸ¥çœ‹æŒ‘æˆ˜ç»“æœ';
          actionBtn.style.background = 'rgba(16, 185, 129, 0.1)';
          actionBtn.style.color = '#059669';
          actionBtn.style.borderColor = '#10b981';
        } else if (status.participated) {
          // ç”¨æˆ·å·²å‚ä¸ä½†æŒ‘æˆ˜æœªå®Œå…¨ç»“æŸ
          actionBtn.textContent = 'æŸ¥çœ‹æˆ‘çš„æˆç»©';
          actionBtn.style.background = 'rgba(59, 130, 246, 0.1)';
          actionBtn.style.color = '#2563eb';
          actionBtn.style.borderColor = '#3b82f6';
        } else {
          // ç”¨æˆ·éœ€è¦å‚ä¸ä½†è¿˜æœªå‚ä¸
          actionBtn.textContent = 'ç‚¹å‡»å‚ä¸æŒ‘æˆ˜';
        }
      }).catch(() => {
        actionBtn.textContent = 'ç‚¹å‡»å‚ä¸æŒ‘æˆ˜';
      });
      
      actionBtn.onclick = (e) => {
        e.stopPropagation();
        startChallenge(challengeContent.id);
      };
      
      card.appendChild(header);
      card.appendChild(meta);
      card.appendChild(actionBtn);
      
      return card;
    }
    
    // å¼€å§‹æŒ‘æˆ˜
    function startChallenge(challengeId) {
      fetch(`/api/get_challenge/${challengeId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            currentChallenge = data.challenge;
            currentChallengeAnswers = [];
            currentQuestionIndex = 0;
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»å‚ä¸è¿‡
            if (currentChallenge.participants[currentUser.username]) {
              showChallengeRanking(challengeId);
              return;
            }
            
            document.getElementById('challengeGameModal').style.display = 'flex';
            // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.getElementById('challengeGameTitle').textContent = currentChallenge.title;
            showNextQuestion();
          } else {
            alert('åŠ è½½æŒ‘æˆ˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
          }
        })
        .catch(e => {
          alert('åŠ è½½æŒ‘æˆ˜å¤±è´¥ï¼š' + e.message);
        });
    }
    
    // æ˜¾ç¤ºä¸‹ä¸€é¢˜
    function showNextQuestion() {
      if (currentQuestionIndex >= currentChallenge.vocabulary.length) {
        finishChallenge();
        return;
      }
      
      const vocab = currentChallenge.vocabulary[currentQuestionIndex];
      const progress = document.getElementById('challengeProgress');
      progress.textContent = `ç¬¬ ${currentQuestionIndex + 1} é¢˜ / å…± ${currentChallenge.vocabulary.length} é¢˜`;
      
      // éšæœºå†³å®šæ˜¯æ˜¾ç¤ºå•è¯è¿˜æ˜¯æ„æ€
      const showWord = Math.random() > 0.5;
      const question = document.getElementById('challengeQuestion');
      const optionsContainer = document.getElementById('challengeOptions');
      
      if (showWord) {
        question.textContent = vocab.word;
        // ç”Ÿæˆé€‰é¡¹ï¼šæ­£ç¡®ç­”æ¡ˆ + 3ä¸ªé”™è¯¯ç­”æ¡ˆ
        const options = [vocab.meaning];
        const otherVocab = currentChallenge.vocabulary.filter(v => v.word !== vocab.word);
        while (options.length < 4 && otherVocab.length > 0) {
          const randomVocab = otherVocab[Math.floor(Math.random() * otherVocab.length)];
          if (!options.includes(randomVocab.meaning)) {
            options.push(randomVocab.meaning);
          }
          otherVocab.splice(otherVocab.indexOf(randomVocab), 1);
        }
        
        // æ‰“ä¹±é€‰é¡¹é¡ºåº
        for (let i = options.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [options[i], options[j]] = [options[j], options[i]];
        }
        
        renderChallengeOptions(options, vocab.meaning);
      } else {
        question.textContent = vocab.meaning;
        // ç”Ÿæˆé€‰é¡¹ï¼šæ­£ç¡®ç­”æ¡ˆ + 3ä¸ªé”™è¯¯ç­”æ¡ˆ
        const options = [vocab.word];
        const otherVocab = currentChallenge.vocabulary.filter(v => v.meaning !== vocab.meaning);
        while (options.length < 4 && otherVocab.length > 0) {
          const randomVocab = otherVocab[Math.floor(Math.random() * otherVocab.length)];
          if (!options.includes(randomVocab.word)) {
            options.push(randomVocab.word);
          }
          otherVocab.splice(otherVocab.indexOf(randomVocab), 1);
        }
        
        // æ‰“ä¹±é€‰é¡¹é¡ºåº
        for (let i = options.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [options[i], options[j]] = [options[j], options[i]];
        }
        
        renderChallengeOptions(options, vocab.word);
      }
      
      // å¼€å§‹å€’è®¡æ—¶
      startQuestionTimer();
    }
    
    // æ¸²æŸ“é€‰é¡¹
    function renderChallengeOptions(options, correctAnswer) {
      const container = document.getElementById('challengeOptions');
      container.innerHTML = '';
      
      options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'challenge-option';
        optionDiv.textContent = option;
        optionDiv.onclick = () => selectChallengeOption(option, correctAnswer, optionDiv);
        container.appendChild(optionDiv);
      });
    }
    
    // é€‰æ‹©ç­”æ¡ˆ
    function selectChallengeOption(selectedOption, correctAnswer, optionElement) {
      // åœæ­¢è®¡æ—¶å™¨
      if (challengeTimer) {
        clearInterval(challengeTimer);
        challengeTimer = null;
      }
      
      const timeTaken = Math.round((Date.now() - questionStartTime) / 1000);
      const isCorrect = selectedOption === correctAnswer;
      
      // è®°å½•ç­”æ¡ˆ
      currentChallengeAnswers.push({
        question_index: currentQuestionIndex,
        selected_option: selectedOption,
        correct_answer: correctAnswer,
        time_taken: timeTaken,
        is_correct: isCorrect
      });
      
      // æ˜¾ç¤ºç»“æœ
      const allOptions = document.querySelectorAll('.challenge-option');
      allOptions.forEach(opt => {
        opt.style.pointerEvents = 'none';
        if (opt.textContent === correctAnswer) {
          opt.classList.add('correct');
        } else if (opt === optionElement && !isCorrect) {
          opt.classList.add('incorrect');
        }
      });
      
      // 2ç§’åæ˜¾ç¤ºä¸‹ä¸€é¢˜
      setTimeout(() => {
        currentQuestionIndex++;
        showNextQuestion();
      }, 2000);
    }
    
    // å¼€å§‹é—®é¢˜è®¡æ—¶å™¨
    function startQuestionTimer() {
      questionStartTime = Date.now();
      let timeLeft = 10;
      const timerElement = document.getElementById('challengeTimer');
      
      timerElement.textContent = `${timeLeft}s`;
      
      challengeTimer = setInterval(() => {
        timeLeft--;
        timerElement.textContent = `${timeLeft}s`;
        
        if (timeLeft <= 0) {
          clearInterval(challengeTimer);
          challengeTimer = null;
          
          // æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨é€‰æ‹©é”™è¯¯ç­”æ¡ˆ
          const timeTaken = 10;
          currentChallengeAnswers.push({
            question_index: currentQuestionIndex,
            selected_option: null,
            correct_answer: null,
            time_taken: timeTaken,
            is_correct: false
          });
          
          // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
          const allOptions = document.querySelectorAll('.challenge-option');
          allOptions.forEach(opt => {
            opt.style.pointerEvents = 'none';
            // è¿™é‡Œéœ€è¦æ ¹æ®å½“å‰é¢˜ç›®æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆ
            // ç®€åŒ–å¤„ç†ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€é¢˜
          });
          
          setTimeout(() => {
            currentQuestionIndex++;
            showNextQuestion();
          }, 2000);
        }
      }, 1000);
    }
    
    // å®ŒæˆæŒ‘æˆ˜
    function finishChallenge() {
      fetch('/api/participate_challenge', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({
          challenge_id: currentChallenge.id,
          answers: currentChallengeAnswers
        })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // å…³é—­æ¸¸æˆæ¨¡æ€æ¡†
          closeModal('challengeGameModal');
          
          // æ˜¾ç¤ºç»“æœ
          alert(`æŒ‘æˆ˜å®Œæˆï¼\\næ­£ç¡®ç‡ï¼š${data.correct_count}/${data.total_questions}\\næ€»åˆ†ï¼š${data.score}åˆ†`);
          
          // åˆ·æ–°é¡µé¢ä¸Šæ‰€æœ‰æŒ‘æˆ˜å¡ç‰‡çš„çŠ¶æ€
          refreshChallengeCards();
          
          // é‡æ–°æ£€æŸ¥å¾…å®Œæˆçš„æŒ‘æˆ˜ï¼ˆæ›´æ–°æé†’çŠ¶æ€ï¼‰
          setTimeout(() => {
            checkPendingChallenges();
          }, 500);
          
          // å¦‚æœæ’åå·²å‡†å¤‡å¥½ï¼Œæ˜¾ç¤ºæ’å
          if (data.ranking_ready) {
            setTimeout(() => {
              showChallengeRanking(currentChallenge.id);
            }, 1000);
          }
        } else {
          alert('æäº¤ç­”æ¡ˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      })
      .catch(e => {
        alert('æäº¤ç­”æ¡ˆå¤±è´¥ï¼š' + e.message);
      });
    }
    
    // åˆ·æ–°é¡µé¢ä¸Šæ‰€æœ‰æŒ‘æˆ˜å¡ç‰‡çš„çŠ¶æ€
    function refreshChallengeCards() {
      const challengeCards = document.querySelectorAll('.challenge-card');
      challengeCards.forEach(card => {
        const challengeId = card.getAttribute('data-challenge-id');
        if (challengeId) {
          // æ‰¾åˆ°æŒ‘æˆ˜å¡ç‰‡ä¸­çš„æŒ‰é’®å¹¶æ›´æ–°çŠ¶æ€
          const actionBtn = card.querySelector('[data-challenge-btn]');
          if (actionBtn) {
            updateChallengeButton(challengeId, actionBtn);
          }
        }
      });
    }
    
    // æ›´æ–°å•ä¸ªæŒ‘æˆ˜æŒ‰é’®çŠ¶æ€
    function updateChallengeButton(challengeId, actionBtn) {
      checkChallengeStatus(challengeId).then(status => {
        if (status.completed) {
          actionBtn.textContent = 'æŸ¥çœ‹æŒ‘æˆ˜ç»“æœ';
          actionBtn.style.background = 'rgba(16, 185, 129, 0.1)';
          actionBtn.style.color = '#059669';
          actionBtn.style.borderColor = '#10b981';
        } else if (!status.needsParticipation) {
          actionBtn.textContent = 'æŸ¥çœ‹æŒ‘æˆ˜ç»“æœ';
          actionBtn.style.background = 'rgba(16, 185, 129, 0.1)';
          actionBtn.style.color = '#059669';
          actionBtn.style.borderColor = '#10b981';
        } else if (status.participated) {
          actionBtn.textContent = 'æŸ¥çœ‹æˆ‘çš„æˆç»©';
          actionBtn.style.background = 'rgba(59, 130, 246, 0.1)';
          actionBtn.style.color = '#2563eb';
          actionBtn.style.borderColor = '#3b82f6';
        } else {
          actionBtn.textContent = 'ç‚¹å‡»å‚ä¸æŒ‘æˆ˜';
          actionBtn.style.background = 'rgba(255,255,255,0.8)';
          actionBtn.style.color = '#92400e';
          actionBtn.style.borderColor = '#f59e0b';
        }
      }).catch(() => {
        // é”™è¯¯æ—¶ä¿æŒé»˜è®¤çŠ¶æ€
      });
    }
    
    // æ˜¾ç¤ºæŒ‘æˆ˜æ’å
    function showChallengeRanking(challengeId) {
      fetch(`/api/get_challenge_ranking/${challengeId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            document.getElementById('challengeRankingModal').style.display = 'flex';
            // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.getElementById('rankingTitle').textContent = data.challenge.title + ' - æ’è¡Œæ¦œ';
            
            const challengeInfo = document.getElementById('challengeInfo');
            challengeInfo.innerHTML = `
              ${data.challenge.description ? `<div style="margin-bottom: 8px;">${data.challenge.description}</div>` : ''}
              <div>${data.challenge.vocabulary_count} ä¸ªè¯æ±‡ â€¢ ${data.ranking.length} äººå‚ä¸</div>
            `;
            
            renderRanking(data.ranking);
          } else {
            alert('åŠ è½½æ’åå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
          }
        })
        .catch(e => {
          alert('åŠ è½½æ’åå¤±è´¥ï¼š' + e.message);
        });
    }
    
    // æ¸²æŸ“æ’å
    function renderRanking(ranking) {
      const container = document.getElementById('rankingList');
      let html = '';
      
      ranking.forEach((item, index) => {
        const rank = index + 1;
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        
        html += `
          <div class="ranking-item ${rankClass}">
            <div class="ranking-number">${rank}</div>
            <img src="/static/${item.avatar}" alt="${item.display_name}" class="ranking-avatar">
            <div class="ranking-info">
              <div class="ranking-name">${item.display_name}</div>
              <div class="ranking-score">${item.correct_count}/${item.total_questions} æ­£ç¡®</div>
            </div>
            <div class="ranking-points">${item.score}åˆ†</div>
          </div>
        `;
      });
      
      if (!html) {
        html = '<div style="text-align: center; padding: 40px; color: #6b7280;">æš‚æ— å‚ä¸è€…</div>';
      }
      
      container.innerHTML = html;
    }
    
    // ==================== æŒ‘æˆ˜æé†’åŠŸèƒ½ ====================
    
    // æ£€æŸ¥å¾…å®Œæˆçš„æŒ‘æˆ˜
    function checkPendingChallenges() {
      fetch('/api/messages')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            findPendingChallenges(data.messages);
          }
        })
        .catch(e => console.error('æ£€æŸ¥æŒ‘æˆ˜å¤±è´¥:', e));
    }
    
    // ä»æ¶ˆæ¯åˆ—è¡¨ä¸­æ‰¾åˆ°å¾…å®Œæˆçš„æŒ‘æˆ˜
    function findPendingChallenges(messages) {
      pendingChallenges = [];
      const challengePromises = [];
      
      messages.forEach(message => {
        if (message.type === 'mixed_content' && message.content.challenge) {
          const challenge = message.content.challenge;
          // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦è¢«@æˆ–æ˜¯åˆ›å»ºè€…
          const isCreator = message.user.username === currentUser.username;
          const isMentioned = challenge.mentioned_users && 
            challenge.mentioned_users.includes(currentUser.username);
          
          if (isCreator || isMentioned) {
            challengePromises.push(
              checkChallengeStatus(challenge.id).then(status => {
                if (!status.participated) {
                  pendingChallenges.push({
                    id: challenge.id,
                    title: challenge.title,
                    postId: message.id,
                    creator: message.user.display_name,
                    isCreator: isCreator
                  });
                }
              }).catch(() => {})
            );
          }
        }
      });
      
      Promise.all(challengePromises).then(() => {
        if (pendingChallenges.length > 0) {
          showChallengeAlert();
        }
      });
    }
    
    // æ˜¾ç¤ºæŒ‘æˆ˜æé†’
    function showChallengeAlert() {
      const alert = document.getElementById('challengeAlert');
      const message = document.getElementById('alertMessage');
      
      if (pendingChallenges.length === 1) {
        const challenge = pendingChallenges[0];
        if (challenge.isCreator) {
          message.textContent = `æ‚¨åˆ›å»ºçš„æŒ‘æˆ˜"${challenge.title}"ç­‰å¾…æ‚¨å®Œæˆ`;
        } else {
          message.textContent = `${challenge.creator}é‚€è¯·æ‚¨å®ŒæˆæŒ‘æˆ˜"${challenge.title}"`;
        }
      } else {
        message.textContent = `æ‚¨æœ‰${pendingChallenges.length}ä¸ªè¯æ±‡æŒ‘æˆ˜ç­‰å¾…å®Œæˆ`;
      }
      
      alert.style.display = 'flex';
      
      // æ·»åŠ æ·¡å…¥åŠ¨ç”»
      alert.style.opacity = '0';
      alert.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        alert.style.transition = 'all 0.3s ease';
        alert.style.opacity = '1';
        alert.style.transform = 'translateY(0)';
      }, 100);
    }
    
    // è·³è½¬åˆ°æŒ‘æˆ˜å¸–å­
    function goToChallengePost() {
      if (pendingChallenges.length > 0) {
        const firstChallenge = pendingChallenges[0];
        // æ‰¾åˆ°å¯¹åº”çš„å¸–å­å¹¶é«˜äº®æ˜¾ç¤º
        const postElement = document.querySelector(`[data-post-id="${firstChallenge.postId}"]`);
        if (postElement) {
          // æ»šåŠ¨åˆ°å¸–å­ä½ç½®
          postElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
          
          // é«˜äº®æ˜¾ç¤ºå¸–å­
          highlightPost(postElement);
        }
      }
      dismissAlert();
    }
    
    // é«˜äº®æ˜¾ç¤ºå¸–å­
    function highlightPost(postElement) {
      // æ·»åŠ é«˜äº®æ•ˆæœ
      postElement.style.background = 'rgba(245, 158, 11, 0.1)';
      postElement.style.border = '2px solid #f59e0b';
      postElement.style.transform = 'scale(1.02)';
      postElement.style.transition = 'all 0.3s ease';
      postElement.style.boxShadow = '0 8px 24px rgba(245, 158, 11, 0.3)';
      
      // 3ç§’åç§»é™¤é«˜äº®
      setTimeout(() => {
        postElement.style.background = '';
        postElement.style.border = '';
        postElement.style.transform = '';
        postElement.style.boxShadow = '';
      }, 3000);
    }
    
    // å…³é—­æé†’
    function dismissAlert() {
      const alert = document.getElementById('challengeAlert');
      alert.style.opacity = '0';
      alert.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 300);
    }
  </script>
</body>
</html>
