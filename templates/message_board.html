<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å­¦ä¹ äº¤æµå°å¤©åœ°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
  
  <link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'PT Serif', 'Crimson Text', ui-serif, 'Times New Roman', 'Georgia', serif; 
      background: linear-gradient(135deg, #e0e7ff 0%, #f4f6fa 100%); 
      margin: 0; 
      min-height: 100vh; 
      padding: 16px; 
      box-sizing: border-box; 
    }
    
    .container { 
      max-width: 900px; 
      margin: 0 auto; 
      background: #fff; 
      border-radius: 20px; 
      box-shadow: 0 16px 48px rgba(31,38,135,0.20); 
      overflow: hidden;
    }
    
    .header { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      padding: 20px 24px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    
    .header h1 { 
      margin: 0; 
      font-size: 24px; 
      font-weight: 700; 
    }
    
    .header-actions { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
    }
    
    .user-info { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      color: rgba(255,255,255,0.9); 
      font-size: 14px; 
    }
    
    .user-avatar-small { 
      width: 28px; 
      height: 28px; 
      border-radius: 50%; 
      border: 2px solid rgba(255,255,255,0.3); 
    }
    
    .new-post-btn { 
      background: rgba(255,255,255,0.2); 
      border: 2px solid rgba(255,255,255,0.3); 
      color: white; 
      border-radius: 20px; 
      padding: 8px 16px; 
      cursor: pointer; 
      font-size: 14px; 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      transition: all 0.2s; 
    }
    
    .new-post-btn:hover { 
      background: rgba(255,255,255,0.3); 
      border-color: rgba(255,255,255,0.5); 
    }
    
    .posts-container { 
      min-height: 500px; 
      padding: 20px 24px; 
      display: flex; 
      flex-direction: column; 
      gap: 16px; 
    }
    
    .post-card { 
      background: #f8fafc; 
      border-radius: 16px; 
      padding: 20px; 
      border: 1px solid #e2e8f0; 
      transition: box-shadow 0.2s; 
      margin-bottom: 20px; 
    }
    
    .post-card:hover { 
      box-shadow: 0 6px 20px rgba(0,0,0,0.08); 
    }
    
    .post-header { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin-bottom: 16px; 
      position: relative; 
    }
    
    .user-avatar { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      object-fit: cover;
      border: 2px solid #e5e7eb; 
    }
    
    .post-user-info { 
      flex: 1; 
    }
    
    .user-name { 
      font-weight: 600; 
      color: #1f2937; 
      font-size: 16px; 
    }
    
    .post-time { 
      color: #6b7280; 
      font-size: 13px; 
      margin-top: 2px; 
    }
    
    .post-content { 
      line-height: 1.6; 
      color: #374151; 
      margin-bottom: 16px; 
    }
    
    .text-content { 
      font-size: 15px; 
      white-space: pre-wrap; 
      line-height: 1.6; 
    }
    
    .image-content { 
      margin-top: 12px; 
    }
    
    .content-section { 
      margin-top: 12px; 
    }
    
    .content-section:first-child { 
      margin-top: 0; 
    }
    
    .message-image { 
      max-width: 100%; 
      max-height: 300px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    }
    
    .audio-card, .article-card { 
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); 
      border: 1px solid #0284c7; 
      border-radius: 12px; 
      padding: 16px; 
      margin-top: 12px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .audio-card:hover, .article-card:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 24px rgba(2,132,199,0.15); 
    }
    
    .card-header { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 8px; 
    }
    
    .card-icon { 
      font-size: 20px; 
    }
    
    .card-title { 
      font-weight: 600; 
      color: #0c4a6e; 
      font-size: 16px; 
    }
    
    .card-desc { 
      color: #075985; 
      font-size: 13px; 
      margin-bottom: 6px; 
    }
    
    .card-meta { 
      color: #0369a1; 
      font-size: 12px; 
    }
    
    .new-post-form { 
      background: #f0f9ff; 
      border: 2px dashed #0284c7; 
      border-radius: 16px; 
      padding: 20px; 
      margin-bottom: 20px; 
      display: none; 
    }
    
    .new-post-form.active { 
      display: block; 
    }
    
    .form-row { 
      margin-bottom: 16px; 
    }
    
    .form-label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600; 
      color: #1f2937; 
      font-size: 14px; 
    }
    
    .text-input { 
      width: 100%; 
      border: 1px solid #d1d5db; 
      border-radius: 12px; 
      padding: 12px 16px; 
      font-family: inherit; 
      font-size: 14px; 
      resize: vertical; 
      min-height: 100px; 
      box-sizing: border-box; 
    }
    
    .text-input:focus { 
      outline: none; 
      border-color: #0284c7; 
      box-shadow: 0 0 0 3px rgba(2,132,199,0.1); 
    }
    
    .form-actions { 
      display: flex; 
      gap: 12px; 
      justify-content: space-between; 
      align-items: center; 
    }
    
    .content-type-selector { 
      display: flex; 
      gap: 8px; 
    }
    
    .type-btn { 
      padding: 6px 12px; 
      border: 1px solid #d1d5db; 
      background: white; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 12px; 
      transition: all 0.2s; 
      display: flex; 
      align-items: center; 
      gap: 4px; 
    }
    
    .type-btn:hover { 
      background: #f3f4f6; 
      border-color: #9ca3af; 
    }
    
    .form-submit-actions { 
      display: flex; 
      gap: 8px; 
    }
    
    .form-btn { 
      padding: 10px 20px; 
      border: 1px solid #d1d5db; 
      border-radius: 8px; 
      cursor: pointer; 
      font-family: inherit; 
      font-size: 14px; 
      transition: all 0.2s; 
    }
    
    .form-btn.primary { 
      background: #0284c7; 
      border-color: #0284c7; 
      color: white; 
    }
    
    .form-btn.primary:hover { 
      background: #0369a1; 
    }
    
    .form-btn.secondary { 
      background: white; 
      color: #374151; 
    }
    
    .form-btn.secondary:hover { 
      background: #f9fafb; 
    }
    
    .modal-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.5); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000; 
    }
    
    .modal { 
      background: white; 
      border-radius: 16px; 
      padding: 0; 
      max-width: 500px; 
      width: 90%; 
      max-height: 70vh; 
      overflow: hidden; 
      display: flex; 
      flex-direction: column; 
    }
    
    .large-modal { 
      max-width: 800px; 
      max-height: 80vh; 
    }
    
    .modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 20px 24px; 
      border-bottom: 1px solid #e5e7eb; 
    }
    
    .modal-header h3 { 
      margin: 0; 
      color: #1f2937; 
      font-size: 18px; 
    }
    
    .close-btn { 
      background: none; 
      border: none; 
      font-size: 24px; 
      cursor: pointer; 
      color: #6b7280; 
      padding: 0; 
      width: 32px; 
      height: 32px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      border-radius: 6px; 
    }
    
    .close-btn:hover { 
      background: #f3f4f6; 
      color: #374151; 
    }
    
    .modal-body { 
      display: flex; 
      flex: 1; 
      min-height: 0; 
    }
    
    .sidebar { 
      width: 200px; 
      background: #f8fafc; 
      border-right: 1px solid #e5e7eb; 
      overflow-y: auto; 
    }
    
    .sidebar-section { 
      padding: 16px; 
    }
    
    .section-title { 
      font-weight: 600; 
      color: #374151; 
      font-size: 14px; 
      margin-bottom: 12px; 
    }
    
    .category-list { 
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
    }
    
    .category-item { 
      padding: 10px 12px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 14px; 
      color: #4b5563; 
      transition: all 0.2s; 
    }
    
    .category-item:hover { 
      background: #e0f2fe; 
      color: #0c4a6e; 
    }
    
    .category-item.active { 
      background: #0284c7; 
      color: white; 
    }
    
    .category-item.active:hover { 
      background: #0369a1; 
    }
    
    .content-area { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      min-height: 0; 
    }
    
    .content-header { 
      padding: 16px 20px; 
      border-bottom: 1px solid #e5e7eb; 
    }
    
    .breadcrumb { 
      color: #6b7280; 
      font-size: 14px; 
    }
    
    .content-list { 
      flex: 1; 
      padding: 16px 20px; 
      overflow-y: auto; 
    }
    
    .empty-content { 
      text-align: center; 
      color: #9ca3af; 
      font-size: 14px; 
      padding: 40px 20px; 
    }
    
    .content-item { 
      padding: 12px 16px; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
      margin-bottom: 8px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .content-item:hover { 
      border-color: #0284c7; 
      box-shadow: 0 2px 8px rgba(2,132,199,0.1); 
    }
    
    .content-item.selected { 
      border-color: #0284c7; 
      background: #f0f9ff; 
    }
    
    .content-item-title { 
      font-weight: 600; 
      color: #1f2937; 
      margin-bottom: 4px; 
    }
    
    .content-item-meta { 
      color: #6b7280; 
      font-size: 12px; 
    }
    
    .content-item-actions { 
      display: flex; 
      gap: 8px; 
      margin-top: 8px; 
    }
    
    .content-item-btn { 
      padding: 4px 8px; 
      border: 1px solid #d1d5db; 
      background: white; 
      border-radius: 4px; 
      font-size: 11px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .content-item-btn:hover { 
      background: #f3f4f6; 
    }
    
    .content-item-btn.primary { 
      background: #0284c7; 
      border-color: #0284c7; 
      color: white; 
    }
    
    .content-item-btn.primary:hover { 
      background: #0369a1; 
    }
    
    .modal h3 { 
      margin: 0 0 16px; 
      color: #1f2937; 
    }
    
    .modal-section { 
      margin-bottom: 20px; 
    }
    
    .modal-section h4 { 
      margin: 0 0 8px; 
      color: #374151; 
      font-size: 14px; 
    }
    
    .item-list { 
      max-height: 200px; 
      overflow-y: auto; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
    }
    
    .item { 
      padding: 12px; 
      border-bottom: 1px solid #f3f4f6; 
      cursor: pointer; 
      transition: background 0.2s; 
    }
    
    .item:hover { 
      background: #f8fafc; 
    }
    
    .item:last-child { 
      border-bottom: none; 
    }
    
    .item-title { 
      font-weight: 600; 
      color: #1f2937; 
      margin-bottom: 4px; 
    }
    
    .item-meta { 
      color: #6b7280; 
      font-size: 12px; 
    }
    
    .modal-actions { 
      display: flex; 
      gap: 12px; 
      justify-content: flex-end; 
      padding: 16px 24px; 
      border-top: 1px solid #e5e7eb; 
      background: #f9fafb; 
    }
    
    .modal-btn { 
      padding: 8px 16px; 
      border: 1px solid #d1d5db; 
      border-radius: 8px; 
      cursor: pointer; 
      font-family: inherit; 
      transition: all 0.2s; 
    }
    
    .modal-btn.primary { 
      background: #6366f1; 
      border-color: #6366f1; 
      color: white; 
    }
    
    .modal-btn.primary:hover { 
      background: #5a5afc; 
    }
    
    .modal-btn.secondary { 
      background: white; 
      color: #374151; 
    }
    
    .modal-btn.secondary:hover { 
      background: #f9fafb; 
    }
    
    .empty-state { 
      text-align: center; 
      padding: 40px 20px; 
      color: #6b7280; 
    }
    
    .empty-icon { 
      font-size: 48px; 
      margin-bottom: 16px; 
      opacity: 0.5; 
    }
    
    .hidden { 
      display: none !important; 
    }
    
    /* å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†æ ·å¼ */
    .image-modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.9); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 2000; 
      cursor: pointer; 
    }
    
    .image-modal img { 
      max-width: 90vw; 
      max-height: 90vh; 
      object-fit: contain; 
      border-radius: 8px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.5); 
    }
    
    .image-modal .close-hint { 
      position: absolute; 
      top: 20px; 
      right: 20px; 
      color: white; 
      font-size: 14px; 
      background: rgba(0,0,0,0.5); 
      padding: 8px 12px; 
      border-radius: 20px; 
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0;
      }
      
      .container { 
        margin: 0; 
        border-radius: 0; 
        min-height: 100vh; 
        box-shadow: none;
      }
      
      .header {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .header h1 {
        font-size: 20px;
        text-align: center;
        margin: 0;
      }
      
      .header-actions {
        justify-content: space-between;
        width: 100%;
      }
      
      .user-info {
        font-size: 13px;
      }
      
      .user-avatar-small {
        width: 24px;
        height: 24px;
      }
      
      .new-post-btn {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 16px;
      }
      
      .posts-container { 
        padding: 12px 16px;
        min-height: calc(100vh - 180px); 
        gap: 12px;
      }
      
      .post-card {
        padding: 16px;
        margin-bottom: 16px;
        border-radius: 12px;
      }
      
      .post-header {
        margin-bottom: 12px;
      }
      
      .user-avatar {
        width: 32px;
        height: 32px;
      }
      
      .user-name {
        font-size: 14px;
      }
      
      .post-time {
        font-size: 11px;
      }
      
      .text-content {
        font-size: 14px;
      }
      
      .audio-card, .article-card {
        padding: 12px;
        margin-top: 8px;
      }
      
      .card-title {
        font-size: 14px;
      }
      
      .card-desc {
        font-size: 12px;
      }
      
      .card-meta {
        font-size: 11px;
      }
      
      .message-image {
        max-height: 250px;
      }
      
      .new-post-form {
        padding: 16px;
        margin-bottom: 16px;
        border-radius: 12px;
      }
      
      .text-input {
        min-height: 80px;
        font-size: 14px;
        padding: 10px 12px;
      }
      
      .form-actions {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .content-type-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        width: 100%;
      }
      
      .type-btn {
        padding: 8px 12px;
        font-size: 12px;
        justify-content: center;
      }
      
      .form-submit-actions {
        width: 100%;
        justify-content: center;
      }
      
      .form-btn {
        flex: 1;
        max-width: 120px;
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .large-modal { 
        max-width: 95vw; 
        max-height: 90vh; 
        margin: 0 8px;
      }
      
      .modal-header {
        padding: 16px 20px;
      }
      
      .modal-header h3 {
        font-size: 16px;
      }
      
      .modal-body { 
        flex-direction: column; 
      }
      
      .sidebar { 
        width: 100%; 
        max-height: 120px; 
        border-right: none; 
        border-bottom: 1px solid #e5e7eb; 
      }
      
      .sidebar-section {
        padding: 12px 16px;
      }
      
      .section-title {
        font-size: 13px;
        margin-bottom: 8px;
      }
      
      .category-list { 
        flex-direction: row; 
        overflow-x: auto; 
        gap: 6px;
        padding-bottom: 8px; 
      }
      
      .category-item { 
        flex-shrink: 0; 
        white-space: nowrap; 
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .content-area { 
        min-height: 250px; 
      }
      
      .content-header {
        padding: 12px 16px;
      }
      
      .breadcrumb {
        font-size: 12px;
      }
      
      .content-list {
        padding: 12px 16px;
      }
      
      .content-item {
        padding: 10px 12px;
        margin-bottom: 6px;
      }
      
      .content-item-title {
        font-size: 13px;
        margin-bottom: 3px;
      }
      
      .content-item-meta {
        font-size: 11px;
      }
      
      .content-item-actions {
        margin-top: 6px;
        gap: 6px;
      }
      
      .content-item-btn {
        padding: 4px 8px;
        font-size: 10px;
        border-radius: 4px;
      }
      
      .modal-actions {
        padding: 12px 16px;
      }
      
      .modal-btn {
        padding: 8px 16px;
        font-size: 13px;
      }
      
      .expanded-content {
        margin-top: 8px !important;
        padding: 12px !important;
      }
      
      .image-modal .close-hint {
        top: 10px;
        right: 10px;
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .empty-state {
        padding: 30px 16px;
      }
      
      .empty-icon {
        font-size: 36px;
        margin-bottom: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 12px 16px;
      }
      
      .header h1 {
        font-size: 18px;
      }
      
      .user-info {
        font-size: 12px;
      }
      
      .user-avatar-small {
        width: 20px;
        height: 20px;
      }
      
      .new-post-btn {
        padding: 6px 10px;
        font-size: 12px;
        gap: 4px;
      }
      
      .posts-container {
        padding: 8px 12px;
      }
      
      .post-card {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      .user-avatar {
        width: 28px;
        height: 28px;
      }
      
      .user-name {
        font-size: 13px;
      }
      
      .post-time {
        font-size: 10px;
      }
      
      .text-content {
        font-size: 13px;
      }
      
      .audio-card, .article-card {
        padding: 10px;
      }
      
      .card-title {
        font-size: 13px;
      }
      
      .card-desc {
        font-size: 11px;
      }
      
      .card-meta {
        font-size: 10px;
      }
      
      .new-post-form {
        padding: 12px;
      }
      
      .text-input {
        min-height: 70px;
        font-size: 13px;
        padding: 8px 10px;
      }
      
      .content-type-selector {
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }
      
      .type-btn {
        padding: 6px 8px;
        font-size: 11px;
        gap: 3px;
      }
      
      .type-btn span:last-child {
        display: none;
      }
      
      .form-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .large-modal {
        max-width: 98vw;
        max-height: 95vh;
        margin: 0 4px;
      }
      
      .modal-header {
        padding: 12px 16px;
      }
      
      .modal-header h3 {
        font-size: 15px;
      }
      
      .sidebar-section {
        padding: 8px 12px;
      }
      
      .category-item {
        padding: 6px 10px;
        font-size: 11px;
      }
      
      .content-header {
        padding: 8px 12px;
      }
      
      .content-list {
        padding: 8px 12px;
      }
      
      .content-item {
        padding: 8px 10px;
      }
      
      .content-item-title {
        font-size: 12px;
      }
      
      .content-item-meta {
        font-size: 10px;
      }
      
      .content-item-btn {
        padding: 3px 6px;
        font-size: 9px;
      }
      
      .modal-actions {
        padding: 10px 12px;
      }
      
      .modal-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“š å­¦ä¹ äº¤æµå°å¤©åœ°</h1>
      <div class="header-actions">
        <div class="user-info" id="userInfo">
          <img class="user-avatar-small" id="userAvatarSmall" src="" alt="">
          <span id="userDisplayName">åŠ è½½ä¸­...</span>
        </div>
        <button class="new-post-btn" onclick="toggleNewPostForm()">
          <span>+</span>
          <span>å‘å¸ƒæ–°å¸–</span>
        </button>
      </div>
    </div>
    
    <div class="posts-container" id="postsContainer">
      <!-- æ–°å¸–å‘å¸ƒè¡¨å• -->
      <div class="new-post-form" id="newPostForm">
        <div class="form-row">
          <label class="form-label">åˆ†äº«å†…å®¹</label>
          <textarea 
            class="text-input" 
            id="postContent" 
            placeholder="åˆ†äº«ä½ çš„å­¦ä¹ å¿ƒå¾—ã€ç»éªŒæˆ–æƒ³æ³•..."
          ></textarea>
        </div>
        
        <div class="form-actions">
          <div class="content-type-selector">
            <button class="type-btn" onclick="showAudioSelector()">
              <span>ğŸ¤</span>
              <span>æ·»åŠ éŸ³é¢‘</span>
            </button>
            <button class="type-btn" onclick="showArticleSelector()">
              <span>ğŸ“</span>
              <span>æ·»åŠ æ–‡ç« </span>
            </button>
            <button class="type-btn" onclick="showImageUploader()">
              <span>ğŸ–¼ï¸</span>
              <span>æ·»åŠ å›¾ç‰‡</span>
            </button>
          </div>
          
          <div class="form-submit-actions">
            <button class="form-btn secondary" onclick="cancelNewPost()">å–æ¶ˆ</button>
            <button class="form-btn primary" onclick="submitPost()">å‘å¸ƒ</button>
          </div>
        </div>
        
        <!-- é¢å¤–å†…å®¹é€‰æ‹©åŒºåŸŸ -->
        <div id="extraContentArea"></div>
      </div>
      
      <!-- å¸–å­åˆ—è¡¨ -->
      <div id="postsList">
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">ğŸ“</div>
          <div>è¿˜æ²¡æœ‰å¸–å­ï¼Œç‚¹å‡»ä¸Šæ–¹"å‘å¸ƒæ–°å¸–"å¼€å§‹åˆ†äº«å§ï¼</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- éŸ³é¢‘åˆ†äº«æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="audioModal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>åˆ†äº«éŸ³é¢‘å†…å®¹</h3>
        <button class="close-btn" onclick="closeModal('audioModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="sidebar">
          <div class="sidebar-section">
            <div class="section-title">é€‰æ‹©åˆ†ç±»</div>
            <div class="category-list" id="audioCategoryList">
              <div class="category-item" data-category="Part1">Part 1</div>
              <div class="category-item" data-category="Part2">Part 2</div>
              <div class="category-item" data-category="Part3">Part 3</div>
              <div class="category-item" data-category="å…¶ä»–">å…¶ä»–</div>
            </div>
          </div>
        </div>
        <div class="content-area">
          <div class="content-header">
            <div class="breadcrumb" id="audioBreadcrumb">è¯·é€‰æ‹©åˆ†ç±»</div>
          </div>
          <div class="content-list" id="audioContentList">
            <div class="empty-content">è¯·å…ˆé€‰æ‹©å·¦ä¾§åˆ†ç±»</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeModal('audioModal')">å…³é—­</button>
      </div>
    </div>
  </div>
  
  <!-- æ–‡ç« åˆ†äº«æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="articleModal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>åˆ†äº«ç²¾è¯»æ–‡ç« </h3>
        <button class="close-btn" onclick="closeModal('articleModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="sidebar">
          <div class="sidebar-section">
            <div class="section-title">é€‰æ‹©åˆ†ç±»</div>
            <div class="category-list" id="articleCategoryList">
              <div class="category-item" data-category="Reading">Reading</div>
              <div class="category-item" data-category="Listening">Listening</div>
              <div class="category-item" data-category="Writing">Writing</div>
            </div>
          </div>
        </div>
        <div class="content-area">
          <div class="content-header">
            <div class="breadcrumb" id="articleBreadcrumb">è¯·é€‰æ‹©åˆ†ç±»</div>
          </div>
          <div class="content-list" id="articleContentList">
            <div class="empty-content">è¯·å…ˆé€‰æ‹©å·¦ä¾§åˆ†ç±»</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeModal('articleModal')">å…³é—­</button>
      </div>
    </div>
  </div>
  
  <!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <div class="close-hint">ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­</div>
    <img id="modalImage" src="" alt="æ”¾å¤§å›¾ç‰‡">
  </div>
  
  <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ input -->
  <input type="file" id="imageUpload" accept="image/*" style="display: none" onchange="handleImageUpload(event)">
  
  <script>
    let currentUser = null;
    let authToken = null;
    let selectedItems = {
      audios: [],
      articles: [],
      images: []
    };
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkStoredToken(){
      const tk = localStorage.getItem('authToken');
      if(!tk) return Promise.resolve(false);
      return fetch('/verify_token',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({token:tk})})
        .then(r=>r.json()).then(d=>{ 
          if(d.valid){ 
            authToken=tk; 
            // å°è¯•è·å–å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
            const userStr = localStorage.getItem('currentUser');
            if(userStr) {
              try {
                currentUser = JSON.parse(userStr);
              } catch(e) {}
            }
            return true;
          } 
          localStorage.removeItem('authToken'); 
          localStorage.removeItem('currentUser');
          return false; 
        })
        .catch(()=>{ 
          localStorage.removeItem('authToken'); 
          localStorage.removeItem('currentUser');
          return false; 
        });
    }
    
    function redirectToLogin() {
      window.location.href = '/login';
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
      // é¦–å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€
      checkStoredToken().then(valid=>{
        if(!valid) {
          redirectToLogin();
          return;
        }
        
        // ç™»å½•æˆåŠŸåç»§ç»­åˆå§‹åŒ–
        showUserInfo();
        loadPosts();
      });
    };
    
    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    function showUserInfo() {
      if(currentUser) {
        document.getElementById('userAvatarSmall').src = `/static/${currentUser.avatar}`;
        document.getElementById('userDisplayName').textContent = currentUser.display_name;
      }
    }
    
    // åˆ‡æ¢æ–°å¸–è¡¨å•
    function toggleNewPostForm() {
      const form = document.getElementById('newPostForm');
      form.classList.toggle('active');
      if (form.classList.contains('active')) {
        document.getElementById('postContent').focus();
      }
    }
    
    // å–æ¶ˆæ–°å¸–
    function cancelNewPost() {
      document.getElementById('newPostForm').classList.remove('active');
      document.getElementById('postContent').value = '';
      document.getElementById('extraContentArea').innerHTML = '';
      
      // æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
      selectedItems = {
        audios: [],
        articles: [],
        images: []
      };
    }
    
    // æ›´æ–°å†…å®¹é¢„è§ˆåŒºåŸŸ
    function updateContentPreview() {
      const extraArea = document.getElementById('extraContentArea');
      extraArea.innerHTML = '';
      
      // æ˜¾ç¤ºæ‰€æœ‰é€‰ä¸­çš„å†…å®¹
      selectedItems.audios.forEach((audio, index) => {
        extraArea.appendChild(createAudioPreview(audio, index));
      });
      
      selectedItems.articles.forEach((article, index) => {
        extraArea.appendChild(createArticlePreview(article, index));
      });
      
      selectedItems.images.forEach((image, index) => {
        extraArea.appendChild(createImagePreview(image, index));
      });
    }
    
    // æäº¤å¸–å­
    function submitPost() {
      const content = document.getElementById('postContent').value.trim();
      if (!content && selectedItems.audios.length === 0 && selectedItems.articles.length === 0 && selectedItems.images.length === 0) {
        alert('è¯·è¾“å…¥å†…å®¹æˆ–æ·»åŠ åˆ†äº«å†…å®¹');
        return;
      }
      
      let postData = {
        type: 'mixed_content',
        content: {
          text: content,
          audios: selectedItems.audios,
          articles: selectedItems.articles,
          images: selectedItems.images
        }
      };
      
      postMessage(postData);
    }
    
    // æ˜¾ç¤ºå›¾ç‰‡ä¸Šä¼ å™¨
    function showImageUploader() {
      const extraArea = document.getElementById('extraContentArea');
      extraArea.innerHTML = `
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
          <label class="form-label">ä¸Šä¼ å›¾ç‰‡</label>
          <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px;">
        </div>
      `;
    }
    
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('image', file);
      formData.append('user_id', currentUser.username);
      
      fetch('/api/upload_message_image', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
          selectedItems.images.push({
            filename: data.filename,
            caption: ''
          });
          
          updateContentPreview();
        } else {
          alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      })
      .catch(e => {
        alert('ä¸Šä¼ å¤±è´¥ï¼š' + e.message);
      });
      
      // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
      event.target.value = '';
    }
    
    // åˆ›å»ºéŸ³é¢‘é¢„è§ˆç»„ä»¶
    function createAudioPreview(audio, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      if (audio.type === 'single') {
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label class="form-label">éŸ³é¢‘ ${index + 1}</label>
            <button onclick="removeSelectedItem('audios', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ç§»é™¤</button>
          </div>
          <div style="padding: 16px; background: #f0f9ff; border: 1px solid #0284c7; border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 20px;">ğŸ¤</span>
              <div>
                <div style="font-weight: 600; color: #0c4a6e;">${audio.filename.replace('.mp3', '')}</div>
                <div style="color: #0369a1; font-size: 12px;">æ¥è‡ªï¼š${audio.folder}</div>
              </div>
            </div>
            ${audio.question ? `<div style="color: #075985; font-size: 13px; margin-bottom: 8px; line-height: 1.4; white-space: pre-wrap;">${audio.question}</div>` : ''}
          </div>
        `;
      } else {
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label class="form-label">åˆé›†éŸ³é¢‘ ${index + 1}</label>
            <button onclick="removeSelectedItem('audios', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ç§»é™¤</button>
          </div>
          <div style="padding: 16px; background: #fef9c3; border: 1px solid #eab308; border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 20px;">ğŸµ</span>
              <div>
                <div style="font-weight: 600; color: #92400e;">${audio.folder}</div>
                <div style="color: #a16207; font-size: 12px;">${audio.file_count} ä¸ªéŸ³é¢‘çš„åˆé›†</div>
              </div>
            </div>
            ${audio.question ? `<div style="color: #a16207; font-size: 13px; margin-bottom: 8px; line-height: 1.4; white-space: pre-wrap;">${audio.question}</div>` : ''}
          </div>
        `;
      }
      
      return div;
    }
    
    // åˆ›å»ºæ–‡ç« é¢„è§ˆç»„ä»¶
    function createArticlePreview(article, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label class="form-label">æ–‡ç«  ${index + 1}</label>
          <button onclick="removeSelectedItem('articles', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ç§»é™¤</button>
        </div>
        <div style="padding: 16px; background: #f0fdf4; border: 1px solid #16a34a; border-radius: 12px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 20px;">ğŸ“</span>
            <div>
              <div style="font-weight: 600; color: #14532d;">${article.title}</div>
              <div style="color: #15803d; font-size: 12px;">${article.category} â€¢ ${article.highlight_count} ä¸ªé«˜äº®è¯æ±‡</div>
            </div>
          </div>
        </div>
      `;
      
      return div;
    }
    
    // åˆ›å»ºå›¾ç‰‡é¢„è§ˆç»„ä»¶
    function createImagePreview(image, index) {
      const div = document.createElement('div');
      div.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label class="form-label">å›¾ç‰‡ ${index + 1}</label>
          <button onclick="removeSelectedItem('images', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">ç§»é™¤</button>
        </div>
        <div style="padding: 16px; background: #fef7ff; border: 1px solid #a855f7; border-radius: 12px;">
          <img src="/message_images/${image.filename}" alt="é¢„è§ˆå›¾ç‰‡" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
        </div>
      `;
      
      return div;
    }
    
    // ç§»é™¤é€‰ä¸­çš„é¡¹ç›®
    function removeSelectedItem(type, index) {
      selectedItems[type].splice(index, 1);
      updateContentPreview();
    }
    
    // æ˜¾ç¤ºéŸ³é¢‘é€‰æ‹©å™¨
    function showAudioSelector() {
      document.getElementById('audioModal').style.display = 'flex';
      resetAudioModal();
      loadAudioList();
    }
    
    // æ˜¾ç¤ºæ–‡ç« é€‰æ‹©å™¨
    function showArticleSelector() {
      document.getElementById('articleModal').style.display = 'flex';
      resetArticleModal();
      loadArticleList();
    }
    
    // é‡ç½®éŸ³é¢‘æ¨¡æ€æ¡†
    function resetAudioModal() {
      document.querySelectorAll('#audioCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById('audioBreadcrumb').textContent = 'è¯·é€‰æ‹©åˆ†ç±»';
      document.getElementById('audioContentList').innerHTML = '<div class="empty-content">è¯·å…ˆé€‰æ‹©å·¦ä¾§åˆ†ç±»</div>';
    }
    
    // é‡ç½®æ–‡ç« æ¨¡æ€æ¡†
    function resetArticleModal() {
      document.querySelectorAll('#articleCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById('articleBreadcrumb').textContent = 'è¯·é€‰æ‹©åˆ†ç±»';
      document.getElementById('articleContentList').innerHTML = '<div class="empty-content">è¯·å…ˆé€‰æ‹©å·¦ä¾§åˆ†ç±»</div>';
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // åŠ è½½éŸ³é¢‘åˆ—è¡¨
    function loadAudioList() {
      fetch('/api/get_audio_list')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            audioData = data.categories;
            setupAudioModal();
          }
        })
        .catch(e => console.error('åŠ è½½éŸ³é¢‘åˆ—è¡¨å¤±è´¥:', e));
    }
    
    let audioData = {};
    let articleData = {};
    
    // è®¾ç½®éŸ³é¢‘æ¨¡æ€æ¡†
    function setupAudioModal() {
      const categoryItems = document.querySelectorAll('#audioCategoryList .category-item');
      categoryItems.forEach(item => {
        item.onclick = () => {
          const category = item.dataset.category;
          selectAudioCategory(category, item);
        };
      });
    }
    
    // é€‰æ‹©éŸ³é¢‘åˆ†ç±»
    function selectAudioCategory(category, itemEl) {
      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('#audioCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      itemEl.classList.add('active');
      
      // æ›´æ–°é¢åŒ…å±‘
      document.getElementById('audioBreadcrumb').textContent = category;
      
      // æ¸²æŸ“å†…å®¹
      renderAudioContent(category);
    }
    
    // æ¸²æŸ“éŸ³é¢‘å†…å®¹
    function renderAudioContent(category) {
      const contentList = document.getElementById('audioContentList');
      const items = audioData[category] || [];
      
      if (items.length === 0) {
        contentList.innerHTML = '<div class="empty-content">è¯¥åˆ†ç±»ä¸‹æš‚æ— å†…å®¹</div>';
        return;
      }
      
      contentList.innerHTML = '';
      items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'content-item';
        
        const titleEl = document.createElement('div');
        titleEl.className = 'content-item-title';
        titleEl.textContent = item.folder;
        
        const metaEl = document.createElement('div');
        metaEl.className = 'content-item-meta';
        let metaText = `${item.file_count} ä¸ªéŸ³é¢‘`;
        if (item.has_combined) metaText += ' â€¢ æœ‰åˆé›†';
        if (item.question) metaText += ` â€¢ ${item.question.substring(0, 40)}...`;
        metaEl.textContent = metaText;
        
        const actionsEl = document.createElement('div');
        actionsEl.className = 'content-item-actions';
        
        // å•ç‹¬éŸ³é¢‘æŒ‰é’®
        const singleBtn = document.createElement('button');
        singleBtn.className = 'content-item-btn';
        singleBtn.textContent = 'åˆ†äº«å•ç‹¬éŸ³é¢‘';
        singleBtn.onclick = (e) => {
          e.stopPropagation();
          selectAudioItem(item, 'single', itemEl);
        };
        
        actionsEl.appendChild(singleBtn);
        
        // åˆé›†éŸ³é¢‘æŒ‰é’®ï¼ˆå¦‚æœæœ‰åˆé›†ï¼‰
        if (item.has_combined) {
          const combinedBtn = document.createElement('button');
          combinedBtn.className = 'content-item-btn primary';
          combinedBtn.textContent = 'åˆ†äº«åˆé›†éŸ³é¢‘';
          combinedBtn.onclick = (e) => {
            e.stopPropagation();
            selectAudioItem(item, 'combined', itemEl);
          };
          actionsEl.appendChild(combinedBtn);
        }
        
        itemEl.appendChild(titleEl);
        itemEl.appendChild(metaEl);
        itemEl.appendChild(actionsEl);
        
        contentList.appendChild(itemEl);
      });
    }
    
    // é€‰æ‹©éŸ³é¢‘é¡¹ç›®
    function selectAudioItem(item, type, itemEl) {
      if (type === 'single') {
        // åœ¨å½“å‰é¡¹ç›®ä¸‹å±•å¼€å•ä¸ªéŸ³é¢‘é€‰æ‹©
        showIndividualAudioInline(item, itemEl);
      } else {
        // åœ¨å½“å‰é¡¹ç›®ä¸‹å±•å¼€åˆé›†éŸ³é¢‘é€‰æ‹©
        showCombinedAudioInline(item, itemEl);
      }
    }
    
    // åœ¨è¡Œå†…å±•å¼€å•ä¸ªéŸ³é¢‘é€‰æ‹©
    function showIndividualAudioInline(item, itemEl) {
      // ç§»é™¤å…¶ä»–å±•å¼€çš„å†…å®¹
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // è·å–å…·ä½“éŸ³é¢‘æ–‡ä»¶åˆ—è¡¨
      fetch(`/list_audio`)
        .then(r => r.json())
        .then(data => {
          if (data) {
            // æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶å¤¹è¯¦ç»†ä¿¡æ¯
            let folderData = null;
            Object.keys(data).forEach(category => {
              const found = data[category].find(f => f.folder === item.folder);
              if (found) folderData = found;
            });
            
            if (folderData && folderData.files) {
              renderIndividualAudioInline(item, folderData.files, itemEl);
            }
          }
        })
        .catch(e => console.error('è·å–éŸ³é¢‘æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', e));
    }
    
    // åœ¨è¡Œå†…å±•å¼€åˆé›†éŸ³é¢‘é€‰æ‹©
    function showCombinedAudioInline(item, itemEl) {
      // ç§»é™¤å…¶ä»–å±•å¼€çš„å†…å®¹
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // åˆ›å»ºåˆé›†éŸ³é¢‘å±•å¼€å†…å®¹
      const expandedDiv = document.createElement('div');
      expandedDiv.className = 'expanded-content';
      expandedDiv.style.cssText = `
        margin-top: 12px; 
        padding: 16px; 
        background: #fef9c3; 
        border: 1px solid #eab308; 
        border-radius: 8px;
      `;
      
      expandedDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div>
            <div style="font-weight: 600; color: #92400e; font-size: 13px;">åˆé›†éŸ³é¢‘é¢„è§ˆ</div>
            <div style="color: #a16207; font-size: 11px;">${item.file_count} ä¸ªéŸ³é¢‘çš„åˆé›†</div>
          </div>
          <button onclick="this.closest('.expanded-content').remove()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px;">æ”¶èµ·</button>
        </div>
        ${item.question ? `<div style="color: #a16207; font-size: 12px; margin-bottom: 8px; line-height: 1.4;">${item.question}</div>` : ''}
        <button onclick="addCombinedAudio('${item.folder}', ${item.file_count}, ${item.has_combined}, '${item.question || ''}')" style="background: #0284c7; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 11px;">æ·»åŠ åˆ°å¸–å­</button>
      `;
      
      itemEl.appendChild(expandedDiv);
    }
    
    // åœ¨è¡Œå†…æ¸²æŸ“å•ä¸ªéŸ³é¢‘æ–‡ä»¶
    function renderIndividualAudioInline(folderItem, files, itemEl) {
      const expandedDiv = document.createElement('div');
      expandedDiv.className = 'expanded-content';
      expandedDiv.style.cssText = `
        margin-top: 12px; 
        padding: 16px; 
        background: #f0f9ff; 
        border: 1px solid #0284c7; 
        border-radius: 8px;
      `;
      
      let filesHtml = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="font-weight: 600; color: #0c4a6e; font-size: 13px;">é€‰æ‹©å…·ä½“éŸ³é¢‘æ–‡ä»¶</div>
          <button onclick="this.closest('.expanded-content').remove()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px;">æ”¶èµ·</button>
        </div>
        <div style="max-height: 200px; overflow-y: auto;">
      `;
      
      files.forEach((file, index) => {
        filesHtml += `
          <div style="padding: 8px 12px; border: 1px solid #e0f2fe; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;" 
               onmouseover="this.style.background='#e0f2fe'" 
               onmouseout="this.style.background=''" 
               onclick="selectIndividualAudioFile('${folderItem.folder}', '${file.name}', '${file.question || ''}')">
            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px; font-size: 13px;">${file.name.replace('.mp3', '')}</div>
            ${file.question ? `<div style="color: #6b7280; font-size: 11px; line-height: 1.4;">${file.question}</div>` : ''}
          </div>
        `;
      });
      
      filesHtml += '</div>';
      expandedDiv.innerHTML = filesHtml;
      itemEl.appendChild(expandedDiv);
    }
    
    // é€‰æ‹©å•ä¸ªéŸ³é¢‘æ–‡ä»¶
    function selectIndividualAudioFile(folder, filename, question) {
      // ç§»é™¤å±•å¼€å†…å®¹
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
      const audioItem = {
        folder: folder,
        filename: filename,
        question: question,
        type: 'single'
      };
      
      selectedItems.audios.push(audioItem);
      updateContentPreview();
      closeModal('audioModal');
    }
    
    // æ·»åŠ åˆé›†éŸ³é¢‘
    function addCombinedAudio(folder, fileCount, hasCombined, question) {
      // ç§»é™¤å±•å¼€å†…å®¹
      document.querySelectorAll('.expanded-content').forEach(el => el.remove());
      
      // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
      const audioItem = {
        folder: folder,
        file_count: fileCount,
        has_combined: hasCombined,
        question: question,
        type: 'combined'
      };
      
      selectedItems.audios.push(audioItem);
      updateContentPreview();
      closeModal('audioModal');
    }
    

    

    
    // åŠ è½½æ–‡ç« åˆ—è¡¨
    function loadArticleList() {
      fetch('/api/get_articles_list')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            articleData = data.categories;
            setupArticleModal();
          }
        })
        .catch(e => console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥:', e));
    }
    
    // è®¾ç½®æ–‡ç« æ¨¡æ€æ¡†
    function setupArticleModal() {
      const categoryItems = document.querySelectorAll('#articleCategoryList .category-item');
      categoryItems.forEach(item => {
        item.onclick = () => {
          const category = item.dataset.category;
          selectArticleCategory(category, item);
        };
      });
    }
    
    // é€‰æ‹©æ–‡ç« åˆ†ç±»
    function selectArticleCategory(category, itemEl) {
      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('#articleCategoryList .category-item').forEach(item => {
        item.classList.remove('active');
      });
      itemEl.classList.add('active');
      
      // æ›´æ–°é¢åŒ…å±‘
      document.getElementById('articleBreadcrumb').textContent = category;
      
      // æ¸²æŸ“å†…å®¹
      renderArticleContent(category);
    }
    
    // æ¸²æŸ“æ–‡ç« å†…å®¹
    function renderArticleContent(category) {
      const contentList = document.getElementById('articleContentList');
      const items = articleData[category] || [];
      
      if (items.length === 0) {
        contentList.innerHTML = '<div class="empty-content">è¯¥åˆ†ç±»ä¸‹æš‚æ— å†…å®¹</div>';
        return;
      }
      
      contentList.innerHTML = '';
      items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'content-item';
        itemEl.onclick = () => selectArticleItem(item, itemEl);
        
        const titleEl = document.createElement('div');
        titleEl.className = 'content-item-title';
        titleEl.textContent = item.title;
        
        const metaEl = document.createElement('div');
        metaEl.className = 'content-item-meta';
        metaEl.textContent = `${item.highlight_count} ä¸ªé«˜äº®è¯æ±‡`;
        
        itemEl.appendChild(titleEl);
        itemEl.appendChild(metaEl);
        contentList.appendChild(itemEl);
      });
    }
    
    // é€‰æ‹©æ–‡ç« é¡¹ç›®
    function selectArticleItem(item, itemEl) {
      // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
      selectedItems.articles.push(item);
      updateContentPreview();
      closeModal('articleModal');
    }
    

    

    
    // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
    function postMessage(message) {
      // æ·»åŠ tokenåˆ°è¯·æ±‚ä½“
      message.token = authToken;
      
      fetch('/api/messages', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(message)
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // å…³é—­æ–°å¸–è¡¨å•
          cancelNewPost();
          // ç«‹å³å°†æ–°å¸–æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨ï¼Œè€Œä¸æ˜¯é‡æ–°åŠ è½½æ•´ä¸ªåˆ—è¡¨
          addNewPostToTop(data.message);
        } else {
          alert('å‘é€å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      })
      .catch(e => {
        alert('å‘é€å¤±è´¥ï¼š' + e.message);
      });
    }
    
    // å°†æ–°å¸–æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
    function addNewPostToTop(newPost) {
      const postsList = document.getElementById('postsList');
      const emptyState = document.getElementById('emptyState');
      
      // éšè—ç©ºçŠ¶æ€
      if (emptyState) {
        emptyState.style.display = 'none';
      }
      
      // åˆ›å»ºæ–°å¸–å…ƒç´ 
      const newPostEl = createPostElement(newPost);
      
      // æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
      if (postsList.firstChild) {
        postsList.insertBefore(newPostEl, postsList.firstChild);
      } else {
        postsList.appendChild(newPostEl);
      }
      
      // æ·»åŠ ä¸€ä¸ªè½»å¾®çš„åŠ¨ç”»æ•ˆæœ
      newPostEl.style.opacity = '0';
      newPostEl.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        newPostEl.style.transition = 'all 0.3s ease';
        newPostEl.style.opacity = '1';
        newPostEl.style.transform = 'translateY(0)';
      }, 100);
    }
    
    // åŠ è½½æ‰€æœ‰å¸–å­
    function loadPosts() {
      fetch('/api/messages')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            renderPosts(data.messages);
          }
        })
        .catch(e => console.error('åŠ è½½å¸–å­å¤±è´¥:', e));
    }
    
    // æ¸²æŸ“å¸–å­åˆ—è¡¨
    function renderPosts(posts) {
      const container = document.getElementById('postsList');
      const emptyState = document.getElementById('emptyState');
      
      if (posts.length === 0) {
        emptyState.style.display = 'block';
        return;
      } else {
        emptyState.style.display = 'none';
      }
      
      container.innerHTML = '';
      
      posts.forEach(post => {
        const postEl = createPostElement(post);
        container.appendChild(postEl);
      });
    }
    
    // åˆ›å»ºå¸–å­å…ƒç´ 
    function createPostElement(post) {
      const postEl = document.createElement('div');
      postEl.className = 'post-card';
      
      const header = document.createElement('div');
      header.className = 'post-header';
      
      const avatar = document.createElement('img');
      avatar.className = 'user-avatar';
      avatar.src = `/static/${post.user.avatar}`;
      avatar.alt = post.user.display_name;
      
      const userInfo = document.createElement('div');
      userInfo.className = 'post-user-info';
      
      const userName = document.createElement('div');
      userName.className = 'user-name';
      userName.textContent = post.user.display_name;
      
      const time = document.createElement('div');
      time.className = 'post-time';
      time.textContent = formatTime(post.timestamp);
      
      userInfo.appendChild(userName);
      userInfo.appendChild(time);
      
      // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„å¸–å­ï¼Œæ·»åŠ åˆ é™¤æŒ‰é’®åˆ°å³ä¸Šè§’
      if (currentUser && post.user.username === currentUser.username) {
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = 'ğŸ—‘ï¸';
        deleteBtn.title = 'åˆ é™¤å¸–å­';
        deleteBtn.style.cssText = `
          position: absolute;
          top: 0;
          right: 0;
          background: none; 
          border: none; 
          color: #9ca3af; 
          cursor: pointer; 
          font-size: 14px; 
          padding: 6px; 
          border-radius: 6px; 
          transition: all 0.2s;
          opacity: 0.7;
        `;
        deleteBtn.onmouseover = () => {
          deleteBtn.style.background = '#fee2e2';
          deleteBtn.style.color = '#dc2626';
          deleteBtn.style.opacity = '1';
          deleteBtn.style.transform = 'scale(1.1)';
        };
        deleteBtn.onmouseout = () => {
          deleteBtn.style.background = 'none';
          deleteBtn.style.color = '#9ca3af';
          deleteBtn.style.opacity = '0.7';
          deleteBtn.style.transform = 'scale(1)';
        };
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deletePost(post.id);
        };
        header.appendChild(deleteBtn);
      }
      header.appendChild(avatar);
      header.appendChild(userInfo);
      
      const content = document.createElement('div');
      content.className = 'post-content';
      
      // æ ¹æ®æ¶ˆæ¯ç±»å‹æ¸²æŸ“ä¸åŒå†…å®¹
      let hasContent = false;
      
      if (post.type === 'mixed_content') {
        // æ–‡å­—å†…å®¹
        if (post.content.text) {
          const textDiv = document.createElement('div');
          textDiv.className = 'text-content';
          if (hasContent) textDiv.className += ' content-section';
          textDiv.innerHTML = escapeHtml(post.content.text);
          content.appendChild(textDiv);
          hasContent = true;
        }
        
        // éŸ³é¢‘å†…å®¹
        if (post.content.audios && post.content.audios.length > 0) {
          post.content.audios.forEach(audio => {
            const audioCard = createAudioCard(audio);
            if (hasContent) audioCard.classList.add('content-section');
            content.appendChild(audioCard);
            hasContent = true;
          });
        }
        
        // æ–‡ç« å†…å®¹
        if (post.content.articles && post.content.articles.length > 0) {
          post.content.articles.forEach(article => {
            const articleCard = createArticleCard(article);
            if (hasContent) articleCard.classList.add('content-section');
            content.appendChild(articleCard);
            hasContent = true;
          });
        }
        
        // å›¾ç‰‡å†…å®¹
        if (post.content.images && post.content.images.length > 0) {
          post.content.images.forEach(image => {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'image-content';
            if (hasContent) imageDiv.classList.add('content-section');
            imageDiv.innerHTML = `<img class="message-image" src="/message_images/${image.filename}" alt="å›¾ç‰‡" ondblclick="openImageModal('/message_images/${image.filename}')" title="åŒå‡»æŸ¥çœ‹å¤§å›¾">`;
            content.appendChild(imageDiv);
            hasContent = true;
          });
        }
      } else if (post.type === 'text') {
        content.innerHTML = `<div class="text-content">${escapeHtml(post.content.text)}</div>        `;
      } else if (post.type === 'image') {
        content.innerHTML = `
          <div class="image-content">
            <img class="message-image" src="/message_images/${post.content.filename}" alt="å›¾ç‰‡" ondblclick="openImageModal('/message_images/${post.content.filename}')" title="åŒå‡»æŸ¥çœ‹å¤§å›¾">
            ${post.content.caption ? `<div class="text-content" style="margin-top: 8px;">${escapeHtml(post.content.caption)}</div>` : ''}
          </div>
        `;
      } else if (post.type === 'audio_share') {
        if (post.content.text) {
          content.innerHTML = `<div class="text-content">${escapeHtml(post.content.text)}</div>`;
        }
        const audioCard = createAudioCard(post.content);
        content.appendChild(audioCard);
      } else if (post.type === 'article_share') {
        if (post.content.text) {
          content.innerHTML = `<div class="text-content">${escapeHtml(post.content.text)}</div>`;
        }
        const articleCard = createArticleCard(post.content);
        content.appendChild(articleCard);
      }
      
      postEl.appendChild(header);
      postEl.appendChild(content);
      
      return postEl;
    }
    
    // åˆ›å»ºéŸ³é¢‘å¡ç‰‡
    function createAudioCard(audioContent) {
      const card = document.createElement('div');
      card.className = 'audio-card';
      
      if (audioContent.type === 'single') {
        card.onclick = () => {
          // æ„é€ è¯¦ç»†çš„å•ä¸ªéŸ³é¢‘è·³è½¬URLï¼ŒåŒ…å«æ–‡ä»¶å¤¹å’Œå…·ä½“éŸ³é¢‘æ–‡ä»¶ä¿¡æ¯
          const jumpUrl = `/speaking#folder=${encodeURIComponent(audioContent.folder)}&file=${encodeURIComponent(audioContent.filename)}`;
          window.open(jumpUrl, '_blank');
        };
        
        const header = document.createElement('div');
        header.className = 'card-header';
        
        const icon = document.createElement('div');
        icon.className = 'card-icon';
        icon.textContent = 'ğŸ¤';
        
        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = audioContent.filename.replace('.mp3', '');
        
        header.appendChild(icon);
        header.appendChild(title);
        
        const desc = document.createElement('div');
        desc.className = 'card-desc';
        desc.style.whiteSpace = 'pre-wrap';
        if (audioContent.question) {
          desc.textContent = audioContent.question;
        } else {
          desc.textContent = 'ç‚¹å‡»æŸ¥çœ‹éŸ³é¢‘å†…å®¹';
        }
        
        const meta = document.createElement('div');
        meta.className = 'card-meta';
        meta.textContent = `æ¥è‡ªï¼š${audioContent.folder}`;
        
        card.appendChild(header);
        card.appendChild(desc);
        card.appendChild(meta);
        
      } else {
        // åˆé›†éŸ³é¢‘
        card.onclick = () => {
          // æ„é€ åˆé›†éŸ³é¢‘è·³è½¬URLï¼Œç›´æ¥å®šä½åˆ°å…·ä½“åˆé›†
          window.open(`/combined#folder=${encodeURIComponent(audioContent.folder)}`, '_blank');
        };
        
        const header = document.createElement('div');
        header.className = 'card-header';
        
        const icon = document.createElement('div');
        icon.className = 'card-icon';
        icon.textContent = 'ğŸµ';
        
        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = audioContent.folder;
        
        header.appendChild(icon);
        header.appendChild(title);
        
        const desc = document.createElement('div');
        desc.className = 'card-desc';
        desc.style.whiteSpace = 'pre-wrap';
        if (audioContent.question) {
          desc.textContent = audioContent.question;
        } else {
          desc.textContent = 'ç‚¹å‡»æŸ¥çœ‹éŸ³é¢‘å†…å®¹';
        }
        
        const meta = document.createElement('div');
        meta.className = 'card-meta';
        meta.textContent = `${audioContent.file_count} ä¸ªéŸ³é¢‘çš„åˆé›†`;
        
        card.appendChild(header);
        card.appendChild(desc);
        card.appendChild(meta);
      }
      
      return card;
    }
    
    // åˆ›å»ºæ–‡ç« å¡ç‰‡
    function createArticleCard(articleContent) {
      const card = document.createElement('div');
      card.className = 'article-card';
      card.onclick = () => {
        // æ„é€ æ­£ç¡®çš„æ–‡ç« è·³è½¬URLï¼Œä½¿ç”¨intensiveé¡µé¢çš„hashæ ¼å¼
        window.open(`/intensive#article-${articleContent.id || articleContent.article_id}`, '_blank');
      };
      
      const header = document.createElement('div');
      header.className = 'card-header';
      
      const icon = document.createElement('div');
      icon.className = 'card-icon';
      icon.textContent = 'ğŸ“';
      
      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = articleContent.title;
      
      header.appendChild(icon);
      header.appendChild(title);
      
      const desc = document.createElement('div');
      desc.className = 'card-desc';
      desc.textContent = `${articleContent.category} æ–‡ç«  â€¢ ç‚¹å‡»æŸ¥çœ‹ç²¾è¯»å†…å®¹`;
      
      const meta = document.createElement('div');
      meta.className = 'card-meta';
      meta.textContent = `${articleContent.highlight_count} ä¸ªé«˜äº®è¯æ±‡`;
      
      card.appendChild(header);
      card.appendChild(desc);
      card.appendChild(meta);
      
      return card;
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // 1åˆ†é’Ÿå†…
        return 'åˆšåˆš';
      } else if (diff < 3600000) { // 1å°æ—¶å†…
        return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
      } else if (diff < 86400000) { // 24å°æ—¶å†…
        return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
      } else if (diff < 604800000) { // 7å¤©å†…
        return Math.floor(diff / 86400000) + 'å¤©å‰';
      } else {
        return date.toLocaleDateString();
      }
    }
    
    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // åˆ é™¤å¸–å­
    function deletePost(postId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸–å­å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
        return;
      }
      
      fetch(`/api/messages/${postId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // é‡æ–°åŠ è½½å¸–å­åˆ—è¡¨
          loadPosts();
        } else {
          alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      })
      .catch(e => {
        alert('åˆ é™¤å¤±è´¥ï¼š' + e.message);
      });
    }
    
    // æ‰“å¼€å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†
    function openImageModal(imageSrc) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      modalImage.src = imageSrc;
      modal.style.display = 'flex';
      
      // æ·»åŠ æ·¡å…¥åŠ¨ç”»
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.transition = 'opacity 0.3s ease';
        modal.style.opacity = '1';
      }, 10);
    }
    
    // å…³é—­å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†
    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
  </script>
</body>
</html>
