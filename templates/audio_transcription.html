<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éŸ³é¢‘è½¬æ–‡æœ¬</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
  
  <!-- Notionå­—ä½“ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Source Serif Pro', 'Inter', ui-serif, serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #2d3748;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      padding: 30px 40px;
      text-align: center;
      position: relative;
    }
    
    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      letter-spacing: -0.02em;
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      font-weight: 400;
    }
    
    .back-btn {
      position: absolute;
      left: 30px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-50%) translateX(-2px);
    }
    
    .main-content {
      padding: 40px;
    }
    
    .mode-selector {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      background: white;
      padding: 8px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
      max-width: 400px;
      margin: 0 auto 30px;
    }
    
    .mode-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      background: transparent;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      font-size: 0.95rem;
    }
    
    .mode-btn.active {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    
    .mode-btn:hover:not(.active) {
      background: #f8fafc;
      color: #4f46e5;
    }
    
    .mode-icon {
      font-size: 1.1rem;
    }
    
    .recording-section {
      background: #f8fafc;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    
    .recording-section.recording {
      border-color: #ef4444;
      background: #fef2f2;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    .recording-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      color: #6b7280;
      transition: all 0.3s ease;
    }
    
    .recording-section.recording .recording-icon {
      color: #ef4444;
      animation: bounce 1s infinite;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    
    .recording-text {
      font-size: 1.2rem;
      color: #4a5568;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .recording-hint {
      font-size: 0.9rem;
      color: #718096;
      margin-bottom: 30px;
    }
    
    .recording-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    
    .record-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .record-btn.primary {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
    }
    
    .record-btn.secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }
    
    .record-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    .record-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .recording-status {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .status-text {
      font-weight: 600;
      color: #374151;
    }
    
    .recording-time {
      font-family: 'Courier New', monospace;
      font-size: 1.2rem;
      font-weight: bold;
      color: #ef4444;
    }
    
    .audio-visualizer {
      margin: 20px 0;
      display: flex;
      justify-content: center;
    }
    
    .audio-visualizer canvas {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
    }
    
    .audio-preview {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #e2e8f0;
    }
    
    .audio-preview audio {
      width: 100%;
      margin-bottom: 15px;
    }
    
    .preview-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .processing-status {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #6b7280;
      font-style: italic;
      padding: 15px;
      background: #f0f9ff;
      border-left: 4px solid #0ea5e9;
    }
    
    .error-status {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      color: #dc2626;
      padding: 15px;
      background: #fef2f2;
      border-left: 4px solid #ef4444;
      border-radius: 8px;
    }
    
    .status-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    .error-content {
      flex: 1;
    }
    
    .error-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 8px;
    }
    
    .error-detail {
      font-size: 0.9rem;
      color: #7f1d1d;
      line-height: 1.4;
      margin-bottom: 8px;
      word-break: break-word;
    }
    
    .error-hint {
      font-size: 0.8rem;
      color: #991b1b;
      font-style: italic;
    }
    
    .upload-section {
      background: #f8fafc;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      border: 2px dashed #cbd5e0;
      transition: all 0.3s ease;
    }
    
    .upload-section.dragover {
      border-color: #4f46e5;
      background: #eef2ff;
      transform: scale(1.02);
    }
    
    .upload-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      color: #6b7280;
      transition: all 0.3s ease;
    }
    
    .upload-section.dragover .upload-icon {
      color: #4f46e5;
      transform: scale(1.1);
    }
    
    .upload-text {
      font-size: 1.2rem;
      color: #4a5568;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .upload-hint {
      font-size: 0.9rem;
      color: #718096;
      margin-bottom: 30px;
    }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      margin: 20px 0;
    }
    
    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .upload-btn {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
    }
    
    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
    }
    
    .file-preview {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #e2e8f0;
      text-align: left;
    }
    
    .file-info {
      margin-bottom: 15px;
    }
    
    .file-name {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
      word-break: break-word;
    }
    
    .file-details {
      display: flex;
      gap: 20px;
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .file-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    .title-input {
      width: 100%;
      max-width: 400px;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      margin: 20px auto;
      display: block;
      font-family: inherit;
      transition: border-color 0.3s ease;
    }
    
    .title-input:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .transcriptions-list {
      margin-top: 40px;
    }
    
    .section-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .transcription-item {
      background: white;
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    
    .transcription-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .transcription-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .transcription-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
      flex: 1;
    }
    
    .transcription-date {
      font-size: 0.9rem;
      color: #718096;
    }
    
    .transcription-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-processing {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-completed {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .transcription-text {
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      font-size: 1rem;
      line-height: 1.6;
      color: #4a5568;
      margin: 15px 0;
      border-left: 4px solid #4f46e5;
    }
    
    .transcription-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    
    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn-primary {
      background: #4f46e5;
      color: white;
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }
    
    .loading.show {
      display: block;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #4f46e5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      border-left: 4px solid #4f46e5;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.error {
      border-left-color: #ef4444;
    }
    
    .toast.success {
      border-left-color: #10b981;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 16px;
      }
      
      .header {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .main-content {
        padding: 20px;
      }
      
      .upload-section {
        padding: 30px 20px;
      }
      
      .transcription-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .transcription-actions {
        justify-content: center;
      }
      
      .back-btn {
        position: static;
        transform: none;
        margin-bottom: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/" class="back-btn">
        <span>â†</span> è¿”å›é¦–é¡µ
      </a>
      <h1>éŸ³é¢‘è½¬æ–‡æœ¬</h1>
      <p>ä½¿ç”¨AIæŠ€æœ¯å°†éŸ³é¢‘æ–‡ä»¶è½¬æ¢ä¸ºæ–‡æœ¬å†…å®¹</p>
    </div>
    
    <div class="main-content">
      <!-- æ¨¡å¼åˆ‡æ¢ -->
      <div class="mode-selector">
        <button class="mode-btn active" id="recordModeBtn" onclick="switchMode('record')">
          <span class="mode-icon">ğŸ™ï¸</span>
          <span class="mode-text">å½•éŸ³æ¨¡å¼</span>
        </button>
        <button class="mode-btn" id="uploadModeBtn" onclick="switchMode('upload')">
          <span class="mode-icon">ğŸ“</span>
          <span class="mode-text">ä¸Šä¼ æ¨¡å¼</span>
        </button>
      </div>
      
      <!-- å½•éŸ³åŒºåŸŸ -->
      <div class="recording-section" id="recordingSection">
        <div class="recording-icon" id="recordingIcon">ğŸ™ï¸</div>
        <div class="recording-text" id="recordingText">ç‚¹å‡»å¼€å§‹å½•éŸ³</div>
        <div class="recording-hint">æ”¯æŒæµè§ˆå™¨å½•éŸ³ï¼Œå½•åˆ¶å®Œæˆåè‡ªåŠ¨è½¬å½•ä¸ºæ–‡æœ¬</div>
        
        <input type="text" class="title-input" id="titleInput" placeholder="è¾“å…¥å½•éŸ³æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰">
        
        <!-- å½•éŸ³æ§åˆ¶æŒ‰é’® -->
        <div class="recording-controls">
          <button class="record-btn" id="startRecordBtn">
            <span class="btn-icon">ğŸ™ï¸</span>
            <span class="btn-text">å¼€å§‹å½•éŸ³</span>
          </button>
          <button class="record-btn secondary" id="stopRecordBtn" style="display: none;">
            <span class="btn-icon">â¹ï¸</span>
            <span class="btn-text">åœæ­¢å½•éŸ³</span>
          </button>
          <button class="record-btn secondary" id="reRecordBtn" style="display: none;">
            <span class="btn-icon">ğŸ”„</span>
            <span class="btn-text">é‡æ–°å½•éŸ³</span>
          </button>
          <button class="record-btn primary" id="uploadRecordBtn" style="display: none;">
            <span class="btn-icon">ğŸ“¤</span>
            <span class="btn-text">ä¸Šä¼ è½¬å½•</span>
          </button>
        </div>
        
        <!-- å½•éŸ³çŠ¶æ€æ˜¾ç¤º -->
        <div class="recording-status" id="recordingStatus" style="display: none;">
          <div class="status-text" id="statusText">å‡†å¤‡å½•éŸ³...</div>
          <div class="recording-time" id="recordingTime">00:00</div>
        </div>
        
        <!-- éŸ³é¢‘æ³¢å½¢å¯è§†åŒ– -->
        <div class="audio-visualizer" id="audioVisualizer" style="display: none;">
          <canvas id="visualizerCanvas" width="400" height="100"></canvas>
        </div>
        
        <!-- å½•éŸ³é¢„è§ˆ -->
        <div class="audio-preview" id="audioPreview" style="display: none;">
          <audio controls id="previewAudio"></audio>
          <div class="preview-info">
            <span id="previewDuration">æ—¶é•¿: --:--</span>
            <span id="previewSize">å¤§å°: -- KB</span>
          </div>
        </div>
      </div>
      
      <!-- ä¸Šä¼ åŒºåŸŸ -->
      <div class="upload-section" id="uploadSection" style="display: none;">
        <div class="upload-icon" id="uploadIcon">ğŸ“</div>
        <div class="upload-text" id="uploadText">æ‹–æ‹½éŸ³é¢‘æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
        <div class="upload-hint">æ”¯æŒ MP3, WAV, M4A, FLAC, OGG, MP4, WebM ç­‰æ ¼å¼ï¼Œæœ€å¤§ 25MB</div>
        
        <input type="text" class="title-input" id="uploadTitleInput" placeholder="è¾“å…¥éŸ³é¢‘æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰">
        
        <div class="file-input-wrapper">
          <input type="file" class="file-input" id="fileInput" accept="audio/*">
          <button class="upload-btn">é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</button>
        </div>
        
        <!-- æ–‡ä»¶é¢„è§ˆ -->
        <div class="file-preview" id="filePreview" style="display: none;">
          <div class="file-info">
            <div class="file-name" id="fileName"></div>
            <div class="file-details">
              <span id="fileSize"></span>
              <span id="fileType"></span>
            </div>
          </div>
          <div class="file-actions">
            <button class="action-btn btn-secondary" onclick="clearSelectedFile()">
              <span>ğŸ—‘ï¸</span> æ¸…é™¤
            </button>
            <button class="action-btn btn-primary" onclick="uploadSelectedFile()">
              <span>ğŸ“¤</span> ä¸Šä¼ è½¬å½•
            </button>
          </div>
        </div>
      </div>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <div class="loading" id="loadingSection">
        <div class="spinner"></div>
        <p>æ­£åœ¨è½¬å½•éŸ³é¢‘ï¼Œè¯·ç¨å€™...</p>
      </div>
      
      <!-- è½¬å½•åˆ—è¡¨ -->
      <div class="transcriptions-list">
        <h2 class="section-title">
          <span>ğŸ“</span> è½¬å½•è®°å½•
        </h2>
        <div id="transcriptionsList">
          <!-- è½¬å½•é¡¹ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast é€šçŸ¥ -->
  <div class="toast" id="toast">
    <div id="toastMessage"></div>
  </div>

  <script>
    let currentToken = null;
    let currentUser = null;
    
    // å½•éŸ³ç›¸å…³å˜é‡
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let recordingTimer = null;
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let visualizerAnimationId = null;
    let recordedBlob = null;
    
    // è½®è¯¢ç›¸å…³å˜é‡
    let pollingInterval = null;
    let processingTranscriptions = new Set(); // è·Ÿè¸ªæ­£åœ¨å¤„ç†çš„è½¬å½•ID
    
    // ä¸Šä¼ ç›¸å…³å˜é‡
    let selectedFile = null;
    let currentMode = 'record'; // 'record' æˆ– 'upload'
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth(); // checkAuthå†…éƒ¨ä¼šè°ƒç”¨loadTranscriptions
      initializeRecording();
      initializeUpload();
      startPolling(); // å¼€å§‹è½®è¯¢
    });
    
    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', function() {
      stopPolling();
    });
    
    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    function checkAuth() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        showToast('è¯·å…ˆç™»å½•', 'error');
        setTimeout(() => {
          window.location.href = '/login';
        }, 1500);
        return;
      }
      
      fetch('/verify_token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({token: token})
      })
      .then(response => response.json())
      .then(data => {
        if (data.valid) {
          currentToken = token;
          if (data.user) {
            currentUser = data.user;
          }
          // è®¤è¯æˆåŠŸååŠ è½½è½¬å½•åˆ—è¡¨
          loadTranscriptions();
        } else {
          localStorage.removeItem('authToken');
          localStorage.removeItem('currentUser');
          showToast('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        }
      })
      .catch(error => {
        console.error('Auth check failed:', error);
        showToast('è®¤è¯æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
      });
    }
    
    // åˆå§‹åŒ–å½•éŸ³åŠŸèƒ½
    function initializeRecording() {
      const startBtn = document.getElementById('startRecordBtn');
      const stopBtn = document.getElementById('stopRecordBtn');
      const reRecordBtn = document.getElementById('reRecordBtn');
      const uploadBtn = document.getElementById('uploadRecordBtn');
      
      startBtn.addEventListener('click', startRecording);
      stopBtn.addEventListener('click', stopRecording);
      reRecordBtn.addEventListener('click', resetRecording);
      uploadBtn.addEventListener('click', uploadRecording);
      
      // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½', 'error');
        startBtn.disabled = true;
      }
    }
    
    // å¼€å§‹å½•éŸ³
    async function startRecording() {
      try {
        // è¯·æ±‚éº¦å…‹é£æƒé™
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          } 
        });
        
        // è®¾ç½®å½•éŸ³å™¨
        mediaRecorder = new MediaRecorder(stream, {
          mimeType: 'audio/webm;codecs=opus'
        });
        
        audioChunks = [];
        
        mediaRecorder.ondataavailable = function(event) {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = function() {
          recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
          showAudioPreview(recordedBlob);
          stream.getTracks().forEach(track => track.stop());
          stopVisualizer();
        };
        
        // å¼€å§‹å½•éŸ³
        mediaRecorder.start(100); // æ¯100msæ”¶é›†ä¸€æ¬¡æ•°æ®
        recordingStartTime = Date.now();
        
        // æ›´æ–°UI
        updateRecordingUI('recording');
        startTimer();
        startVisualizer(stream);
        
        showToast('å½•éŸ³å·²å¼€å§‹', 'success');
        
      } catch (error) {
        console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
        if (error.name === 'NotAllowedError') {
          showToast('è¯·å…è®¸è®¿é—®éº¦å…‹é£æƒé™', 'error');
        } else {
          showToast('å½•éŸ³å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
      }
    }
    
    // åœæ­¢å½•éŸ³
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        updateRecordingUI('stopped');
        stopTimer();
        showToast('å½•éŸ³å·²åœæ­¢', 'success');
      }
    }
    
    // é‡æ–°å½•éŸ³
    function resetRecording() {
      recordedBlob = null;
      audioChunks = [];
      updateRecordingUI('ready');
      hideAudioPreview();
      document.getElementById('titleInput').value = '';
    }
    
    // ä¸Šä¼ å½•éŸ³
    function uploadRecording() {
      if (!recordedBlob) {
        showToast('æ²¡æœ‰å½•éŸ³æ–‡ä»¶', 'error');
        return;
      }
      
      const title = document.getElementById('titleInput').value.trim() || 
                   `å½•éŸ³_${new Date().toLocaleString('zh-CN')}`;
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      document.getElementById('loadingSection').classList.add('show');
      
      // åˆ›å»ºFormData
      const formData = new FormData();
      formData.append('file', recordedBlob, 'recording.webm');
      formData.append('title', title);
      
      // ä¸Šä¼ å¹¶è½¬å½•
      fetch('/api/audio_transcription/upload', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${currentToken}`
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('loadingSection').classList.remove('show');
        
        if (data.success) {
          showToast('å½•éŸ³ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨è½¬å½•...', 'success');
          // æ·»åŠ åˆ°å¤„ç†ä¸­çš„è½¬å½•åˆ—è¡¨
          processingTranscriptions.add(data.transcription_id);
          resetRecording();
          loadTranscriptions();
        } else {
          showToast(data.error || 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
      })
      .catch(error => {
        document.getElementById('loadingSection').classList.remove('show');
        console.error('Upload error:', error);
        showToast('ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
      });
    }
    
    // æ›´æ–°å½•éŸ³UIçŠ¶æ€
    function updateRecordingUI(state) {
      const section = document.getElementById('recordingSection');
      const icon = document.getElementById('recordingIcon');
      const text = document.getElementById('recordingText');
      const startBtn = document.getElementById('startRecordBtn');
      const stopBtn = document.getElementById('stopRecordBtn');
      const reRecordBtn = document.getElementById('reRecordBtn');
      const uploadBtn = document.getElementById('uploadRecordBtn');
      const status = document.getElementById('recordingStatus');
      const statusText = document.getElementById('statusText');
      
      switch (state) {
        case 'recording':
          section.classList.add('recording');
          text.textContent = 'æ­£åœ¨å½•éŸ³...';
          startBtn.style.display = 'none';
          stopBtn.style.display = 'inline-flex';
          reRecordBtn.style.display = 'none';
          uploadBtn.style.display = 'none';
          status.style.display = 'flex';
          statusText.textContent = 'å½•éŸ³ä¸­...';
          break;
          
        case 'stopped':
          section.classList.remove('recording');
          text.textContent = 'å½•éŸ³å®Œæˆ';
          startBtn.style.display = 'none';
          stopBtn.style.display = 'none';
          reRecordBtn.style.display = 'inline-flex';
          uploadBtn.style.display = 'inline-flex';
          status.style.display = 'none';
          break;
          
        case 'ready':
        default:
          section.classList.remove('recording');
          text.textContent = 'ç‚¹å‡»å¼€å§‹å½•éŸ³';
          startBtn.style.display = 'inline-flex';
          stopBtn.style.display = 'none';
          reRecordBtn.style.display = 'none';
          uploadBtn.style.display = 'none';
          status.style.display = 'none';
          break;
      }
    }
    
    // å¼€å§‹è®¡æ—¶å™¨
    function startTimer() {
      const timeDisplay = document.getElementById('recordingTime');
      recordingTimer = setInterval(() => {
        const elapsed = Date.now() - recordingStartTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }
    
    // åœæ­¢è®¡æ—¶å™¨
    function stopTimer() {
      if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
      }
    }
    
    // å¼€å§‹éŸ³é¢‘å¯è§†åŒ–
    function startVisualizer(stream) {
      const canvas = document.getElementById('visualizerCanvas');
      const canvasCtx = canvas.getContext('2d');
      const visualizer = document.getElementById('audioVisualizer');
      
      visualizer.style.display = 'block';
      
      // è®¾ç½®éŸ³é¢‘ä¸Šä¸‹æ–‡
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioContext.createAnalyser();
      microphone = audioContext.createMediaStreamSource(stream);
      
      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      
      microphone.connect(analyser);
      
      // ç»˜åˆ¶æ³¢å½¢
      function draw() {
        visualizerAnimationId = requestAnimationFrame(draw);
        
        analyser.getByteFrequencyData(dataArray);
        
        canvasCtx.fillStyle = '#f8fafc';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        
        const barWidth = (canvas.width / bufferLength) * 2.5;
        let barHeight;
        let x = 0;
        
        for (let i = 0; i < bufferLength; i++) {
          barHeight = (dataArray[i] / 255) * canvas.height * 0.8;
          
          const gradient = canvasCtx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
          gradient.addColorStop(0, '#4f46e5');
          gradient.addColorStop(1, '#7c3aed');
          
          canvasCtx.fillStyle = gradient;
          canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
          
          x += barWidth + 1;
        }
      }
      
      draw();
    }
    
    // åœæ­¢éŸ³é¢‘å¯è§†åŒ–
    function stopVisualizer() {
      if (visualizerAnimationId) {
        cancelAnimationFrame(visualizerAnimationId);
        visualizerAnimationId = null;
      }
      
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      
      document.getElementById('audioVisualizer').style.display = 'none';
    }
    
    // æ˜¾ç¤ºéŸ³é¢‘é¢„è§ˆ
    function showAudioPreview(blob) {
      const preview = document.getElementById('audioPreview');
      const audio = document.getElementById('previewAudio');
      const duration = document.getElementById('previewDuration');
      const size = document.getElementById('previewSize');
      
      const url = URL.createObjectURL(blob);
      audio.src = url;
      
      audio.onloadedmetadata = function() {
        const mins = Math.floor(audio.duration / 60);
        const secs = Math.floor(audio.duration % 60);
        duration.textContent = `æ—¶é•¿: ${mins}:${secs.toString().padStart(2, '0')}`;
      };
      
      size.textContent = `å¤§å°: ${(blob.size / 1024).toFixed(1)} KB`;
      preview.style.display = 'block';
    }
    
    // éšè—éŸ³é¢‘é¢„è§ˆ
    function hideAudioPreview() {
      const preview = document.getElementById('audioPreview');
      const audio = document.getElementById('previewAudio');
      
      if (audio.src) {
        URL.revokeObjectURL(audio.src);
        audio.src = '';
      }
      
      preview.style.display = 'none';
    }
    
    // æ¨¡å¼åˆ‡æ¢
    function switchMode(mode) {
      currentMode = mode;
      const recordBtn = document.getElementById('recordModeBtn');
      const uploadBtn = document.getElementById('uploadModeBtn');
      const recordSection = document.getElementById('recordingSection');
      const uploadSection = document.getElementById('uploadSection');
      
      if (mode === 'record') {
        recordBtn.classList.add('active');
        uploadBtn.classList.remove('active');
        recordSection.style.display = 'block';
        uploadSection.style.display = 'none';
        
        // æ¸…ç†ä¸Šä¼ çŠ¶æ€
        clearSelectedFile();
      } else {
        recordBtn.classList.remove('active');
        uploadBtn.classList.add('active');
        recordSection.style.display = 'none';
        uploadSection.style.display = 'block';
        
        // æ¸…ç†å½•éŸ³çŠ¶æ€
        resetRecording();
      }
    }
    
    // åˆå§‹åŒ–ä¸Šä¼ åŠŸèƒ½
    function initializeUpload() {
      const uploadSection = document.getElementById('uploadSection');
      const fileInput = document.getElementById('fileInput');
      
      // æ‹–æ‹½ä¸Šä¼ 
      uploadSection.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadSection.classList.add('dragover');
      });
      
      uploadSection.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
      });
      
      uploadSection.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelection(files[0]);
        }
      });
      
      // æ–‡ä»¶é€‰æ‹©ä¸Šä¼ 
      fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          handleFileSelection(e.target.files[0]);
        }
      });
    }
    
    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelection(file) {
      // éªŒè¯æ–‡ä»¶ç±»å‹
      const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/m4a', 'audio/flac', 'audio/ogg', 'audio/webm'];
      const allowedExtensions = ['.mp3', '.wav', '.m4a', '.flac', '.ogg', '.mp4', '.webm'];
      
      const isValidType = allowedTypes.includes(file.type) || 
                         allowedExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
      
      if (!isValidType) {
        showToast('è¯·é€‰æ‹©æœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶æ ¼å¼', 'error');
        return;
      }
      
      // éªŒè¯æ–‡ä»¶å¤§å° (25MB)
      if (file.size > 25 * 1024 * 1024) {
        showToast('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 25MB', 'error');
        return;
      }
      
      selectedFile = file;
      showFilePreview(file);
      
      // è‡ªåŠ¨å¡«å……æ ‡é¢˜
      const titleInput = document.getElementById('uploadTitleInput');
      if (!titleInput.value.trim()) {
        titleInput.value = file.name.replace(/\.[^/.]+$/, "");
      }
    }
    
    // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
    function showFilePreview(file) {
      const preview = document.getElementById('filePreview');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      const fileType = document.getElementById('fileType');
      
      fileName.textContent = file.name;
      fileSize.textContent = `å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
      fileType.textContent = `ç±»å‹: ${file.type || 'æœªçŸ¥'}`;
      
      preview.style.display = 'block';
    }
    
    // æ¸…é™¤é€‰ä¸­çš„æ–‡ä»¶
    function clearSelectedFile() {
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('uploadTitleInput').value = '';
      document.getElementById('filePreview').style.display = 'none';
    }
    
    // ä¸Šä¼ é€‰ä¸­çš„æ–‡ä»¶
    function uploadSelectedFile() {
      if (!selectedFile) {
        showToast('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶', 'error');
        return;
      }
      
      const title = document.getElementById('uploadTitleInput').value.trim() || 
                   selectedFile.name.replace(/\.[^/.]+$/, "");
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      document.getElementById('loadingSection').classList.add('show');
      
      // åˆ›å»ºFormData
      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('title', title);
      
      // ä¸Šä¼ å¹¶è½¬å½•
      fetch('/api/audio_transcription/upload', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${currentToken}`
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('loadingSection').classList.remove('show');
        
        if (data.success) {
          showToast('éŸ³é¢‘ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨è½¬å½•...', 'success');
          // æ·»åŠ åˆ°å¤„ç†ä¸­çš„è½¬å½•åˆ—è¡¨
          processingTranscriptions.add(data.transcription_id);
          clearSelectedFile();
          loadTranscriptions();
        } else {
          showToast(data.error || 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
      })
      .catch(error => {
        document.getElementById('loadingSection').classList.remove('show');
        console.error('Upload error:', error);
        showToast('ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
      });
    }
    
    // åŠ è½½è½¬å½•åˆ—è¡¨
    function loadTranscriptions() {
      if (!currentToken) {
        console.log('No valid token, skipping transcriptions load');
        renderTranscriptions([]);
        return;
      }
      
      fetch('/api/audio_transcription/list', {
        headers: {
          'Authorization': `Bearer ${currentToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // æ£€æŸ¥å¤„ç†ä¸­çš„è½¬å½•æ˜¯å¦å®Œæˆ
          checkProcessingStatus(data.transcriptions);
          renderTranscriptions(data.transcriptions);
        } else {
          console.error('Failed to load transcriptions:', data.error);
          if (data.error.includes('token') || data.error.includes('ç™»å½•')) {
            // Tokenæ— æ•ˆï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
            showToast('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
          } else {
            renderTranscriptions([]);
          }
        }
      })
      .catch(error => {
        console.error('Load transcriptions error:', error);
        renderTranscriptions([]);
      });
    }
    
    // æ£€æŸ¥å¤„ç†ä¸­çš„è½¬å½•çŠ¶æ€
    function checkProcessingStatus(transcriptions) {
      const completedIds = [];
      
      for (const transcription of transcriptions) {
        if (processingTranscriptions.has(transcription.id)) {
          if (transcription.status === 'completed') {
            completedIds.push(transcription.id);
            showToast(`"${transcription.title}" è½¬å½•å®Œæˆï¼`, 'success');
          } else if (transcription.status === 'error') {
            completedIds.push(transcription.id);
            showToast(`"${transcription.title}" è½¬å½•å¤±è´¥`, 'error');
          }
        }
      }
      
      // ä»å¤„ç†ä¸­åˆ—è¡¨ç§»é™¤å·²å®Œæˆçš„
      completedIds.forEach(id => processingTranscriptions.delete(id));
    }
    
    // å¼€å§‹è½®è¯¢
    function startPolling() {
      // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
      pollingInterval = setInterval(() => {
        // åªåœ¨é¡µé¢å¯è§ä¸”æœ‰å¤„ç†ä¸­çš„è½¬å½•æ—¶è½®è¯¢
        if (processingTranscriptions.size > 0 && !document.hidden) {
          loadTranscriptions();
        }
      }, 3000);
      
      // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶çš„å¤„ç†
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden && processingTranscriptions.size > 0) {
          // é¡µé¢å˜ä¸ºå¯è§æ—¶ç«‹å³æ£€æŸ¥ä¸€æ¬¡
          loadTranscriptions();
        }
      });
    }
    
    // åœæ­¢è½®è¯¢
    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }
    
    // æ¸²æŸ“è½¬å½•åˆ—è¡¨
    function renderTranscriptions(transcriptions) {
      const container = document.getElementById('transcriptionsList');
      
      if (transcriptions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸµ</div>
            <h3>è¿˜æ²¡æœ‰è½¬å½•è®°å½•</h3>
            <p>ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶å¼€å§‹ä½¿ç”¨å§ï¼</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = transcriptions.map(item => `
        <div class="transcription-item" data-id="${item.id}">
          <div class="transcription-header">
            <div class="transcription-title">${item.title}</div>
            <div class="transcription-date">${formatDate(item.created_at)}</div>
            <div class="transcription-status status-${item.status}">
              ${getStatusText(item.status)}
            </div>
          </div>
          
          ${item.text ? `
            <div class="transcription-text">${escapeHtml(item.text)}</div>
          ` : (item.status === 'processing' ? `
            <div class="transcription-text processing-status">
              <span class="status-icon">â³</span>
              æ­£åœ¨è½¬å½•ä¸­ï¼Œè¯·ç¨å€™...
            </div>
          ` : (item.status === 'error' ? `
            <div class="transcription-text error-status">
              <span class="status-icon">âŒ</span>
              <div class="error-content">
                <div class="error-title">è½¬å½•å¤±è´¥</div>
                <div class="error-detail">${formatErrorMessage(item.error || 'æœªçŸ¥é”™è¯¯')}</div>
                <div class="error-hint">ç‚¹å‡»"é‡æ–°è½¬å½•"æŒ‰é’®é‡è¯•</div>
              </div>
            </div>
          ` : ''))}
          
          <div class="transcription-actions">
            ${item.audio_url ? `
              <a href="${item.audio_url}" class="action-btn btn-secondary" download>
                <span>â¬‡ï¸</span> ä¸‹è½½éŸ³é¢‘
              </a>
            ` : ''}
            
            ${item.text ? `
              <button class="action-btn btn-primary" onclick="copyText('${item.id}')">
                <span>ğŸ“‹</span> å¤åˆ¶æ–‡æœ¬
              </button>
            ` : ''}
            
            <button class="action-btn btn-secondary" onclick="retranscribe('${item.id}')" 
                    ${item.status === 'processing' ? 'disabled' : ''}>
              <span>ğŸ”„</span> é‡æ–°è½¬å½•
            </button>
            
            <button class="action-btn btn-danger" onclick="deleteTranscription('${item.id}')">
              <span>ğŸ—‘ï¸</span> åˆ é™¤
            </button>
          </div>
        </div>
      `).join('');
    }
    
    // å¤åˆ¶æ–‡æœ¬
    function copyText(id) {
      const transcriptionItem = document.querySelector(`[data-id="${id}"] .transcription-text`);
      if (transcriptionItem) {
        navigator.clipboard.writeText(transcriptionItem.textContent).then(() => {
          showToast('æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(() => {
          // é™çº§æ–¹æ¡ˆï¼šåˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
          const textArea = document.createElement('textarea');
          textArea.value = transcriptionItem.textContent;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showToast('æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        });
      }
    }
    
    // é‡æ–°è½¬å½•
    function retranscribe(id) {
      // æ‰¾åˆ°å¯¹åº”çš„è½¬å½•è®°å½•ä»¥è·å–æ ‡é¢˜
      const transcriptionItem = document.querySelector(`[data-id="${id}"]`);
      const title = transcriptionItem ? transcriptionItem.querySelector('.transcription-title').textContent : 'è¯¥éŸ³é¢‘';
      
      if (!confirm(`ç¡®å®šè¦é‡æ–°è½¬å½•"${title}"å—ï¼Ÿ\n\nè¿™å°†ä½¿ç”¨åŸå§‹éŸ³é¢‘æ–‡ä»¶é‡æ–°è¿›è¡Œè½¬å½•ã€‚`)) return;
      
      // ç¦ç”¨é‡æ–°è½¬å½•æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      const retryBtn = transcriptionItem ? transcriptionItem.querySelector('button[onclick*="retranscribe"]') : null;
      if (retryBtn) {
        retryBtn.disabled = true;
        retryBtn.innerHTML = '<span>â³</span> è½¬å½•ä¸­...';
      }
      
      fetch(`/api/audio_transcription/retranscribe/${id}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${currentToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(`"${title}" é‡æ–°è½¬å½•å·²å¼€å§‹`, 'success');
          // æ·»åŠ åˆ°å¤„ç†ä¸­çš„è½¬å½•åˆ—è¡¨
          processingTranscriptions.add(id);
          loadTranscriptions();
        } else {
          showToast(data.error || 'é‡æ–°è½¬å½•å¤±è´¥', 'error');
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          if (retryBtn) {
            retryBtn.disabled = false;
            retryBtn.innerHTML = '<span>ğŸ”„</span> é‡æ–°è½¬å½•';
          }
        }
      })
      .catch(error => {
        console.error('Retranscribe error:', error);
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'error');
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        if (retryBtn) {
          retryBtn.disabled = false;
          retryBtn.innerHTML = '<span>ğŸ”„</span> é‡æ–°è½¬å½•';
        }
      });
    }
    
    // HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // æ ¼å¼åŒ–é”™è¯¯æ¶ˆæ¯
    function formatErrorMessage(error) {
      if (typeof error !== 'string') {
        return 'æœªçŸ¥é”™è¯¯';
      }
      
      // ç½‘ç»œè¿æ¥é”™è¯¯
      if (error.includes('Network is unreachable') || error.includes('Connection') || error.includes('HTTPSConnectionPool')) {
        return 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
      }
      
      // APIé”™è¯¯
      if (error.includes('API') || error.includes('api')) {
        return 'APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
      }
      
      // è¶…æ—¶é”™è¯¯
      if (error.includes('timeout') || error.includes('Timeout')) {
        return 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
      }
      
      // æ–‡ä»¶æ ¼å¼é”™è¯¯
      if (error.includes('format') || error.includes('æ ¼å¼')) {
        return 'éŸ³é¢‘æ ¼å¼ä¸æ”¯æŒï¼Œè¯·ä½¿ç”¨å…¶ä»–æ ¼å¼';
      }
      
      // å…¶ä»–é”™è¯¯ï¼Œæˆªå–å‰100ä¸ªå­—ç¬¦
      return error.length > 100 ? error.substring(0, 100) + '...' : error;
    }
    
    // åˆ é™¤è½¬å½•
    function deleteTranscription(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè½¬å½•è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
      
      fetch(`/api/audio_transcription/delete/${id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${currentToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('è½¬å½•è®°å½•å·²åˆ é™¤', 'success');
          loadTranscriptions();
        } else {
          showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
        }
      })
      .catch(error => {
        console.error('Delete error:', error);
        showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      });
    }
    
    // æ˜¾ç¤ºToasté€šçŸ¥
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      
      toastMessage.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
      const statusMap = {
        'processing': 'è½¬å½•ä¸­',
        'completed': 'å·²å®Œæˆ',
        'error': 'è½¬å½•å¤±è´¥'
      };
      return statusMap[status] || status;
    }
  </script>
</body>
</html>
