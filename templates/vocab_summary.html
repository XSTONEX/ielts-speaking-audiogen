<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è¯æ±‡æ±‡æ€»</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
  
  <link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'PT Serif', 'Crimson Text', ui-serif, 'Times New Roman', 'Georgia', serif; background: #f6f8fb; margin:0; line-height: 1.6; color: #1f2937; letter-spacing: -0.05px; text-rendering: optimizeLegibility; font-kerning: normal; }
    .container { max-width: 1600px; margin: 0 auto; background:#fff; min-height: 100vh; display: flex; flex-direction: column; }
    
    /* Header */
    .header { display:flex; justify-content:space-between; align-items:center; padding: 20px 32px; border-bottom:1px solid #f1f5f9; background: #fafbfc; }
    .header .title { font-weight:600; color:#111827; font-size: 24px; }
    .header .actions { display: flex; gap: 12px; align-items: center; }
    .btn { padding: 10px 20px; border:none; border-radius:12px; cursor:pointer; background:#f8fafc; color:#374151; font-weight:500; transition: all 0.2s; border: 1px solid #e2e8f0; font-size: 14px; }
    .btn:hover { background:#e2e8f0; transform: translateY(-1px); }
    .btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border: none; }
    .btn.primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25); }
    .btn.export { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color:#fff; border: none; }
    .btn.export:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.25); }
    .btn.challenge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color:#fff; border: none; }
    .btn.challenge:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(245, 158, 11, 0.25); }
    
    /* Main Layout */
    .main { flex: 1; display: flex; overflow: hidden; }
    .sidebar { width: 380px; border-right: 1px solid #e6ebf2; background: #fafbfc; display: flex; flex-direction: column; }
    .content { flex: 1; display: flex; flex-direction: column; background: #fff; }
    
    /* Category Tabs */
    .cat-tabs { display:flex; gap:4px; justify-content:center; margin: 20px 16px 16px; border-bottom: 1px solid #f1f5f9; padding-bottom: 16px; }
    .cat-tabs button { padding:10px 18px; border-radius:12px; border:none; background:#f8fafc; cursor:pointer; font-weight:500; color:#6b7280; transition: all 0.2s; font-size: 14px; }
    .cat-tabs button.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    .cat-tabs button:hover:not(.active) { background:#e2e8f0; }
    
    /* Article List */
    .article-list { flex: 1; overflow-y: auto; padding: 0 16px 16px; }
    .article-item { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: #fff; cursor: pointer; transition: all 0.2s; }
    .article-item:hover { border-color: #c7d2fe; background: #f5f7ff; transform: translateY(-1px); }
    .article-item.active { border-color: #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); }
    .article-title { font-weight: 600; color: #111827; font-size: 15px; margin-bottom: 6px; }
    .article-meta { color: #6b7280; font-size: 12px; display: flex; justify-content: space-between; }
    .article-stats { color: #10b981; font-weight: 500; }
    
    /* Vocabulary Content */
    .vocab-header { padding: 20px 24px; border-bottom: 1px solid #f1f5f9; background: #fafbfc; }
    .vocab-title { font-weight: 600; color: #111827; font-size: 18px; margin-bottom: 8px; }
    .vocab-subtitle { color: #6b7280; font-size: 14px; }
    .vocab-controls { display: flex; gap: 12px; margin-top: 16px; }
    .search-box { flex: 1; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 10px; background: #f8fafc; font-size: 14px; font-family: 'PT Serif', 'Crimson Text', ui-serif, 'Times New Roman', 'Georgia', serif; }
    .search-box:focus { outline: none; border-color: #667eea; background: #fff; }
    
    /* Vocabulary List */
    .vocab-list { flex: 1; overflow-y: auto; padding: 16px 24px; }
    .vocab-item { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; background: #fafbff; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .vocab-item:hover { border-color: #c7d2fe; background: #f5f7ff; }
    .vocab-content { flex: 1; min-width: 0; }
    .vocab-word { font-weight: 700; color: #111827; font-size: 15px; margin-bottom: 4px; word-break: break-word; }
    .vocab-meaning { color: #6b7280; font-size: 13px; line-height: 1.4; word-break: break-word; }
    .vocab-actions { flex-shrink: 0; display: flex; align-items: center; }
    .jump-btn { width: 32px; height: 32px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; color: #475569; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .jump-btn:hover { background: #eef2f7; border-color: #cbd5e1; transform: translateY(-1px); color: #667eea; }
    .jump-btn:active { transform: translateY(0); }
    
    /* Empty States */
    .empty { text-align: center; padding: 48px 24px; color: #9ca3af; }
    .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-text { font-size: 16px; margin-bottom: 8px; }
    .empty-hint { font-size: 14px; color: #d1d5db; }
    
    /* Export Dropdown */
    .export-dropdown { position: relative; display: inline-block; }
    .export-menu { position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); min-width: 200px; z-index: 1000; display: none; }
    .export-menu.active { display: block; }
    .export-item { padding: 12px 16px; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid #f1f5f9; }
    .export-item:last-child { border-bottom: none; }
    .export-item:hover { background: #f8fafc; }
    .export-item-title { font-weight: 500; color: #111827; font-size: 14px; }
    .export-item-desc { color: #6b7280; font-size: 12px; margin-top: 2px; }

    /* Modal Styles */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; }
    .modal-content { background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); max-width: 90vw; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #f1f5f9; background: #fafbfc; }
    .modal-header h3 { margin: 0; color: #111827; font-size: 18px; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 24px; color: #6b7280; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
    .modal-close:hover { background: #f3f4f6; color: #374151; }
    .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px; border-top: 1px solid #f1f5f9; background: #fafbfc; }

    /* Challenge Setup Modal */
    .challenge-setup { width: 700px; }
    .setup-section { margin-bottom: 24px; }
    .setup-section label { display: block; margin-bottom: 8px; font-weight: 500; color: #374151; }
    .category-filter-buttons { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .category-filter-btn { padding: 8px 16px; border: 2px solid #e5e7eb; border-radius: 20px; background: #fff; color: #6b7280; cursor: pointer; transition: all 0.2s; font-size: 14px; font-weight: 500; }
    .category-filter-btn:hover { border-color: #d1d5db; background: #f9fafb; }
    .category-filter-btn.active { border-color: #667eea; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
    .article-selection { border: 1px solid #e5e7eb; border-radius: 12px; max-height: 300px; overflow-y: auto; }
    .article-category { margin-bottom: 16px; }
    .article-category:last-child { margin-bottom: 0; }
    .category-header { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #f8fafc; border-bottom: 1px solid #e5e7eb; font-weight: 500; color: #374151; }
    .category-header input[type="checkbox"] { margin: 0; }
    .article-category .article-list { padding: 0; }
    .article-category .article-item { margin: 0; border: none; border-bottom: 1px solid #f1f5f9; border-radius: 0; display: flex; align-items: center; gap: 12px; }
    .article-category .article-item:last-child { border-bottom: none; }
    .article-category .article-item input[type="checkbox"] { margin: 0; flex-shrink: 0; }
    .article-category .article-item .article-info { flex: 1; min-width: 0; }
    .article-category-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; background: #f3f4f6; color: #6b7280; }
    .article-category-badge[data-category="Reading"] { background: #dbeafe; color: #1e40af; }
    .article-category-badge[data-category="Listening"] { background: #d1fae5; color: #065f46; }
    .article-category-badge[data-category="Writing"] { background: #fef3c7; color: #92400e; }
    .word-count-input { width: 80px; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
    .word-count-slider { margin-top: 12px; }
    .word-count-slider input[type="range"] { width: 100%; }
    .slider-labels { display: flex; justify-content: space-between; margin-top: 4px; font-size: 12px; color: #6b7280; }
    .challenge-stats { display: flex; gap: 24px; padding: 16px; background: #f8fafc; border-radius: 12px; }
    .stat-item { text-align: center; }
    .stat-label { display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px; }
    .stat-value { display: block; font-size: 24px; font-weight: 600; color: #111827; }

    /* Challenge Game Modal */
    .challenge-game { width: 600px; }
    .challenge-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #f1f5f9; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
    .challenge-info h3 { margin: 0; font-size: 18px; }
    .challenge-progress { font-size: 14px; opacity: 0.9; margin-top: 4px; }
    .challenge-timer { font-size: 20px; font-weight: 600; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; }
    .challenge-question-container { padding: 40px 24px; text-align: center; background: #fafbfc; }
    .challenge-question { font-size: 24px; font-weight: 600; color: #111827; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 12px; }
    .challenge-word { color: #667eea; }
    .challenge-audio-btn { background: #667eea; color: #fff; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
    .challenge-audio-btn:hover { background: #5a67d8; transform: scale(1.1); }
    .challenge-options { padding: 0 24px 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .challenge-option { padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; background: #fff; cursor: pointer; transition: all 0.2s; text-align: center; font-weight: 500; }
    .challenge-option:hover { border-color: #667eea; background: #f5f7ff; }
    .challenge-option.correct { border-color: #10b981; background: #ecfdf5; color: #065f46; }
    .challenge-option.incorrect { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
    .challenge-controls { display: flex; gap: 12px; justify-content: center; padding: 16px 24px; border-top: 1px solid #f1f5f9; }

    /* Challenge Result Modal */
    .challenge-result { width: 600px; }
    .result-summary { text-align: center; margin-bottom: 24px; }
    .result-score { font-size: 48px; font-weight: 600; color: #667eea; margin-bottom: 8px; }
    .result-accuracy { font-size: 18px; color: #6b7280; margin-bottom: 16px; }
    .result-details { display: flex; justify-content: space-around; padding: 16px; background: #f8fafc; border-radius: 12px; }
    .result-detail { text-align: center; }
    .result-detail-value { font-size: 20px; font-weight: 600; color: #111827; }
    .result-detail-label { font-size: 12px; color: #6b7280; margin-top: 4px; }
    .wrong-words-section { margin-top: 24px; }
    .wrong-words-section h4 { margin-bottom: 16px; color: #111827; }
    .wrong-word-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; background: #fef2f2; }
    .wrong-word-text { font-weight: 600; color: #991b1b; }
    .wrong-word-meaning { color: #6b7280; }

    /* Challenge History Modal */
    .challenge-history { width: 800px; }
    .history-tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 24px; }
    .tab-btn { padding: 12px 24px; border: none; background: none; cursor: pointer; color: #6b7280; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-btn:hover:not(.active) { color: #374151; }
    .history-content { min-height: 300px; }
    .history-item { padding: 16px; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 12px; }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .history-title { font-weight: 600; color: #111827; }
    .history-date { font-size: 12px; color: #6b7280; }
    .history-stats { display: flex; gap: 16px; font-size: 14px; color: #6b7280; }
    
    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .main { flex-direction: column; }
      .sidebar { width: 100%; max-height: 40vh; }
      .content { flex: 1; }
      .header { padding: 16px 20px; flex-direction: column; gap: 12px; }
      .header .actions { width: 100%; justify-content: center; }
    }
    
    @media (max-width: 768px) {
      .container { margin: 0; }
      .header { padding: 12px 16px; }
      .header .title { font-size: 20px; }
      .cat-tabs { margin: 16px 12px 12px; flex-wrap: wrap; }
      .cat-tabs button { padding: 8px 14px; font-size: 13px; }
      .article-list { padding: 0 12px 12px; }
      .vocab-header { padding: 16px 16px; }
      .vocab-list { padding: 12px 16px; }
      .vocab-item { padding: 10px 12px; align-items: flex-start; gap: 8px; }
      .vocab-content { flex: 1; }
      .vocab-actions { margin-top: 2px; }
      .btn { padding: 8px 16px; font-size: 13px; }
    }
  </style>
  <!-- è¯æ±‡å‘éŸ³ç®¡ç†å™¨ -->
  <script src="/static/word-pronunciation.js"></script>
</head>
<body>
  <div id="authOverlay" style="position:fixed;z-index:10000;left:0;top:0;width:100vw;height:100vh;background:rgba(240,245,255,0.98);display:flex;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:14px;box-shadow:0 8px 32px 0 rgba(31,38,135,0.15);padding:38px 32px 32px 32px;max-width:90vw;min-width:320px;text-align:center;">
        <h2 style="color:#3b4a6b;margin-bottom:18px;">è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
        <input id="authPassword" type="password" placeholder="Password" style="padding:12px 16px;font-size:17px;border-radius:8px;border:1.5px solid #d1d5db;width:80%;max-width:260px;outline:none;" autofocus onkeydown="if(event.key==='Enter'){checkPassword();}">
        <div id="authError" style="color:#e94e77;margin-top:14px;display:none;font-size:15px;">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚</div>
        <button onclick="checkPassword()" style="margin-top:22px;width:60%;max-width:180px;">è¿›å…¥</button>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="title">ğŸ“š è¯æ±‡æ±‡æ€»</div>
      <div class="actions">
        <button class="btn challenge" onclick="openChallengeSetup()">ğŸ† è¯æ±‡æŒ‘æˆ˜</button>
        <button class="btn" onclick="openChallengeHistory()">ğŸ“Š æŒ‘æˆ˜è®°å½•</button>
        <button class="btn" onclick="location.href='/intensive'">è¿”å›ç²¾è¯»</button>
        <div class="export-dropdown">
          <button class="btn export" onclick="toggleExportMenu()">å¯¼å‡ºè¯æ±‡ â–¼</button>
          <div class="export-menu" id="exportMenu">
            <div class="export-item" onclick="exportVocab('current')">
              <div class="export-item-title">å¯¼å‡ºå½“å‰æ–‡ç« </div>
              <div class="export-item-desc">å¯¼å‡ºæ‰€é€‰æ–‡ç« çš„è¯æ±‡</div>
            </div>
            <div class="export-item" onclick="exportVocab('category')">
              <div class="export-item-title">å¯¼å‡ºå½“å‰åˆ†ç±»</div>
              <div class="export-item-desc">å¯¼å‡ºæ‰€é€‰åˆ†ç±»çš„æ‰€æœ‰è¯æ±‡</div>
            </div>
            <div class="export-item" onclick="exportVocab('all')">
              <div class="export-item-title">å¯¼å‡ºå…¨éƒ¨è¯æ±‡</div>
              <div class="export-item-desc">å¯¼å‡ºæ‰€æœ‰åˆ†ç±»çš„è¯æ±‡</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="sidebar">
        <div class="cat-tabs">
          <button id="tab-Reading" class="active" onclick="setActiveCat('Reading')">Reading</button>
          <button id="tab-Listening" onclick="setActiveCat('Listening')">Listening</button>
          <button id="tab-Writing" onclick="setActiveCat('Writing')">Writing</button>
        </div>
        <div class="article-list" id="articleList">
          <div class="empty">
            <div class="empty-icon">ğŸ“„</div>
            <div class="empty-text">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="vocab-header">
          <div class="vocab-title" id="vocabTitle">é€‰æ‹©æ–‡ç« æŸ¥çœ‹è¯æ±‡</div>
          <div class="vocab-subtitle" id="vocabSubtitle">ä»å·¦ä¾§é€‰æ‹©ä¸€ç¯‡æ–‡ç« å¼€å§‹æµè§ˆè¯æ±‡</div>
          <div class="vocab-controls">
            <input type="text" class="search-box" id="vocabSearch" placeholder="æœç´¢å•è¯æˆ–é‡Šä¹‰..." oninput="filterVocab()">
            <button class="btn" onclick="refreshVocab()">åˆ·æ–°</button>
          </div>
        </div>
        <div class="vocab-list" id="vocabList">
          <div class="empty">
            <div class="empty-icon">ğŸ”¤</div>
            <div class="empty-text">æš‚æ— è¯æ±‡æ˜¾ç¤º</div>
            <div class="empty-hint">é€‰æ‹©å·¦ä¾§æ–‡ç« æŸ¥çœ‹å…¶è¯æ±‡å†…å®¹</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æŒ‘æˆ˜è®¾ç½®æ¨¡æ€æ¡† -->
  <div id="challengeSetupModal" class="modal" style="display: none;">
    <div class="modal-content challenge-setup">
      <div class="modal-header">
        <h3>ğŸ† å¼€å§‹è¯æ±‡æŒ‘æˆ˜</h3>
        <button class="modal-close" onclick="closeChallengeSetup()">&times;</button>
      </div>
      <div class="modal-body">
                <div class="setup-section">
          <label>é€‰æ‹©æŒ‘æˆ˜æ–‡ç« </label>
          
          <!-- åˆ†ç±»ç­›é€‰æŒ‰é’® -->
          <div class="category-filter-buttons">
            <button class="category-filter-btn active" onclick="switchCategoryFilter('all')" id="filterAll">
              ğŸ“š å…¨éƒ¨æ–‡ç« 
            </button>
            <button class="category-filter-btn" onclick="switchCategoryFilter('Reading')" id="filterReading">
              ğŸ“– Reading
            </button>
            <button class="category-filter-btn" onclick="switchCategoryFilter('Listening')" id="filterListening">
              ğŸ§ Listening  
            </button>
            <button class="category-filter-btn" onclick="switchCategoryFilter('Writing')" id="filterWriting">
              âœï¸ Writing
            </button>
      </div>
          
          <div class="article-selection" id="challengeArticleSelection">
            <div class="article-category" id="allArticlesCategory">
              <div class="category-header">
                <input type="checkbox" id="selectAllArticles" onchange="toggleAllArticlesSelection(this.checked)">
                <label for="selectAllArticles">å…¨é€‰å½“å‰æ˜¾ç¤ºçš„æ–‡ç« </label>
    </div>
              <div class="article-list" id="filteredArticles"></div>
            </div>
          </div>
        </div>
        
        <div class="setup-section">
          <label for="challengeWordCount">è¯æ±‡æ•°é‡</label>
          <input type="number" id="challengeWordCount" min="5" max="50" value="20" class="word-count-input">
          <div class="word-count-slider">
            <input type="range" min="5" max="50" value="20" id="wordCountSlider" oninput="updateWordCount(this.value)">
            <div class="slider-labels">
              <span>5</span>
              <span>50</span>
            </div>
          </div>
        </div>

        <div class="setup-section">
          <div class="challenge-stats" id="challengeStats">
            <div class="stat-item">
              <span class="stat-label">å·²é€‰æ–‡ç« </span>
              <span class="stat-value" id="selectedArticlesCount">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">å¯ç”¨è¯æ±‡</span>
              <span class="stat-value" id="availableVocabCount">0</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn" onclick="closeChallengeSetup()">å–æ¶ˆ</button>
        <button class="btn primary" onclick="startVocabChallenge()" id="startChallengeBtn" disabled>å¼€å§‹æŒ‘æˆ˜</button>
      </div>
    </div>
  </div>

  <!-- æŒ‘æˆ˜æ¸¸æˆæ¨¡æ€æ¡† -->
  <div id="challengeGameModal" class="modal" style="display: none;">
    <div class="modal-content challenge-game">
      <div class="challenge-header">
        <div class="challenge-info">
          <h3 id="challengeGameTitle">è¯æ±‡æŒ‘æˆ˜</h3>
          <div class="challenge-progress" id="challengeProgress">ç¬¬ 1 é¢˜ / å…± 20 é¢˜</div>
        </div>
        <div class="challenge-timer" id="challengeTimer">10s</div>
      </div>
      
      <div class="challenge-question-container">
        <div class="challenge-question" id="challengeQuestion">
          Loading...
        </div>
      </div>
      
      <div class="challenge-options" id="challengeOptions">
        <!-- é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
      
      <div class="challenge-controls">
        <button class="btn" onclick="skipQuestion()">è·³è¿‡</button>
        <button class="btn" onclick="quitChallenge()">é€€å‡ºæŒ‘æˆ˜</button>
      </div>
    </div>
  </div>

  <!-- æŒ‘æˆ˜ç»“æœæ¨¡æ€æ¡† -->
  <div id="challengeResultModal" class="modal" style="display: none;">
    <div class="modal-content challenge-result">
      <div class="modal-header">
        <h3>ğŸ‰ æŒ‘æˆ˜å®Œæˆ</h3>
        <button class="modal-close" onclick="closeChallengeResult()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="result-summary" id="resultSummary">
          <!-- ç»“æœå°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="wrong-words-section" id="wrongWordsSection">
          <!-- é”™è¯å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeChallengeResult()">å…³é—­</button>
        <button class="btn primary" onclick="reviewWrongWords()">å¤ä¹ é”™è¯</button>
        <button class="btn challenge" onclick="restartChallenge()">å†æ¥ä¸€æ¬¡</button>
      </div>
    </div>
  </div>

  <!-- æŒ‘æˆ˜è®°å½•æ¨¡æ€æ¡† -->
  <div id="challengeHistoryModal" class="modal" style="display: none;">
    <div class="modal-content challenge-history">
      <div class="modal-header">
        <h3>ğŸ“Š æŒ‘æˆ˜è®°å½•</h3>
        <button class="modal-close" onclick="closeChallengeHistory()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="history-tabs">
          <button class="tab-btn active" onclick="switchHistoryTab('recent')" id="recentTab">æœ€è¿‘æŒ‘æˆ˜</button>
          <button class="tab-btn" onclick="switchHistoryTab('wrong')" id="wrongTab">é”™è¯æ±‡æ€»</button>
          <button class="tab-btn" onclick="switchHistoryTab('stats')" id="statsTab">ç»Ÿè®¡æ•°æ®</button>
        </div>
        <div class="history-content" id="historyContent">
          <!-- å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeChallengeHistory()">å…³é—­</button>
        <button class="btn primary" onclick="exportChallengeHistory()">å¯¼å‡ºè®°å½•</button>
      </div>
    </div>
  </div>
  
  <script>
    let currentToken = null;
    let allArticles = [];
    let currentArticle = null;
    let currentVocab = [];
    let activeCat = 'Reading';

    // Authentication
    function fetchServerPassword(){ return fetch('/get_password').then(r=>r.json()); }
    function checkStoredToken(){ const tk=localStorage.getItem('authToken'); if(!tk) return Promise.resolve(false); return fetch('/verify_token',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({token:tk})}).then(r=>r.json()).then(d=>{ if(d.valid){ currentToken=tk; return true;} localStorage.removeItem('authToken'); return false; }).catch(()=>{ localStorage.removeItem('authToken'); return false; }); }
    function checkPassword(){ const val=document.getElementById('authPassword').value; fetch('/verify_password',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({password:val})}).then(r=>r.json()).then(d=>{ if(d.success){ currentToken=d.token; localStorage.setItem('authToken', d.token); document.getElementById('authOverlay').style.display='none'; document.body.style.overflow=''; loadData(); } else { document.getElementById('authError').style.display=''; document.getElementById('authPassword').value=''; document.getElementById('authPassword').focus(); } }).catch(()=>{ document.getElementById('authError').style.display=''; }); }
    
    window.onload = function(){
      checkStoredToken().then(valid=>{
        if(valid){
          if(document.getElementById('authOverlay')){
            document.getElementById('authOverlay').style.display='none';
            document.body.style.overflow='';
          }
          loadData();
        } else {
          window.location.href='/login';
        }
      });
    }

    // Category management
    function setActiveCat(cat) {
      activeCat = cat;
      ['Reading','Listening','Writing'].forEach(c=>{
        const el = document.getElementById('tab-'+c);
        if(el) el.className = (c===activeCat ? 'active' : '');
      });
      renderArticleList();
      clearVocabDisplay();
    }

    // Data loading
    function loadData() {
      fetch('/intensive_list')
        .then(r => r.json())
        .then(d => {
          allArticles = d.items || [];
          renderArticleList();
          // åŠ è½½å®Œæ–‡ç« ååˆå§‹åŒ–æŒ‘æˆ˜æ•°æ®
          initializeChallengeData();
        })
        .catch(e => {
          console.error('Failed to load articles:', e);
          document.getElementById('articleList').innerHTML = '<div class="empty"><div class="empty-icon">âŒ</div><div class="empty-text">åŠ è½½å¤±è´¥</div></div>';
        });
    }

    // Article list rendering
    function renderArticleList() {
      const container = document.getElementById('articleList');
      const filtered = allArticles.filter(item => (item.category || 'Reading') === activeCat);
      
      if (!filtered.length) {
        container.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“„</div><div class="empty-text">è¯¥åˆ†ç±»æš‚æ— æ–‡ç« </div></div>';
        return;
      }

      container.innerHTML = '';
      filtered.forEach(article => {
        const div = document.createElement('div');
        div.className = 'article-item';
        div.onclick = () => selectArticle(article);
        
        div.innerHTML = `
          <div class="article-title">${escapeHtml(article.title || 'æœªå‘½å')}</div>
          <div class="article-meta">
            <span>${(article.created_at || '').slice(0,19).replace('T',' ')}</span>
            <span class="article-stats">${article.highlight_count || 0} è¯æ±‡</span>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Article selection
    function selectArticle(article) {
      // Update active state
      document.querySelectorAll('.article-item').forEach(item => item.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      currentArticle = article;
      loadArticleVocab(article.id);
    }

    // Load vocabulary for selected article
    function loadArticleVocab(articleId) {
      fetch(`/intensive_article/${articleId}`)
        .then(r => r.json())
        .then(d => {
          if (d.success) {
            const article = d.article;
            currentVocab = article.highlights || [];
            renderVocabDisplay();
          } else {
            showVocabError('åŠ è½½è¯æ±‡å¤±è´¥');
          }
        })
        .catch(e => {
          console.error('Failed to load vocabulary:', e);
          showVocabError('åŠ è½½è¯æ±‡å¤±è´¥');
        });
    }

    // Vocabulary display
    function renderVocabDisplay() {
      const titleEl = document.getElementById('vocabTitle');
      const subtitleEl = document.getElementById('vocabSubtitle');
      const listEl = document.getElementById('vocabList');
      
      titleEl.textContent = currentArticle.title || 'æœªå‘½å';
      subtitleEl.textContent = `å…± ${currentVocab.length} ä¸ªè¯æ±‡`;
      
      if (!currentVocab.length) {
        listEl.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ”¤</div><div class="empty-text">è¯¥æ–‡ç« æš‚æ— è¯æ±‡</div></div>';
        return;
      }

      filterVocab();
    }

    function filterVocab() {
      const searchVal = (document.getElementById('vocabSearch').value || '').toLowerCase();
      const listEl = document.getElementById('vocabList');
      
      let filteredVocab = currentVocab.slice().sort((a,b) => a.start - b.start);
      
      if (searchVal) {
        filteredVocab = filteredVocab.filter(item => {
          const word = (item.text || '').toLowerCase();
          const meaning = (item.meaning || '').toLowerCase();
          return word.includes(searchVal) || meaning.includes(searchVal);
        });
      }

      if (!filteredVocab.length) {
        listEl.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-text">${searchVal ? 'æœªæ‰¾åˆ°åŒ¹é…è¯æ±‡' : 'æš‚æ— è¯æ±‡'}</div></div>`;
        return;
      }

      listEl.innerHTML = '';
      filteredVocab.forEach(vocab => {
        const div = document.createElement('div');
        div.className = 'vocab-item';
        div.style.cursor = 'pointer';
        
        div.innerHTML = `
          <div class="vocab-content">
            <div class="vocab-word">${escapeHtml(vocab.text || '')}</div>
            <div class="vocab-meaning">${escapeHtml(vocab.meaning || '')}</div>
          </div>
          <div class="vocab-actions">
            <button class="play-btn" style="padding:6px 8px;margin-right:6px;border:none;background:#f3f4f6;color:#6b7280;border-radius:4px;cursor:pointer;font-size:12px;" onclick="event.stopPropagation(); playWordPronunciation('${(vocab.text || '').replace(/'/g, "\\'")}', '${currentArticle.id}')" title="æ’­æ”¾å‘éŸ³">ğŸ”Š</button>
            <button class="jump-btn" onclick="jumpToArticle('${currentArticle.id}', '${vocab.id}')" title="è·³è½¬åˆ°åŸæ–‡">â†—</button>
          </div>
        `;
        
        // æ·»åŠ æ•´ä½“ç‚¹å‡»äº‹ä»¶æ’­æ”¾å‘éŸ³
        div.onclick = function(e) {
          if (e.target.closest('.vocab-actions')) return; // å¦‚æœç‚¹å‡»çš„æ˜¯åŠ¨ä½œæŒ‰é’®åŒºåŸŸï¼Œä¸è§¦å‘
          const word = vocab.text || '';
          if (word && window.playWordPronunciation) {
            window.playWordPronunciation(word, currentArticle.id);
          }
        };
        
        listEl.appendChild(div);
      });
    }

    function clearVocabDisplay() {
      document.getElementById('vocabTitle').textContent = 'é€‰æ‹©æ–‡ç« æŸ¥çœ‹è¯æ±‡';
      document.getElementById('vocabSubtitle').textContent = 'ä»å·¦ä¾§é€‰æ‹©ä¸€ç¯‡æ–‡ç« å¼€å§‹æµè§ˆè¯æ±‡';
      document.getElementById('vocabList').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ”¤</div><div class="empty-text">æš‚æ— è¯æ±‡æ˜¾ç¤º</div><div class="empty-hint">é€‰æ‹©å·¦ä¾§æ–‡ç« æŸ¥çœ‹å…¶è¯æ±‡å†…å®¹</div></div>';
      document.getElementById('vocabSearch').value = '';
      currentArticle = null;
      currentVocab = [];
      document.querySelectorAll('.article-item').forEach(item => item.classList.remove('active'));
    }

    function showVocabError(message) {
      document.getElementById('vocabList').innerHTML = `<div class="empty"><div class="empty-icon">âŒ</div><div class="empty-text">${message}</div></div>`;
    }

    function refreshVocab() {
      if (currentArticle) {
        loadArticleVocab(currentArticle.id);
      }
    }

    // Jump to article
    function jumpToArticle(articleId, vocabId) {
      // Store the target highlight in sessionStorage and navigate to intensive page
      sessionStorage.setItem('jumpToHighlight', vocabId);
      window.open(`/intensive#article-${articleId}`, '_blank');
    }

    // Export functionality
    function toggleExportMenu() {
      const menu = document.getElementById('exportMenu');
      menu.classList.toggle('active');
    }

    // Close export menu when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.querySelector('.export-dropdown');
      if (dropdown && !dropdown.contains(e.target)) {
        document.getElementById('exportMenu').classList.remove('active');
      }
    });

    function exportVocab(type) {
      document.getElementById('exportMenu').classList.remove('active');
      
      let vocabData = [];
      let filename = '';

      switch(type) {
        case 'current':
          if (!currentArticle || !currentVocab.length) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ç¯‡åŒ…å«è¯æ±‡çš„æ–‡ç« ');
            return;
          }
          vocabData = currentVocab;
          filename = `${currentArticle.title || 'æ–‡ç« '}_è¯æ±‡.csv`;
          break;
        case 'category':
          const categoryArticles = allArticles.filter(item => (item.category || 'Reading') === activeCat);
          if (!categoryArticles.length) {
            alert('å½“å‰åˆ†ç±»æš‚æ— æ–‡ç« ');
            return;
          }
          // We'll need to fetch all articles in this category
          exportCategoryVocab(categoryArticles);
          return;
        case 'all':
          if (!allArticles.length) {
            alert('æš‚æ— æ–‡ç« æ•°æ®');
            return;
          }
          exportAllVocab();
          return;
      }

      downloadCSV(vocabData, filename);
    }

    function exportCategoryVocab(articles) {
      const filename = `${activeCat}_åˆ†ç±»è¯æ±‡.csv`;
      const promises = articles.map(article => 
        fetch(`/intensive_article/${article.id}`)
          .then(r => r.json())
          .then(d => d.success ? d.article.highlights || [] : [])
          .catch(() => [])
      );

      Promise.all(promises).then(results => {
        const allVocab = results.flat();
        downloadCSV(allVocab, filename);
      });
    }

    function exportAllVocab() {
      const filename = 'å…¨éƒ¨è¯æ±‡.csv';
      const promises = allArticles.map(article => 
        fetch(`/intensive_article/${article.id}`)
          .then(r => r.json())
          .then(d => d.success ? d.article.highlights || [] : [])
          .catch(() => [])
      );

      Promise.all(promises).then(results => {
        const allVocab = results.flat();
        downloadCSV(allVocab, filename);
      });
    }

    function downloadCSV(vocabData, filename) {
      if (!vocabData.length) {
        alert('æ²¡æœ‰è¯æ±‡æ•°æ®å¯å¯¼å‡º');
        return;
      }

      // Remove duplicates based on text and meaning
      const uniqueVocab = [];
      const seen = new Set();
      
      vocabData.forEach(item => {
        const key = `${item.text}|${item.meaning}`;
        if (!seen.has(key)) {
          seen.add(key);
          uniqueVocab.push(item);
        }
      });

      // Create CSV content
      let csvContent = '\uFEFF'; // BOM for proper UTF-8 encoding
      csvContent += 'è¯æ±‡,é‡Šä¹‰\n';
      
      uniqueVocab.forEach(item => {
        const word = (item.text || '').replace(/"/g, '""');
        const meaning = (item.meaning || '').replace(/"/g, '""');
        csvContent += `"${word}","${meaning}"\n`;
      });

      // Download file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert(`å·²å¯¼å‡º ${uniqueVocab.length} ä¸ªè¯æ±‡åˆ° ${filename}`);
    }

    // Utility functions
    function escapeHtml(text) {
      return (text || '').replace(/[&<>"']/g, function(match) {
        const escape = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return escape[match];
      });
    }

    // ==================== æŒ‘æˆ˜åŠŸèƒ½ ====================
    
    let challengeSelectedArticles = [];
    let currentChallenge = null;
    let currentChallengeAnswers = [];
    let currentQuestionIndex = 0;
    let currentQuestionType = '';
    let challengeTimer = null;
    let questionStartTime = 0;
    let challengeHistory = [];
    let wrongWordsRecord = {};

    // åˆå§‹åŒ–æ—¶åŠ è½½åç«¯æ•°æ®
    async function initializeChallengeData() {
      try {
        // åŠ è½½æŒ‘æˆ˜è®°å½•
        const recordsResponse = await fetch('/api/vocab_challenge_records', {
          headers: {
            'Authorization': `Bearer ${currentToken}`
          }
        });
        
        if (recordsResponse.ok) {
          const recordsData = await recordsResponse.json();
          if (recordsData.success) {
            challengeHistory = recordsData.records || [];
          }
        }
        
        // åŠ è½½é”™è¯è®°å½•
        const wrongWordsResponse = await fetch('/api/vocab_wrong_words', {
          headers: {
            'Authorization': `Bearer ${currentToken}`
          }
        });
        
        if (wrongWordsResponse.ok) {
          const wrongWordsData = await wrongWordsResponse.json();
          if (wrongWordsData.success) {
            wrongWordsRecord = wrongWordsData.wrong_words || {};
          }
        }
      } catch (error) {
        console.warn('åŠ è½½æŒ‘æˆ˜æ•°æ®å¤±è´¥:', error);
        // å¦‚æœåç«¯åŠ è½½å¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½ä½œä¸ºå¤‡ä»½
        challengeHistory = JSON.parse(localStorage.getItem('vocabChallengeHistory') || '[]');
        wrongWordsRecord = JSON.parse(localStorage.getItem('vocabWrongWords') || '{}');
      }
    }

    // æ‰“å¼€æŒ‘æˆ˜è®¾ç½®
    function openChallengeSetup() {
      document.getElementById('challengeSetupModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
      loadArticlesForChallenge();
      updateChallengeStats();
    }

    // å…³é—­æŒ‘æˆ˜è®¾ç½®
    function closeChallengeSetup() {
      document.getElementById('challengeSetupModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      challengeSelectedArticles = [];
    }

    let currentCategoryFilter = 'all';
    let allChallengeArticles = []; // å­˜å‚¨æ‰€æœ‰æ–‡ç« æ•°æ®

    // åŠ è½½æ–‡ç« åˆ—è¡¨ç”¨äºæŒ‘æˆ˜
    function loadArticlesForChallenge() {
      // å­˜å‚¨æ‰€æœ‰æ–‡ç« 
      allChallengeArticles = [...allArticles];
      
      // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰æ–‡ç« 
      switchCategoryFilter('all');
    }

    // åˆ‡æ¢åˆ†ç±»ç­›é€‰
    function switchCategoryFilter(category) {
      currentCategoryFilter = category;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`filter${category.charAt(0).toUpperCase() + category.slice(1)}`).classList.add('active');
      
      // ç­›é€‰æ–‡ç« 
      let filteredArticles;
      if (category === 'all') {
        filteredArticles = allChallengeArticles;
      } else {
        filteredArticles = allChallengeArticles.filter(article => 
          (article.category || 'Reading') === category
        );
      }
      
      // æ˜¾ç¤ºç­›é€‰åçš„æ–‡ç« 
      displayFilteredArticles(filteredArticles);
      
      // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
      updateSelectAllButtonState();
    }

    // æ˜¾ç¤ºç­›é€‰åçš„æ–‡ç« 
    function displayFilteredArticles(articles) {
      const container = document.getElementById('filteredArticles');
      
      if (articles.length === 0) {
        container.innerHTML = '<div style="padding: 16px; color: #6b7280; text-align: center;">è¯¥åˆ†ç±»æš‚æ— æ–‡ç« </div>';
        return;
      }

      container.innerHTML = articles.map(article => `
        <div class="article-item">
          <input type="checkbox" id="article_${article.id}" value="${article.id}" 
                 ${challengeSelectedArticles.includes(article.id) ? 'checked' : ''}
                 onchange="toggleArticleSelection('${article.id}', this.checked)">
          <div class="article-info">
            <div class="article-title">${escapeHtml(article.title || 'æœªå‘½åæ–‡ç« ')}</div>
            <div class="article-meta">
              <span id="vocab_count_${article.id}">è®¡ç®—ä¸­...</span>
              <span>${new Date(article.updated_at || article.created_at).toLocaleDateString()}</span>
              <span class="article-category-badge" data-category="${article.category || 'Reading'}">${article.category || 'Reading'}</span>
            </div>
          </div>
        </div>
      `).join('');
      
      // å¼‚æ­¥è·å–æ¯ç¯‡æ–‡ç« çš„è¯æ±‡æ•°é‡
      articles.forEach(async (article) => {
        try {
          const response = await fetch(`/intensive_article/${article.id}`);
          const data = await response.json();
          const vocabCount = data.success ? (data.article.highlights || []).length : 0;
          const countElement = document.getElementById(`vocab_count_${article.id}`);
          if (countElement) {
            countElement.textContent = `${vocabCount} è¯æ±‡`;
          }
        } catch (error) {
          const countElement = document.getElementById(`vocab_count_${article.id}`);
          if (countElement) {
            countElement.textContent = '0 è¯æ±‡';
          }
        }
      });
    }

    // åˆ‡æ¢å…¨é€‰
    function toggleAllArticlesSelection(selected) {
      // è·å–å½“å‰æ˜¾ç¤ºçš„æ–‡ç« 
      let currentArticles;
      if (currentCategoryFilter === 'all') {
        currentArticles = allChallengeArticles;
      } else {
        currentArticles = allChallengeArticles.filter(article => 
          (article.category || 'Reading') === currentCategoryFilter
        );
      }
      
      currentArticles.forEach(article => {
        const checkbox = document.getElementById(`article_${article.id}`);
        if (checkbox) {
          checkbox.checked = selected;
          toggleArticleSelection(article.id, selected);
        }
      });
    }

    // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
    function updateSelectAllButtonState() {
      // è·å–å½“å‰æ˜¾ç¤ºçš„æ–‡ç« 
      let currentArticles;
      if (currentCategoryFilter === 'all') {
        currentArticles = allChallengeArticles;
      } else {
        currentArticles = allChallengeArticles.filter(article => 
          (article.category || 'Reading') === currentCategoryFilter
        );
      }
      
      const selectAllCheckbox = document.getElementById('selectAllArticles');
      if (selectAllCheckbox && currentArticles.length > 0) {
        const selectedCount = currentArticles.filter(article => 
          challengeSelectedArticles.includes(article.id)
        ).length;
        
        selectAllCheckbox.checked = selectedCount === currentArticles.length;
        selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < currentArticles.length;
      }
    }

    // åˆ‡æ¢æ–‡ç« é€‰æ‹©
    function toggleArticleSelection(articleId, selected) {
      if (selected) {
        if (!challengeSelectedArticles.includes(articleId)) {
          challengeSelectedArticles.push(articleId);
        }
      } else {
        challengeSelectedArticles = challengeSelectedArticles.filter(id => id !== articleId);
      }
      
      updateChallengeStats();
      updateStartButtonState();
      updateSelectAllButtonState();
    }

    // æ›´æ–°è¯æ±‡æ•°é‡
    function updateWordCount(value) {
      document.getElementById('challengeWordCount').value = value;
      updateChallengeStats();
    }

    // æ›´æ–°æŒ‘æˆ˜ç»Ÿè®¡
    async function updateChallengeStats() {
      const selectedCount = challengeSelectedArticles.length;
      document.getElementById('selectedArticlesCount').textContent = selectedCount;
      
      if (selectedCount === 0) {
        document.getElementById('availableVocabCount').textContent = '0';
        return;
      }

      // è®¡ç®—å¯ç”¨è¯æ±‡æ•°é‡
      try {
        const vocabCounts = await Promise.all(
          challengeSelectedArticles.map(async articleId => {
            const response = await fetch(`/intensive_article/${articleId}`);
            const data = await response.json();
            return data.success ? (data.article.highlights || []).length : 0;
          })
        );
        
        const totalVocab = vocabCounts.reduce((sum, count) => sum + count, 0);
        document.getElementById('availableVocabCount').textContent = totalVocab;
      } catch (error) {
        console.error('è·å–è¯æ±‡ç»Ÿè®¡å¤±è´¥:', error);
        document.getElementById('availableVocabCount').textContent = '?';
      }
    }

    // æ›´æ–°å¼€å§‹æŒ‰é’®çŠ¶æ€
    function updateStartButtonState() {
      const startBtn = document.getElementById('startChallengeBtn');
      const hasSelection = challengeSelectedArticles.length > 0;
      
      startBtn.disabled = !hasSelection;
      startBtn.textContent = hasSelection ? 'å¼€å§‹æŒ‘æˆ˜' : 'è¯·é€‰æ‹©æ–‡ç« ';
    }

    // å¼€å§‹è¯æ±‡æŒ‘æˆ˜
    async function startVocabChallenge() {
      if (challengeSelectedArticles.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç¯‡æ–‡ç« ');
        return;
      }

      const wordCount = parseInt(document.getElementById('challengeWordCount').value);
      
      try {
        // åˆ›å»ºä¸ªäººæŒ‘æˆ˜
        const response = await fetch('/api/vocab_summary_challenge', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify({
            article_ids: challengeSelectedArticles,
            word_count: wordCount
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          currentChallenge = data.challenge;
          currentChallengeAnswers = [];
          currentQuestionIndex = 0;
          
          // å…³é—­è®¾ç½®æ¨¡æ€æ¡†ï¼Œæ‰“å¼€æ¸¸æˆæ¨¡æ€æ¡†
          closeChallengeSetup();
          document.getElementById('challengeGameModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';

          document.getElementById('challengeGameTitle').textContent = `è¯æ±‡æŒ‘æˆ˜ - ${wordCount}è¯`;
          showNextQuestion();
        } else {
          alert('åˆ›å»ºæŒ‘æˆ˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('åˆ›å»ºæŒ‘æˆ˜å¤±è´¥:', error);
        alert('åˆ›å»ºæŒ‘æˆ˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // æ˜¾ç¤ºä¸‹ä¸€é¢˜
    function showNextQuestion() {
      if (currentQuestionIndex >= currentChallenge.vocabulary.length) {
        finishChallenge();
        return;
      }

      const vocab = currentChallenge.vocabulary[currentQuestionIndex];
      const progress = document.getElementById('challengeProgress');
      progress.textContent = `ç¬¬ ${currentQuestionIndex + 1} é¢˜ / å…± ${currentChallenge.vocabulary.length} é¢˜`;

      // éšæœºå†³å®šæ˜¯æ˜¾ç¤ºå•è¯è¿˜æ˜¯æ„æ€
      const showWord = Math.random() > 0.5;
      const question = document.getElementById('challengeQuestion');
      const optionsContainer = document.getElementById('challengeOptions');

      if (showWord) {
        // è‹±æ–‡å¯¹ä¸­æ–‡ï¼šæ˜¾ç¤ºè‹±æ–‡å•è¯ï¼Œé€‰æ‹©ä¸­æ–‡é‡Šä¹‰
        currentQuestionType = 'word_to_meaning';
        question.innerHTML = `
          <span class="challenge-word">${vocab.word}</span>
          <button class="challenge-audio-btn" onclick="playChallengeWord('${vocab.word.replace(/'/g, "\\'")}', '${currentChallenge.id}')" title="æ’­æ”¾å‘éŸ³">
            ğŸ”Š
          </button>
        `;

        // è‡ªåŠ¨æ’­æ”¾ä¸€æ¬¡
        setTimeout(() => {
          playChallengeWord(vocab.word, currentChallenge.id);
        }, 100);
        
        // ç”Ÿæˆé€‰é¡¹ï¼šæ­£ç¡®ç­”æ¡ˆ + 3ä¸ªé”™è¯¯ç­”æ¡ˆ
        const options = [vocab.meaning];
        const otherVocab = currentChallenge.vocabulary.filter(v => v.word !== vocab.word);
        
        // ä½¿ç”¨æ”¹è¿›çš„éšæœºç®—æ³•ç”Ÿæˆé€‰é¡¹
        const wrongOptions = generateWrongOptions(otherVocab, vocab.meaning, 'meaning');
        options.push(...wrongOptions);
        
        // æ‰“ä¹±é€‰é¡¹é¡ºåº
        shuffleArray(options);
        renderChallengeOptions(options, vocab.meaning);
      } else {
        // ä¸­æ–‡å¯¹è‹±æ–‡ï¼šæ˜¾ç¤ºä¸­æ–‡é‡Šä¹‰ï¼Œé€‰æ‹©è‹±æ–‡å•è¯
        currentQuestionType = 'meaning_to_word';
        question.textContent = vocab.meaning;
        
        // ç”Ÿæˆé€‰é¡¹ï¼šæ­£ç¡®ç­”æ¡ˆ + 3ä¸ªé”™è¯¯ç­”æ¡ˆ
        const options = [vocab.word];
        const otherVocab = currentChallenge.vocabulary.filter(v => v.meaning !== vocab.meaning);
        
        // ä½¿ç”¨æ”¹è¿›çš„éšæœºç®—æ³•ç”Ÿæˆé€‰é¡¹
        const wrongOptions = generateWrongOptions(otherVocab, vocab.word, 'word');
        options.push(...wrongOptions);
        
        // æ‰“ä¹±é€‰é¡¹é¡ºåº
        shuffleArray(options);
        renderChallengeOptions(options, vocab.word);
      }

      // å¼€å§‹å€’è®¡æ—¶
      startQuestionTimer();
    }

    // æ”¹è¿›çš„éšæœºé€‰é¡¹ç”Ÿæˆç®—æ³•
    function generateWrongOptions(otherVocab, correctAnswer, type) {
      const wrongOptions = [];
      const usedOptions = new Set([correctAnswer]);
      
      // åˆ›å»ºå€™é€‰é€‰é¡¹æ± 
      let candidates = otherVocab.map(v => type === 'meaning' ? v.meaning : v.word)
        .filter(option => option && !usedOptions.has(option));
      
      // å»é‡
      candidates = [...new Set(candidates)];
      
      // å¦‚æœå€™é€‰é€‰é¡¹ä¸å¤Ÿï¼Œé‡å¤ä½¿ç”¨
      while (wrongOptions.length < 3 && candidates.length > 0) {
        // ä½¿ç”¨æ”¹è¿›çš„éšæœºé€‰æ‹©ç®—æ³•
        const randomIndex = Math.floor(Math.random() * candidates.length);
        const selectedOption = candidates[randomIndex];
        
        if (!usedOptions.has(selectedOption)) {
          wrongOptions.push(selectedOption);
          usedOptions.add(selectedOption);
        }
        
        // ä»å€™é€‰æ± ä¸­ç§»é™¤å·²é€‰æ‹©çš„é€‰é¡¹
        candidates.splice(randomIndex, 1);
      }
      
      return wrongOptions;
    }

    // æ”¹è¿›çš„æ•°ç»„æ‰“ä¹±ç®—æ³• (Fisher-Yates)
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // æ¸²æŸ“é€‰é¡¹
    function renderChallengeOptions(options, correctAnswer) {
      const container = document.getElementById('challengeOptions');
      container.innerHTML = '';

      options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'challenge-option';
        optionDiv.textContent = option;
        optionDiv.onclick = () => selectChallengeOption(option, correctAnswer, optionDiv);
        container.appendChild(optionDiv);
      });
    }

    // æ’­æ”¾æŒ‘æˆ˜è¯æ±‡éŸ³é¢‘
    function playChallengeWord(word, challengeId) {
      if (!word || !challengeId) {
        console.warn('Word or challenge ID missing for audio playback');
        return;
      }
      
      try {
        // æ„é€ æŒ‘æˆ˜éŸ³é¢‘URLï¼ˆä½¿ç”¨challenge_å‰ç¼€ä½œä¸ºæ–‡ç« IDï¼‰
        const audioUrl = `/vocab_audio/challenge_${encodeURIComponent(challengeId)}/${encodeURIComponent(word.trim().toLowerCase())}`;
        
        // åˆ›å»ºå¹¶æ’­æ”¾éŸ³é¢‘
        const audio = new Audio(audioUrl);
        audio.onended = () => {
          console.log(`æ’­æ”¾å®Œæˆ: ${word}`);
        };
        audio.onerror = (error) => {
          console.warn(`éŸ³é¢‘æ’­æ”¾å¤±è´¥: ${word}`, error);
          // æ’­æ”¾å¤±è´¥æ—¶å°è¯•ä½¿ç”¨åŸå§‹æ–‡ç« éŸ³é¢‘
          fallbackToOriginalAudio(word);
        };
        audio.play().catch(error => {
          console.warn(`éŸ³é¢‘æ’­æ”¾å¤±è´¥: ${word}`, error);
          // æ’­æ”¾å¤±è´¥æ—¶å°è¯•ä½¿ç”¨åŸå§‹æ–‡ç« éŸ³é¢‘
          fallbackToOriginalAudio(word);
        });
      } catch (error) {
        console.warn(`éŸ³é¢‘æ’­æ”¾é”™è¯¯: ${word}`, error);
        fallbackToOriginalAudio(word);
      }
    }

    // å¤‡ç”¨éŸ³é¢‘æ’­æ”¾æ–¹æ¡ˆ
    function fallbackToOriginalAudio(word) {
      try {
        if (window.playWordPronunciation && currentChallenge && currentChallenge.vocabulary) {
          // æ‰¾åˆ°è¿™ä¸ªè¯æ±‡å¯¹åº”çš„åŸå§‹æ–‡ç« ID
          const vocab = currentChallenge.vocabulary.find(v => v.word === word);
          if (vocab && vocab.article_id) {
            window.playWordPronunciation(word, vocab.article_id);
          }
        }
      } catch (error) {
        console.warn(`å¤‡ç”¨éŸ³é¢‘æ’­æ”¾ä¹Ÿå¤±è´¥: ${word}`, error);
      }
    }

    // é€‰æ‹©ç­”æ¡ˆ
    function selectChallengeOption(selectedOption, correctAnswer, optionElement) {
      // åœæ­¢è®¡æ—¶å™¨
      if (challengeTimer) {
        clearInterval(challengeTimer);
        challengeTimer = null;
      }

      const timeTaken = Math.round((Date.now() - questionStartTime) / 1000);
      const isCorrect = selectedOption === correctAnswer;
      const vocab = currentChallenge.vocabulary[currentQuestionIndex];

      // å¦‚æœæ˜¯ä¸­æ–‡å¯¹è‹±æ–‡é¢˜ç›®ï¼Œæ’­æ”¾é€‰ä¸­å•è¯çš„éŸ³é¢‘
        if (currentQuestionType === 'meaning_to_word') {
          playChallengeWord(selectedOption, currentChallenge.id);
      }

      // è®°å½•ç­”æ¡ˆ
      currentChallengeAnswers.push({
        question_index: currentQuestionIndex,
        vocab: vocab,
        selected_option: selectedOption,
        correct_answer: correctAnswer,
        time_taken: timeTaken,
        is_correct: isCorrect,
        question_type: currentQuestionType
      });
      
      // å¦‚æœç­”é”™äº†ï¼Œè®°å½•åˆ°é”™è¯æœ¬
      if (!isCorrect) {
        recordWrongWord(vocab, selectedOption, correctAnswer);
      }

      // æ˜¾ç¤ºç»“æœ
      const allOptions = document.querySelectorAll('.challenge-option');
      allOptions.forEach(opt => {
        opt.style.pointerEvents = 'none';
        if (opt.textContent === correctAnswer) {
          opt.classList.add('correct');
        } else if (opt === optionElement && !isCorrect) {
          opt.classList.add('incorrect');
        }
      });

      // 2ç§’åæ˜¾ç¤ºä¸‹ä¸€é¢˜
      setTimeout(() => {
        currentQuestionIndex++;
        showNextQuestion();
      }, 2000);
    }

    // è®°å½•é”™è¯
    function recordWrongWord(vocab, selectedOption, correctAnswer) {
      const wordKey = `${vocab.word}::${vocab.meaning}`;
      
      if (!wrongWordsRecord[wordKey]) {
        wrongWordsRecord[wordKey] = {
          word: vocab.word,
          meaning: vocab.meaning,
          article_title: vocab.article_title || '',
          article_id: vocab.article_id || '',
          wrong_count: 0,
          last_wrong_at: null,
          wrong_answers: []
        };
      }
      
      wrongWordsRecord[wordKey].wrong_count++;
      wrongWordsRecord[wordKey].last_wrong_at = new Date().toISOString();
      wrongWordsRecord[wordKey].wrong_answers.push({
        selected: selectedOption,
        correct: correctAnswer,
        timestamp: new Date().toISOString()
      });
      
      // ä¿å­˜åˆ°åç«¯
      saveWrongWordsToBackend();
    }

    // å¼€å§‹é—®é¢˜è®¡æ—¶å™¨
    function startQuestionTimer() {
      questionStartTime = Date.now();
      let timeLeft = 15; // å¢åŠ åˆ°15ç§’
      const timerElement = document.getElementById('challengeTimer');
      
      timerElement.textContent = `${timeLeft}s`;

      challengeTimer = setInterval(() => {
        timeLeft--;
        timerElement.textContent = `${timeLeft}s`;

        if (timeLeft <= 0) {
          clearInterval(challengeTimer);
          challengeTimer = null;
          
          // æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨è·³è¿‡
          skipQuestion();
        }
      }, 1000);
    }

    // è·³è¿‡é—®é¢˜
    function skipQuestion() {
      if (challengeTimer) {
        clearInterval(challengeTimer);
        challengeTimer = null;
      }
      
      const vocab = currentChallenge.vocabulary[currentQuestionIndex];
      const timeTaken = 15;
      
      // è®°å½•è·³è¿‡çš„ç­”æ¡ˆ
      currentChallengeAnswers.push({
        question_index: currentQuestionIndex,
        vocab: vocab,
        selected_option: null,
        correct_answer: null,
        time_taken: timeTaken,
        is_correct: false,
        question_type: currentQuestionType,
        skipped: true
      });
      
      // è®°å½•ä¸ºé”™è¯
      recordWrongWord(vocab, 'è·³è¿‡', currentQuestionType === 'word_to_meaning' ? vocab.meaning : vocab.word);
      
      currentQuestionIndex++;
      showNextQuestion();
    }

    // å®ŒæˆæŒ‘æˆ˜
    function finishChallenge() {
      // è®¡ç®—ç»“æœ
      const totalQuestions = currentChallenge.vocabulary.length;
      const correctCount = currentChallengeAnswers.filter(answer => answer.is_correct).length;
      const accuracy = Math.round((correctCount / totalQuestions) * 100);
      
      // è®¡ç®—æ—¶é—´å¥–åŠ±
      let timeBonus = 0;
      currentChallengeAnswers.forEach(answer => {
        if (answer.is_correct && !answer.skipped) {
          timeBonus += Math.max(1, 16 - answer.time_taken); // 15ç§’æ»¡åˆ†ï¼Œç”¨æ—¶è¶Šå°‘å¥–åŠ±è¶Šå¤š
        }
      });
      
      const score = Math.round((correctCount / totalQuestions) * 70 + (timeBonus / (totalQuestions * 15)) * 30);
      
      // ä¿å­˜æŒ‘æˆ˜è®°å½•
      const challengeRecord = {
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        article_ids: currentChallenge.article_ids,
        article_titles: challengeSelectedArticles.map(id => {
          const article = allArticles.find(a => a.id === id);
          return article ? article.title : 'æœªçŸ¥æ–‡ç« ';
        }),
        total_questions: totalQuestions,
        correct_count: correctCount,
        accuracy: accuracy,
        score: score,
        time_bonus: timeBonus,
        answers: currentChallengeAnswers
      };
      
      // ä¿å­˜åˆ°åç«¯
      saveChallengeRecordToBackend(challengeRecord);
      
      challengeHistory.unshift(challengeRecord); // æ·»åŠ åˆ°å¼€å¤´æœ¬åœ°ç¼“å­˜
      
      // æ˜¾ç¤ºç»“æœ
      showChallengeResult(challengeRecord);
    }

    // æ˜¾ç¤ºæŒ‘æˆ˜ç»“æœ
    function showChallengeResult(result) {
      document.getElementById('challengeGameModal').style.display = 'none';
      document.getElementById('challengeResultModal').style.display = 'flex';
      
      const wrongAnswers = result.answers.filter(answer => !answer.is_correct);
      
      document.getElementById('resultSummary').innerHTML = `
        <div class="result-score">${result.score}</div>
        <div class="result-accuracy">æ­£ç¡®ç‡ ${result.accuracy}%</div>
        <div class="result-details">
          <div class="result-detail">
            <div class="result-detail-value">${result.correct_count}</div>
            <div class="result-detail-label">ç­”å¯¹é¢˜æ•°</div>
          </div>
          <div class="result-detail">
            <div class="result-detail-value">${result.total_questions}</div>
            <div class="result-detail-label">æ€»é¢˜æ•°</div>
          </div>
          <div class="result-detail">
            <div class="result-detail-value">${Math.round(result.time_bonus)}</div>
            <div class="result-detail-label">æ—¶é—´å¥–åŠ±</div>
          </div>
        </div>
      `;
      
      if (wrongAnswers.length > 0) {
        document.getElementById('wrongWordsSection').innerHTML = `
          <h4>é”™è¯å›é¡¾ (${wrongAnswers.length}ä¸ª)</h4>
          ${wrongAnswers.map(answer => `
            <div class="wrong-word-item">
              <div>
                <div class="wrong-word-text">${answer.vocab.word}</div>
                <div class="wrong-word-meaning">${answer.vocab.meaning}</div>
              </div>
              <div style="text-align: right; font-size: 12px; color: #6b7280;">
                ${answer.skipped ? 'è·³è¿‡' : `é”™é€‰: ${answer.selected_option}`}
              </div>
            </div>
          `).join('')}
        `;
      } else {
        document.getElementById('wrongWordsSection').innerHTML = `
          <div style="text-align: center; padding: 24px; color: #10b981;">
            ğŸ‰ å…¨éƒ¨ç­”å¯¹ï¼å¤ªæ£’äº†ï¼
          </div>
        `;
      }
    }

    // å…³é—­æŒ‘æˆ˜ç»“æœ
    function closeChallengeResult() {
      document.getElementById('challengeResultModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // å¤ä¹ é”™è¯
    function reviewWrongWords() {
      // å¯ä»¥å®ç°ä¸€ä¸ªä¸“é—¨çš„é”™è¯å¤ä¹ åŠŸèƒ½
      alert('é”™è¯å¤ä¹ åŠŸèƒ½å¼€å‘ä¸­...');
    }

    // é‡æ–°å¼€å§‹æŒ‘æˆ˜
    function restartChallenge() {
      closeChallengeResult();
      openChallengeSetup();
      
      // é¢„é€‰ä¹‹å‰çš„æ–‡ç« 
      challengeSelectedArticles.forEach(articleId => {
        const checkbox = document.getElementById(`article_${articleId}`);
        if (checkbox) {
          checkbox.checked = true;
        }
      });
      updateChallengeStats();
      updateStartButtonState();
    }

    // é€€å‡ºæŒ‘æˆ˜
    function quitChallenge() {
      if (confirm('ç¡®å®šè¦é€€å‡ºå½“å‰æŒ‘æˆ˜å—ï¼Ÿè¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚')) {
      if (challengeTimer) {
        clearInterval(challengeTimer);
        challengeTimer = null;
      }
        document.getElementById('challengeGameModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        
        currentChallenge = null;
        currentChallengeAnswers = [];
        currentQuestionIndex = 0;
      }
    }

    // ==================== æŒ‘æˆ˜è®°å½•åŠŸèƒ½ ====================

    // æ‰“å¼€æŒ‘æˆ˜è®°å½•
    function openChallengeHistory() {
      document.getElementById('challengeHistoryModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
      switchHistoryTab('recent');
    }

    // å…³é—­æŒ‘æˆ˜è®°å½•
    function closeChallengeHistory() {
      document.getElementById('challengeHistoryModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // åˆ‡æ¢å†å²æ ‡ç­¾é¡µ
    function switchHistoryTab(tab) {
      // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tab + 'Tab').classList.add('active');
      
      const content = document.getElementById('historyContent');
      
      switch(tab) {
        case 'recent':
          showRecentChallenges();
          break;
        case 'wrong':
          showWrongWordsStats();
          break;
        case 'stats':
          showChallengeStats();
          break;
      }
    }

    // æ˜¾ç¤ºæœ€è¿‘æŒ‘æˆ˜
    function showRecentChallenges() {
      const content = document.getElementById('historyContent');
      
      if (challengeHistory.length === 0) {
        content.innerHTML = `
          <div style="text-align: center; padding: 48px; color: #6b7280;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“š</div>
            <div>è¿˜æ²¡æœ‰æŒ‘æˆ˜è®°å½•</div>
            <div style="margin-top: 8px; font-size: 14px; color: #9ca3af;">å¼€å§‹ä½ çš„ç¬¬ä¸€ä¸ªè¯æ±‡æŒ‘æˆ˜å§ï¼</div>
            </div>
        `;
        return;
      }
      
      content.innerHTML = challengeHistory.map(challenge => `
        <div class="history-item">
          <div class="history-header">
            <div class="history-title">
              ${challenge.article_titles.join(', ')} (${challenge.total_questions}è¯)
            </div>
            <div class="history-date">
              ${new Date(challenge.timestamp).toLocaleDateString('zh-CN')} 
              ${new Date(challenge.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}
            </div>
            </div>
          <div class="history-stats">
            <span>æ­£ç¡®ç‡: <strong>${challenge.accuracy}%</strong></span>
            <span>å¾—åˆ†: <strong>${challenge.score}</strong></span>
            <span>ç­”å¯¹: <strong>${challenge.correct_count}/${challenge.total_questions}</strong></span>
            <span>æ—¶é—´å¥–åŠ±: <strong>${Math.round(challenge.time_bonus)}</strong></span>
          </div>
          <div style="margin-top: 12px;">
            <button class="btn" style="font-size: 12px; padding: 4px 8px;" onclick="showChallengeDetail('${challenge.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
            <button class="btn" style="font-size: 12px; padding: 4px 8px;" onclick="reviewChallengeWrongWords('${challenge.id}')">å¤ä¹ é”™è¯</button>
          </div>
        </div>
      `).join('');
    }

    // æ˜¾ç¤ºé”™è¯ç»Ÿè®¡
    function showWrongWordsStats() {
      const content = document.getElementById('historyContent');
      const wrongWords = Object.values(wrongWordsRecord);
      
      if (wrongWords.length === 0) {
        content.innerHTML = `
          <div style="text-align: center; padding: 48px; color: #6b7280;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‰</div>
            <div>è¿˜æ²¡æœ‰é”™è¯è®°å½•</div>
            <div style="margin-top: 8px; font-size: 14px; color: #9ca3af;">ç»§ç»­ä¿æŒï¼Œæˆ–è€…å¼€å§‹æ›´å¤šæŒ‘æˆ˜ï¼</div>
          </div>
        `;
        return;
      }
      
      // æŒ‰é”™è¯¯æ¬¡æ•°æ’åº
      wrongWords.sort((a, b) => b.wrong_count - a.wrong_count);
      
      content.innerHTML = `
        <div style="margin-bottom: 16px; padding: 16px; background: #fef2f2; border-radius: 12px; border-left: 4px solid #ef4444;">
          <div style="font-weight: 600; color: #991b1b; margin-bottom: 8px;">é”™è¯æ±‡æ€»</div>
          <div style="color: #6b7280; font-size: 14px;">
            æ€»è®¡ ${wrongWords.length} ä¸ªè¯æ±‡éœ€è¦é‡ç‚¹å¤ä¹ ï¼Œç´¯è®¡é”™è¯¯ ${wrongWords.reduce((sum, w) => sum + w.wrong_count, 0)} æ¬¡
          </div>
        </div>
        ${wrongWords.map(word => `
          <div class="history-item" style="border-left: 3px solid #ef4444;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 600; color: #111827; font-size: 16px;">${word.word}</div>
                <div style="color: #6b7280; margin-top: 2px;">${word.meaning}</div>
                ${word.article_title ? `<div style="color: #9ca3af; font-size: 12px; margin-top: 4px;">æ¥æº: ${word.article_title}</div>` : ''}
              </div>
              <div style="text-align: right;">
                <div style="color: #ef4444; font-weight: 600;">é”™ ${word.wrong_count} æ¬¡</div>
                <div style="color: #6b7280; font-size: 12px;">
                  ${new Date(word.last_wrong_at).toLocaleDateString('zh-CN')}
                </div>
              </div>
            </div>
            <div style="margin-top: 8px;">
              <button class="btn" style="font-size: 12px; padding: 4px 8px;" onclick="practiceWrongWord('${word.word}', '${word.meaning}')">å•è¯ç»ƒä¹ </button>
              <button class="btn" style="font-size: 12px; padding: 4px 8px;" onclick="removeFromWrongWords('${word.word}::${word.meaning}')">ç§»å‡ºé”™è¯æœ¬</button>
            </div>
          </div>
        `).join('')}
      `;
    }

    // æ˜¾ç¤ºæŒ‘æˆ˜ç»Ÿè®¡
    function showChallengeStats() {
      const content = document.getElementById('historyContent');
      
      if (challengeHistory.length === 0) {
        content.innerHTML = `
          <div style="text-align: center; padding: 48px; color: #6b7280;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
            <div>æš‚æ— ç»Ÿè®¡æ•°æ®</div>
          </div>
        `;
        return;
      }
      
      // è®¡ç®—ç»Ÿè®¡æ•°æ®
      const totalChallenges = challengeHistory.length;
      const totalQuestions = challengeHistory.reduce((sum, c) => sum + c.total_questions, 0);
      const totalCorrect = challengeHistory.reduce((sum, c) => sum + c.correct_count, 0);
      const avgAccuracy = Math.round((totalCorrect / totalQuestions) * 100);
      const avgScore = Math.round(challengeHistory.reduce((sum, c) => sum + c.score, 0) / totalChallenges);
      const bestScore = Math.max(...challengeHistory.map(c => c.score));
      const recentAccuracy = challengeHistory.slice(0, 5).reduce((sum, c) => sum + c.accuracy, 0) / Math.min(5, challengeHistory.length);
      
      // æŒ‰æ—¥æœŸåˆ†ç»„ç»Ÿè®¡
      const dailyStats = {};
      challengeHistory.forEach(challenge => {
        const date = new Date(challenge.timestamp).toDateString();
        if (!dailyStats[date]) {
          dailyStats[date] = { count: 0, accuracy: 0, totalQuestions: 0, correctAnswers: 0 };
        }
        dailyStats[date].count++;
        dailyStats[date].totalQuestions += challenge.total_questions;
        dailyStats[date].correctAnswers += challenge.correct_count;
        dailyStats[date].accuracy = Math.round((dailyStats[date].correctAnswers / dailyStats[date].totalQuestions) * 100);
      });
      
      const sortedDates = Object.keys(dailyStats).sort((a, b) => new Date(b) - new Date(a));
      
      content.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 600;">${totalChallenges}</div>
            <div style="opacity: 0.9;">æ€»æŒ‘æˆ˜æ¬¡æ•°</div>
          </div>
          <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 600;">${avgAccuracy}%</div>
            <div style="opacity: 0.9;">å¹³å‡æ­£ç¡®ç‡</div>
          </div>
          <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 600;">${avgScore}</div>
            <div style="opacity: 0.9;">å¹³å‡å¾—åˆ†</div>
          </div>
          <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 600;">${bestScore}</div>
            <div style="opacity: 0.9;">æœ€é«˜å¾—åˆ†</div>
          </div>
        </div>
        
        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
          <h4 style="margin-bottom: 16px; color: #111827;">è¿‘æœŸè¡¨ç°</h4>
          <div style="display: flex; gap: 24px; margin-bottom: 16px;">
            <div>
              <div style="color: #6b7280; font-size: 14px;">æœ€è¿‘5æ¬¡å¹³å‡æ­£ç¡®ç‡</div>
              <div style="font-size: 20px; font-weight: 600; color: #111827;">${Math.round(recentAccuracy)}%</div>
            </div>
            <div>
              <div style="color: #6b7280; font-size: 14px;">æ€»ç­”é¢˜æ•°</div>
              <div style="font-size: 20px; font-weight: 600; color: #111827;">${totalQuestions}</div>
            </div>
            <div>
              <div style="color: #6b7280; font-size: 14px;">æ€»ç­”å¯¹æ•°</div>
              <div style="font-size: 20px; font-weight: 600; color: #111827;">${totalCorrect}</div>
            </div>
          </div>
        </div>
        
        <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px;">
          <h4 style="margin-bottom: 16px; color: #111827;">æ¯æ—¥ç»ƒä¹ è®°å½•</h4>
          ${sortedDates.slice(0, 10).map(date => {
            const stats = dailyStats[date];
            return `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9;">
                <div>
                  <div style="font-weight: 500; color: #111827;">${new Date(date).toLocaleDateString('zh-CN')}</div>
                  <div style="font-size: 14px; color: #6b7280;">${stats.count} æ¬¡æŒ‘æˆ˜</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-weight: 500; color: #111827;">${stats.accuracy}%</div>
                  <div style="font-size: 14px; color: #6b7280;">${stats.correctAnswers}/${stats.totalQuestions}</div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // æ˜¾ç¤ºæŒ‘æˆ˜è¯¦æƒ…
    function showChallengeDetail(challengeId) {
      const challenge = challengeHistory.find(c => c.id === challengeId);
      if (!challenge) return;
      
      const wrongAnswers = challenge.answers.filter(a => !a.is_correct);
      
      alert(`æŒ‘æˆ˜è¯¦æƒ…ï¼š
      
æ–‡ç« ï¼š${challenge.article_titles.join(', ')}
æ—¶é—´ï¼š${new Date(challenge.timestamp).toLocaleString('zh-CN')}
æ€»é¢˜æ•°ï¼š${challenge.total_questions}
ç­”å¯¹ï¼š${challenge.correct_count}
æ­£ç¡®ç‡ï¼š${challenge.accuracy}%
å¾—åˆ†ï¼š${challenge.score}
æ—¶é—´å¥–åŠ±ï¼š${Math.round(challenge.time_bonus)}

é”™é¢˜ï¼š${wrongAnswers.length}ä¸ª
${wrongAnswers.map(a => `â€¢ ${a.vocab.word} - ${a.vocab.meaning}`).join('\n')}`);
    }

    // å¤ä¹ æŒ‘æˆ˜é”™è¯
    function reviewChallengeWrongWords(challengeId) {
      const challenge = challengeHistory.find(c => c.id === challengeId);
      if (!challenge) return;
      
      const wrongAnswers = challenge.answers.filter(a => !a.is_correct);
      if (wrongAnswers.length === 0) {
        alert('è¿™æ¬¡æŒ‘æˆ˜æ²¡æœ‰é”™è¯ï¼');
        return;
      }
      
      // åˆ›å»ºä¸€ä¸ªåŸºäºé”™è¯çš„æ–°æŒ‘æˆ˜
      const wrongVocab = wrongAnswers.map(a => a.vocab);
      
      currentChallenge = {
        id: `review_${challengeId}`,
        type: 'review',
        vocabulary: wrongVocab,
        article_ids: challenge.article_ids
      };
      
      currentChallengeAnswers = [];
      currentQuestionIndex = 0;
      
      closeChallengeHistory();
      document.getElementById('challengeGameModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      document.getElementById('challengeGameTitle').textContent = `é”™è¯å¤ä¹  - ${wrongVocab.length}è¯`;
      showNextQuestion();
    }

    // ç»ƒä¹ å•ä¸ªé”™è¯
    function practiceWrongWord(word, meaning) {
      // æ’­æ”¾å‘éŸ³ - å°è¯•ä½¿ç”¨åŸå§‹æ–‡ç« çš„éŸ³é¢‘
      try {
        if (window.playWordPronunciation) {
          // å°è¯•ä»é”™è¯è®°å½•ä¸­æ‰¾åˆ°åŸå§‹æ–‡ç« ID
          const wordKey = `${word}::${meaning}`;
          const wrongWordData = wrongWordsRecord[wordKey];
          
          if (wrongWordData && wrongWordData.article_id) {
            window.playWordPronunciation(word, wrongWordData.article_id);
          } else {
            // å¦‚æœæ‰¾ä¸åˆ°åŸå§‹æ–‡ç« IDï¼Œå°è¯•ä»å½“å‰æ˜¾ç¤ºçš„æ–‡ç« ä¸­æ‰¾
            const currentDisplayedArticle = currentArticle;
            if (currentDisplayedArticle) {
              window.playWordPronunciation(word, currentDisplayedArticle.id);
            }
          }
        }
      } catch (error) {
        console.warn(`ç»ƒä¹ å•è¯éŸ³é¢‘æ’­æ”¾å¤±è´¥: ${word}`, error);
      }
      
      alert(`${word}\n${meaning}\n\nå·²æ’­æ”¾å‘éŸ³ï¼Œè¯·ä»”ç»†å¬å¹¶è®°å¿†ï¼`);
    }

    // ä»é”™è¯æœ¬ç§»é™¤
    function removeFromWrongWords(wordKey) {
      if (confirm('ç¡®å®šè¦ä»é”™è¯æœ¬ä¸­ç§»é™¤è¿™ä¸ªè¯æ±‡å—ï¼Ÿ')) {
        delete wrongWordsRecord[wordKey];
        saveWrongWordsToBackend();
        showWrongWordsStats(); // åˆ·æ–°æ˜¾ç¤º
      }
    }

    // å¯¼å‡ºæŒ‘æˆ˜è®°å½•
    function exportChallengeHistory() {
      if (challengeHistory.length === 0) {
        alert('æš‚æ— æŒ‘æˆ˜è®°å½•å¯å¯¼å‡º');
        return;
      }
      
      let csvContent = '\uFEFF'; // BOM for proper UTF-8 encoding
      csvContent += 'æŒ‘æˆ˜æ—¶é—´,æ–‡ç« ,é¢˜ç›®æ•°,ç­”å¯¹æ•°,æ­£ç¡®ç‡,å¾—åˆ†,æ—¶é—´å¥–åŠ±\n';
      
      challengeHistory.forEach(challenge => {
        const time = new Date(challenge.timestamp).toLocaleString('zh-CN');
        const articles = challenge.article_titles.join(';');
        csvContent += `"${time}","${articles}",${challenge.total_questions},${challenge.correct_count},${challenge.accuracy}%,${challenge.score},${Math.round(challenge.time_bonus)}\n`;
      });
      
      // Download file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `è¯æ±‡æŒ‘æˆ˜è®°å½•_${new Date().toLocaleDateString('zh-CN')}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert(`å·²å¯¼å‡º ${challengeHistory.length} æ¡æŒ‘æˆ˜è®°å½•`);
    }

    // ==================== åç«¯æŒä¹…åŒ–åŠŸèƒ½ ====================
    
    // ä¿å­˜æŒ‘æˆ˜è®°å½•åˆ°åç«¯
    async function saveChallengeRecordToBackend(challengeRecord) {
      try {
        const response = await fetch('/api/vocab_challenge_record', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify({
            challenge_record: challengeRecord
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            console.log(`æŒ‘æˆ˜è®°å½•å·²ä¿å­˜åˆ°åç«¯ï¼Œæ€»è®°å½•æ•°: ${data.record_count}`);
          }
        } else {
          console.warn('ä¿å­˜æŒ‘æˆ˜è®°å½•åˆ°åç«¯å¤±è´¥');
          // å¤‡ä»½åˆ°localStorage
          let localHistory = JSON.parse(localStorage.getItem('vocabChallengeHistory') || '[]');
          localHistory.unshift(challengeRecord);
          if (localHistory.length > 50) {
            localHistory = localHistory.slice(0, 50);
          }
          localStorage.setItem('vocabChallengeHistory', JSON.stringify(localHistory));
        }
      } catch (error) {
        console.warn('ä¿å­˜æŒ‘æˆ˜è®°å½•åˆ°åç«¯å‡ºé”™:', error);
        // å¤‡ä»½åˆ°localStorage
        let localHistory = JSON.parse(localStorage.getItem('vocabChallengeHistory') || '[]');
        localHistory.unshift(challengeRecord);
        if (localHistory.length > 50) {
          localHistory = localHistory.slice(0, 50);
        }
        localStorage.setItem('vocabChallengeHistory', JSON.stringify(localHistory));
      }
    }

    // ä¿å­˜é”™è¯è®°å½•åˆ°åç«¯
    async function saveWrongWordsToBackend() {
      try {
        const response = await fetch('/api/vocab_wrong_words', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify({
            wrong_words: wrongWordsRecord
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            console.log(`é”™è¯è®°å½•å·²ä¿å­˜åˆ°åç«¯ï¼Œæ€»è¯æ±‡æ•°: ${data.word_count}`);
          }
        } else {
          console.warn('ä¿å­˜é”™è¯è®°å½•åˆ°åç«¯å¤±è´¥');
          // å¤‡ä»½åˆ°localStorage
          localStorage.setItem('vocabWrongWords', JSON.stringify(wrongWordsRecord));
        }
      } catch (error) {
        console.warn('ä¿å­˜é”™è¯è®°å½•åˆ°åç«¯å‡ºé”™:', error);
        // å¤‡ä»½åˆ°localStorage
        localStorage.setItem('vocabWrongWords', JSON.stringify(wrongWordsRecord));
      }
    }
  </script>
</body>
</html>
