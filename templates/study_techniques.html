<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>学习技巧</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
  
  <link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
  
  <!-- Markdown解析库和相关依赖 -->
  <script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
  
  <style>
    body { 
      font-family: 'PT Serif', 'Crimson Text', ui-serif, 'Times New Roman', 'Georgia', serif; 
      background: linear-gradient(135deg, #e0e7ff 0%, #f4f6fa 100%); 
      margin: 0; 
      min-height: 100vh; 
      padding: 20px; 
      box-sizing: border-box; 
    }
    
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: #fff; 
      border-radius: 20px; 
      box-shadow: 0 16px 48px rgba(31,38,135,0.20); 
      padding: 24px; 
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .header h1 { 
      margin: 0; 
      color: #1f2937; 
      font-size: 28px; 
      letter-spacing: 0.3px; 
    }
    
    .back-btn {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      color: #374151;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .back-btn:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }
    
    .categories {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .category-tab {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      flex: none;
      min-width: 100px;
    }
    
    .category-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    }
    
    .category-tab:hover:not(.active) {
      border-color: #c7d2fe;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(31,38,135,0.1);
    }
    
    .category-icon {
      font-size: 16px;
      margin-right: 6px;
    }
    
    .category-name {
      font-weight: 600;
      font-size: 14px;
      display: inline;
    }
    
    .category-desc {
      display: none;
    }
    
    .content-area {
      display: none;
    }
    
    .content-area.active {
      display: block;
    }
    
    .modules {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 24px;
    }
    
    .module {
      background: #fafafa;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      min-height: 400px;
      position: relative;
      z-index: 1;
    }
    
    .module.techniques {
      grid-column: 1 / -1;
      min-height: 300px;
    }
    
    .module-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .module-title {
      font-weight: 700;
      font-size: 18px;
      color: #1f2937;
    }
    
    .add-btn {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 60px;
    }
    
    .add-btn:hover {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .add-btn:active {
      transform: translateY(0);
    }
    
    .items {
      max-height: 350px;
      overflow-y: visible;
      overflow-x: hidden;
    }
    
    .item {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    
    .item:hover {
      box-shadow: 0 2px 8px rgba(31,38,135,0.1);
    }
    
    .word-item {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .word-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .word-group-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .word-group-title:hover {
      color: #60a5fa;
    }

    .word-group-title.editing {
      border: 1px solid #60a5fa;
      border-radius: 4px;
      padding: 4px 8px;
      background: white;
      outline: none;
    }

    .word-main {
      flex: 1;
    }
    
    .word-primary {
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 4px;
      cursor: pointer;
      transition: color 0.2s;
      position: relative;
    }
    
    .word-primary:hover {
      color: #60a5fa;
    }
    
    .word-clickable {
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
    }
    
    .word-clickable:hover {
      background: #eff6ff;
      color: #3b82f6;
    }
    
    
    /* 单词和词义两行布局 */
    .word-with-definition {
      display: inline-block;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 4px;
      transition: all 0.2s ease;
      min-width: 120px;
      vertical-align: top;
    }

    .word-with-definition:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .word-text {
      font-weight: 600;
      color: #1e293b;
      font-size: 14px;
      margin-bottom: 4px;
      text-align: center;
    }

    .word-definition {
      font-size: 12px;
      color: #64748b;
      line-height: 1.4;
      text-align: center;
      font-style: italic;
    }

    .synonyms {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-start;
      align-items: flex-start;
    }

    .hypernym-chain {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      justify-content: flex-start;
    }

    .hypernym-separator {
      color: #64748b;
      font-size: 14px;
      font-weight: 500;
    }

    .hypernym-arrow {
      color: #60a5fa;
      font-size: 16px;
      font-weight: bold;
      margin: 0 8px;
    }
    
    .word-definition {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .synonyms {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .synonym {
      background: #f3f4f6;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .synonym:hover {
      background: #60a5fa;
      color: white;
    }
    
    .hypernym-chain {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .hypernym-arrow {
      color: #9ca3af;
      font-size: 14px;
    }
    
    .hypernym-word {
      background: #f0f9ff;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
      color: #0369a1;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #bae6fd;
    }
    
    .hypernym-word:hover {
      background: #0369a1;
      color: white;
    }
    
    .hypernym-word.target {
      background: #3b82f6;
      color: white;
      font-weight: 600;
    }
    
    .technique-item {
      border-left: 4px solid #60a5fa;
      padding-left: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .technique-item:hover {
      background: #f8fafc;
      border-radius: 8px;
    }
    
    .technique-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .technique-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 16px;
    }
    
    .technique-toggle {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      font-size: 14px;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .technique-toggle:hover {
      background: #e5e7eb;
      color: #374151;
    }
    
    
    /* 全屏模态框样式 */
    .fullscreen-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 2000;
      overflow-y: auto;
    }
    
    .fullscreen-modal.show {
      display: block;
    }
    
    .fullscreen-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap;
      gap: 12px;
    }

    .fullscreen-left {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1;
      min-width: 200px;
    }

    .fullscreen-sort-controls {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    
    .fullscreen-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin: 0;
    }
    
    .fullscreen-actions {
      display: flex;
      gap: 12px;
    }
    
    .fullscreen-main {
      display: flex;
      gap: 40px;
      align-items: flex-start;
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .fullscreen-content {
      flex: 1;
      line-height: 1.8;
      font-size: 16px;
      min-width: 0;
    }

    /* 全屏词汇显示样式 */
    .fullscreen-content .word-with-definition {
      display: inline-block;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 6px;
      transition: all 0.2s ease;
      min-width: 120px;
      vertical-align: top;
      font-size: 16px;
    }

    .fullscreen-content .word-with-definition:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .fullscreen-content .word-text {
      font-weight: 600;
      color: #1e293b;
      font-size: 16px;
      margin-bottom: 6px;
      text-align: center;
    }

    .fullscreen-content .word-definition {
      font-size: 14px;
      color: #64748b;
      line-height: 1.4;
      text-align: center;
      font-style: italic;
    }

    .fullscreen-content .hypernym-chain {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      justify-content: center;
      padding: 8px;
    }

    .fullscreen-content .hypernym-separator {
      color: #64748b;
      font-size: 16px;
      font-weight: 500;
    }

    .fullscreen-content .hypernym-arrow {
      color: #60a5fa;
      font-size: 18px;
      font-weight: bold;
      margin: 0 12px;
    }
    
    .fullscreen-edit-area {
      display: none;
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .fullscreen-edit-area.active {
      display: block;
    }
    
    .fullscreen-textarea {
      width: 100%;
      min-height: 500px;
      padding: 20px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      line-height: 1.6;
      resize: vertical;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .fullscreen-close {
      background: #6b7280;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    .fullscreen-close:hover {
      background: #4b5563;
    }
    
    .fullscreen-edit-btn, .fullscreen-save-btn {
      background: #60a5fa;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    .fullscreen-edit-btn:hover, .fullscreen-save-btn:hover {
      background: #60a5fa;
    }
    
    /* Markdown内容样式 */
    .technique-content {
      line-height: 1.8;
      color: #374151;
      margin-top: 12px;
      display: none;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .technique-content.expanded {
      display: block;
    }

    /* Markdown元素样式 */
    .technique-content h1,
    .technique-content h2,
    .technique-content h3,
    .technique-content h4,
    .technique-content h5,
    .technique-content h6 {
      color: #1f2937;
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      font-weight: 600;
    }

    .technique-content h1 { font-size: 1.8em; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.3em; }
    .technique-content h2 { font-size: 1.5em; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.2em; }
    .technique-content h3 { font-size: 1.3em; }
    .technique-content h4 { font-size: 1.1em; }
    .technique-content h5 { font-size: 1.05em; }
    .technique-content h6 { font-size: 1em; }

    .technique-content p {
      margin: 1em 0;
    }

    .technique-content blockquote {
      border-left: 4px solid #60a5fa;
      padding-left: 1em;
      margin: 1em 0;
      color: #6b7280;
      background: #f8fafc;
      padding: 1em;
      border-radius: 0 8px 8px 0;
    }

    .technique-content ul,
    .technique-content ol {
      margin: 1em 0;
      padding-left: 2em;
    }

    .technique-content li {
      margin: 0.5em 0;
    }

    .technique-content code {
      background: #f3f4f6;
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      color: #dc2626;
    }

    .technique-content pre {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1em;
      overflow-x: auto;
      margin: 1em 0;
    }

    .technique-content pre code {
      background: none;
      padding: 0;
      border-radius: 0;
      color: inherit;
    }

    /* Markdown表格样式 */
    .technique-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 1em 0;
      background: #a5d8ff;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .technique-content th,
    .technique-content td {
      border: 1px solid #d1d5db;
      padding: 0.75em 1em;
      text-align: center;
      vertical-align: top;
    }

    .technique-content th {
      background: rgba(255, 255, 255, 0.95);
      font-weight: 600;
      color: #1f2937;
      border-bottom: 2px solid #9ca3af;
    }

    .technique-content tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.8);
    }

    .technique-content tr:hover {
      background: rgba(255, 255, 255, 0.9);
    }

    /* 强调和突出显示 */
    .technique-content strong,
    .technique-content b {
      font-weight: 700;
      color: #1f2937;
    }

    .technique-content em,
    .technique-content i {
      font-style: italic;
      color: #4b5563;
    }

    .technique-content del {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .technique-content mark {
      background: #fef3c7;
      color: #92400e;
      padding: 0.1em 0.3em;
      border-radius: 3px;
    }

    /* 链接样式 */
    .technique-content a {
      color: #60a5fa;
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: all 0.2s;
    }

    .technique-content a:hover {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    /* 水平线 */
    .technique-content hr {
      border: none;
      height: 2px;
      background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
      margin: 2em 0;
    }

    /* 全屏Markdown样式 */
    .fullscreen-content h1,
    .fullscreen-content h2,
    .fullscreen-content h3,
    .fullscreen-content h4,
    .fullscreen-content h5,
    .fullscreen-content h6 {
      color: #1f2937;
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      font-weight: 600;
    }

    .fullscreen-content h1 { font-size: 1.8em; border-bottom: 3px solid #e5e7eb; padding-bottom: 0.3em; }
    .fullscreen-content h2 { font-size: 1.5em; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.2em; }
    .fullscreen-content h3 { font-size: 1.3em; }
    .fullscreen-content h4 { font-size: 1.1em; }
    .fullscreen-content h5 { font-size: 1.0em; }
    .fullscreen-content h6 { font-size: 0.95em; }

    .fullscreen-content p {
      margin: 1.2em 0;
      font-size: 1.0em;
      line-height: 1.8;
    }

    .fullscreen-content blockquote {
      border-left: 5px solid #60a5fa;
      padding-left: 1.5em;
      margin: 1.5em 0;
      color: #6b7280;
      background: #f8fafc;
      padding: 1.5em;
      border-radius: 0 12px 12px 0;
      font-style: italic;
      font-size: 1.1em;
    }

    .fullscreen-content ul,
    .fullscreen-content ol {
      margin: 1.2em 0;
      padding-left: 2.5em;
    }

    .fullscreen-content li {
      margin: 0.6em 0;
      font-size: 1.0em;
    }

    .fullscreen-content code {
      background: #f3f4f6;
      padding: 0.3em 0.6em;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.95em;
      color: #dc2626;
      border: 1px solid #e2e8f0;
    }

    .fullscreen-content pre {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1.5em;
      overflow-x: auto;
      margin: 1.5em 0;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }

    .fullscreen-content pre code {
      background: none;
      padding: 0;
      border-radius: 0;
      color: inherit;
      border: none;
    }

    /* 全屏表格样式 */
    .fullscreen-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5em 0;
      background: #a5d8ff;
      border: 3px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .fullscreen-content th,
    .fullscreen-content td {
      border: 2px solid #d1d5db;
      padding: 1em 1.2em;
      text-align: center;
      vertical-align: top;
    }

    .fullscreen-content th {
      background: rgba(255, 255, 255, 0.95);
      font-weight: 700;
      color: #1f2937;
      border-bottom: 3px solid #9ca3af;
      font-size: 1.0em;
    }

    .fullscreen-content tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.8);
    }

    .fullscreen-content tr:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: scale(1.01);
      transition: all 0.2s;
    }

    /* 全屏强调样式 */
    .fullscreen-content strong,
    .fullscreen-content b {
      font-weight: 700;
      color: #1f2937;
    }

    .fullscreen-content em,
    .fullscreen-content i {
      font-style: italic;
      color: #4b5563;
    }

    .fullscreen-content del {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .fullscreen-content mark {
      background: #fef3c7;
      color: #92400e;
      padding: 0.2em 0.4em;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .fullscreen-content a {
      color: #60a5fa;
      text-decoration: none;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-weight: 500;
    }

    .fullscreen-content a:hover {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    .fullscreen-content hr {
      border: none;
      height: 3px;
      background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
      margin: 3em 0;
    }

    /* 全屏布局控制 */
    .fullscreen-narrow {
      max-width: 600px;
      margin: 0 auto;
      font-size: 1.0em;
    }

    .fullscreen-wide {
      max-width: 1200px;
      margin: 0 auto;
      font-size: 1.0em;
    }

    /* 全屏目录样式 */
    .fullscreen-toc-float {
      position: fixed;
      top: 50%;
      left: 20px;
      transform: translateY(-50%);
      z-index: 10;
      transition: all 0.3s ease;
    }

    .fullscreen-toc-float.collapsed {
      left: -20px;
      opacity: 0.9;
    }

    .fullscreen-toc.collapsed {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: rgba(96, 165, 250, 0.2);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.2);
      border: 2px solid rgba(96, 165, 250, 0.4);
      transition: all 0.3s ease;
    }

    .fullscreen-toc.collapsed:hover {
      background: rgba(96, 165, 250, 0.3);
      box-shadow: 0 6px 20px rgba(96, 165, 250, 0.3);
      border-color: rgba(96, 165, 250, 0.6);
      transform: scale(1.05);
    }

    .fullscreen-toc.collapsed .fullscreen-toc-title,
    .fullscreen-toc.collapsed .toc-list {
      display: none;
    }

    .fullscreen-toc.collapsed::before {
      content: "📖";
      font-size: 22px;
      color: #1f2937;
      font-weight: bold;
    }

    .fullscreen-toc {
      width: 280px;
      background: rgba(248, 250, 252, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(226, 232, 240, 0.3);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      max-height: calc(100vh - 140px);
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    .fullscreen-toc:hover {
      background: rgba(248, 250, 252, 0.9);
      border-color: rgba(96, 165, 250, 0.2);
      box-shadow: 0 4px 16px rgba(96, 165, 250, 0.08);
    }

    .fullscreen-toc-title {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toc-toggle-btn {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      font-size: 16px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }

    .toc-toggle-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .toc-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .toc-item {
      margin-bottom: 8px;
    }

    .toc-link {
      display: block;
      color: #4b5563;
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-size: 14px;
      line-height: 1.4;
      border-left: 3px solid transparent;
    }

    .toc-link:hover {
      background: #eff6ff;
      color: #3b82f6;
      border-left-color: #3b82f6;
      transform: translateX(2px);
    }

    .toc-link.active {
      background: rgba(96, 165, 250, 0.1);
      color: #3b82f6;
      border-left-color: #60a5fa;
      font-weight: 500;
      box-shadow: 0 1px 3px rgba(96, 165, 250, 0.1);
    }

    .toc-h1 { padding-left: 0; font-weight: 600; }
    .toc-h2 { padding-left: 12px; }
    .toc-h3 { padding-left: 24px; font-size: 13px; }
    .toc-h4 { padding-left: 36px; font-size: 13px; }
    .toc-h5 { padding-left: 48px; font-size: 12px; }
    .toc-h6 { padding-left: 60px; font-size: 12px; }

    .fullscreen-content-with-toc {
      flex: 1;
      min-width: 0;
    }

    /* 滚动条样式优化 */
    .fullscreen-toc::-webkit-scrollbar {
      width: 4px;
    }

    .fullscreen-toc::-webkit-scrollbar-track {
      background: rgba(241, 245, 249, 0.5);
      border-radius: 2px;
    }

    .fullscreen-toc::-webkit-scrollbar-thumb {
      background: rgba(203, 213, 225, 0.6);
      border-radius: 2px;
    }

    .fullscreen-toc::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.8);
    }

    /* 布局切换按钮 */
    .layout-toggle {
      display: flex;
      gap: 8px;
      margin-left: 16px;
    }

    .layout-btn {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      color: #374151;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 60px;
    }

    .layout-btn:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }

    .layout-btn.active {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      color: white;
      border-color: #60a5fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .container {
        padding: 16px;
        margin: 0;
      }
      
      .header {
        text-align: center;
        margin-bottom: 20px;
      }
      
      .header h1 {
        font-size: 24px;
        margin-bottom: 8px;
      }
      
      .categories {
        justify-content: center;
        gap: 8px;
        margin-bottom: 20px;
      }
      
      .category-tab {
        padding: 10px 16px;
        font-size: 14px;
        min-width: 80px;
      }
      
      .modules {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .module.techniques {
        grid-column: 1;
      }
      
      .module {
        padding: 16px;
        min-height: 200px;
      }
      
      .module-header {
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }
      
      .module-title {
        font-size: 16px;
      }
      
      .add-btn {
        font-size: 14px;
        padding: 10px 20px;
        width: 100%;
        max-width: 120px;
      }
      
      .item {
        padding: 12px;
      }
      
      .word-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .word-group-title {
        margin-right: 0;
      }

      .word-main {
        margin-right: 0;
      }
      
      .item-actions {
        justify-content: center;
        margin-left: 0;
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .action-btn {
        flex: 1;
        min-width: 60px;
        font-size: 12px;
      }
      
      .synonyms {
        gap: 8px;
        line-height: 1.8;
      }
      
      .synonym {
        padding: 4px 8px;
        font-size: 14px;
      }
      
      .hypernym-chain {
        font-size: 14px;
        line-height: 1.6;
      }
      
      .technique-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .technique-toggle {
        align-self: flex-end;
      }
      
      .items {
        overflow-y: visible;
        overflow-x: hidden;
      }

      .word-with-definition {
        min-width: 100px;
        padding: 6px 8px;
        margin: 2px;
        font-size: 12px;
      }

      .word-text {
        font-size: 13px;
        margin-bottom: 2px;
      }

      .word-definition {
        font-size: 11px;
      }

      .synonyms {
        gap: 4px;
      }

      .hypernym-chain {
        gap: 8px;
      }
      
      /* 模态框移动端适配 */
      .modal-content {
        width: 95vw;
        max-height: 90vh;
        padding: 20px;
        margin: 5vh auto;
      }
      
      .modal-header {
        font-size: 18px;
        text-align: center;
        margin-bottom: 20px;
      }
      
      .form-input, .form-textarea {
        font-size: 16px;
        padding: 12px;
      }
      
      .synonym-input-row {
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 12px;
      }
      
      .remove-synonym {
        justify-self: center;
        width: 80px;
      }
      
      .add-synonym {
        font-size: 14px;
        padding: 12px;
      }
      
      .btn {
        padding: 14px 24px;
        font-size: 16px;
        width: 100%;
        margin-bottom: 8px;
      }
      
      .modal-actions {
        flex-direction: column;
        gap: 12px;
      }
      
      /* 全屏模态框移动端适配 */
      .fullscreen-header {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }

      .fullscreen-title {
        font-size: 20px;
      }

      .fullscreen-actions {
        order: -1;
        justify-content: center;
      }

      .fullscreen-main {
        padding: 20px;
        flex-direction: column;
        gap: 20px;
      }

      .fullscreen-toc-float {
        position: static;
        transform: none;
        left: auto;
        top: auto;
        z-index: auto;
        margin-bottom: 20px;
      }

      .fullscreen-toc-float.collapsed {
        left: auto;
        opacity: 1;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10;
      }

      .fullscreen-toc.collapsed {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(96, 165, 250, 0.25);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(96, 165, 250, 0.25);
        border: 2px solid rgba(96, 165, 250, 0.5);
      }

      .fullscreen-toc.collapsed:hover {
        background: rgba(96, 165, 250, 0.35);
        box-shadow: 0 6px 20px rgba(96, 165, 250, 0.35);
        border-color: rgba(96, 165, 250, 0.7);
        transform: scale(1.05);
      }

      .fullscreen-toc {
        width: 100%;
        max-height: 200px;
        background: rgba(248, 250, 252, 0.9);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(226, 232, 240, 0.4);
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      }

      .fullscreen-toc:hover {
        background: rgba(248, 250, 252, 0.95);
        border-color: rgba(96, 165, 250, 0.3);
        box-shadow: 0 4px 12px rgba(96, 165, 250, 0.1);
      }

      .fullscreen-content {
        padding: 0;
        font-size: 15px;
        line-height: 1.7;
      }

      .fullscreen-edit-area {
        padding: 20px;
      }

      .fullscreen-textarea {
        font-size: 16px;
        padding: 16px;
        min-height: 400px;
      }

      /* 全屏词汇移动端适配 */
      .fullscreen-content .word-with-definition {
        min-width: 100px;
        padding: 8px 12px;
        margin: 4px;
        font-size: 14px;
      }

      .fullscreen-content .word-text {
        font-size: 14px;
        margin-bottom: 4px;
      }

      .fullscreen-content .word-definition {
        font-size: 12px;
      }

      .fullscreen-content .hypernym-chain {
        gap: 8px;
        padding: 4px;
      }

      .fullscreen-content .hypernym-separator {
        font-size: 14px;
      }

      .fullscreen-content .hypernym-arrow {
        font-size: 16px;
        margin: 0 8px;
      }

      /* 复制按钮移动端适配 */
      .copy-btn {
        top: 8px;
        right: 8px;
        padding: 6px 8px;
        font-size: 14px;
      }

      /* 排序按钮移动端适配 */
      .sort-btn {
        padding: 3px 4px;
        font-size: 11px;
        min-width: 24px;
        height: 24px;
      }

      /* 全屏排序按钮移动端适配 */
      .fullscreen-sort-btn {
        padding: 3px 4px;
        font-size: 11px;
        min-width: 24px;
        height: 24px;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 12px;
      }
      
      .header h1 {
        font-size: 22px;
      }
      
      .categories {
        gap: 6px;
      }
      
      .category-tab {
        padding: 8px 12px;
        font-size: 13px;
        min-width: 70px;
      }
      
      .module {
        padding: 12px;
      }
      
      .add-btn {
        font-size: 12px;
        padding: 8px 16px;
      }
      
      .synonym, .hypernym-word {
        font-size: 13px;
        padding: 3px 6px;
      }

      .word-with-definition {
        min-width: 80px;
        padding: 4px 6px;
        margin: 1px;
        font-size: 11px;
      }

      .word-text {
        font-size: 12px;
        margin-bottom: 1px;
      }

      .word-definition {
        font-size: 10px;
      }

      .synonyms {
        gap: 2px;
      }

      .hypernym-chain {
        gap: 4px;
      }

      .hypernym-separator {
        font-size: 12px;
      }

      .hypernym-arrow {
        font-size: 14px;
        margin: 0 4px;
      }

      /* 全屏词汇480px以下适配 */
      .fullscreen-content .word-with-definition {
        min-width: 80px;
        padding: 6px 8px;
        margin: 2px;
        font-size: 12px;
      }

      .fullscreen-content .word-text {
        font-size: 12px;
        margin-bottom: 2px;
      }

      .fullscreen-content .word-definition {
        font-size: 10px;
      }

      .fullscreen-content .hypernym-chain {
        gap: 4px;
        padding: 2px;
      }

      .fullscreen-content .hypernym-separator {
        font-size: 12px;
      }

      .fullscreen-content .hypernym-arrow {
        font-size: 14px;
        margin: 0 4px;
      }

      /* 480px以下复制按钮适配 */
      .copy-btn {
        top: 6px;
        right: 6px;
        padding: 4px 6px;
        font-size: 12px;
      }

      /* 480px以下排序按钮适配 */
      .sort-btn {
        padding: 2px 3px;
        font-size: 10px;
        min-width: 22px;
        height: 22px;
      }

      /* 480px以下全屏排序按钮适配 */
      .fullscreen-sort-btn {
        padding: 2px 3px;
        font-size: 10px;
        min-width: 22px;
        height: 22px;
      }
    }
    
    .item-actions {
      display: flex;
      gap: 6px;
      margin-left: auto;
      flex-shrink: 0;
    }
    
    .action-btn {
      background: #f8fafc;
      color: #475569;
      border: 1px solid #e2e8f0;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      min-width: 50px;
      text-align: center;
    }
    
    .action-btn:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
      transform: translateY(-1px);
    }
    
    .action-btn.delete {
      color: #dc2626;
      border-color: #fca5a5;
      background: #fef2f2;
    }
    
    .action-btn.delete:hover {
      background: #fee2e2;
      border-color: #dc2626;
      transform: translateY(-1px);
    }
    
    /* 复制按钮样式 */
    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #e2e8f0;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 16px;
      color: #475569;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .copy-btn:hover {
      background: #cbd5e1;
      border-color: #94a3b8;
      transform: translateY(-1px);
    }

    .copy-btn:active {
      transform: translateY(0);
    }

    .copy-btn.copied {
      background: #10b981;
      border-color: #059669;
      color: white;
    }

    /* 排序按钮样式 */
    .sort-controls {
      display: flex;
      gap: 2px;
      align-items: center;
      margin-left: 8px;
    }

    .sort-btn {
      background: transparent;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 4px 6px;
      cursor: pointer;
      font-size: 12px;
      color: #6b7280;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      line-height: 1;
    }

    .sort-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
      color: #374151;
    }

    .sort-btn.active {
      background: #eff6ff;
      color: #3b82f6;
      border-color: #60a5fa;
      font-weight: 500;
    }

    .sort-btn.active:hover {
      background: #dbeafe;
      border-color: #60a5fa;
    }

    /* 全屏排序按钮样式 */
    .fullscreen-sort-btn {
      background: transparent;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 4px 6px;
      cursor: pointer;
      font-size: 12px;
      color: #6b7280;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      line-height: 1;
    }

    .fullscreen-sort-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
      color: #374151;
    }

    .fullscreen-sort-btn.active {
      background: #eff6ff;
      color: #3b82f6;
      border-color: #60a5fa;
      font-weight: 500;
    }

    .fullscreen-sort-btn.active:hover {
      background: #dbeafe;
      border-color: #60a5fa;
    }

    /* 模态框样式 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2500;
      backdrop-filter: blur(4px);
    }
    
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: min(600px, 90vw);
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    .modal-header {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 16px;
      color: #1f2937;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #374151;
    }
    
    .form-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
      box-sizing: border-box;
      font-family: inherit;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-textarea {
      resize: none;
      min-height: 80px;
      font-family: inherit;
    }
    
    .synonym-inputs {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .synonym-input-row {
      display: grid;
      grid-template-columns: 1fr 2fr auto;
      gap: 12px;
      align-items: center;
      padding: 8px;
      background: #f8fafc;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    
    .remove-synonym {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .add-synonym {
      background: #10b981;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 80px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
      background: #f8fafc;
      color: #475569;
      border: 2px solid #e2e8f0;
    }
    
    .btn-secondary:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
      transform: translateY(-2px);
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f4f6;
      border-top: 2px solid #60a5fa;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .audio-playing {
      color: #10b981 !important;
      transform: scale(1.05);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 16px;
        border-radius: 16px;
      }
      
      .categories {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .modules {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .module {
        padding: 16px;
      }
      
      .modal-content {
        width: 95vw;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>学习技巧</h1>
      <div style="display: flex; align-items: center; gap: 16px;">
        <div id="userDisplay"></div>
        <a href="/" class="back-btn">← 返回主页</a>
      </div>
    </div>
    
    <div class="categories">
      <div class="category-tab active" data-category="listening">
        <span class="category-icon">🎧</span>
        <span class="category-name">Listening</span>
      </div>
      <div class="category-tab" data-category="speaking">
        <span class="category-icon">🎤</span>
        <span class="category-name">Speaking</span>
      </div>
      <div class="category-tab" data-category="reading">
        <span class="category-icon">📖</span>
        <span class="category-name">Reading</span>
      </div>
      <div class="category-tab" data-category="writing">
        <span class="category-icon">✍️</span>
        <span class="category-name">Writing</span>
      </div>
    </div>
    
    <div id="content-listening" class="content-area active">
      <div class="modules">
        <div class="module">
          <div class="module-header">
            <div class="module-title">📝 词汇替换</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="sort-controls">
                <button class="sort-btn active" onclick="sortItems('synonyms', 'listening', 'desc')" title="最新在前">
                  ↓
                </button>
                <button class="sort-btn" onclick="sortItems('synonyms', 'listening', 'asc')" title="最早在前">
                  ↑
                </button>
              </div>
              <button class="add-btn" onclick="openFullscreenSynonyms('listening')">全屏</button>
              <button class="add-btn" onclick="openFileUploadModal('synonym', 'listening')">用文件添加</button>
              <button class="add-btn" onclick="openSynonymModal('listening')">添加</button>
            </div>
          </div>
          <div class="items" id="synonyms-listening"></div>
        </div>
        
        <div class="module">
          <div class="module-header">
            <div class="module-title">🔗 上下义词</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="sort-controls">
                <button class="sort-btn active" onclick="sortItems('hypernyms', 'listening', 'desc')" title="最新在前">
                  ↓
                </button>
                <button class="sort-btn" onclick="sortItems('hypernyms', 'listening', 'asc')" title="最早在前">
                  ↑
                </button>
              </div>
              <button class="add-btn" onclick="openFullscreenHypernyms('listening')">全屏</button>
              <button class="add-btn" onclick="openFileUploadModal('hypernym', 'listening')">用文件添加</button>
              <button class="add-btn" onclick="openHypernymModal('listening')">添加</button>
            </div>
          </div>
          <div class="items" id="hypernyms-listening"></div>
        </div>
        
        <div class="module techniques">
          <div class="module-header">
            <div class="module-title">💡 做题技巧</div>
            <button class="add-btn" onclick="openTechniqueModal('listening')">添加</button>
          </div>
          <div class="items" id="techniques-listening"></div>
        </div>
      </div>
    </div>
    
    <div id="content-speaking" class="content-area">
      <div class="modules">
        <div class="module">
          <div class="module-header">
            <div class="module-title">📝 词汇替换</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="sort-controls">
                <button class="sort-btn active" onclick="sortItems('synonyms', 'speaking', 'desc')" title="最新在前">
                  ↓
                </button>
                <button class="sort-btn" onclick="sortItems('synonyms', 'speaking', 'asc')" title="最早在前">
                  ↑
                </button>
              </div>
              <button class="add-btn" onclick="openFullscreenSynonyms('speaking')">全屏</button>
              <button class="add-btn" onclick="openFileUploadModal('synonym', 'speaking')">用文件添加</button>
              <button class="add-btn" onclick="openSynonymModal('speaking')">添加</button>
            </div>
          </div>
          <div class="items" id="synonyms-speaking"></div>
        </div>

        <div class="module">
          <div class="module-header">
            <div class="module-title">🔗 上下义词</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="sort-controls">
                <button class="sort-btn active" onclick="sortItems('hypernyms', 'speaking', 'desc')" title="最新在前">
                  ↓
                </button>
                <button class="sort-btn" onclick="sortItems('hypernyms', 'speaking', 'asc')" title="最早在前">
                  ↑
                </button>
              </div>
              <button class="add-btn" onclick="openFullscreenHypernyms('speaking')">全屏</button>
              <button class="add-btn" onclick="openFileUploadModal('hypernym', 'speaking')">用文件添加</button>
              <button class="add-btn" onclick="openHypernymModal('speaking')">添加</button>
            </div>
          </div>
          <div class="items" id="hypernyms-speaking"></div>
        </div>
        
        <div class="module techniques">
          <div class="module-header">
            <div class="module-title">💡 做题技巧</div>
            <button class="add-btn" onclick="openTechniqueModal('speaking')">添加</button>
          </div>
          <div class="items" id="techniques-speaking"></div>
        </div>
      </div>
    </div>
    
    <div id="content-reading" class="content-area">
      <div class="modules">
        <div class="module">
          <div class="module-header">
            <div class="module-title">📝 词汇替换</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="sort-controls">
                <button class="sort-btn active" onclick="sortItems('synonyms', 'reading', 'desc')" title="最新在前">
                  ↓
                </button>
                <button class="sort-btn" onclick="sortItems('synonyms', 'reading', 'asc')" title="最早在前">
                  ↑
                </button>
              </div>
              <button class="add-btn" onclick="openFullscreenSynonyms('reading')">全屏</button>
              <button class="add-btn" onclick="openFileUploadModal('synonym', 'reading')">用文件添加</button>
              <button class="add-btn" onclick="openSynonymModal('reading')">添加</button>
            </div>
          </div>
          <div class="items" id="synonyms-reading"></div>
        </div>

        <div class="module">
          <div class="module-header">
            <div class="module-title">🔗 上下义词</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="sort-controls">
                <button class="sort-btn active" onclick="sortItems('hypernyms', 'reading', 'desc')" title="最新在前">
                  ↓
                </button>
                <button class="sort-btn" onclick="sortItems('hypernyms', 'reading', 'asc')" title="最早在前">
                  ↑
                </button>
              </div>
              <button class="add-btn" onclick="openFullscreenHypernyms('reading')">全屏</button>
              <button class="add-btn" onclick="openFileUploadModal('hypernym', 'reading')">用文件添加</button>
              <button class="add-btn" onclick="openHypernymModal('reading')">添加</button>
            </div>
          </div>
          <div class="items" id="hypernyms-reading"></div>
        </div>
        
        <div class="module techniques">
          <div class="module-header">
            <div class="module-title">💡 做题技巧</div>
            <button class="add-btn" onclick="openTechniqueModal('reading')">添加</button>
          </div>
          <div class="items" id="techniques-reading"></div>
        </div>
      </div>
    </div>
    
    <div id="content-writing" class="content-area">
      <div class="modules">
        <div class="module">
          <div class="module-header">
            <div class="module-title">📝 词汇替换</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="sort-controls">
                <button class="sort-btn active" onclick="sortItems('synonyms', 'writing', 'desc')" title="最新在前">
                  ↓
                </button>
                <button class="sort-btn" onclick="sortItems('synonyms', 'writing', 'asc')" title="最早在前">
                  ↑
                </button>
              </div>
              <button class="add-btn" onclick="openFullscreenSynonyms('writing')">全屏</button>
              <button class="add-btn" onclick="openFileUploadModal('synonym', 'writing')">用文件添加</button>
              <button class="add-btn" onclick="openSynonymModal('writing')">添加</button>
            </div>
          </div>
          <div class="items" id="synonyms-writing"></div>
        </div>

        <div class="module">
          <div class="module-header">
            <div class="module-title">🔗 上下义词</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="sort-controls">
                <button class="sort-btn active" onclick="sortItems('hypernyms', 'writing', 'desc')" title="最新在前">
                  ↓
                </button>
                <button class="sort-btn" onclick="sortItems('hypernyms', 'writing', 'asc')" title="最早在前">
                  ↑
                </button>
              </div>
              <button class="add-btn" onclick="openFullscreenHypernyms('writing')">全屏</button>
              <button class="add-btn" onclick="openFileUploadModal('hypernym', 'writing')">用文件添加</button>
              <button class="add-btn" onclick="openHypernymModal('writing')">添加</button>
            </div>
          </div>
          <div class="items" id="hypernyms-writing"></div>
        </div>
        
        <div class="module techniques">
          <div class="module-header">
            <div class="module-title">💡 做题技巧</div>
            <button class="add-btn" onclick="openTechniqueModal('writing')">添加</button>
          </div>
          <div class="items" id="techniques-writing"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 同义词模态框 -->
  <div id="synonymModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">添加词汇替换</div>
      <form id="synonymForm">
        <div class="form-group">
          <label class="form-label">组标题（可选）</label>
          <input type="text" id="synonymTitle" class="form-input" placeholder="请输入词汇组的标题">
        </div>
        <div class="form-group">
          <label class="form-label">同义词组</label>
          <div id="synonymInputs" class="synonym-inputs">
            <div class="synonym-input-row">
              <input type="text" placeholder="同义词" class="form-input synonym-word">
              <input type="text" placeholder="释义" class="form-input synonym-def">
              <button type="button" class="remove-synonym" onclick="removeSynonymInput(this)">删除</button>
            </div>
          </div>
          <button type="button" class="add-synonym" onclick="addSynonymInput()">+ 添加同义词</button>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 上下义词模态框 -->
  <div id="hypernymModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">添加上下义词</div>
      <form id="hypernymForm">
        <div class="form-group">
          <label class="form-label">组标题（可选）</label>
          <input type="text" id="hypernymTitle" class="form-input" placeholder="请输入上下义词组的标题">
        </div>
        <div class="form-group">
          <label class="form-label">上义词</label>
          <div id="hypernymUpperInputs" class="synonym-inputs">
            <div class="synonym-input-row">
              <input type="text" placeholder="上义词" class="form-input hypernym-word">
              <input type="text" placeholder="释义" class="form-input hypernym-def">
              <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, 'upper')">删除</button>
            </div>
          </div>
          <button type="button" class="add-synonym" onclick="addHypernymInput('upper')">+ 添加上义词</button>
        </div>
        <div class="form-group">
          <label class="form-label">下义词</label>
          <div id="hypernymLowerInputs" class="synonym-inputs">
            <div class="synonym-input-row">
              <input type="text" placeholder="下义词" class="form-input hypernym-word">
              <input type="text" placeholder="释义" class="form-input hypernym-def">
              <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, 'lower')">删除</button>
            </div>
          </div>
          <button type="button" class="add-synonym" onclick="addHypernymInput('lower')">+ 添加下义词</button>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 做题技巧模态框 -->
  <div id="techniqueModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">添加做题技巧</div>
      <form id="techniqueForm">
        <div class="form-group">
          <label class="form-label">标题</label>
          <input type="text" id="techniqueTitle" class="form-input" placeholder="请输入技巧标题" required>
        </div>
        <div class="form-group">
          <label class="form-label">内容（支持Markdown语法）</label>
          <textarea id="techniqueContent" class="form-input form-textarea" placeholder="请输入技巧内容，支持Markdown语法如 **粗体** *斜体* # 标题 - 列表等" style="min-height: 150px;"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 文件上传模态框 -->
  <div id="fileUploadModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">用文件添加</div>
      <form id="fileUploadForm">
        <div class="form-group">
          <label class="form-label">选择JSON文件</label>
          <input type="file" id="jsonFile" class="form-input" accept=".json" required>
          <div style="margin-top: 8px; font-size: 14px; color: #6b7280;">
            支持上传JSON格式的文件，包含多组词汇数据
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">JSON格式说明</label>
          <div style="position: relative;">
            <div id="jsonFormatExample" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-top: 8px; font-size: 14px; color: #374151; font-family: 'Courier New', monospace; white-space: pre-wrap; overflow-x: auto;"></div>
            <button id="copyJsonFormatBtn" class="copy-btn" title="复制格式说明" onclick="copyJsonFormat()">
              📋
            </button>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
          <button type="submit" class="btn btn-primary">上传并导入</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentToken = null;
    let currentUser = null;
    let currentCategory = 'listening';
    
    // 身份验证相关
    function checkStoredToken(){
      const tk = localStorage.getItem('authToken');
      if(!tk) return Promise.resolve(false);
      return fetch('/verify_token',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({token:tk})})
        .then(r=>r.json()).then(d=>{ 
          if(d.valid){ 
            currentToken=tk; 
            const userStr = localStorage.getItem('currentUser');
            if(userStr) {
              try {
                currentUser = JSON.parse(userStr);
              } catch(e) {}
            }
            return true;
          } 
          localStorage.removeItem('authToken'); 
          localStorage.removeItem('currentUser');
          return false; 
        })
        .catch(()=>{ 
          localStorage.removeItem('authToken'); 
          localStorage.removeItem('currentUser');
          return false; 
        });
    }
    
    function redirectToLogin() {
      window.location.href = '/login';
    }
    
    function showUserInfo() {
      if(currentUser) {
        const userDisplay = document.getElementById('userDisplay');
        if(userDisplay) {
          userDisplay.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
              <img src="/static/${currentUser.avatar}" alt="${currentUser.display_name}" style="width: 24px; height: 24px; border-radius: 50%;">
              <span style="color: #374151; font-weight: 600;">${currentUser.display_name}</span>
            </div>
          `;
        }
      }
    }
    
    // 分类切换
    function switchCategory(category) {
      currentCategory = category;
      
      // 更新分类标签状态
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-category="${category}"]`).classList.add('active');
      
      // 更新内容区域
      document.querySelectorAll('.content-area').forEach(area => {
        area.classList.remove('active');
      });
      document.getElementById(`content-${category}`).classList.add('active');
      
      // 加载数据
      loadData(category);
    }
    
    // 初始化事件监听
    function initEventListeners() {
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          switchCategory(tab.dataset.category);
        });
      });
    }
    
    // 加载数据
    async function loadData(category) {
      console.log(`正在加载数据: ${category}`);

      try {
        const [synonyms, hypernyms, techniques] = await Promise.all([
          fetch(`/api/study_techniques/synonyms/${category}`, {
            headers: { 'Authorization': `Bearer ${currentToken}` }
          }).then(r => r.json()),
          fetch(`/api/study_techniques/hypernyms/${category}`, {
            headers: { 'Authorization': `Bearer ${currentToken}` }
          }).then(r => r.json()),
          fetch(`/api/study_techniques/techniques/${category}`, {
            headers: { 'Authorization': `Bearer ${currentToken}` }
          }).then(r => r.json())
        ]);

        console.log(`数据加载完成:`, {
          synonyms: synonyms.length,
          hypernyms: hypernyms.length,
          techniques: techniques.length
        });

        // 存储数据到全局变量
        if (!currentData[category]) currentData[category] = {};
        currentData[category].synonyms = synonyms;
        currentData[category].hypernyms = hypernyms;
        currentData[category].techniques = techniques;

        renderSynonyms(category, synonyms);
        renderHypernyms(category, hypernyms);
        renderTechniques(category, techniques);

        console.log(`数据渲染完成: ${category}`);
      } catch (error) {
        console.error('Failed to load data:', error);
      }
    }
    
    // 渲染同义词
    function renderSynonyms(category, data) {
      const container = document.getElementById(`synonyms-${category}`);
      container.innerHTML = '';

      if (data && data.length > 0) {
        data.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div class="word-item">
              <div class="word-header">
                <div class="word-group-title" onclick="editTitle(this, '${category}', '${item.id}', 'synonym')" contenteditable="false">${item.title || '同义词组 ' + (index + 1)}</div>
                <div class="item-actions">
                  <button class="action-btn" onclick="editSynonym('${category}', '${item.id}')">编辑</button>
                  <button class="action-btn delete" onclick="deleteSynonym('${category}', '${item.id}')">删除</button>
                </div>
              </div>
              <div class="word-main">
                <div class="synonyms">
                  ${item.synonyms.map(syn =>
                    `<div class="word-with-definition">
                      <div class="word-text">${syn.word}</div>
                      ${syn.definition ? `<div class="word-definition">${syn.definition}</div>` : ''}
                    </div>`
                  ).join('')}
                </div>
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">暂无词汇替换数据</div>';
      }
    }
    
    // 渲染上下义词
    function renderHypernyms(category, data) {
      const container = document.getElementById(`hypernyms-${category}`);
      container.innerHTML = '';

      if (data && data.length > 0) {
        data.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'item';

          let chainHtml = '<div class="hypernym-chain">';

          // 渲染上义词
          if (item.upper_words && item.upper_words.length > 0) {
            item.upper_words.forEach((upper, index) => {
              if (index > 0) chainHtml += '<span class="hypernym-separator">, </span>';
              chainHtml += `<div class="word-with-definition">
                <div class="word-text">${upper.word}</div>
                ${upper.definition ? `<div class="word-definition">${upper.definition}</div>` : ''}
              </div>`;
            });
            chainHtml += '<span class="hypernym-arrow"> → </span>';
          }

          // 渲染下义词
          if (item.lower_words && item.lower_words.length > 0) {
            item.lower_words.forEach((lower, index) => {
              if (index > 0) chainHtml += '<span class="hypernym-separator">, </span>';
              chainHtml += `<div class="word-with-definition">
                <div class="word-text">${lower.word}</div>
                ${lower.definition ? `<div class="word-definition">${lower.definition}</div>` : ''}
              </div>`;
            });
          }

          chainHtml += '</div>';

          div.innerHTML = `
            <div class="word-item">
              <div class="word-header">
                <div class="word-group-title" onclick="editTitle(this, '${category}', '${item.id}', 'hypernym')" contenteditable="false">${item.title || '上下义词组 ' + (index + 1)}</div>
                <div class="item-actions">
                  <button class="action-btn" onclick="editHypernym('${category}', '${item.id}')">编辑</button>
                  <button class="action-btn delete" onclick="deleteHypernym('${category}', '${item.id}')">删除</button>
                </div>
              </div>
              <div class="word-main">
                ${chainHtml}
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">暂无上下义词数据</div>';
      }
    }
    
    // 渲染做题技巧
    function renderTechniques(category, data) {
      const container = document.getElementById(`techniques-${category}`);
      container.innerHTML = '';

      if (data && data.length > 0) {
        data.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'item technique-item';
          const contentId = `technique-content-${category}-${index}`;
          div.innerHTML = `
            <div class="word-item">
              <div class="word-main">
                <div class="technique-header">
                  <div class="technique-title">${item.title}</div>
                  <button class="technique-toggle" onclick="toggleTechnique('${contentId}', this)">展开 ▼</button>
                </div>
                <div class="technique-content" id="${contentId}">
                  ${renderMarkdown(item.content)}
                </div>
              </div>
              <div class="item-actions">
                <button class="action-btn" onclick="openFullscreenTechnique('${category}', '${item.id}')">全屏</button>
                <button class="action-btn" onclick="editTechnique('${category}', '${item.id}')">编辑</button>
                <button class="action-btn delete" onclick="deleteTechnique('${category}', '${item.id}')">删除</button>
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">暂无做题技巧数据</div>';
      }
    }
    
    // 编辑标题
    function editTitle(element, category, id, type) {
      const originalText = element.textContent.trim();

      element.contentEditable = true;
      element.classList.add('editing');
      element.focus();

      // 选中全部文本
      const range = document.createRange();
      range.selectNodeContents(element);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);

      function saveTitle() {
        const newTitle = element.textContent.trim();
        if (newTitle && newTitle !== originalText) {
          updateTitle(category, id, type, newTitle);
        } else {
          element.textContent = originalText;
        }
        element.contentEditable = false;
        element.classList.remove('editing');
      }

      function cancelEdit() {
        element.textContent = originalText;
        element.contentEditable = false;
        element.classList.remove('editing');
      }

      element.onblur = saveTitle;
      element.onkeydown = function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveTitle();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      };
    }

    // 更新标题
    async function updateTitle(category, id, type, newTitle) {
      console.log('Updating title:', {category, id, type, newTitle});

      try {
        // 找到对应的item
        let item;
        if (currentData[category]) {
          if (type === 'synonym') {
            item = currentData[category].synonyms.find(item => item.id === id);
          } else if (type === 'hypernym') {
            item = currentData[category].hypernyms.find(item => item.id === id);
          }
        }

        if (!item) {
          console.error('Item not found:', {category, id, type});
          return;
        }

        let url;
        if (type === 'synonym') {
          url = `/api/study_techniques/synonyms/${category}/${id}`;
        } else if (type === 'hypernym') {
          url = `/api/study_techniques/hypernyms/${category}/${id}`;
        }

        const requestData = {
          title: newTitle,
          // 保留原有数据
          ...(type === 'synonym' ? { synonyms: item.synonyms } : {
            upper_words: item.upper_words || [],
            lower_words: item.lower_words || []
          })
        };

        console.log('Sending request:', {url, data: requestData});

        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify(requestData)
        });

        console.log('Response status:', response.status);

        if (response.ok) {
          const result = await response.json();
          console.log('Update successful:', result);

          // 更新本地数据
          if (currentData[category]) {
            if (type === 'synonym') {
              const item = currentData[category].synonyms.find(item => item.id === id);
              if (item) item.title = newTitle;
            } else if (type === 'hypernym') {
              const item = currentData[category].hypernyms.find(item => item.id === id);
              if (item) item.title = newTitle;
            }
          }
        } else {
          const errorText = await response.text();
          console.error('Failed to update title:', response.status, errorText);
          alert('更新标题失败，请重试');
        }
      } catch (error) {
        console.error('Error updating title:', error);
        alert('更新标题时发生错误，请重试');
      }
    }

    // 切换技巧内容显示
    function toggleTechnique(contentId, button) {
      const content = document.getElementById(contentId);
      const isExpanded = content.classList.contains('expanded');

      if (isExpanded) {
        content.classList.remove('expanded');
        button.innerHTML = '展开 ▼';
      } else {
        content.classList.add('expanded');
        button.innerHTML = '收起 ▲';
      }
    }
    
    
    // 模态框操作
    function openSynonymModal(category) {
      document.getElementById('synonymForm').reset();
      document.getElementById('synonymTitle').value = '';
      document.getElementById('synonymInputs').innerHTML = `
        <div class="synonym-input-row">
          <input type="text" placeholder="同义词" class="form-input synonym-word">
          <input type="text" placeholder="释义" class="form-input synonym-def">
          <button type="button" class="remove-synonym" onclick="removeSynonymInput(this)">删除</button>
        </div>
      `;
      document.getElementById('synonymModal').classList.add('show');
    }
    
    function openHypernymModal(category) {
      document.getElementById('hypernymForm').reset();
      document.getElementById('hypernymTitle').value = '';

      // 重置上义词输入
      document.getElementById('hypernymUpperInputs').innerHTML = `
        <div class="synonym-input-row">
          <input type="text" placeholder="上义词" class="form-input hypernym-word">
          <input type="text" placeholder="释义" class="form-input hypernym-def">
          <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, 'upper')">删除</button>
        </div>
      `;
      
      // 重置下义词输入
      document.getElementById('hypernymLowerInputs').innerHTML = `
        <div class="synonym-input-row">
          <input type="text" placeholder="下义词" class="form-input hypernym-word">
          <input type="text" placeholder="释义" class="form-input hypernym-def">
          <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, 'lower')">删除</button>
        </div>
      `;
      
      document.getElementById('hypernymModal').classList.add('show');
    }
    
    function openTechniqueModal(category) {
      document.getElementById('techniqueForm').reset();
      document.getElementById('techniqueModal').classList.add('show');
    }
    
    function closeModal() {
      // 保存编辑项信息（如果存在），因为后面的操作会将其设为null
      const wasFullscreenEdit = editingItem && editingItem.isFullscreen;
      const editType = editingItem ? editingItem.type : null;
      const editCategory = editingItem ? editingItem.category : null;

      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('show');
      });

      // 检查是否是从全屏状态编辑的
      if (wasFullscreenEdit) {
        // 从全屏状态编辑，重新打开全屏模态框
        if (editType === 'synonym') {
          openFullscreenSynonyms(editCategory);
        } else if (editType === 'hypernym') {
          openFullscreenHypernyms(editCategory);
        }
      }

      // 重置编辑状态和模态框标题
      editingItem = null;
      currentUploadType = null;
      currentUploadCategory = null;
      document.querySelector('#synonymModal .modal-header').textContent = '添加词汇替换';
      document.querySelector('#hypernymModal .modal-header').textContent = '添加上下义词';
      document.querySelector('#techniqueModal .modal-header').textContent = '添加做题技巧';

      // 重置文件上传表单
      document.getElementById('fileUploadForm').reset();
    }

    // 复制功能
    async function copyJsonFormat() {
      const formatExample = document.getElementById('jsonFormatExample');
      const copyBtn = document.getElementById('copyJsonFormatBtn');

      try {
        // 获取纯文本内容（去除HTML标签）
        const textToCopy = formatExample.textContent || formatExample.innerText;

        await navigator.clipboard.writeText(textToCopy);

        // 视觉反馈
        copyBtn.innerHTML = '✅';
        copyBtn.classList.add('copied');
        copyBtn.title = '已复制！';

        // 3秒后恢复原状
        setTimeout(() => {
          copyBtn.innerHTML = '📋';
          copyBtn.classList.remove('copied');
          copyBtn.title = '复制格式说明';
        }, 3000);

      } catch (error) {
        console.error('复制失败:', error);

        // 降级方案：使用传统的方法
        try {
          const textArea = document.createElement('textarea');
          textArea.value = formatExample.textContent || formatExample.innerText;
          textArea.style.position = 'fixed';
          textArea.style.left = '-9999px';
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);

          copyBtn.innerHTML = '✅';
          copyBtn.classList.add('copied');
          copyBtn.title = '已复制！';

          setTimeout(() => {
            copyBtn.innerHTML = '📋';
            copyBtn.classList.remove('copied');
            copyBtn.title = '复制格式说明';
          }, 3000);

        } catch (fallbackError) {
          console.error('降级复制也失败:', fallbackError);
          alert('复制失败，请手动选择文本复制');
        }
      }
    }

    // 排序功能
    function sortItems(type, category, order) {
      const containerId = `${type}-${category}`;
      const container = document.getElementById(containerId);

      if (!container) return;

      // 更新排序按钮状态
      const sortControls = container.closest('.module').querySelector('.sort-controls');
      if (sortControls) {
        sortControls.querySelectorAll('.sort-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
      }

      // 获取数据并排序
      const data = currentData[category]?.[type] || [];

      if (data.length === 0) return;

      // 按创建时间排序
      const sortedData = [...data].sort((a, b) => {
        const dateA = new Date(a.created_at);
        const dateB = new Date(b.created_at);

        if (order === 'asc') {
          return dateA - dateB; // 最早的在前
        } else {
          return dateB - dateA; // 最新的在前
        }
      });

      // 更新本地数据
      if (!currentData[category]) currentData[category] = {};
      currentData[category][type] = sortedData;

      // 重新渲染
      if (type === 'synonyms') {
        renderSynonyms(category, sortedData);
      } else if (type === 'hypernyms') {
        renderHypernyms(category, sortedData);
      }
    }

    // 文件上传相关函数
    function openFileUploadModal(type, category) {
      currentUploadType = type;
      currentUploadCategory = category;

      // 设置格式说明
      const formatExample = document.getElementById('jsonFormatExample');
      if (type === 'synonym') {
        formatExample.innerHTML = `词汇替换JSON格式示例：
{
  "groups": [
    {
      "title": "描述外貌的词汇",
      "synonyms": [
        {"word": "beautiful", "definition": "美丽的"},
        {"word": "attractive", "definition": "有吸引力的"},
        {"word": "gorgeous", "definition": "华丽的"}
      ]
    },
    {
      "title": "表达喜欢的词汇",
      "synonyms": [
        {"word": "like", "definition": "喜欢"},
        {"word": "enjoy", "definition": "享受"},
        {"word": "love", "definition": "热爱"}
      ]
    }
  ]
}`;
      } else if (type === 'hypernym') {
        formatExample.innerHTML = `上下义词JSON格式示例：
{
  "groups": [
    {
      "title": "交通工具",
      "upper_words": [
        {"word": "transportation", "definition": "运输"}
      ],
      "lower_words": [
        {"word": "car", "definition": "汽车"},
        {"word": "bus", "definition": "公共汽车"},
        {"word": "train", "definition": "火车"}
      ]
    },
    {
      "title": "颜色",
      "upper_words": [
        {"word": "color", "definition": "颜色"}
      ],
      "lower_words": [
        {"word": "red", "definition": "红色"},
        {"word": "blue", "definition": "蓝色"},
        {"word": "green", "definition": "绿色"}
      ]
    }
  ]
}`;
      }

      document.getElementById('fileUploadModal').classList.add('show');
    }

    async function handleFileUpload(event) {
      event.preventDefault();

      const fileInput = document.getElementById('jsonFile');
      const file = fileInput.files[0];

      if (!file) {
        alert('请选择要上传的文件');
        return;
      }

      // 检查文件类型
      if (!file.name.toLowerCase().endsWith('.json')) {
        alert('只支持上传JSON格式的文件');
        return;
      }

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        // 验证数据格式
        if (!data.groups || !Array.isArray(data.groups)) {
          alert('JSON格式错误：缺少groups数组或格式不正确');
          return;
        }

        // 验证每组数据的格式
        for (let i = 0; i < data.groups.length; i++) {
          const group = data.groups[i];

          if (currentUploadType === 'synonym') {
            if (!group.synonyms || !Array.isArray(group.synonyms)) {
              alert(`第${i + 1}组数据格式错误：词汇替换需要包含synonyms数组`);
              return;
            }
          } else if (currentUploadType === 'hypernym') {
            if ((!group.upper_words || !Array.isArray(group.upper_words)) &&
                (!group.lower_words || !Array.isArray(group.lower_words))) {
              alert(`第${i + 1}组数据格式错误：上下义词需要包含upper_words或lower_words数组`);
              return;
            }
          }
        }

        // 开始上传数据
        await uploadDataInBatches(data.groups);

      } catch (error) {
        console.error('文件解析失败:', error);
        alert('文件解析失败，请检查JSON格式是否正确');
      }
    }

    async function uploadDataInBatches(groups) {
      let successCount = 0;
      let errorCount = 0;

      for (let i = 0; i < groups.length; i++) {
        const group = groups[i];

        try {
          let url;
          let requestData;

          if (currentUploadType === 'synonym') {
            url = `/api/study_techniques/synonyms/${currentUploadCategory}`;
            requestData = {
              title: group.title || `词汇组 ${i + 1}`,
              synonyms: group.synonyms
            };
          } else if (currentUploadType === 'hypernym') {
            url = `/api/study_techniques/hypernyms/${currentUploadCategory}`;
            requestData = {
              title: group.title || `上下义词组 ${i + 1}`,
              upper_words: group.upper_words || [],
              lower_words: group.lower_words || []
            };
          }

          console.log(`正在上传第${i + 1}组数据:`, requestData);

          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${currentToken}`
            },
            body: JSON.stringify(requestData)
          });

          console.log(`第${i + 1}组响应状态:`, response.status);

          if (response.ok) {
            const result = await response.json();
            console.log(`第${i + 1}组上传成功:`, result);
            successCount++;
          } else {
            const errorText = await response.text();
            console.error(`上传第${i + 1}组失败:`, response.status, errorText);
            errorCount++;
          }

        } catch (error) {
          errorCount++;
          console.error(`上传第${i + 1}组时发生错误:`, error);
        }
      }

      // 显示结果
      if (errorCount === 0) {
        alert(`成功上传 ${successCount} 组数据`);
      } else {
        alert(`上传完成：成功 ${successCount} 组，失败 ${errorCount} 组。请检查控制台了解详细错误信息。`);
      }

      // 刷新数据
      loadData(currentUploadCategory);
      closeModal();
    }
    
    // 全屏功能
    function openFullscreenSynonyms(category) {
      const data = currentData[category]?.synonyms || [];
      if (data.length === 0) {
        alert('暂无词汇替换数据');
        return;
      }

      // 设置全屏排序状态
      fullscreenType = 'synonyms';
      fullscreenCategory = category;

      // 显示排序控件
      const sortControls = document.getElementById('fullscreenSortControls');
      sortControls.style.display = 'flex';

      // 重置排序按钮状态
      sortControls.querySelectorAll('.fullscreen-sort-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      sortControls.querySelector('[onclick*="desc"]').classList.add('active');

      let contentHtml = '<div style="display: flex; flex-direction: column; gap: 16px;">';

      data.forEach(item => {
        contentHtml += '<div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: white;">';
        contentHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
        contentHtml += `<h3 style="margin: 0; color: #1f2937; font-size: 16px; font-weight: 600;">${item.title || '未命名'}</h3>`;
        contentHtml += '<div style="display: flex; gap: 8px;">';
        contentHtml += `<button class="action-btn" onclick="editFullscreenSynonym('${category}', '${item.id}')" style="font-size: 12px; padding: 4px 8px;">编辑</button>`;
        contentHtml += `<button class="action-btn delete" onclick="deleteFullscreenSynonym('${category}', '${item.id}')" style="font-size: 12px; padding: 4px 8px;">删除</button>`;
        contentHtml += '</div>';
        contentHtml += '</div>';
        contentHtml += '<div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start;">';

        item.synonyms.forEach(syn => {
          contentHtml += `
            <div class="word-with-definition">
              <div class="word-text">${syn.word}</div>
              ${syn.definition ? `<div class="word-definition">${syn.definition}</div>` : ''}
            </div>
          `;
        });

        contentHtml += '</div></div>';
      });

      contentHtml += '</div>';

      document.getElementById('fullscreenTitle').textContent = `${getCategoryName(category)} - 词汇替换`;
      document.getElementById('fullscreenContent').innerHTML = contentHtml;

      // 隐藏编辑功能
      document.getElementById('fullscreenEditBtn').style.display = 'none';
      document.getElementById('fullscreenSaveBtn').style.display = 'none';

      document.getElementById('fullscreenModal').classList.add('show');
    }

    function openFullscreenHypernyms(category) {
      const data = currentData[category]?.hypernyms || [];
      if (data.length === 0) {
        alert('暂无上下义词数据');
        return;
      }

      // 设置全屏排序状态
      fullscreenType = 'hypernyms';
      fullscreenCategory = category;

      // 显示排序控件
      const sortControls = document.getElementById('fullscreenSortControls');
      sortControls.style.display = 'flex';

      // 重置排序按钮状态
      sortControls.querySelectorAll('.fullscreen-sort-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      sortControls.querySelector('[onclick*="desc"]').classList.add('active');

      let contentHtml = '<div style="display: flex; flex-direction: column; gap: 16px;">';

      data.forEach(item => {
        contentHtml += '<div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: white;">';
        contentHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
        contentHtml += `<h3 style="margin: 0; color: #1f2937; font-size: 16px; font-weight: 600;">${item.title || '未命名'}</h3>`;
        contentHtml += '<div style="display: flex; gap: 8px;">';
        contentHtml += `<button class="action-btn" onclick="editFullscreenHypernym('${category}', '${item.id}')" style="font-size: 12px; padding: 4px 8px;">编辑</button>`;
        contentHtml += `<button class="action-btn delete" onclick="deleteFullscreenHypernym('${category}', '${item.id}')" style="font-size: 12px; padding: 4px 8px;">删除</button>`;
        contentHtml += '</div>';
        contentHtml += '</div>';
        contentHtml += '<div class="hypernym-chain">';

        // 渲染上义词
        if (item.upper_words && item.upper_words.length > 0) {
          item.upper_words.forEach((upper, index) => {
            if (index > 0) contentHtml += '<span class="hypernym-separator">, </span>';
            contentHtml += `
              <div class="word-with-definition">
                <div class="word-text">${upper.word}</div>
                ${upper.definition ? `<div class="word-definition">${upper.definition}</div>` : ''}
              </div>
            `;
          });
          contentHtml += '<span class="hypernym-arrow"> → </span>';
        }

        // 渲染下义词
        if (item.lower_words && item.lower_words.length > 0) {
          item.lower_words.forEach((lower, index) => {
            if (index > 0) contentHtml += '<span class="hypernym-separator">, </span>';
            contentHtml += `
              <div class="word-with-definition">
                <div class="word-text">${lower.word}</div>
                ${lower.definition ? `<div class="word-definition">${lower.definition}</div>` : ''}
              </div>
            `;
          });
        }

        contentHtml += '</div></div>';
      });

      contentHtml += '</div>';

      document.getElementById('fullscreenTitle').textContent = `${getCategoryName(category)} - 上下义词`;
      document.getElementById('fullscreenContent').innerHTML = contentHtml;

      // 隐藏编辑功能
      document.getElementById('fullscreenEditBtn').style.display = 'none';
      document.getElementById('fullscreenSaveBtn').style.display = 'none';

      document.getElementById('fullscreenModal').classList.add('show');
    }

    function getCategoryName(category) {
      const names = {
        'listening': 'Listening',
        'speaking': 'Speaking',
        'reading': 'Reading',
        'writing': 'Writing'
      };
      return names[category] || category;
    }

    function openFullscreenTechnique(category, id) {
      const data = currentData[category]?.techniques || [];
      const item = data.find(item => item.id === id);
      if (!item) return;

      fullscreenTechnique = {category, id, item};
      document.getElementById('fullscreenTitle').textContent = item.title;

      // 渲染Markdown内容并生成目录
      const renderedContent = renderMarkdown(item.content);
      document.getElementById('fullscreenContent').innerHTML = renderedContent;
      document.getElementById('fullscreenTextarea').value = item.content;

      // 生成并显示目录
      generateTableOfContents(item.content);

      // 应用用户偏好的布局
      loadFullscreenLayoutPreference();

      // 显示布局切换控件
      document.getElementById('layoutToggle').style.display = 'flex';

      // 重置到查看模式
      document.getElementById('fullscreenContent').style.display = 'block';
      document.getElementById('fullscreenEditArea').classList.remove('active');
      document.getElementById('fullscreenEditBtn').style.display = 'inline-block';
      document.getElementById('fullscreenSaveBtn').style.display = 'none';

      document.getElementById('fullscreenModal').classList.add('show');
    }
    
    function closeFullscreenModal() {
      document.getElementById('fullscreenModal').classList.remove('show');
      fullscreenTechnique = null;

      // 隐藏排序控件
      const sortControls = document.getElementById('fullscreenSortControls');
      sortControls.style.display = 'none';

      // 隐藏布局切换控件
      const layoutToggle = document.getElementById('layoutToggle');
      layoutToggle.style.display = 'none';

      // 隐藏目录
      const tocFloat = document.getElementById('fullscreenTocFloat');
      tocFloat.style.display = 'none';

      // 清理目录相关事件监听器
      const tocContainer = document.getElementById('tocList');
      const tocWrapper = document.getElementById('fullscreenToc');
      const contentContainer = document.querySelector('.fullscreen-modal');
      tocContainer.removeEventListener('click', handleTocClick);
      if (tocWrapper._handleTocInteraction) {
        tocWrapper.removeEventListener('click', tocWrapper._handleTocInteraction);
        delete tocWrapper._handleTocInteraction;
      }
      contentContainer.removeEventListener('scroll', updateActiveTocItem);

      // 清空目录内容
      tocContainer.innerHTML = '';

      // 重置全屏状态
      fullscreenType = null;
      fullscreenCategory = null;
    }

    // 全屏排序功能
    function sortFullscreenItems(order) {
      if (!fullscreenType || !fullscreenCategory) return;

      const data = currentData[fullscreenCategory]?.[fullscreenType] || [];
      if (data.length === 0) return;

      // 更新排序按钮状态
      const sortControls = document.getElementById('fullscreenSortControls');
      sortControls.querySelectorAll('.fullscreen-sort-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // 按创建时间排序
      const sortedData = [...data].sort((a, b) => {
        const dateA = new Date(a.created_at);
        const dateB = new Date(b.created_at);

        if (order === 'asc') {
          return dateA - dateB; // 最早的在前
        } else {
          return dateB - dateA; // 最新的在前
        }
      });

      // 重新渲染全屏内容
      if (fullscreenType === 'synonyms') {
        renderFullscreenSynonyms(sortedData);
      } else if (fullscreenType === 'hypernyms') {
        renderFullscreenHypernyms(sortedData);
      }
    }

    // 渲染全屏词汇替换
    function renderFullscreenSynonyms(data) {
      let contentHtml = '<div style="display: flex; flex-direction: column; gap: 16px;">';

      data.forEach(item => {
        contentHtml += '<div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: white;">';
        contentHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
        contentHtml += `<h3 style="margin: 0; color: #1f2937; font-size: 16px; font-weight: 600;">${item.title || '未命名'}</h3>`;
        contentHtml += `<button class="action-btn delete" onclick="deleteFullscreenSynonym('${fullscreenCategory}', '${item.id}')" style="font-size: 12px; padding: 4px 8px;">删除</button>`;
        contentHtml += '</div>';
        contentHtml += '<div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start;">';

        item.synonyms.forEach(syn => {
          contentHtml += `
            <div class="word-with-definition">
              <div class="word-text">${syn.word}</div>
              ${syn.definition ? `<div class="word-definition">${syn.definition}</div>` : ''}
            </div>
          `;
        });

        contentHtml += '</div></div>';
      });

      contentHtml += '</div>';
      document.getElementById('fullscreenContent').innerHTML = contentHtml;
    }

    // 渲染全屏上下义词
    function renderFullscreenHypernyms(data) {
      let contentHtml = '<div style="display: flex; flex-direction: column; gap: 16px;">';

      data.forEach(item => {
        contentHtml += '<div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: white;">';
        contentHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
        contentHtml += `<h3 style="margin: 0; color: #1f2937; font-size: 16px; font-weight: 600;">${item.title || '未命名'}</h3>`;
        contentHtml += '<div style="display: flex; gap: 8px;">';
        contentHtml += `<button class="action-btn" onclick="editFullscreenHypernym('${fullscreenCategory}', '${item.id}')" style="font-size: 12px; padding: 4px 8px;">编辑</button>`;
        contentHtml += `<button class="action-btn delete" onclick="deleteFullscreenHypernym('${fullscreenCategory}', '${item.id}')" style="font-size: 12px; padding: 4px 8px;">删除</button>`;
        contentHtml += '</div>';
        contentHtml += '</div>';
        contentHtml += '<div class="hypernym-chain">';

        // 渲染上义词
        if (item.upper_words && item.upper_words.length > 0) {
          item.upper_words.forEach((upper, index) => {
            if (index > 0) contentHtml += '<span class="hypernym-separator">, </span>';
            contentHtml += `
              <div class="word-with-definition">
                <div class="word-text">${upper.word}</div>
                ${upper.definition ? `<div class="word-definition">${upper.definition}</div>` : ''}
              </div>
            `;
          });
          contentHtml += '<span class="hypernym-arrow"> → </span>';
        }

        // 渲染下义词
        if (item.lower_words && item.lower_words.length > 0) {
          item.lower_words.forEach((lower, index) => {
            if (index > 0) contentHtml += '<span class="hypernym-separator">, </span>';
            contentHtml += `
              <div class="word-with-definition">
                <div class="word-text">${lower.word}</div>
                ${lower.definition ? `<div class="word-definition">${lower.definition}</div>` : ''}
              </div>
            `;
          });
        }

        contentHtml += '</div></div>';
      });

      contentHtml += '</div>';
      document.getElementById('fullscreenContent').innerHTML = contentHtml;
    }
    
    function enterFullscreenEditMode() {
      document.getElementById('fullscreenContent').style.display = 'none';
      document.getElementById('fullscreenTocFloat').style.display = 'none'; // 编辑时隐藏目录
      document.getElementById('fullscreenEditArea').classList.add('active');
      document.getElementById('fullscreenEditBtn').style.display = 'none';
      document.getElementById('fullscreenSaveBtn').style.display = 'inline-block';
    }
    
    async function saveFullscreenEdit() {
      if (!fullscreenTechnique) return;

      const newContent = document.getElementById('fullscreenTextarea').value;

      try {
        const response = await fetch(`/api/study_techniques/techniques/${fullscreenTechnique.category}/${fullscreenTechnique.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify({
            title: fullscreenTechnique.item.title,
            content: newContent
          })
        });

        if (response.ok) {
          // 更新显示
          const renderedContent = renderMarkdown(newContent);
          document.getElementById('fullscreenContent').innerHTML = renderedContent;
          fullscreenTechnique.item.content = newContent;

          // 重新生成目录
          generateTableOfContents(newContent);

          // 退出编辑模式
          document.getElementById('fullscreenContent').style.display = 'block';
          document.getElementById('fullscreenEditArea').classList.remove('active');
          document.getElementById('fullscreenEditBtn').style.display = 'inline-block';
          document.getElementById('fullscreenSaveBtn').style.display = 'none';

          // 刷新列表数据
          loadData(fullscreenTechnique.category);
        } else {
          alert('保存失败，请重试');
        }
      } catch (error) {
        console.error('Save failed:', error);
        alert('保存失败，请重试');
      }
    }
    
    function addSynonymInput() {
      const container = document.getElementById('synonymInputs');
      const div = document.createElement('div');
      div.className = 'synonym-input-row';
      div.innerHTML = `
        <input type="text" placeholder="同义词" class="form-input synonym-word">
        <input type="text" placeholder="释义" class="form-input synonym-def">
        <button type="button" class="remove-synonym" onclick="removeSynonymInput(this)">删除</button>
      `;
      container.appendChild(div);
    }
    
    function removeSynonymInput(button) {
      const container = document.getElementById('synonymInputs');
      if (container.children.length > 1) {
        button.parentElement.remove();
      }
    }
    
    function addHypernymInput(type) {
      const container = document.getElementById(`hypernym${type === 'upper' ? 'Upper' : 'Lower'}Inputs`);
      const div = document.createElement('div');
      div.className = 'synonym-input-row';
      div.innerHTML = `
        <input type="text" placeholder="${type === 'upper' ? '上义词' : '下义词'}" class="form-input hypernym-word">
        <input type="text" placeholder="释义" class="form-input hypernym-def">
        <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, '${type}')">删除</button>
      `;
      container.appendChild(div);
    }
    
    function removeHypernymInput(button, type) {
      const container = document.getElementById(`hypernym${type === 'upper' ? 'Upper' : 'Lower'}Inputs`);
      if (container.children.length > 1) {
        button.parentElement.remove();
      }
    }
    
    // 表单提交
    async function submitSynonym() {
      const synonyms = [];
      document.querySelectorAll('#synonymInputs .synonym-input-row').forEach(row => {
        const wordInput = row.querySelector('.synonym-word');
        const defInput = row.querySelector('.synonym-def');
        if (wordInput && wordInput.value.trim()) {
          synonyms.push({
            word: wordInput.value.trim(),
            definition: defInput ? defInput.value.trim() : ''
          });
        }
      });

      if (synonyms.length === 0) {
        alert('请至少添加一个同义词');
        return;
      }

      const title = document.getElementById('synonymTitle').value.trim();
      console.log('Submitting synonym:', {synonyms, title, currentToken: currentToken ? 'exists' : 'null'});

      try {
        let url = `/api/study_techniques/synonyms/${currentCategory}`;
        let method = 'POST';

        // 如果是编辑模式
        if (editingItem && editingItem.type === 'synonym') {
          url += `/${editingItem.id}`;
          method = 'PUT';
        }

        const requestData = {
          synonyms,
          ...(title ? {title} : {})
        };

        console.log('Sending request:', {url, method, data: requestData});

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify(requestData)
        });

        console.log('Response status:', response.status);

        if (response.ok) {
          const result = await response.json();
          console.log('Submit successful:', result);

          // 检查是否是从全屏状态编辑的
          if (editingItem && editingItem.isFullscreen) {
            // 保存编辑项信息，因为closeModal会将其设为null
            const editType = editingItem.type;
            const editCategory = editingItem.category;

            // 从全屏状态编辑，只关闭编辑模态框，刷新全屏内容
            closeModal();
            // 重新加载数据并刷新全屏显示
            await loadData(editCategory);
            if (editType === 'synonym' && currentData[editCategory]?.synonyms) {
              openFullscreenSynonyms(editCategory);
            } else if (editType === 'hypernym' && currentData[editCategory]?.hypernyms) {
              openFullscreenHypernyms(editCategory);
            }
          } else {
            // 普通编辑模式
            closeModal();
            loadData(currentCategory);
          }
        } else {
          const errorText = await response.text();
          console.error('Submit failed:', response.status, errorText);
          alert('保存失败，请重试');
        }
      } catch (error) {
        console.error('Submit failed:', error);
        alert('保存失败，请重试');
      }
    }
    
    async function submitHypernym() {
      // 收集上义词
      const upperWords = [];
      document.querySelectorAll('#hypernymUpperInputs .synonym-input-row').forEach(row => {
        const wordInput = row.querySelector('.hypernym-word');
        const defInput = row.querySelector('.hypernym-def');
        if (wordInput && wordInput.value.trim()) {
          upperWords.push({
            word: wordInput.value.trim(),
            definition: defInput ? defInput.value.trim() : ''
          });
        }
      });

      // 收集下义词
      const lowerWords = [];
      document.querySelectorAll('#hypernymLowerInputs .synonym-input-row').forEach(row => {
        const wordInput = row.querySelector('.hypernym-word');
        const defInput = row.querySelector('.hypernym-def');
        if (wordInput && wordInput.value.trim()) {
          lowerWords.push({
            word: wordInput.value.trim(),
            definition: defInput ? defInput.value.trim() : ''
          });
        }
      });

      if (upperWords.length === 0 && lowerWords.length === 0) {
        alert('请至少添加一个上义词或下义词');
        return;
      }

      const title = document.getElementById('hypernymTitle').value.trim();
      console.log('Submitting hypernym:', {upperWords, lowerWords, title, currentToken: currentToken ? 'exists' : 'null'});

      try {
        let url = `/api/study_techniques/hypernyms/${currentCategory}`;
        let method = 'POST';

        // 如果是编辑模式
        if (editingItem && editingItem.type === 'hypernym') {
          url += `/${editingItem.id}`;
          method = 'PUT';
        }

        const requestData = {
          upper_words: upperWords,
          lower_words: lowerWords,
          ...(title ? {title} : {})
        };

        console.log('Sending request:', {url, method, data: requestData});

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify(requestData)
        });

        console.log('Response status:', response.status);

        if (response.ok) {
          const result = await response.json();
          console.log('Submit successful:', result);

          // 检查是否是从全屏状态编辑的
          if (editingItem && editingItem.isFullscreen) {
            // 保存编辑项信息，因为closeModal会将其设为null
            const editType = editingItem.type;
            const editCategory = editingItem.category;

            // 从全屏状态编辑，只关闭编辑模态框，刷新全屏内容
            closeModal();
            // 重新加载数据并刷新全屏显示
            await loadData(editCategory);
            if (editType === 'synonym' && currentData[editCategory]?.synonyms) {
              openFullscreenSynonyms(editCategory);
            } else if (editType === 'hypernym' && currentData[editCategory]?.hypernyms) {
              openFullscreenHypernyms(editCategory);
            }
          } else {
            // 普通编辑模式
            closeModal();
            loadData(currentCategory);
          }
        } else {
          const errorText = await response.text();
          console.error('Submit failed:', response.status, errorText);
          alert('保存失败，请重试');
        }
      } catch (error) {
        console.error('Submit failed:', error);
        alert('保存失败，请重试');
      }
    }
    
    async function submitTechnique() {
      const title = document.getElementById('techniqueTitle').value;
      const content = document.getElementById('techniqueContent').value;
      
      try {
        let url = `/api/study_techniques/techniques/${currentCategory}`;
        let method = 'POST';
        
        // 如果是编辑模式
        if (editingItem && editingItem.type === 'technique') {
          url += `/${editingItem.id}`;
          method = 'PUT';
        }
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify({
            title,
            content
          })
        });
        
        if (response.ok) {
          closeModal();
          editingItem = null;
          loadData(currentCategory);
        } else {
          alert('保存失败，请重试');
        }
      } catch (error) {
        console.error('Submit failed:', error);
        alert('保存失败，请重试');
      }
    }
    
    // 删除操作（带动效）
    async function deleteSynonym(category, id) {
      if (!confirm('确定要删除这个词汇替换吗？')) return;

      console.log(`正在删除词汇替换: ${category}/${id}`);

      // 添加删除动效
      const itemElement = event.target.closest('.item');
      if (itemElement) {
        itemElement.style.transition = 'all 0.3s ease';
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'translateX(-100%)';

        // 等待动效完成后再执行删除
        setTimeout(async () => {
          try {
            const response = await fetch(`/api/study_techniques/synonyms/${category}/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${currentToken}` }
            });

            console.log(`删除响应状态:`, response.status);

            if (response.ok) {
              console.log('删除成功，刷新数据');
              await loadData(category);
            } else {
              // 恢复元素状态
              itemElement.style.opacity = '1';
              itemElement.style.transform = 'translateX(0)';
              const errorText = await response.text();
              console.error('删除失败:', response.status, errorText);
              alert('删除失败，请重试');
            }
          } catch (error) {
            // 恢复元素状态
            itemElement.style.opacity = '1';
            itemElement.style.transform = 'translateX(0)';
            console.error('删除失败:', error);
            alert('删除失败，请重试');
          }
        }, 300);
      } else {
        // 如果找不到元素，直接执行删除
        try {
          const response = await fetch(`/api/study_techniques/synonyms/${category}/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${currentToken}` }
          });

          console.log(`删除响应状态:`, response.status);

          if (response.ok) {
            console.log('删除成功，刷新数据');
            await loadData(category);
          } else {
            const errorText = await response.text();
            console.error('删除失败:', response.status, errorText);
            alert('删除失败，请重试');
          }
        } catch (error) {
          console.error('删除失败:', error);
          alert('删除失败，请重试');
        }
      }
    }

    async function deleteHypernym(category, id) {
      if (!confirm('确定要删除这个上下义词吗？')) return;

      console.log(`正在删除上下义词: ${category}/${id}`);

      // 添加删除动效
      const itemElement = event.target.closest('.item');
      if (itemElement) {
        itemElement.style.transition = 'all 0.3s ease';
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'translateX(-100%)';

        // 等待动效完成后再执行删除
        setTimeout(async () => {
          try {
            const response = await fetch(`/api/study_techniques/hypernyms/${category}/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${currentToken}` }
            });

            console.log(`删除响应状态:`, response.status);

            if (response.ok) {
              console.log('删除成功，刷新数据');
              await loadData(category);
            } else {
              // 恢复元素状态
              itemElement.style.opacity = '1';
              itemElement.style.transform = 'translateX(0)';
              const errorText = await response.text();
              console.error('删除失败:', response.status, errorText);
              alert('删除失败，请重试');
            }
          } catch (error) {
            // 恢复元素状态
            itemElement.style.opacity = '1';
            itemElement.style.transform = 'translateX(0)';
            console.error('删除失败:', error);
            alert('删除失败，请重试');
          }
        }, 300);
      } else {
        // 如果找不到元素，直接执行删除
        try {
          const response = await fetch(`/api/study_techniques/hypernyms/${category}/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${currentToken}` }
          });

          console.log(`删除响应状态:`, response.status);

          if (response.ok) {
            console.log('删除成功，刷新数据');
            await loadData(category);
          } else {
            const errorText = await response.text();
            console.error('删除失败:', response.status, errorText);
            alert('删除失败，请重试');
          }
        } catch (error) {
          console.error('删除失败:', error);
          alert('删除失败，请重试');
        }
      }
    }

    async function deleteTechnique(category, id) {
      if (!confirm('确定要删除这个做题技巧吗？')) return;

      // 添加删除动效
      const itemElement = event.target.closest('.item');
      if (itemElement) {
        itemElement.style.transition = 'all 0.3s ease';
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'translateX(-100%)';

        // 等待动效完成后再执行删除
        setTimeout(async () => {
          try {
            const response = await fetch(`/api/study_techniques/techniques/${category}/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${currentToken}` }
            });

            if (response.ok) {
              await loadData(category);
            } else {
              // 恢复元素状态
              itemElement.style.opacity = '1';
              itemElement.style.transform = 'translateX(0)';
              alert('删除失败，请重试');
            }
          } catch (error) {
            // 恢复元素状态
            itemElement.style.opacity = '1';
            itemElement.style.transform = 'translateX(0)';
            console.error('Delete failed:', error);
            alert('删除失败，请重试');
          }
        }, 300);
      } else {
        // 如果找不到元素，直接执行删除
        try {
          const response = await fetch(`/api/study_techniques/techniques/${category}/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${currentToken}` }
          });

          if (response.ok) {
            await loadData(category);
          } else {
            alert('删除失败，请重试');
          }
        } catch (error) {
          console.error('Delete failed:', error);
          alert('删除失败，请重试');
        }
      }
    }

    // 全屏删除功能（带动效）
    async function deleteFullscreenSynonym(category, id) {
      if (!confirm('确定要删除这个词汇替换组吗？')) return;

      console.log(`正在删除全屏词汇替换: ${category}/${id}`);

      // 添加删除动效
      const itemElement = event.target.closest('.item');
      if (itemElement) {
        itemElement.style.transition = 'all 0.3s ease';
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'translateX(-100%)';

        // 等待动效完成后再执行删除
        setTimeout(async () => {
          try {
            const response = await fetch(`/api/study_techniques/synonyms/${category}/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${currentToken}` }
            });

            console.log(`删除响应状态:`, response.status);

            if (response.ok) {
              console.log('删除成功，刷新全屏数据');
              // 刷新本地数据
              await loadData(category);
              // 重新打开全屏
              openFullscreenSynonyms(category);
            } else {
              // 恢复元素状态
              itemElement.style.opacity = '1';
              itemElement.style.transform = 'translateX(0)';
              const errorText = await response.text();
              console.error('删除失败:', response.status, errorText);
              alert('删除失败，请重试');
            }
          } catch (error) {
            // 恢复元素状态
            itemElement.style.opacity = '1';
            itemElement.style.transform = 'translateX(0)';
            console.error('删除失败:', error);
            alert('删除失败，请重试');
          }
        }, 300);
      } else {
        // 如果找不到元素，直接执行删除
        try {
          const response = await fetch(`/api/study_techniques/synonyms/${category}/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${currentToken}` }
          });

          console.log(`删除响应状态:`, response.status);

          if (response.ok) {
            console.log('删除成功，刷新全屏数据');
            // 刷新本地数据
            await loadData(category);
            // 重新打开全屏
            openFullscreenSynonyms(category);
          } else {
            const errorText = await response.text();
            console.error('删除失败:', response.status, errorText);
            alert('删除失败，请重试');
          }
        } catch (error) {
          console.error('删除失败:', error);
          alert('删除失败，请重试');
        }
      }
    }

    async function deleteFullscreenHypernym(category, id) {
      if (!confirm('确定要删除这个上下义词组吗？')) return;

      console.log(`正在删除全屏上下义词: ${category}/${id}`);

      // 添加删除动效
      const itemElement = event.target.closest('.item');
      if (itemElement) {
        itemElement.style.transition = 'all 0.3s ease';
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'translateX(-100%)';

        // 等待动效完成后再执行删除
        setTimeout(async () => {
          try {
            const response = await fetch(`/api/study_techniques/hypernyms/${category}/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${currentToken}` }
            });

            console.log(`删除响应状态:`, response.status);

            if (response.ok) {
              console.log('删除成功，刷新全屏数据');
              // 刷新本地数据
              await loadData(category);
              // 重新打开全屏
              openFullscreenHypernyms(category);
            } else {
              // 恢复元素状态
              itemElement.style.opacity = '1';
              itemElement.style.transform = 'translateX(0)';
              const errorText = await response.text();
              console.error('删除失败:', response.status, errorText);
              alert('删除失败，请重试');
            }
          } catch (error) {
            // 恢复元素状态
            itemElement.style.opacity = '1';
            itemElement.style.transform = 'translateX(0)';
            console.error('删除失败:', error);
            alert('删除失败，请重试');
          }
        }, 300);
      } else {
        // 如果找不到元素，直接执行删除
        try {
          const response = await fetch(`/api/study_techniques/hypernyms/${category}/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${currentToken}` }
          });

          console.log(`删除响应状态:`, response.status);

          if (response.ok) {
            console.log('删除成功，刷新全屏数据');
            // 刷新本地数据
            await loadData(category);
            // 重新打开全屏
            openFullscreenHypernyms(category);
          } else {
            const errorText = await response.text();
            console.error('删除失败:', response.status, errorText);
            alert('删除失败，请重试');
          }
        } catch (error) {
          console.error('删除失败:', error);
          alert('删除失败，请重试');
        }
      }
    }

    // 全屏编辑功能（支持同义词和上下义词）
    function editFullscreenSynonym(category, id) {
      const data = currentData[category]?.synonyms || [];
      const item = data.find(item => item.id === id);
      if (!item) return;

      // 填充标题
      document.getElementById('synonymTitle').value = item.title || '';

      // 清空并填充同义词输入
      const container = document.getElementById('synonymInputs');
      container.innerHTML = '';
      item.synonyms.forEach(syn => {
        const div = document.createElement('div');
        div.className = 'synonym-input-row';
        div.innerHTML = `
          <input type="text" placeholder="同义词" class="form-input synonym-word" value="${syn.word}">
          <input type="text" placeholder="释义" class="form-input synonym-def" value="${syn.definition || ''}">
          <button type="button" class="remove-synonym" onclick="removeSynonymInput(this)">删除</button>
        `;
        container.appendChild(div);
      });

      // 设置编辑模式
      editingItem = {type: 'synonym', category, id, isFullscreen: true};
      document.querySelector('#synonymModal .modal-header').textContent = '编辑词汇替换';
      document.getElementById('synonymModal').classList.add('show');

      // 保持全屏模态框打开，编辑模态框会显示在全屏之上
    }

    function editFullscreenHypernym(category, id) {
      const data = currentData[category]?.hypernyms || [];
      const item = data.find(item => item.id === id);
      if (!item) return;

      // 填充标题
      document.getElementById('hypernymTitle').value = item.title || '';

      // 填充上义词
      const upperContainer = document.getElementById('hypernymUpperInputs');
      upperContainer.innerHTML = '';
      (item.upper_words || []).forEach(upper => {
        const div = document.createElement('div');
        div.className = 'synonym-input-row';
        div.innerHTML = `
          <input type="text" placeholder="上义词" class="form-input hypernym-word" value="${upper.word}">
          <input type="text" placeholder="释义" class="form-input hypernym-def" value="${upper.definition || ''}">
          <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, 'upper')">删除</button>
        `;
        upperContainer.appendChild(div);
      });

      // 填充下义词
      const lowerContainer = document.getElementById('hypernymLowerInputs');
      lowerContainer.innerHTML = '';
      (item.lower_words || []).forEach(lower => {
        const div = document.createElement('div');
        div.className = 'synonym-input-row';
        div.innerHTML = `
          <input type="text" placeholder="下义词" class="form-input hypernym-word" value="${lower.word}">
          <input type="text" placeholder="释义" class="form-input hypernym-def" value="${lower.definition || ''}">
          <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, 'lower')">删除</button>
        `;
        lowerContainer.appendChild(div);
      });

      // 设置编辑模式
      editingItem = {type: 'hypernym', category, id, isFullscreen: true};
      document.querySelector('#hypernymModal .modal-header').textContent = '编辑上下义词';
      document.getElementById('hypernymModal').classList.add('show');

      // 保持全屏模态框打开，编辑模态框会显示在全屏之上
    }
    
    // 编辑功能
    function editSynonym(category, id) {
      // 找到要编辑的项目
      const data = currentData[category]?.synonyms || [];
      const item = data.find(item => item.id === id);
      if (!item) return;

      // 填充标题
      document.getElementById('synonymTitle').value = item.title || '';

      // 清空并填充同义词输入
      const container = document.getElementById('synonymInputs');
      container.innerHTML = '';
      item.synonyms.forEach(syn => {
        const div = document.createElement('div');
        div.className = 'synonym-input-row';
        div.innerHTML = `
          <input type="text" placeholder="同义词" class="form-input synonym-word" value="${syn.word}">
          <input type="text" placeholder="释义" class="form-input synonym-def" value="${syn.definition || ''}">
          <button type="button" class="remove-synonym" onclick="removeSynonymInput(this)">删除</button>
        `;
        container.appendChild(div);
      });
      
      // 设置编辑模式
      editingItem = {type: 'synonym', category, id};
      document.querySelector('#synonymModal .modal-header').textContent = '编辑词汇替换';
      document.getElementById('synonymModal').classList.add('show');
    }
    
    function editHypernym(category, id) {
      // 找到要编辑的项目
      const data = currentData[category]?.hypernyms || [];
      const item = data.find(item => item.id === id);
      if (!item) return;

      // 填充标题
      document.getElementById('hypernymTitle').value = item.title || '';

      // 填充上义词
      const upperContainer = document.getElementById('hypernymUpperInputs');
      upperContainer.innerHTML = '';
      (item.upper_words || []).forEach(upper => {
        const div = document.createElement('div');
        div.className = 'synonym-input-row';
        div.innerHTML = `
          <input type="text" placeholder="上义词" class="form-input hypernym-word" value="${upper.word}">
          <input type="text" placeholder="释义" class="form-input hypernym-def" value="${upper.definition || ''}">
          <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, 'upper')">删除</button>
        `;
        upperContainer.appendChild(div);
      });
      
      // 如果没有上义词，添加一个空的输入框
      if (!item.upper_words || item.upper_words.length === 0) {
        const div = document.createElement('div');
        div.className = 'synonym-input-row';
        div.innerHTML = `
          <input type="text" placeholder="上义词" class="form-input hypernym-word">
          <input type="text" placeholder="释义" class="form-input hypernym-def">
          <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, 'upper')">删除</button>
        `;
        upperContainer.appendChild(div);
      }
      
      // 填充下义词
      const lowerContainer = document.getElementById('hypernymLowerInputs');
      lowerContainer.innerHTML = '';
      (item.lower_words || []).forEach(lower => {
        const div = document.createElement('div');
        div.className = 'synonym-input-row';
        div.innerHTML = `
          <input type="text" placeholder="下义词" class="form-input hypernym-word" value="${lower.word}">
          <input type="text" placeholder="释义" class="form-input hypernym-def" value="${lower.definition || ''}">
          <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, 'lower')">删除</button>
        `;
        lowerContainer.appendChild(div);
      });
      
      // 如果没有下义词，添加一个空的输入框
      if (!item.lower_words || item.lower_words.length === 0) {
        const div = document.createElement('div');
        div.className = 'synonym-input-row';
        div.innerHTML = `
          <input type="text" placeholder="下义词" class="form-input hypernym-word">
          <input type="text" placeholder="释义" class="form-input hypernym-def">
          <button type="button" class="remove-synonym" onclick="removeHypernymInput(this, 'lower')">删除</button>
        `;
        lowerContainer.appendChild(div);
      }
      
      // 设置编辑模式
      editingItem = {type: 'hypernym', category, id};
      document.querySelector('#hypernymModal .modal-header').textContent = '编辑上下义词';
      document.getElementById('hypernymModal').classList.add('show');
    }
    
    function editTechnique(category, id) {
      // 找到要编辑的项目
      const data = currentData[category]?.techniques || [];
      const item = data.find(item => item.id === id);
      if (!item) return;
      
      // 填充表单
      document.getElementById('techniqueTitle').value = item.title;
      document.getElementById('techniqueContent').value = item.content;
      
      // 设置编辑模式
      editingItem = {type: 'technique', category, id};
      document.querySelector('#techniqueModal .modal-header').textContent = '编辑做题技巧';
      document.getElementById('techniqueModal').classList.add('show');
    }
    
    // 全局变量存储当前数据和编辑状态
    let currentData = {};
    let editingItem = null;
    let fullscreenTechnique = null;
    let currentUploadType = null;
    let currentUploadCategory = null;
    let fullscreenType = null;
    let fullscreenCategory = null;
    let fullscreenLayout = 'narrow'; // 'narrow' or 'wide'


    // Markdown配置和初始化
    function initMarkdown() {
      // 配置marked.js
      marked.setOptions({
        breaks: true, // 支持GitHub风格的换行
        gfm: true, // 启用GitHub风格Markdown
        headerIds: true, // 为标题添加ID
        mangle: false, // 不修改邮箱地址
        highlight: function(code, language) {
          // 使用highlight.js进行代码高亮
          if (language && hljs.getLanguage(language)) {
            try {
              return hljs.highlight(code, { language }).value;
            } catch (err) {
              console.warn('Highlighter error:', err);
            }
          }
          // 如果没有指定语言或高亮失败，使用自动检测
          try {
            return hljs.highlightAuto(code).value;
          } catch (err) {
            console.warn('Auto highlighter error:', err);
          }
          return code; // 降级到原始代码
        }
      });

      // 配置marked以支持更多HTML标签
      marked.use({
        extensions: [
          // 支持下划线语法 ++text++
          {
            name: 'underline',
            level: 'inline',
            start: (src) => src.match(/\+\+/)? src.indexOf('++') : -1,
            tokenizer: (src, tokens) => {
              const rule = /^\+\+([^\+]+(?:\+?[^\+]+)*)\+\+/;
              const match = rule.exec(src);
              if (match) {
                return {
                  type: 'underline',
                  raw: match[0],
                  text: match[1]
                };
              }
            },
            renderer: (token) => `<u>${token.text}</u>`
          },
          // 支持高亮语法 ==text==
          {
            name: 'highlight',
            level: 'inline',
            start: (src) => src.match(/==/)? src.indexOf('==') : -1,
            tokenizer: (src, tokens) => {
              const rule = /^==([^=]+(?:=?[^=]+)*)==/;
              const match = rule.exec(src);
              if (match) {
                return {
                  type: 'highlight',
                  raw: match[0],
                  text: match[1]
                };
              }
            },
            renderer: (token) => `<mark>${token.text}</mark>`
          }
        ]
      });
    }

    // 安全的Markdown渲染函数
    function renderMarkdown(content) {
      try {
        const html = marked.parse(content || '');
        return DOMPurify.sanitize(html);
      } catch (error) {
        console.error('Markdown rendering error:', error);
        return '<p>内容渲染出错</p>';
      }
    }

    // 生成目录函数
    function generateTableOfContents(markdownContent) {
      const tocContainer = document.getElementById('tocList');
      const tocWrapper = document.getElementById('fullscreenToc');
      const tocFloat = document.getElementById('fullscreenTocFloat');
      const tocToggleBtn = document.getElementById('tocToggleBtn');

      // 解析Markdown中的标题
      const headings = [];
      const lines = markdownContent.split('\n');

      lines.forEach((line, index) => {
        // 匹配ATX风格的标题 (# ## ### 等)
        const atxMatch = line.match(/^(#{1,6})\s+(.+)$/);
        if (atxMatch) {
          const level = atxMatch[1].length;
          const text = atxMatch[2].trim();
          headings.push({
            level: level,
            text: text,
            id: `heading-${index}`,
            lineIndex: index
          });
          return;
        }

        // 匹配Setext风格的标题 (=== 或 ---)
        if (index > 0 && (line.match(/^=+$/) || line.match(/^-+$/))) {
          const prevLine = lines[index - 1].trim();
          if (prevLine) {
            const level = line.match(/^=+$/) ? 1 : 2;
            headings.push({
              level: level,
              text: prevLine,
              id: `heading-${index - 1}`,
              lineIndex: index - 1
            });
          }
        }
      });

      // 如果没有标题，隐藏目录
      if (headings.length === 0) {
        tocFloat.style.display = 'none';
        return;
      }

      // 生成目录HTML
      let tocHtml = '';
      headings.forEach(heading => {
        const indentClass = `toc-h${heading.level}`;
        tocHtml += `<li class="toc-item">
          <a href="#${heading.id}" class="toc-link ${indentClass}" data-target="${heading.id}">
            ${heading.text}
          </a>
        </li>`;
      });

      tocContainer.innerHTML = tocHtml;

      // 为内容中的标题添加ID
      const contentElement = document.getElementById('fullscreenContent');
      const contentHeadings = contentElement.querySelectorAll('h1, h2, h3, h4, h5, h6');

      contentHeadings.forEach((heading, index) => {
        if (index < headings.length) {
          heading.id = headings[index].id;
        }
      });

      // 显示目录
      tocFloat.style.display = 'block';

      // 检查并恢复用户的折叠状态
      const isCollapsed = localStorage.getItem('tocCollapsed') === 'true';
      if (isCollapsed) {
        collapseToc();
      } else {
        expandToc();
      }

      // 添加目录交互事件处理函数（折叠/展开）
      function handleTocInteraction(e) {
        // 检查点击的元素是否是折叠按钮或其子元素
        const isToggleButton = e.target.id === 'tocToggleBtn' ||
                              e.target.closest('#tocToggleBtn') !== null;

        // 如果目录处于收起状态，任何点击都应该展开
        if (tocWrapper.classList.contains('collapsed')) {
          e.preventDefault();
          e.stopPropagation();
          toggleToc();
          return;
        }

        // 如果目录处于展开状态，只有点击折叠按钮才收起
        if (isToggleButton) {
          e.preventDefault();
          e.stopPropagation();
          toggleToc();
          return;
        }
      }

      // 添加目录交互事件（折叠/展开）
      tocWrapper.addEventListener('click', handleTocInteraction);

      // 保存事件处理函数引用以便后续清理
      tocWrapper._handleTocInteraction = handleTocInteraction;

      // 添加目录链接点击事件
      tocContainer.addEventListener('click', handleTocClick);

      // 添加滚动监听来高亮当前目录项
      const contentContainer = document.querySelector('.fullscreen-modal');
      contentContainer.addEventListener('scroll', updateActiveTocItem);
    }

    // 切换目录折叠状态
    function toggleToc() {
      const tocFloat = document.getElementById('fullscreenTocFloat');
      const isCollapsed = tocFloat.classList.contains('collapsed');

      if (isCollapsed) {
        expandToc();
      } else {
        collapseToc();
      }
    }

    // 展开目录
    function expandToc() {
      const tocFloat = document.getElementById('fullscreenTocFloat');
      const tocWrapper = document.getElementById('fullscreenToc');
      const tocToggleBtn = document.getElementById('tocToggleBtn');

      tocFloat.classList.remove('collapsed');
      tocWrapper.classList.remove('collapsed');
      tocToggleBtn.innerHTML = '◀';
      tocToggleBtn.title = '收起目录';

      // 保存状态
      localStorage.setItem('tocCollapsed', 'false');
    }

    // 收起目录
    function collapseToc() {
      const tocFloat = document.getElementById('fullscreenTocFloat');
      const tocWrapper = document.getElementById('fullscreenToc');
      const tocToggleBtn = document.getElementById('tocToggleBtn');

      tocFloat.classList.add('collapsed');
      tocWrapper.classList.add('collapsed');
      tocToggleBtn.innerHTML = '▶';
      tocToggleBtn.title = '展开目录';

      // 保存状态
      localStorage.setItem('tocCollapsed', 'true');
    }

    // 处理目录点击事件
    function handleTocClick(event) {
      if (event.target.classList.contains('toc-link')) {
        event.preventDefault();
        const targetId = event.target.getAttribute('data-target');
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          // 平滑滚动到目标位置
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start',
            inline: 'nearest'
          });

          // 更新活动状态
          updateActiveTocItem();
        }
      }
    }

    // 更新活动目录项
    function updateActiveTocItem() {
      const tocLinks = document.querySelectorAll('.toc-link');
      const contentHeadings = document.querySelectorAll('#fullscreenContent h1, #fullscreenContent h2, #fullscreenContent h3, #fullscreenContent h4, #fullscreenContent h5, #fullscreenContent h6');

      let activeIndex = -1;
      const scrollTop = document.querySelector('.fullscreen-modal').scrollTop + 150; // 偏移量

      // 找到当前在视窗中的标题
      for (let i = 0; i < contentHeadings.length; i++) {
        const heading = contentHeadings[i];
        const headingTop = heading.offsetTop;

        if (headingTop <= scrollTop) {
          activeIndex = i;
        } else {
          break;
        }
      }

      // 更新目录链接的活动状态
      tocLinks.forEach((link, index) => {
        link.classList.remove('active');
        if (index === activeIndex) {
          link.classList.add('active');
        }
      });
    }

    // 全屏布局切换函数
    function setFullscreenLayout(layout) {
      const content = document.getElementById('fullscreenContent');
      const buttons = document.querySelectorAll('.layout-btn');

      // 移除所有活动状态
      buttons.forEach(btn => btn.classList.remove('active'));

      if (layout === 'narrow') {
        content.className = 'fullscreen-content fullscreen-narrow';
        document.querySelector('[onclick="setFullscreenLayout(\'narrow\')"]').classList.add('active');
        fullscreenLayout = 'narrow';
      } else if (layout === 'wide') {
        content.className = 'fullscreen-content fullscreen-wide';
        document.querySelector('[onclick="setFullscreenLayout(\'wide\')"]').classList.add('active');
        fullscreenLayout = 'wide';
      }

      // 保存用户偏好到localStorage
      localStorage.setItem('fullscreenLayout', layout);
    }

    // 加载用户布局偏好
    function loadFullscreenLayoutPreference() {
      const saved = localStorage.getItem('fullscreenLayout');
      if (saved === 'wide') {
        setFullscreenLayout('wide');
      } else {
        setFullscreenLayout('narrow');
      }
    }

    // 表单事件绑定
    document.getElementById('synonymForm').addEventListener('submit', (e) => {
      e.preventDefault();
      submitSynonym();
    });

    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化将在window.onload中处理
    });
    
    document.getElementById('hypernymForm').addEventListener('submit', (e) => {
      e.preventDefault();
      submitHypernym();
    });
    
    document.getElementById('techniqueForm').addEventListener('submit', (e) => {
      e.preventDefault();
      submitTechnique();
    });

    document.getElementById('fileUploadForm').addEventListener('submit', handleFileUpload);
    
    // 点击模态框外部关闭
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
    });
    
    // 初始化
    window.onload = function(){
      // 初始化Markdown
      initMarkdown();

      checkStoredToken().then(valid=>{
        if(valid) {
          showUserInfo();
          initEventListeners();
          loadData('listening');
        } else {
          redirectToLogin();
        }
      });
    }
  </script>
  
  <!-- 全屏模态框 -->
  <div id="fullscreenModal" class="fullscreen-modal">
    <div class="fullscreen-header">
      <div class="fullscreen-left">
        <h1 class="fullscreen-title" id="fullscreenTitle">技巧详情</h1>
        <div class="fullscreen-sort-controls" id="fullscreenSortControls" style="display: none;">
          <button class="sort-btn fullscreen-sort-btn active" onclick="sortFullscreenItems('desc')" title="最新在前">
            ↓
          </button>
          <button class="sort-btn fullscreen-sort-btn" onclick="sortFullscreenItems('asc')" title="最早在前">
            ↑
          </button>
        </div>
        <div class="layout-toggle" id="layoutToggle">
          <button class="layout-btn active" onclick="setFullscreenLayout('narrow')" title="窄边布局">窄边</button>
          <button class="layout-btn" onclick="setFullscreenLayout('wide')" title="宽边布局">宽边</button>
        </div>
      </div>
      <div class="fullscreen-actions">
        <button class="fullscreen-edit-btn" id="fullscreenEditBtn" onclick="enterFullscreenEditMode()">编辑</button>
        <button class="fullscreen-save-btn" id="fullscreenSaveBtn" onclick="saveFullscreenEdit()" style="display: none;">保存</button>
        <button class="fullscreen-close" onclick="closeFullscreenModal()">关闭</button>
      </div>
    </div>

    <!-- 浮动目录 -->
    <div class="fullscreen-toc-float" id="fullscreenTocFloat" style="display: none;">
      <div class="fullscreen-toc" id="fullscreenToc">
        <div class="fullscreen-toc-title">
          <span>📖 目录</span>
          <button class="toc-toggle-btn" id="tocToggleBtn" title="收起目录">
            ◀
          </button>
        </div>
        <ul class="toc-list" id="tocList"></ul>
      </div>
    </div>

    <div class="fullscreen-main">
      <div class="fullscreen-content fullscreen-narrow" id="fullscreenContent"></div>
    </div>
    <div class="fullscreen-edit-area" id="fullscreenEditArea">
      <textarea class="fullscreen-textarea" id="fullscreenTextarea" placeholder="请输入技巧内容，支持Markdown语法"></textarea>
    </div>
  </div>
</body>
</html>
